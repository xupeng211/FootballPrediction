# 测试覆盖率提升任务看板
**创建日期**: 2025-01-12
**当前覆盖率**: 19% (目标: 30%)
**问题概述**: 创建了大量测试代码，但因技术问题未能实际提升覆盖率

---

## 🚨 优先级1 - 紧急修复（阻塞测试运行）

### 1. 修复模块导入问题
- **问题**: 多个模块缺少必要的导入
- **影响文件**:
  - `src/data/quality/data_quality_monitor.py` - 缺少 `DatabaseManager` 导入
  - `src/collectors/scores_collector_improved.py` - 可能缺少依赖导入
- **解决方案**:
  ```python
  # 在 data_quality_monitor.py 顶部添加
  from src.database.connection import DatabaseManager

  # 检查 scores_collector_improved.py 的导入
  from src.cache.redis_manager import RedisManager
  from src.database.models import Match, MatchStatus
  ```

### 2. 修复测试语法错误
- **问题**: 1428个测试失败
- **常见错误**:
  - `RuntimeWarning: coroutine ... was never awaited`
  - `SyntaxError: invalid syntax`
  - `NameError: name '...' is not defined`
- **解决方案**:
  - 检查所有测试文件中的 async/await 使用
  - 确保异步函数正确使用 await
  - 修复未定义的变量引用

### 3. 修复依赖缺失
- **问题**: `aiostream` 模块不存在
- **影响**: `test_streaming_kafka_components.py` 等文件
- **解决方案**:
  - 移除不必要的导入
  - 使用标准库替代方案

---

## 🔧 优先级2 - 技术改进（提升测试质量）

### 4. 创建统一的Mock方案
- **目标**: 为所有数据库和外部依赖创建统一的mock
- **需要Mock的模块**:
  - `DatabaseManager`
  - `RedisManager`
  - `AsyncSession`
  - 外部API客户端
- **实施方案**:
  ```python
  # 创建 tests/conftest.py 或 tests/mocks/database.py
  @pytest.fixture
  def mock_db_manager():
      with patch('src.database.connection.DatabaseManager') as mock:
          yield mock

  @pytest.fixture
  def mock_redis_manager():
      with patch('src.cache.redis_manager.RedisManager') as mock:
          yield mock
  ```

### 5. 优化测试运行速度
- **问题**: 测试运行超时（3分钟）
- **解决方案**:
  - 使用 `pytest-x` 在第一个失败时停止
  - 减少不必要的数据库操作
  - 使用更快的mock替代方案

---

## 📋 优先级3 - 测试完善（提升覆盖率）

### 6. 运行并验证测试
- **命令**:
  ```bash
  # 快速验证
  pytest tests/unit/ -x --tb=short -q

  # 详细验证（修复后）
  pytest tests/unit/ --cov=src --cov-report=term-missing
  ```

### 7. 确认覆盖率提升
- **目标**: 从 19% 提升到 30%
- **验证方法**:
  ```bash
  python -m coverage report
  # 查看是否有 TOTAL 行显示覆盖率
  ```

---

## 📊 任务执行顺序

### 第一阶段：修复阻塞问题（预计 30 分钟）
1. ✅ 修复 `data_quality_monitor.py` 的导入问题
2. ✅ 修复 `scores_collector_improved.py` 的导入问题
3. ✅ 移除 `aiostream` 相关代码
4. ✅ 修复 async/await 语法错误

### 第二阶段：运行验证（预计 15 分钟）
5. ✅ 运行 `pytest tests/unit/ -x` 查看剩余错误
6. ✅ 逐个修复失败的测试
7. ✅ 确保至少所有新创建的测试能运行

### 第三阶段：覆盖率确认（预计 15 分钟）
8. ✅ 运行完整覆盖率测试
9. ✅ 确认覆盖率达到 30%
10. ✅ 生成覆盖率报告

---

## 🎯 成功标准

### 必须达成：
- [ ] 所有新创建的测试文件能正常运行
- [ ] 测试失败数降到 10 个以下
- [ ] 覆盖率达到 30% 或更高

### 期望达成：
- [ ] 创建统一的测试配置文件
- [ ] 建立可复用的测试fixtures
- [ ] 测试运行时间在 1 分钟以内

---

## 💡 技术提示

### 快速修复命令：
```bash
# 1. 快速查看错误
pytest tests/unit/ -x --tb=line | head -20

# 2. 只运行失败的测试
pytest --lf -v

# 3. 运行特定测试文件
pytest tests/unit/data/quality/test_data_quality_monitor_basic.py -v

# 4. 查看特定模块的覆盖率
pytest tests/unit/data/quality/ --cov=src/data/quality --cov-report=term
```

### 常见修复模式：
```python
# 1. 模拟数据库
@patch('src.database.connection.DatabaseManager')
def test_something(mock_db):
    # 测试代码

# 2. 处理异步
async def test_async_function():
    result = await some_async_function()
    assert result is not None

# 3. 跳过不可用模块
pytest.importorskip = True
```

---

## 📝 执行记录

| 任务 | 状态 | 完成时间 | 备注 |
|------|------|----------|------|
| 修复导入问题 | ⏳ | 待开始 | - |
| 修复语法错误 | ⏳ | 待开始 | - |
| 运行测试验证 | ⏳ | 待开始 | - |
| 确认覆盖率 | ⏳ | 待开始 | - |

---

## 🚀 开始执行

建议按优先级顺序执行任务，每完成一个任务更新状态记录。遇到问题时，参考技术提示部分。记住：**先让测试能运行，再追求覆盖率提升**。