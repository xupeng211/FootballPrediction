# AlertManageré…ç½®æ–‡ä»¶
# ç”¨äºç”Ÿäº§ç¯å¢ƒå‘Šè­¦ç®¡ç†å’Œé€šçŸ¥

global:
  resolve_timeout: 5m
  http_config:
    follow_redirects: true
    enable_http2: true
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@footballprediction.com'
  smtp_auth_username: 'alerts@footballprediction.com'
  smtp_auth_password: 'your-smtp-password'

# è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'
  routes:
    # ç³»ç»Ÿçº§å‘Šè­¦
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 5m
      routes:
        - match:
            service: football-api
          receiver: 'football-api-critical'

    # æ•°æ®åº“å‘Šè­¦
    - match:
        service: postgres
      receiver: 'database-alerts'
      group_wait: 10s
      repeat_interval: 30m

    # ç¼“å­˜å‘Šè­¦
    - match:
        service: redis
      receiver: 'cache-alerts'
      group_wait: 10s
      repeat_interval: 30m

    # ç›‘æ§ç³»ç»Ÿå‘Šè­¦
    - match:
        service: prometheus
      receiver: 'monitoring-alerts'
      group_wait: 30s
      repeat_interval: 1h

    # è­¦å‘Šçº§åˆ«å‘Šè­¦
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      repeat_interval: 2h

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default'
    email_configs:
      - to: 'team@footballprediction.com'
        subject: '[FootballPrediction] {{ .GroupLabels.alertname }} - {{ .Status | toUpper }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          æ ‡ç­¾: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
          {{ end }}

  # å…³é”®å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    email_configs:
      - to: 'ops@footballprediction.com,manager@footballprediction.com'
        subject: '[CRITICAL] FootballPredictionç³»ç»Ÿå‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          ğŸš¨ å…³é”®å‘Šè­¦ ğŸš¨

          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          è¯¦ç»†æè¿°: {{ .Annotations.description }}
          ä¸¥é‡ç¨‹åº¦: {{ .Labels.severity }}
          æœåŠ¡: {{ .Labels.service }}
          å®ä¾‹: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}

          ç«‹å³å¤„ç†ï¼
          {{ end }}

  # Football APIå…³é”®å‘Šè­¦
  - name: 'football-api-critical'
    email_configs:
      - to: 'dev-team@footballprediction.com,ops@footballprediction.com'
        subject: '[CRITICAL] FootballPrediction APIå‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          ğŸš¨ FootballPrediction APIå…³é”®å‘Šè­¦ ğŸš¨

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          ç«¯ç‚¹: {{ .Labels.endpoint }}
          æ–¹æ³•: {{ .Labels.method }}
          çŠ¶æ€ç : {{ .Labels.status_code }}
          å“åº”æ—¶é—´: {{ .Labels.response_time }}ms
          {{ end }}

  # æ•°æ®åº“å‘Šè­¦
  - name: 'database-alerts'
    email_configs:
      - to: 'dba@footballprediction.com,ops@footballprediction.com'
        subject: '[DATABASE] FootballPredictionæ•°æ®åº“å‘Šè­¦'
        body: |
          ğŸ“Š æ•°æ®åº“å‘Šè­¦ ğŸ“Š

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æ•°æ®åº“: {{ .Labels.database }}
          æŒ‡æ ‡: {{ .Labels.metric }}
          å½“å‰å€¼: {{ .Labels.current_value }}
          é˜ˆå€¼: {{ .Labels.threshold }}
          {{ end }}

  # ç¼“å­˜å‘Šè­¦
  - name: 'cache-alerts'
    email_configs:
      - to: 'ops@footballprediction.com,dev-team@footballprediction.com'
        subject: '[CACHE] FootballPredictionç¼“å­˜å‘Šè­¦'
        body: |
          ğŸ’¾ ç¼“å­˜å‘Šè­¦ ğŸ’¾

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          å®ä¾‹: {{ .Labels.instance }}
          æŒ‡æ ‡: {{ .Labels.metric }}
          å½“å‰å€¼: {{ .Labels.current_value }}
          {{ end }}

  # ç›‘æ§ç³»ç»Ÿå‘Šè­¦
  - name: 'monitoring-alerts'
    email_configs:
      - to: 'ops@footballprediction.com'
        subject: '[MONITORING] ç›‘æ§ç³»ç»Ÿå‘Šè­¦'
        body: |
          ğŸ“ˆ ç›‘æ§ç³»ç»Ÿå‘Šè­¦ ğŸ“ˆ

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          ç»„ä»¶: {{ .Labels.component }}
          å®ä¾‹: {{ .Labels.instance }}
          {{ end }}

  # è­¦å‘Šçº§å‘Šè­¦
  - name: 'warning-alerts'
    email_configs:
      - to: 'team@footballprediction.com'
        subject: '[WARNING] FootballPredictionè­¦å‘Š'
        body: |
          âš ï¸ ç³»ç»Ÿè­¦å‘Š âš ï¸

          {{ range .Alerts }}
          è­¦å‘Š: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æœåŠ¡: {{ .Labels.service }}
          å®ä¾‹: {{ .Labels.instance }}
          {{ end }}

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœæœåŠ¡å®•æœºï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡çš„å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: 'InstanceDown'
      severity: 'critical'
    target_match:
      service: '{{ .Labels.service }}'
    equal: ['instance', 'service']

  # å¦‚æœèŠ‚ç‚¹å®•æœºï¼ŒæŠ‘åˆ¶è¯¥èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å‘Šè­¦
  - source_match:
      alertname: 'NodeDown'
      severity: 'critical'
    target_match:
      instance: '{{ .Labels.instance }}'
    equal: ['instance']

# æ¨¡æ¿æ–‡ä»¶
templates:
  - '/etc/alertmanager/templates/*.tmpl'