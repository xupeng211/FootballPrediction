# Prometheus告警规则配置
# Prometheus Alert Rules Configuration

groups:
  # 系统级告警
  - name: system.rules
    rules:
      # 高CPU使用率告警
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "高CPU使用率告警"
          description: "实例 {{ $labels.instance }} CPU使用率超过80%，当前值: {{ $value }}%"

      # 严重高CPU使用率告警
      - alert: CriticalCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 2m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "严重高CPU使用率告警"
          description: "实例 {{ $labels.instance }} CPU使用率超过95%，当前值: {{ $value }}%"

      # 高内存使用率告警
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "高内存使用率告警"
          description: "实例 {{ $labels.instance }} 内存使用率超过85%，当前值: {{ $value }}%"

      # 磁盘空间不足告警
      - alert: DiskSpaceLow
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "磁盘空间不足告警"
          description: "实例 {{ $labels.instance }} 磁盘 {{ $labels.mountpoint }} 使用率超过85%，当前值: {{ $value }}%"

      # 磁盘空间严重不足告警
      - alert: DiskSpaceCritical
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 95
        for: 2m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "磁盘空间严重不足告警"
          description: "实例 {{ $labels.instance }} 磁盘 {{ $labels.mountpoint }} 使用率超过95%，当前值: {{ $value }}%"

  # 应用级告警
  - name: application.rules
    rules:
      # 应用服务不可用告警
      - alert: ApplicationDown
        expr: up{job="football-app"} == 0
        for: 1m
        labels:
          severity: critical
          service: application
        annotations:
          summary: "应用服务不可用"
          description: "足球预测应用服务 {{ $labels.instance }} 已停止响应超过1分钟"

      # 高响应时间告警
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          service: application
        annotations:
          summary: "高响应时间告警"
          description: "应用95%响应时间超过1秒，当前值: {{ $value }}秒"

      # 高错误率告警
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 3m
        labels:
          severity: warning
          service: application
        annotations:
          summary: "高错误率告警"
          description: "应用5xx错误率超过5%，当前值: {{ $value | humanizePercentage }}"

      # 严重错误率告警
      - alert: CriticalErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.1
        for: 1m
        labels:
          severity: critical
          service: application
        annotations:
          summary: "严重错误率告警"
          description: "应用5xx错误率超过10%，当前值: {{ $value | humanizePercentage }}"

      # 数据库连接池告警
      - alert: DatabaseConnectionPoolExhausted
        expr: db_connections_active / db_connections_max > 0.9
        for: 3m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "数据库连接池即将耗尽"
          description: "数据库连接池使用率超过90%，当前值: {{ $value | humanizePercentage }}"

  # Nginx级告警
  - name: nginx.rules
    rules:
      # Nginx高负载告警
      - alert: NginxHighLoad
        expr: nginx_connections_current / nginx_connections_limit > 0.8
        for: 5m
        labels:
          severity: warning
          service: nginx
        annotations:
          summary: "Nginx高负载告警"
          description: "Nginx连接数使用率超过80%，当前值: {{ $value | humanizePercentage }}"

      # Nginx响应时间告警
      - alert: NginxHighResponseTime
        expr: nginx_request_time_seconds{quantile="0.95"} > 2
        for: 5m
        labels:
          severity: warning
          service: nginx
        annotations:
          summary: "Nginx高响应时间告警"
          description: "Nginx 95%响应时间超过2秒，当前值: {{ $value }}秒"

  # 数据库级告警
  - name: database.rules
    rules:
      # PostgreSQL连接数告警
      - alert: PostgreSQLTooManyConnections
        expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "PostgreSQL连接数过多"
          description: "PostgreSQL连接数使用率超过80%，当前值: {{ $value | humanizePercentage }}"

      # PostgreSQL慢查询告警
      - alert: PostgreSQLSlowQueries
        expr: rate(pg_stat_statements_mean_time_seconds[5m]) > 1
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "PostgreSQL慢查询告警"
          description: "PostgreSQL平均查询时间超过1秒，当前值: {{ $value }}秒"

      # PostgreSQL复制延迟告警
      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag_seconds > 60
        for: 3m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "PostgreSQL复制延迟告警"
          description: "PostgreSQL复制延迟超过60秒，当前值: {{ $value }}秒"

  # Redis级告警
  - name: redis.rules
    rules:
      # Redis内存使用率告警
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis高内存使用率告警"
          description: "Redis内存使用率超过80%，当前值: {{ $value | humanizePercentage }}"

      # Redis连接数告警
      - alert: RedisTooManyConnections
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis连接数过多"
          description: "Redis连接数超过100，当前值: {{ $value }}"

      # Redis键空间告警
      - alert: RedisTooManyKeys
        expr: redis_db_keys > 1000000
        for: 10m
        labels:
          severity: info
          service: redis
        annotations:
          summary: "Redis键数量过多"
          description: "Redis键数量超过100万，当前值: {{ $value }}"

  # 业务级告警
  - name: business.rules
    rules:
      # 预测请求量异常告警
      - alert: PredictionRequestAnomaly
        expr: rate(prediction_requests_total[5m]) < 10
        for: 10m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "预测请求量异常"
          description: "预测请求量低于10/分钟，可能存在系统问题"

      # 预测准确率告警
      - alert: LowPredictionAccuracy
        expr: prediction_accuracy_rate < 0.6
        for: 30m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "预测准确率过低"
          description: "预测准确率低于60%，当前值: {{ $value | humanizePercentage }}"

      # 用户活跃度告警
      - alert: LowUserActivity
        expr: rate(user_active_total[1h]) < 5
        for: 2h
        labels:
          severity: info
          service: business
        annotations:
          summary: "用户活跃度过低"
          description: "用户活跃度低于5/小时，当前值: {{ $value }}"

  # SSL证书告警
  - name: ssl.rules
    rules:
      # SSL证书即将过期告警
      - alert: SSLCertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7
        for: 1h
        labels:
          severity: warning
          service: ssl
        annotations:
          summary: "SSL证书即将过期"
          description: "SSL证书将在7天内过期，域名: {{ $labels.instance }}"

      # SSL证书已过期告警
      - alert: SSLCertificateExpired
        expr: probe_ssl_earliest_cert_expiry - time() < 0
        for: 1m
        labels:
          severity: critical
          service: ssl
        annotations:
          summary: "SSL证书已过期"
          description: "SSL证书已过期，域名: {{ $labels.instance }}"

  # 网络可用性告警
  - name: availability.rules
    rules:
      # 网站不可用告警
      - alert: WebsiteDown
        expr: probe_success == 0
        for: 1m
        labels:
          severity: critical
          service: availability
        annotations:
          summary: "网站不可用"
          description: "网站 {{ $labels.instance }} 无法访问"

      # 网站响应时间过长告警
      - alert: WebsiteSlowResponse
        expr: probe_duration_seconds > 5
        for: 5m
        labels:
          severity: warning
          service: availability
        annotations:
          summary: "网站响应时间过长"
          description: "网站 {{ $labels.instance }} 响应时间超过5秒，当前值: {{ $value }}秒"
