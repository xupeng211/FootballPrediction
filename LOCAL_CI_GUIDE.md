# ğŸš€ æœ¬åœ°CIæ¨¡æ‹Ÿå™¨ V5.0 ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

**æ‹’ç»ç­‰å¾…ï¼Œæœ¬åœ°è·‘CIï¼**

æœ¬åœ°CIæ¨¡æ‹Ÿå™¨æ˜¯ä¸€ä¸ªå®Œå…¨å¤ç°GitHub Actionsç¯å¢ƒçš„Docker Composeé…ç½®ï¼Œè®©ä½ èƒ½å¤Ÿåœ¨æœ¬åœ°å‡ åˆ†é’Ÿå†…å®ŒæˆåŸæœ¬éœ€è¦åå‡ åˆ†é’Ÿè¿œç¨‹ç­‰å¾…çš„CIæµç¨‹ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ—ï¸ å®Œå…¨éš”ç¦»çš„"ç™½æ¿"ç¯å¢ƒ
- **çº¯å‡€Python 3.11ç¯å¢ƒ** - ä¸ä¾èµ–ä½ æœ¬åœ°ä»»ä½•Pythonå®‰è£…
- **DockeråŸç”Ÿ** - æ‰€æœ‰ä¾èµ–åœ¨å®¹å™¨å†…ä»é›¶å®‰è£…
- **ç«¯å£éš”ç¦»** - ä½¿ç”¨5433/6380ç«¯å£é¿å…ä¸å¼€å‘ç¯å¢ƒå†²çª

### ğŸ”§ ç¯å¢ƒå®Œå…¨å¯¹é½
- **æ•°æ®åº“**: PostgreSQL 15 + test_football_predictionæ•°æ®åº“
- **ç¼“å­˜**: Redis 7 + å®Œå…¨ä¸€è‡´çš„è¿æ¥é…ç½®
- **ç¯å¢ƒå˜é‡**: ä¸`.github/workflows/ci_pipeline_v2.yml`100%ä¸€è‡´
- **ä¾èµ–ç®¡ç†**: åŒæ—¶ä½¿ç”¨`requirements.txt`å’Œ`requirements-ci.txt`

### âš¡ ä¸€é”®è¿è¡Œ
- **è‡ªåŠ¨åŒ–æµç¨‹**: å¯åŠ¨æœåŠ¡â†’å®‰è£…ä¾èµ–â†’è¿è¡Œæµ‹è¯•â†’ç”ŸæˆæŠ¥å‘Š
- **æ™ºèƒ½æ¸…ç†**: è‡ªåŠ¨å¤„ç†å®¹å™¨å’Œæ•°æ®å·
- **å¤šç§æ¨¡å¼**: æ”¯æŒæ ‡å‡†æ¨¡å¼ã€å¿«é€Ÿæ¨¡å¼ã€å¼ºåˆ¶é‡å»ºç­‰

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```bash
# æ ‡å‡†CIè¿è¡Œï¼ˆå®Œæ•´æµç¨‹ï¼‰
./run_local_ci.sh

# æˆ–è€…ç›´æ¥ä½¿ç”¨Docker Compose
docker-compose -f docker-compose.ci.yml up --build --abort-on-container-exit --exit-code-from ci-runner
```

### 2. å¿«é€Ÿæ¨¡å¼ï¼ˆè·³è¿‡ä»£ç æ£€æŸ¥ï¼‰

```bash
# è·³è¿‡ruffå’Œbanditæ£€æŸ¥ï¼Œç›´æ¥è¿è¡Œæµ‹è¯•
./run_local_ci.sh --fast
```

### 3. ç¯å¢ƒç®¡ç†

```bash
# æ¸…ç†æ‰€æœ‰CIå®¹å™¨å’Œæ•°æ®
./run_local_ci.sh --clean

# å¼ºåˆ¶é‡æ–°æ„å»ºé•œåƒ
./run_local_ci.sh --build

# æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯
./run_local_ci.sh --help
```

## ğŸ“Š è¾“å‡ºæ–‡ä»¶è¯´æ˜

è¿è¡Œå®Œæˆåï¼Œä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

| æ–‡ä»¶ | è¯´æ˜ | å¦‚ä½•æŸ¥çœ‹ |
|------|------|----------|
| `test-results.xml` | JUnitæ ¼å¼çš„æµ‹è¯•ç»“æœ | `cat test-results.xml` |
| `htmlcov/index.html` | è¦†ç›–ç‡HTMLæŠ¥å‘Š | `open htmlcov/index.html` |
| `bandit-report.json` | å®‰å…¨æ‰«ææŠ¥å‘Š | `cat bandit-report.json` |
| `ci-report.txt` | CIè¿è¡Œæ‘˜è¦ | `cat ci-report.txt` |

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. ç«¯å£å†²çª
```bash
# å¦‚æœ5433æˆ–6380ç«¯å£è¢«å ç”¨ï¼Œä¿®æ”¹docker-compose.ci.ymlä¸­çš„ç«¯å£æ˜ å°„
ports:
  - "5434:5432"  # ä¿®æ”¹ä¸ºå…¶ä»–ç«¯å£
  - "6381:6379"
```

#### 2. æ„å»ºå¤±è´¥
```bash
# æ¸…ç†å¹¶é‡æ–°æ„å»º
./run_local_ci.sh --clean
./run_local_ci.sh --build
```

#### 3. æµ‹è¯•å¤±è´¥æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```bash
# æŸ¥çœ‹CIè¿è¡Œå™¨çš„è¯¦ç»†æ—¥å¿—
docker-compose -f docker-compose.ci.yml logs ci-runner

# è¿›å…¥å®¹å™¨å†…éƒ¨è°ƒè¯•
docker-compose -f docker-compose.ci.yml exec ci-runner bash
```

#### 4. ä¾èµ–å®‰è£…é—®é¢˜
```bash
# æ‰‹åŠ¨è¿›å…¥å®¹å™¨å®‰è£…ä¾èµ–
docker-compose -f docker-compose.ci.yml exec ci-runner pip install -r requirements-ci.txt
```

### è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹å®¹å™¨çŠ¶æ€**
   ```bash
   docker-compose -f docker-compose.ci.yml ps
   ```

2. **æŸ¥çœ‹æœåŠ¡å¥åº·çŠ¶æ€**
   ```bash
   docker-compose -f docker-compose.ci.yml exec db pg_isready -U postgres
   docker-compose -f docker-compose.ci.yml exec redis redis-cli ping
   ```

3. **ä¿ç•™å®¹å™¨è¿›è¡Œè°ƒè¯•**
   ```bash
   # ä¿®æ”¹docker-compose.ci.ymlï¼Œæ·»åŠ tty: true, stdin_open: true
   # ç„¶åè¿è¡Œ: docker-compose -f docker-compose.ci.yml up
   ```

## ğŸ¯ æœ€ä½³å®è·µ

### å¼€å‘å·¥ä½œæµé›†æˆ

```bash
# 1. å¼€å‘å®Œæˆåï¼Œè¿è¡Œæœ¬åœ°CI
./run_local_ci.sh

# 2. å¦‚æœé€šè¿‡ï¼Œæäº¤ä»£ç 
git add .
git commit -m "feat: æ–°åŠŸèƒ½å®ç°"
git push

# 3. å¦‚æœå¤±è´¥ï¼Œä¿®å¤é—®é¢˜åé‡æ–°è¿è¡Œ
./run_local_ci.sh --fast  # å¿«é€ŸéªŒè¯ä¿®å¤
```

### æ€§èƒ½ä¼˜åŒ–

- **é¦–æ¬¡è¿è¡Œ**: éœ€è¦æ„å»ºé•œåƒï¼Œæ—¶é—´è¾ƒé•¿ï¼ˆ~5-10åˆ†é’Ÿï¼‰
- **åç»­è¿è¡Œ**: é•œåƒå·²ç¼“å­˜ï¼Œé€šå¸¸2-5åˆ†é’Ÿå®Œæˆ
- **å¿«é€Ÿæ¨¡å¼**: 1-2åˆ†é’Ÿå®Œæˆï¼Œé€‚åˆé¢‘ç¹éªŒè¯

### èµ„æºç®¡ç†

- **å†…å­˜ä½¿ç”¨**: çº¦1-2GBï¼ˆML Mockæ¨¡å¼ï¼‰
- **ç£ç›˜ç©ºé—´**: çº¦500MBï¼ˆé•œåƒ+æ•°æ®ï¼‰
- **æ¸…ç†å»ºè®®**: æ¯å‘¨è¿è¡Œä¸€æ¬¡ `./run_local_ci.sh --clean`

## ğŸ” CIé…ç½®å¯¹é½è¯´æ˜

æœ¬åœ°CIæ¨¡æ‹Ÿå™¨ä¸è¿œç¨‹GitHub Actionsçš„ç¯å¢ƒå®Œå…¨å¯¹é½ï¼š

### ç¯å¢ƒå˜é‡å¯¹ç…§è¡¨

| è¿œç¨‹CI | æœ¬åœ°CI | è¯´æ˜ |
|--------|--------|------|
| `DATABASE_URL` | `postgresql://postgres:postgres@db:5432/test_football_prediction` | å®Œå…¨ä¸€è‡´ |
| `REDIS_URL` | `redis://redis:6379/0` | å®Œå…¨ä¸€è‡´ |
| `TESTING` | `true` | æµ‹è¯•æ¨¡å¼æ ‡è¯† |
| `FOOTBALL_PREDICTION_ML_MODE` | `mock` | ML Mockæ¨¡å¼ |
| `SKIP_ML_MODEL_LOADING` | `true` | è·³è¿‡MLæ¨¡å‹åŠ è½½ |

### æµ‹è¯•å‘½ä»¤å¯¹ç…§è¡¨

| è¿œç¨‹CIå‘½ä»¤ | æœ¬åœ°CIå‘½ä»¤ | è¯´æ˜ |
|------------|------------|------|
| `pytest tests/unit/ --ignore=tests/unit/ml/` | å®Œå…¨ä¸€è‡´ | è·³è¿‡MLæµ‹è¯• |
| `--timeout=30 --timeout-method=thread` | å®Œå…¨ä¸€è‡´ | è¶…æ—¶è®¾ç½® |
| `--maxfail=5 -x` | å®Œå…¨ä¸€è‡´ | å¤±è´¥æ§åˆ¶ |
| `--cov=src --cov-report=html` | å®Œå…¨ä¸€è‡´ | è¦†ç›–ç‡æŠ¥å‘Š |

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### Dockeræ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœ¬åœ°CIæ¨¡æ‹Ÿå™¨æ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚   Redis     â”‚  â”‚  CI Runner      â”‚  â”‚
â”‚  â”‚   (5433)    â”‚  â”‚   (6380)    â”‚  â”‚   Python 3.11  â”‚  â”‚
â”‚  â”‚ test_db     â”‚  â”‚  cache      â”‚  â”‚  + pytest      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚               â”‚                    â”‚            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                        â”‚                                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â”‚  ci-network     â”‚                          â”‚
â”‚              â”‚  (bridge)       â”‚                          â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®é…ç½®æ–‡ä»¶

1. **docker-compose.ci.yml**: CIç¯å¢ƒå®šä¹‰
2. **Dockerfile.ci**: CIè¿è¡Œå™¨é•œåƒ
3. **run_local_ci.sh**: ä¸€é”®è¿è¡Œè„šæœ¬
4. **requirements-ci.txt**: CIä¸“ç”¨ä¾èµ–

---

## ğŸ‰ æˆåŠŸï¼

ç°åœ¨ä½ æ‹¥æœ‰äº†ä¸€ä¸ªå®Œå…¨æœ¬åœ°åŒ–çš„CIç¯å¢ƒï¼Œå†ä¹Ÿä¸ç”¨ä¸ºè¿œç¨‹CIçš„æ¼«é•¿ç­‰å¾…è€Œçƒ¦æ¼äº†ï¼

**è®°ä½ï¼š** æœ¬åœ°é€šè¿‡ â‰  è¿œç¨‹ä¸€å®šé€šè¿‡ï¼Œä½†æœ¬åœ°å¤±è´¥ = è¿œç¨‹ä¸€å®šå¤±è´¥ã€‚ç”¨è¿™ä¸ªå·¥å…·å¿«é€Ÿå‘ç°é—®é¢˜ï¼Œä¿®å¤åå†æäº¤ï¼