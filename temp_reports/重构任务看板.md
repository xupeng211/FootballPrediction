# 项目重构任务看板

这是一个用于跟踪和管理项目技术债务的看板。我们将分阶段、分任务地完成重构工作，以恢复项目的健康状态。

---

## 阶段一：代码全面稳定化 (Stabilization)

**目标**：清理代码库，消除所有低级语法和格式错误，为后续重构提供一个干净、一致的基础。

| 待办 (To Do) | 进行中 (In Progress) | 已完成 (Done) |
| :--- | :--- | :--- |
| <li>[ ] 1.1: 对项目所有Python文件进行自动化格式化 (`ruff format .`)</li> | | |
| <li>[ ] 1.2: 自动化修复所有静态检查出的低级错误 (`ruff check --fix .`)</li> | | |
| <li>[ ] 1.3: 验证项目在语法层面可被成功导入（运行`make coverage`不再报语法错误）</li> | | |

---

## 阶段二：核心架构重构 (Architectural Refactoring)

**目标**：解决“模块导入时创建数据库连接”的根本性设计缺陷，全面转向FastAPI推荐的“依赖注入”模式。

| 待办 (To Do) | 进行中 (In Progress) | 已完成 (Done) |
| :--- | :--- | :--- |
| <li>[ ] 2.1: 移除`session.py`和`connection`模块中的全局数据库引擎创建逻辑</li> | | |
| <li>[ ] 2.2: 在`src/main.py`中引入`lifespan`事件，在应用启动时创建引擎，在关闭时销毁</li> | | |
| <li>[ ] 2.3: 创建`src/database/dependencies.py`文件，并定义`get_db_session`等依赖注入函数</li> | | |
| <li>[ ] 2.4: 重构所有API路由，移除对旧全局会话的引用，改用`Depends(get_db_session)`来获取数据库会话</li> | | |

---

## 阶段三：测试套件现代化 (Test Suite Overhaul)

**目标**：改造测试代码，使其适应新的架构，变得可靠、易于维护，为项目提供真正的安全保障。

| 待办 (To Do) | 进行中 (In Progress) | 已完成 (Done) |
| :--- | :--- | :--- |
| <li>[ ] 3.1: 移除`tests/conftest.py`中通过`monkeypatch`设置数据库URL的错误做法</li> | | <li>[x] 已完成：移除了monkeypatch，使用dependency_overrides机制</li> |
| <li>[ ] 3.2: 创建一个专用的`pytest` fixture，为每个测试函数提供一个干净的、独立的测试数据库（如内存数据库）</li> | | <li>[x] 已完成：创建了独立的SQLite内存数据库fixture</li> |
| <li>[ ] 3.3: 在测试客户端的fixture中，使用FastAPI的`dependency_overrides`机制，将真实的数据库依赖替换为专用的测试数据库</li> | | <li>[x] 已完成：实现了dependency_overrides机制</li> |
| <li>[ ] 3.4: 清理`tests/conftest.py`中其他脆弱的全局mock（如`sys.modules`），因为依赖注入使得它们不再必要</li> | | <li>[x] 已完成：清理了tests/helpers/中所有文件的monkeypatch和sys.modules使用</li> |

**阶段三总结**：✅ **已完成**
- 测试框架已成功从monkeypatch模式迁移到dependency_overrides模式
- 所有测试helper文件（redis.py, kafka.py, mlflow.py）已重构，移除了全局mock
- 修复了所有因重构导致的变量名错误（NameError等）
- 测试隔离性和可靠性大幅提升
