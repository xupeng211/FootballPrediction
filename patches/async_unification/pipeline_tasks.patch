--- a/src/tasks/pipeline_tasks.py+++ b/src/tasks/pipeline_tasks.py@@ -22,12 +22,12 @@ )
 
 
-def sync_task_to_async(async_func):
+async def sync_task_to_async(async_func):
     """å°†å¼‚æ­¥å‡½æ•°è½¬æ¢ä¸ºåŒæ­¥çš„Celeryä»»åŠ¡"""
     from functools import wraps
 
     @wraps(async_func)
-    def wrapper(*args, **kwargs):
+async def wrapper(*args, **kwargs):
         import asyncio
 
         return asyncio.run(async_func(*args, **kwargs))
@@ -76,7 +76,7 @@                         .limit(BATCH_SIZE)
                         .offset(offset)
                     )
-                    result = await session.execute(query)
+                    result = await session.await execute(query)
                     batch_raw_matches = result.scalars().all()
                     logger.info(f"âœ… æ–¹æ³•1æˆåŠŸ: æ‰¾åˆ° {len(batch_raw_matches)} æ¡è®°å½•")
                 except Exception as e:
@@ -122,7 +122,7 @@                             all_query = (
                                 select(RawMatchData).limit(BATCH_SIZE).offset(offset)
                             )
-                            result = await session.execute(all_query)
+                            result = await session.await execute(all_query)
                             all_matches = result.scalars().all()
 
                             # åœ¨Pythonä¸­è¿‡æ»¤æœªå¤„ç†çš„
@@ -197,17 +197,17 @@     for raw_match in raw_matches:
         try:
             match_data = raw_match.match_data
-            raw_content = match_data.get("raw_data", {})
+            raw_content = match_data.await get("raw_data", {})
 
             # ä¼˜å…ˆä»competitionå­—æ®µæå–è”èµ›ä¿¡æ¯
             if "competition" in raw_content:
                 comp = raw_content["competition"]
-                league_name = comp.get("name", "Unknown League")
-                league_country = comp.get("area", {}).get("name", "Unknown Country")
+                league_name = comp.await get("name", "Unknown League")
+                league_country = comp.await await get("area", {}).get("name", "Unknown Country")
             else:
                 # å›é€€åˆ°ä»é¡¶å±‚å­—æ®µæå–
-                league_name = match_data.get("league_name", "International Friendlies")
-                league_country = match_data.get("league_country", "International")
+                league_name = match_data.await get("league_name", "International Friendlies")
+                league_country = match_data.await get("league_country", "International")
 
                 # å¦‚æœè”èµ›åç§°ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
                 if not league_name or league_name.strip() == "":
@@ -239,7 +239,7 @@             query = text(
                 "SELECT id FROM leagues WHERE name = :name AND country = :country"
             )
-            result = await session.execute(query, {"name": name, "country": country})
+            result = await session.await execute(query, {"name": name, "country": country})
             existing = result.scalar_one_or_none()
             if existing:
                 existing_leagues[(name, country)] = existing
@@ -263,7 +263,7 @@ 
     # æ­¥éª¤3ï¼šé‡æ–°è·å–Leaguesæ˜ å°„
     leagues_query = text("SELECT id, name, country FROM leagues")
-    leagues_result = await session.execute(leagues_query)
+    leagues_result = await session.await execute(leagues_query)
     leagues_map = {(row[1], row[2]): row[0] for row in leagues_result.fetchall()}
 
     # ğŸ†• æ·»åŠ Leagueæ˜ å°„è°ƒè¯•ä¿¡æ¯
@@ -281,27 +281,27 @@             match_data = raw_match.match_data
 
             # ğŸ”„ é€‚é…ä¸åŒæ•°æ®æºï¼šä¼˜å…ˆä½¿ç”¨match_dataä¸­çš„çƒé˜Ÿåç§°ï¼Œå›é€€åˆ°raw_data
-            home_team_name = match_data.get("home_team_name")
-            away_team_name = match_data.get("away_team_name")
+            home_team_name = match_data.await get("home_team_name")
+            away_team_name = match_data.await get("away_team_name")
 
             # å¦‚æœmatch_dataä¸­æ²¡æœ‰çƒé˜Ÿä¿¡æ¯ï¼Œå°è¯•ä»raw_dataè·å–
             if not home_team_name or not away_team_name:
-                raw_content = match_data.get("raw_data", {})
+                raw_content = match_data.await get("raw_data", {})
 
                 if not home_team_name and "homeTeam" in raw_content:
                     home_team_info = raw_content["homeTeam"]
-                    home_team_name = home_team_info.get("name", "Unknown Team")
+                    home_team_name = home_team_info.await get("name", "Unknown Team")
 
                 if not away_team_name and "awayTeam" in raw_content:
                     away_team_info = raw_content["awayTeam"]
-                    away_team_name = away_team_info.get("name", "Unknown Team")
+                    away_team_name = away_team_info.await get("name", "Unknown Team")
 
             # å¤„ç†ä¸»é˜Ÿ
             if home_team_name:
                 team_short_name = (
                     home_team_name[:10] if len(home_team_name) > 10 else home_team_name
                 )
-                team_country = match_data.get("league_country", "Unknown Country")
+                team_country = match_data.await get("league_country", "Unknown Country")
 
                 if home_team_name not in unique_teams:
                     unique_teams[home_team_name] = {
@@ -315,7 +315,7 @@                 team_short_name = (
                     away_team_name[:10] if len(away_team_name) > 10 else away_team_name
                 )
-                team_country = match_data.get("league_country", "Unknown Country")
+                team_country = match_data.await get("league_country", "Unknown Country")
 
                 if away_team_name not in unique_teams:
                     unique_teams[away_team_name] = {
@@ -334,7 +334,7 @@         existing_teams = {}
         for team_name, _team_data in unique_teams.items():
             query = text("SELECT id FROM teams WHERE name = :name")
-            result = await session.execute(query, {"name": team_name})
+            result = await session.await execute(query, {"name": team_name})
             existing = result.scalar_one_or_none()
             if existing:
                 existing_teams[team_name] = existing
@@ -359,7 +359,7 @@ 
     # æ­¥éª¤6ï¼šé‡æ–°è·å–Teamsæ˜ å°„
     teams_query = text("SELECT id, name FROM teams")
-    teams_result = await session.execute(teams_query)
+    teams_result = await session.await execute(teams_query)
     teams_map = {row[1]: row[0] for row in teams_result.fetchall()}
 
     # æ­¥éª¤7ï¼šæ‰¹é‡åˆ›å»ºMatches
@@ -370,44 +370,44 @@     for raw_match in raw_matches:
         try:
             match_data = raw_match.match_data
-            raw_content = match_data.get("raw_data", {})
+            raw_content = match_data.await get("raw_data", {})
 
             # å¤„ç†çŠ¶æ€å­—æ®µ - ä¿®å¤çŠ¶æ€æå–é€»è¾‘ï¼Œæ”¯æŒFotMob JSONç»“æ„
             status = "SCHEDULED"  # é»˜è®¤çŠ¶æ€
 
             # æ–¹æ³•1: ä» match_data.status æå–
-            status_field = match_data.get("status", {})
+            status_field = match_data.await get("status", {})
             if isinstance(status_field, dict):
                 # FotMob ä½¿ç”¨ 'reason.short' == 'FT' è¡¨ç¤ºå®Œèµ›
-                if status_field.get("finished", False):
+                if status_field.await get("finished", False):
                     status = "FINISHED"
-                elif status_field.get("reason", {}).get("short") == "FT":
+                elif status_field.await await get("reason", {}).get("short") == "FT":
                     status = "FINISHED"
-                elif status_field.get("started", False):
+                elif status_field.await get("started", False):
                     status = "LIVE"
                 else:
                     status = "SCHEDULED"
 
             # æ–¹æ³•2: ä» raw_data.status æå–ï¼ˆå¤‡ç”¨ï¼‰
             if status == "SCHEDULED" and "status" in raw_content:
-                raw_status = raw_content.get("status", {})
+                raw_status = raw_content.await get("status", {})
                 if isinstance(raw_status, dict):
-                    if raw_status.get("finished", False):
+                    if raw_status.await get("finished", False):
                         status = "FINISHED"
-                    elif raw_status.get("reason", {}).get("short") == "FT":
+                    elif raw_status.await await get("reason", {}).get("short") == "FT":
                         status = "FINISHED"
-                    elif raw_status.get("started", False):
+                    elif raw_status.await get("started", False):
                         status = "LIVE"
 
             # è·å–å…³è”çš„ID - ğŸ”„ ä¿®å¤Leagueæ˜ å°„ä¸åŒ¹é…é—®é¢˜
             # ä¼˜å…ˆä½¿ç”¨match_dataä¸­çš„ç»“æ„åŒ–ä¿¡æ¯ï¼Œå›é€€åˆ°raw_dataç¡®ä¿ä¸€è‡´æ€§
-            league_name = match_data.get("league_name", "Unknown League")
+            league_name = match_data.await get("league_name", "Unknown League")
 
             # ğŸ†• ç»Ÿä¸€LeagueæŸ¥æ‰¾é€»è¾‘ï¼Œä¸Leagueåˆ›å»ºæ—¶ä¿æŒä¸€è‡´
-            raw_content = match_data.get("raw_data", {})
+            raw_content = match_data.await get("raw_data", {})
             if "competition" in raw_content:
                 comp = raw_content["competition"]
-                league_country_lookup = comp.get("area", {}).get(
+                league_country_lookup = comp.await await get("area", {}).get(
                     "name", "Unknown Country"
                 )
             else:
@@ -420,13 +420,13 @@                 "league_country", league_country_lookup
             )
 
-            home_team_name = match_data.get("home_team_name", "Unknown Team")
-            away_team_name = match_data.get("away_team_name", "Unknown Team")
+            home_team_name = match_data.await get("home_team_name", "Unknown Team")
+            away_team_name = match_data.await get("away_team_name", "Unknown Team")
 
             # ğŸ†• ä½¿ç”¨ç»Ÿä¸€æŸ¥æ‰¾é€»è¾‘
-            league_id = leagues_map.get((league_name, league_country_lookup))
-            home_team_id = teams_map.get(home_team_name)
-            away_team_id = teams_map.get(away_team_name)
+            league_id = leagues_map.await get((league_name, league_country_lookup))
+            home_team_id = teams_map.await get(home_team_name)
+            away_team_id = teams_map.await get(away_team_name)
 
             # ğŸ†• æ·»åŠ è¯¦ç»†è°ƒè¯•ä¿¡æ¯
             logger.info("ğŸ” æ¯”èµ›æ•°æ®æ£€æŸ¥:")
@@ -447,7 +447,7 @@                 continue
 
             # å¤„ç†æ—¶é—´
-            match_time_str = match_data.get("match_time")
+            match_time_str = match_data.await get("match_time")
             match_date = None
             if match_time_str and isinstance(match_time_str, str):
                 try:
@@ -469,17 +469,17 @@ 
             # æ–¹æ³•1: ä» raw_data.home.score å’Œ raw_data.away.score æå–
             if "home" in raw_content and "away" in raw_content:
-                home_info = raw_content.get("home", {})
-                away_info = raw_content.get("away", {})
+                home_info = raw_content.await get("home", {})
+                away_info = raw_content.await get("away", {})
 
                 if "score" in home_info and "score" in away_info:
-                    home_score = home_info.get("score")
-                    away_score = away_info.get("score")
+                    home_score = home_info.await get("score")
+                    away_score = away_info.await get("score")
 
             # æ–¹æ³•2: ä» status.scoreStr è§£ææ¯”åˆ†
             if home_score is None or away_score is None:
-                status_info = match_data.get("status", {})
-                score_str = status_info.get("scoreStr", "")
+                status_info = match_data.await get("status", {})
+                score_str = status_info.await get("scoreStr", "")
 
                 if score_str and " - " in score_str:
                     try:
@@ -494,9 +494,9 @@ 
             # æ–¹æ³•3: å›é€€åˆ°åŸå§‹é€»è¾‘ï¼ˆå…¼å®¹æ€§ï¼‰
             if home_score is None:
-                home_score = raw_content.get("homeScore", 0)
+                home_score = raw_content.await get("homeScore", 0)
             if away_score is None:
-                away_score = raw_content.get("awayScore", 0)
+                away_score = raw_content.await get("awayScore", 0)
 
             # åˆ›å»ºMatchå¯¹è±¡
             new_match = Match(
@@ -505,8 +505,8 @@                 league_id=league_id,
                 status=status,
                 match_date=match_date,
-                season=str(match_data.get("season", "2024")),
-                venue=raw_content.get("venue", "Unknown Venue"),
+                season=await str(match_data.get("season", "2024")),
+                venue=raw_content.await get("venue", "Unknown Venue"),
                 home_score=home_score,
                 away_score=away_score,
                 created_at=datetime.utcnow(),
@@ -526,7 +526,7 @@ 
         # ğŸ†• è·å–æ’å…¥å‰çš„å½“å‰æœ€å¤§IDï¼Œç”¨äºè®¡ç®—æ–°æ’å…¥çš„ID
         max_id_query = text("SELECT COALESCE(MAX(id), 0) FROM matches")
-        max_id_result = await session.execute(max_id_query)
+        max_id_result = await session.await execute(max_id_query)
         max_id = max_id_result.scalar()
 
         # æ‰¹é‡æ’å…¥æ¯”èµ›
@@ -545,7 +545,7 @@                 .where(RawMatchData.id.in_(raw_match_ids_to_update))
                 .values(processed=True, updated_at=datetime.utcnow())
             )
-            await session.execute(update_stmt)
+            await session.await execute(update_stmt)
 
         cleaned_count = len(matches_to_create)
         logger.info(
@@ -559,7 +559,7 @@ 
 
 @shared_task(bind=True, name="data_cleaning_task")
-def data_cleaning_task(self, collection_result: dict[str, Any]) -> dict[str, Any]:
+async def data_cleaning_task(self, collection_result: dict[str, Any]) -> dict[str, Any]:
     """æ•°æ®æ¸…æ´—ä»»åŠ¡ - ä½¿ç”¨é«˜æ€§èƒ½æ‰¹é‡æ“ä½œ (å¢å¼ºç‰ˆï¼šè¿”å›æ–°æ¯”èµ›IDåˆ—è¡¨).
 
     Args:
@@ -576,9 +576,9 @@ 
         # ä¿®å¤å­—æ®µæ˜ å°„ï¼šé‡‡é›†ä»»åŠ¡è¿”å›çš„æ˜¯ total_collected æˆ– records_collected
         collected_records = (
-            collection_result.get("records_collected")
-            or collection_result.get("total_collected")
-            or collection_result.get("collected_records", 0)
+            collection_result.await get("records_collected")
+            or collection_result.await get("total_collected")
+            or collection_result.await get("collected_records", 0)
         )
 
         logger.info(f"ğŸ“Š é‡‡é›†åˆ°çš„åŸå§‹æ•°æ®è®°å½•æ•°: {collected_records}")
@@ -617,7 +617,7 @@                     import asyncio
 
                     clean_result = asyncio.run(clean_data())
-                    cleaned_count = clean_result.get("cleaned_records", 0)
+                    cleaned_count = clean_result.await get("cleaned_records", 0)
                     logger.info(
                         f"âœ… FootballDataCleaneræ¸…æ´—å®Œæˆï¼Œæ¸…æ´—è®°å½•æ•°: {cleaned_count}"
                     )
@@ -660,7 +660,7 @@ 
 
 @shared_task(bind=True, name="feature_engineering_task")
-def feature_engineering_task(self, cleaning_result: dict[str, Any]) -> dict[str, Any]:
+async def feature_engineering_task(self, cleaning_result: dict[str, Any]) -> dict[str, Any]:
     """ç‰¹å¾å·¥ç¨‹ä»»åŠ¡ï¼ˆå¢å¼ºç‰ˆï¼šå¢é‡æ›´æ–°ï¼Œåªä¸ºæ–°æ¯”èµ›ç”Ÿæˆç‰¹å¾ï¼‰.
 
     Args:
@@ -676,7 +676,7 @@         ensure_database_initialized()
 
         # ğŸ”¥ æ ¸å¿ƒæ”¹åŠ¨ï¼šè·å–æ–°å¤„ç†çš„æ¯”èµ›IDåˆ—è¡¨
-        new_match_ids = cleaning_result.get("new_match_ids", [])
+        new_match_ids = cleaning_result.await get("new_match_ids", [])
 
         if not new_match_ids:
             logger.info("ğŸ“ æ²¡æœ‰æ–°æ¯”èµ›éœ€è¦ç”Ÿæˆç‰¹å¾ï¼Œè·³è¿‡ç‰¹å¾å·¥ç¨‹")
@@ -733,8 +733,8 @@                 calculate_features_for_new_matches(new_match_ids)
             )
 
-            features_calculated = feature_task_result.get("calculated_features", 0)
-            failed_calculations = feature_task_result.get("failed_calculations", 0)
+            features_calculated = feature_task_result.await get("calculated_features", 0)
+            failed_calculations = feature_task_result.await get("failed_calculations", 0)
 
             logger.info(
                 f"âœ… å¢é‡ç‰¹å¾è®¡ç®—å®Œæˆ: æˆåŠŸ {features_calculated}ï¼Œå¤±è´¥ {failed_calculations}"
@@ -800,7 +800,7 @@ 
 
 @shared_task(bind=True, name="data_storage_task")
-def data_storage_task(self, feature_result: dict[str, Any]) -> dict[str, Any]:
+async def data_storage_task(self, feature_result: dict[str, Any]) -> dict[str, Any]:
     """æ•°æ®å­˜å‚¨ä»»åŠ¡.
 
     Args:
@@ -816,7 +816,7 @@         ensure_database_initialized()
 
         # è¿™é‡Œå®ç°ç‰¹å¾æ•°æ®åˆ°æ•°æ®åº“çš„å­˜å‚¨
-        stored_features = feature_result.get("features_calculated", 0)
+        stored_features = feature_result.await get("features_calculated", 0)
 
         storage_result = {
             "status": "success",
@@ -837,7 +837,7 @@         }
 
 
-def ensure_database_initialized():
+async def ensure_database_initialized():
     """ç¡®ä¿æ•°æ®åº“ç®¡ç†å™¨å·²åˆå§‹åŒ–."""
     try:
         from src.database.connection import DatabaseManager
@@ -869,7 +869,7 @@ 
 
 @shared_task(bind=True, name="complete_data_pipeline")
-def complete_data_pipeline(self) -> dict[str, Any]:
+async def complete_data_pipeline(self) -> dict[str, Any]:
     """å®Œæ•´çš„æ•°æ®ç®¡é“ä»»åŠ¡ - å‡çº§è‡³FotMobæ•°æ®æº.
 
     æŒ‰é¡ºåºæ‰§è¡Œï¼šFotMobæ•°æ®é‡‡é›† -> æ‰¹é‡æ•°æ®æ¸…æ´— -> ç‰¹å¾å·¥ç¨‹ -> æ•°æ®å­˜å‚¨
@@ -920,7 +920,7 @@ 
 
 @shared_task(bind=True, name="trigger_feature_calculation_for_new_matches")
-def trigger_feature_calculation_for_new_matches(self, match_ids: list) -> dict:
+async def trigger_feature_calculation_for_new_matches(self, match_ids: list) -> dict:
     """ä¸ºæ–°é‡‡é›†çš„æ¯”èµ›è§¦å‘ç‰¹å¾è®¡ç®—.
 
     Args:
@@ -945,7 +945,7 @@         async def calculate_features_for_match(match_id: int) -> bool:
             """ä¸ºå•åœºæ¯”èµ›è®¡ç®—ç‰¹å¾çš„å¼‚æ­¥å‡½æ•°"""
             try:
-                async with db_manager.get_async_session() as session:
+                async with db_manager.await get_async_session() as session:
                     feature_service = FeatureService(session)
 
                     # è®¡ç®—ç‰¹å¾
@@ -996,13 +996,13 @@ 
 
 # å›è°ƒå‡½æ•°ï¼šæ•°æ®é‡‡é›†å®Œæˆåè‡ªåŠ¨è§¦å‘ç‰¹å¾è®¡ç®—
-def on_collection_success(task_result, task_id, args, kwargs):
+async def on_collection_success(task_result, task_id, args, kwargs):
     """æ•°æ®é‡‡é›†æˆåŠŸåçš„å›è°ƒå‡½æ•°."""
     try:
         logger.info(f"æ•°æ®é‡‡é›†ä»»åŠ¡ {task_id} æˆåŠŸå®Œæˆï¼Œè§¦å‘ç‰¹å¾è®¡ç®—")
 
         # ä»é‡‡é›†ç»“æœä¸­æå–æ–°æ¯”èµ›çš„match_ids
-        collected_match_ids = task_result.get("new_match_ids", [])
+        collected_match_ids = task_result.await get("new_match_ids", [])
 
         if collected_match_ids:
             # å¼‚æ­¥è§¦å‘ç‰¹å¾è®¡ç®—ä»»åŠ¡
