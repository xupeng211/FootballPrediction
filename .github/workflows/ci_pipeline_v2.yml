---
name: CI Pipeline v2 - Clean Architecture

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual CI trigger'

env:
  NODE_VERSION: '18'
  # ç§»é™¤å…¨å±€SQLiteé…ç½®ï¼Œä½¿ç”¨æµ‹è¯•ç¯å¢ƒçš„PostgreSQLé…ç½®

jobs:
  test:
    name: ğŸ§ª Test Matrix
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']  # V4.0: æ¢å¤å…¨é‡Pythonç‰ˆæœ¬çŸ©é˜µ

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_football_prediction
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools
          pip install -r requirements-ci.txt
          sudo apt-get update && sudo apt-get install -y bc

      - name: Set up test environment
        run: |
          cat > .env.test << EOF
          DATABASE_URL=postgresql://postgres:postgres@localhost:5432/test_football_prediction
          REDIS_URL=redis://localhost:6379/0
          ENV=testing
          DEBUG=false
          LOG_LEVEL=WARNING
          PYTHONPATH=$PWD:$PYTHONPATH
          CI=true
          PYTEST_CURRENT_TEST=1
          TESTING=true
          FOOTBALL_PREDICTION_ML_MODE=mock
          INFERENCE_SERVICE_MOCK=true
          SKIP_ML_MODEL_LOADING=true
          XGBOOST_MOCK=true
          JOBLIB_MOCK=true
          EOF
          # V4.0: ML Mockç¯å¢ƒå˜é‡ - å¼ºåˆ¶ä½¿ç”¨Mockæ¨¡å¼é¿å…MLä¾èµ–å†…å­˜é—®é¢˜
          export $(cat .env.test | xargs)
          echo "âœ… æµ‹è¯•ç¯å¢ƒå·²è®¾ç½®"

      - name: Create dummy data files
        run: |
          echo "ğŸ“ åˆ›å»ºæµ‹è¯•æ‰€éœ€çš„æ•°æ®æ–‡ä»¶..."
          mkdir -p data logs

          # åˆ›å»º dataset_v1.csv ç¤ºä¾‹æ•°æ®
          cat > data/dataset_v1.csv << 'EOF'
          date,home_team,away_team,home_score,away_score,result
          2024-01-01,Manchester United,Liverpool,2,1,H
          2024-01-02,Arsenal,Chelsea,1,1,D
          2024-01-03,Manchester City,Tottenham,3,0,H
          2024-01-04,Newcastle,Everton,1,2,A
          2024-01-05,Leicester,West Ham,2,2,D
          EOF

          # åˆ›å»ºå¿…è¦çš„æ—¥å¿—æ–‡ä»¶é¿å…æµ‹è¯•å¤±è´¥
          touch logs/enhanced_ev_test.log

          echo "âœ… æ•°æ®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
          echo "ğŸ“Š dataset_v1.csv: $(wc -l < data/dataset_v1.csv) è¡Œ"
          ls -la data/ logs/

      - name: Run Linting
        run: |
          echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
          export $(cat .env.test | xargs)
          if command -v ruff &> /dev/null; then
            ruff check src/ tests/ --output-format=github
          fi

      - name: Run Security Check
        run: |
          echo "ğŸ›¡ï¸ è¿è¡Œå®‰å…¨æ‰«æ..."
          export $(cat .env.test | xargs)
          if command -v bandit &> /dev/null; then
            bandit -r src/ -f json -o bandit-report.json || true
            echo "ğŸ›¡ï¸ å®‰å…¨æ‰«æå®Œæˆï¼ŒæŠ¥å‘Šå·²ç”Ÿæˆ"
          fi

      - name: Test API (Step 1) ğŸ¯
        run: |
          echo "ğŸ§ª Step 1: æµ‹è¯• API æ¨¡å—..."
          export $(cat .env.test | xargs)
          export MALLOC_ARENA_MAX=2
          export PYTHONPATH=$PWD:$PYTHONPATH
          timeout 120s python -m pytest tests/unit/api/ -vv --timeout=30 --tb=short || exit 1
          echo "âœ… Step 1: API æµ‹è¯•å®Œæˆ!"

      - name: Test Utils (Step 2) ğŸ”§ [V14.0 åå‘æµ‹è¯•]
        run: |
          echo "ğŸ§ª Step 2: V14.0 åå‘æµ‹è¯• - ä¸“é—¨æµ‹è¯•html/regexï¼Œæ’é™¤å·²å®‰å…¨çš„slug/clean/strip"
          export $(cat .env.test | xargs)
          export MALLOC_ARENA_MAX=2
          export PYTHONPATH=$PWD:$PYTHONPATH
          # V14.0 åå‘æµ‹è¯•ï¼šGroup B - ä¸“é—¨æµ‹è¯•html/regexï¼Œæ’é™¤å·²è¯æ˜å®‰å…¨çš„slug/clean/strip
          timeout 300s python -m pytest \
            tests/unit/utils/test_formatters.py \
            tests/unit/utils/test_dict_utils.py \
            tests/unit/utils/test_helpers.py \
            tests/unit/utils/test_simple_utils.py \
            tests/unit/utils/test_time_utils.py \
            tests/unit/utils/test_validators.py \
            tests/unit/utils/test_working_validators.py \
            tests/unit/utils/test_warning_filters_init.py \
            tests/unit/utils/test_warning_filters_error_path.py \
            tests/unit/utils/test_string_utils.py -k "html or regex" \
            -vv --timeout=90 --tb=short || exit 1
          echo "âœ… Step 2: V14.0 Group Bæµ‹è¯•å®Œæˆ! (ä¸“é—¨æµ‹è¯•html/regexï¼Œå·²æ’é™¤å®‰å…¨å‡½æ•°)"

      - name: Test Cache (Step 3) ğŸ’¾
        run: |
          echo "ğŸ§ª Step 3: æµ‹è¯• Cache æ¨¡å—..."
          export $(cat .env.test | xargs)
          export MALLOC_ARENA_MAX=2
          export PYTHONPATH=$PWD:$PYTHONPATH
          timeout 120s python -m pytest tests/unit/cache/ -vv --timeout=30 --tb=short || exit 1
          echo "âœ… Step 3: Cache æµ‹è¯•å®Œæˆ!"

      - name: Test Events (Step 4) ğŸš€
        run: |
          echo "ğŸ§ª Step 4: æµ‹è¯• Events æ¨¡å—..."
          export $(cat .env.test | xargs)
          export MALLOC_ARENA_MAX=2
          export PYTHONPATH=$PWD:$PYTHONPATH
          timeout 120s python -m pytest tests/unit/events/ -vv --timeout=30 --tb=short || exit 1
          echo "âœ… Step 4: Events æµ‹è¯•å®Œæˆ!"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-py${{ matrix.python-version }}
          path: |
            test-results.xml
            bandit-report.json
          retention-days: 7

  quality-summary:
    name: ğŸ“Š Quality Summary
    runs-on: ubuntu-22.04
    needs: test
    if: always()

    steps:
      - name: Quality Summary
        run: |
          echo "ğŸ“Š CI Pipeline v2 è´¨é‡æ±‡æ€»æŠ¥å‘Š"
          echo "================================"
          TEST_STATUS="${{ needs.test.result }}"
          echo "ğŸ§ª æµ‹è¯•çŸ©é˜µ: $TEST_STATUS"

          if [ "$TEST_STATUS" = "success" ]; then
            echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡!"
            echo "ğŸš€ Pipeline v2 éƒ¨ç½²å°±ç»ª"
          else
            echo "âš ï¸ æµ‹è¯•æœªé€šè¿‡"
            echo "ğŸ”§ è¯·æŸ¥çœ‹å…·ä½“æµ‹è¯•æ—¥å¿—"
          fi

          echo "ğŸ‰ CI Pipeline v2 - ç»ˆæç‰ˆæœ¬!"