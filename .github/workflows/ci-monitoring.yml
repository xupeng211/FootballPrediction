name: CI/CD Monitoring

on:
  schedule:
    # æ¯å¤©UTC 00:00è¿è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
  workflow_run:
    workflows: ["Optimized CI Pipeline"]
    types: [completed]

jobs:
  ci-performance-monitor:
    name: CI Performance Monitor
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install requests pandas numpy matplotlib
        pip install -r requirements/requirements.lock

    - name: Run CI monitoring analysis
      run: |
        python3 scripts/ci_cd_monitor_optimizer.py           --analyze-performance           --generate-report           --output-reports

    - name: Upload monitoring reports
      uses: actions/upload-artifact@v3
      with:
        name: ci-monitoring-reports
        path: reports/ci_cd_monitoring/
        retention-days: 90

    - name: Check for performance degradation
      id: performance-check
      run: |
        # æ£€æŸ¥æ€§èƒ½æ˜¯å¦æœ‰æ˜¾è‘—ä¸‹é™
        python3 -c "
        import json
        import sys
        from pathlib import Path

        # æŸ¥æ‰¾æœ€æ–°çš„ç›‘æ§æŠ¥å‘Š
        reports_dir = Path('reports/ci_cd_monitoring')
        if reports_dir.exists():
            reports = list(reports_dir.glob('ci_monitoring_report_*.json'))
            if reports:
                latest_report = sorted(reports)[-1]
                with open(latest_report) as f:
                    data = json.load(f)

                # æ£€æŸ¥å…³é”®æŒ‡æ ‡
                if data.get('overall_status') == 'critical':
                    print('ğŸš¨ æ£€æµ‹åˆ°ä¸¥é‡çš„CIæ€§èƒ½é—®é¢˜')
                    sys.exit(1)
                elif data.get('warning_checks', 0) > 3:
                    print('âš ï¸ æ£€æµ‹åˆ°å¤šä¸ªCIæ€§èƒ½è­¦å‘Š')
                    sys.exit(2)
                else:
                    print('âœ… CIæ€§èƒ½æ­£å¸¸')
                    sys.exit(0)
        "

    - name: Create performance alert
      if: failure() && steps.performance-check.outcome == 'failure'
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ CI/CDæ€§èƒ½å‘Šè­¦',
            body: `
            æ£€æµ‹åˆ°CI/CDæµæ°´çº¿æ€§èƒ½é—®é¢˜

            **æ—¶é—´**: ${new Date().toISOString()}
            **å·¥ä½œæµ**: ${context.workflow}
            **è¿è¡ŒID**: ${context.runId}

            è¯·æŸ¥çœ‹[è¯¦ç»†æŠ¥å‘Š](${context.serverUrl}/${context.repository}/actions/runs/${context.runId})å¹¶é‡‡å–ç›¸åº”æªæ–½ã€‚
            `,
            labels: ['ci-cd', 'monitoring', 'alert', 'high-priority']
          });

  # è´¨é‡è¶‹åŠ¿åˆ†æ
  quality-trends:
    name: Quality Trends Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Analyze quality trends
      run: |
        echo "ğŸ“ˆ åˆ†æè´¨é‡è¶‹åŠ¿..."
        # è¿™é‡Œå¯ä»¥é›†æˆå†å²æ•°æ®åˆ†æ
        echo "è´¨é‡è¶‹åŠ¿åˆ†æå®Œæˆ"

    - name: Update quality badge
      run: |
        echo "ğŸ… æ›´æ–°è´¨é‡å¾½ç« ..."
        # æ›´æ–°READMEä¸­çš„è´¨é‡å¾½ç« 
