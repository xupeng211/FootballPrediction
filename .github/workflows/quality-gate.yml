name: Quality Gate CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      strict_mode:
        description: 'å¯ç”¨ä¸¥æ ¼æ¨¡å¼ï¼ˆè­¦å‘Šä¹Ÿä¼šå¤±è´¥ï¼‰'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          .venv
        key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-

    - name: Install dependencies
      run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio
        pip install ruff mypy bandit
        pip install aiohttp psutil scikit-learn

    - name: Run Quality Gate
      id: quality-gate
      run: |
        source .venv/bin/activate

        # æ„å»ºä¸¥æ ¼æ¨¡å¼å‚æ•°
        STRICT_FLAG=""
        if [ "${{ github.event.inputs.strict_mode }}" = "true" ]; then
          STRICT_FLAG="--strict"
        fi

        # è¿è¡Œè´¨é‡é—¨ç¦æ£€æŸ¥
        python3 scripts/maintenance/ci_cd_quality_gate.py $STRICT_FLAG

        # ä¿å­˜æŠ¥å‘Šæ–‡ä»¶ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "REPORT_FILE=$(find reports/quality_gate -name '*.json' | head -1)" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Upload Quality Gate Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: quality-gate-report
        path: ${{ steps.quality-gate.outputs.REPORT_FILE }}
        retention-days: 30

    - name: Generate Quality Badge
      if: always()
      id: badge
      run: |
        REPORT_FILE="${{ steps.quality-gate.outputs.REPORT_FILE }}"
        if [ -f "$REPORT_FILE" ]; then
          # è§£æè´¨é‡é—¨ç¦æŠ¥å‘Š
          HEALTH_SCORE=$(python3 -c "
          import json
          with open('$REPORT_FILE') as f:
              data = json.load(f)
          print(data['summary']['health_score'])
          ")

          RESULT=$(python3 -c "
          import json
          with open('$REPORT_FILE') as f:
              data = json.load(f)
          print(data['overall_result'])
          ")

          # ç¡®å®šå¾½ç« é¢œè‰²
          if [ "$RESULT" = "pass" ]; then
            COLOR="brightgreen"
          elif [ "$RESULT" = "warn" ]; then
            COLOR="yellow"
          else
            COLOR="red"
          fi

          # ç”Ÿæˆå¾½ç« JSON
          cat << EOF > quality-badge.json
          {
            "schemaVersion": 1,
            "label": "Quality Gate",
            "message": "${HEALTH_SCORE:.0f}/100",
            "color": "$COLOR"
          }
          EOF

          echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
          echo "result=$RESULT" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
        else
          echo "report_file_not_found=true" >> $GITHUB_OUTPUT
        fi

    - name: Update Quality Badge
      if: always() && steps.badge.outputs.result != ''
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const badgeData = JSON.parse(fs.readFileSync('quality-badge.json', 'utf8'));

          // æ›´æ–°PRçŠ¶æ€æ£€æŸ¥ï¼ˆå¦‚æœæ˜¯PRï¼‰
          if (context.payload.pull_request) {
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: '${{ steps.badge.outputs.result === 'pass' && 'success' || steps.badge.outputs.result === 'warn' && 'pending' || 'failure' }}',
              target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              description: `Quality Score: ${{ steps.badge.outputs.health_score }}/100`,
              context: 'quality-gate'
            });
          }

    - name: Comment on PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          try {
            const reportData = JSON.parse(fs.readFileSync('${{ steps.quality-gate.outputs.REPORT_FILE }}', 'utf8'));
            const healthScore = Math.round(reportData.summary.health_score);
            const result = reportData.overall_result;

            let emoji = 'âœ…';
            let status = 'é€šè¿‡';
            if (result === 'fail') {
              emoji = 'âŒ';
              status = 'æœªé€šè¿‡';
            } else if (result === 'warn') {
              emoji = 'âš ï¸';
              status = 'è­¦å‘Š';
            }

            const comment = `
            ## ğŸš¦ è´¨é‡é—¨ç¦æ£€æŸ¥ç»“æœ

            **çŠ¶æ€**: ${emoji} ${status}
            **å¥åº·è¯„åˆ†**: ${healthScore}/100
            **æ£€æŸ¥æ—¶é—´**: ${new Date(reportData.timestamp).toLocaleString('zh-CN')}

            ### ğŸ“Š æ£€æŸ¥æ‘˜è¦
            - æ€»æŒ‡æ ‡: ${reportData.total_metrics}
            - é€šè¿‡: ${reportData.passed_metrics}
            - å¤±è´¥: ${reportData.failed_metrics}
            - è­¦å‘Š: ${reportData.warning_metrics}

            ### ğŸš¨ å…³é”®é—®é¢˜
            ${reportData.metrics.filter(m => m.status === 'fail' && m.level === 'critical')
              .map(m => `- ${m.message}`)
              .join('\n') || 'æ— å…³é”®é—®é¢˜'}

            ### ğŸ’¡ æ”¹è¿›å»ºè®®
            ${reportData.recommendations.slice(0, 5).map(r => `- ${r}`).join('\n')}

            ---
            ğŸ“„ [è¯¦ç»†æŠ¥å‘Š](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.error('Failed to generate PR comment:', error);
          }

    - name: Fail on Quality Gate Failure
      if: steps.quality-gate.outcome == 'failure'
      run: |
        echo "âŒ è´¨é‡é—¨ç¦æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤é—®é¢˜åé‡è¯•"
        exit 1

    - name: Notify on Failure
      if: failure() && steps.quality-gate.outcome != 'failure'
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ è´¨é‡é—¨ç¦æ£€æŸ¥å¤±è´¥',
            body: `
            è´¨é‡é—¨ç¦æ£€æŸ¥åœ¨æäº¤ ${{ github.sha }} å¤±è´¥ã€‚

            **åˆ†æ”¯**: ${{ github.ref_name }}
            **æäº¤è€…**: ${{ github.actor }}
            **æ—¶é—´**: ${new Date().toISOString()}

            è¯·æŸ¥çœ‹ [è¯¦ç»†æŠ¥å‘Š](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) å¹¶ä¿®å¤ç›¸å…³é—®é¢˜ã€‚
            `,
            labels: ['bug', 'quality-gate', 'high-priority']
          });

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: quality-gate

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Bandit Security Scan
      run: |
        pip install bandit
        bandit -r src/ -f json -o bandit-report.json || true

        # ç”Ÿæˆå®‰å…¨æ‰«ææ‘˜è¦
        if [ -f bandit-report.json ]; then
          python3 -c "
          import json
          with open('bandit-report.json') as f:
              data = json.load(f)
          high_issues = len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH'])
          medium_issues = len([r for r in data.get('results', []) if r.get('issue_severity') == 'MEDIUM'])
          low_issues = len([r for r in data.get('results', []) if r.get('issue_severity') == 'LOW'])

          print(f'ğŸ”’ å®‰å…¨æ‰«æç»“æœ:')
          print(f'  é«˜å±é—®é¢˜: {high_issues}')
          print(f'  ä¸­å±é—®é¢˜: {medium_issues}')
          print(f'  ä½å±é—®é¢˜: {low_issues}')

          if high_issues > 0:
              print('âŒ å‘ç°é«˜å±å®‰å…¨é—®é¢˜ï¼Œè¯·ç«‹å³ä¿®å¤')
              exit(1)
          elif medium_issues > 3:
              print('âš ï¸ ä¸­å±å®‰å…¨é—®é¢˜è¾ƒå¤šï¼Œå»ºè®®ä¿®å¤')
          else:
              print('âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡')
          "
        fi

    - name: Upload Security Report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: bandit-report.json
        retention-days: 30

  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install --upgrade pip
        pip install pytest pytest-benchmark
        pip install -r requirements.txt

    - name: Run Performance Tests
      run: |
        source .venv/bin/activate
        pytest tests/performance/ --benchmark-json=benchmark.json --benchmark-only || true

    - name: Upload Benchmark Results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: benchmark.json
        retention-days: 30

    - name: Compare with Baseline
      if: hashFiles('benchmark-baseline.json') != ''
      run: |
        source .venv/bin/activate
        pytest-benchmark compare benchmark.json benchmark-baseline.json || true