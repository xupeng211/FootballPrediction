name: ðŸ“§ Smart Notifications and Alerts

on:
  workflow_run:
    workflows: ["ðŸ”„ Enhanced CI/CD Monitoring", "ðŸšª Enhanced Quality Gate", "Enhanced CI Monitoring"]
    types:
      - completed
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'docker-compose*.yml'
  pull_request:
    branches: [main]
    types: [opened, closed, ready_for_review]
  schedule:
    # æ¯æ—¥è´¨é‡æŠ¥å‘Š
    - cron: '0 9 * * *'  # æ¯å¤©9ç‚¹
  workflow_dispatch:
    inputs:
      notification_type:
        description: 'Type of notification'
        required: false
        default: 'quality'
        type: choice
        options:
        - quality
        - performance
        - security
        - deployment

env:
  PYTHON_VERSION: '3.11'

jobs:
  # 1. CI/CDçŠ¶æ€é€šçŸ¥
  ci-cd-notifications:
    name: ðŸ“§ CI/CD Status Notifications
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ðŸ“¦ Install Dependencies
      run: |
        pip install --upgrade pip
        pip install requests pyyaml

    - name: ðŸ” Analyze Workflow Results
      id: analyze-results
      run: |
        # åˆ†æžCI/CDå·¥ä½œæµç»“æžœ
        echo "ðŸ” Analyzing workflow: ${{ github.event.workflow_run.name }}"
        echo "ðŸ” Status: ${{ github.event.workflow_run.conclusion }}"
        echo "ðŸ” Branch: ${{ github.event.workflow_run.head_branch }}"

        # èŽ·å–å·¥ä½œæµè¯¦æƒ…
        curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
             "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" \
             > workflow_details.json

        # åˆ†æžç»“æžœ
        python3 scripts/analyze_workflow_results.py

    - name: ðŸ“§ Send Quality Report
      if: always()
      run: |
        python3 scripts/send_notification.py \
          --type quality \
          --status ${{ job.status }} \
          --workflow ${{ github.event.workflow_run.name }} \
          --data workflow_details.json

    - name: ðŸ“Š Generate Quality Metrics
      if: always()
      run: |
        python3 scripts/generate_quality_metrics.py

  # 2. æ¯æ—¥è´¨é‡æŠ¥å‘Š
  daily-quality-report:
    name: ðŸ“Š Daily Quality Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ðŸ“¦ Install Dependencies
      run: |
        pip install --upgrade pip
        pip install requests pyyaml pandas

    - name: ðŸ“Š Generate Daily Report
      run: |
        python3 scripts/generate_daily_quality_report.py

    - name: ðŸ“§ Send Daily Report
      run: |
        python3 scripts/send_daily_report.py

    - name: ðŸ“¤ Upload Daily Report
      uses: actions/upload-artifact@v4
      with:
        name: daily-quality-report
        path: daily_quality_report_*.md
        retention-days: 7

  # 3. æ€§èƒ½ç›‘æŽ§å‘Šè­¦
  performance-alerts:
    name: âš¡ Performance Monitoring Alerts
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ðŸ“¦ Install Performance Tools
      run: |
        pip install --upgrade pip
        pip install requests pyyaml radon bandit

    - name: ðŸ“Š Performance Analysis
      run: |
        # åˆ›å»ºæ¨¡æ‹Ÿæ€§èƒ½æ•°æ®æ–‡ä»¶
        cat > performance_data.json << EOF
        {
          "execution_time": 45.2,
          "memory_usage": 128.5,
          "cpu_usage": 15.3,
          "test_count": 156,
          "pass_rate": 98.7
        }
        EOF

        python3 scripts/performance_analysis.py --data-file performance_data.json --output performance_report.md

    - name: ðŸš¨ Check Performance Thresholds
      run: |
        python3 scripts/check_performance_thresholds.py

    - name: ðŸ“§ Send Performance Alerts
      if: failure()
      run: |
        python3 scripts/send_performance_alerts.py

  # 4. å®‰å…¨æ¼æ´žå‘Šè­¦
  security-alerts:
    name: ðŸ›¡ï¸ Security Vulnerability Alerts
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule'

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ðŸ“¦ Install Security Tools
      run: |
        pip install --upgrade pip
        pip install bandit safety pip-audit requests

    - name: ðŸ›¡ï¸ Security Scan
      run: |
        # Banditå®‰å…¨æ‰«æ
        bandit -r src/ -f json -o bandit-report.json || true

        # Safetyä¾èµ–æ‰«æ
        safety check --json --output safety-report.json || true

        # pip-auditä¾èµ–å®¡è®¡
        pip-audit --format=json --output audit-report.json || true

    - name: ðŸš¨ Analyze Security Issues
      run: |
        # ç¡®ä¿æ‰«ææŠ¥å‘Šæ–‡ä»¶å­˜åœ¨
        if [ ! -f bandit-report.json ]; then
          echo '{"results": [], "metrics": {"vulnerabilities": {"high": 0, "medium": 0, "low": 0}}}' > bandit-report.json
        fi

        if [ ! -f safety-report.json ]; then
          echo '{"vulnerabilities": [], "metrics": {"vulnerabilities": 0}}' > safety-report.json
        fi

        python3 scripts/analyze_security_issues.py --bandit-file bandit-report.json --safety-file safety-report.json --output security_analysis.md

    - name: ðŸ“§ Send Security Alerts
      if: failure()
      run: |
        python3 scripts/send_security_alerts.py

    - name: ðŸ“¤ Upload Security Reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          audit-report.json
        retention-days: 30

  # 5. PRçŠ¶æ€é€šçŸ¥
  pr-notifications:
    name: ðŸ”” PR Status Notifications
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: ðŸ”” PR Opened Notification
      if: github.event.action == 'opened'
      run: |
        echo "ðŸ“§ PR Opened: #${{ github.event.number }} - ${{ github.event.pull_request.title }}"

    - name: ðŸ”” PR Ready for Review
      if: github.event.action == 'ready_for_review'
      run: |
        echo "ðŸ“§ PR Ready for Review: #${{ github.event.number }}"

    - name: ðŸ”” PR Closed Notification
      if: github.event.action == 'closed'
      run: |
        if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
          echo "ðŸŽ‰ PR Merged: #${{ github.event.number }}"
        else
          echo "ðŸ“ PR Closed (not merged): #${{ github.event.number }}"
        fi

  # 6. éƒ¨ç½²çŠ¶æ€é€šçŸ¥
  deployment-notifications:
    name: ðŸš€ Deployment Status Notifications
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸš€ Deployment Started
      run: |
        echo "ðŸš€ Deployment started for commit: ${{ github.sha }}"

    - name: ðŸ“§ Deployment Notification
      run: |
        python3 scripts/deployment_notification.py \
          --commit ${{ github.sha }} \
          --branch ${{ github.ref_name }} \
          --status started

    - name: âœ… Deployment Success
      if: success()
      run: |
        python3 scripts/deployment_notification.py \
          --commit ${{ github.sha }} \
          --branch ${{ github.ref_name }} \
          --status success

    - name: âŒ Deployment Failed
      if: failure()
      run: |
        python3 scripts/deployment_notification.py \
          --commit ${{ github.sha }} \
          --branch ${{ github.ref_name }} \
          --status failed

  # 7. æ™ºèƒ½å‘Šè­¦æ±‡æ€»
  alert-summary:
    name: ðŸ“Š Alert Summary
    runs-on: ubuntu-latest
    needs: [ci-cd-notifications, performance-alerts, security-alerts]
    if: always()

    steps:
    - name: ðŸ“Š Generate Alert Summary
      run: |
        echo "ðŸ“Š Generating alert summary..."

        # æ”¶é›†æ‰€æœ‰å‘Šè­¦ä¿¡æ¯
        ci_status="${{ needs.ci-cd-notifications.result }}"
        perf_status="${{ needs.performance-alerts.result }}"
        security_status="${{ needs.security-alerts.result }}"

        cat > alert_summary.md << EOF
        # ðŸ“Š Alert Summary Report

        **Generated**: $(date '+%Y-%m-%d %H:%M:%S')
        **Commit**: ${{ github.sha }}

        ## ðŸ“‹ Alert Status

        - **CI/CD**: $ci_status
        - **Performance**: $perf_status
        - **Security**: $security_status

        ## ðŸš¨ Critical Issues

        $(if [ "$ci_status" = "failure" ]; then echo "- âŒ CI/CD pipeline failed"; fi)
        $(if [ "$perf_status" = "failure" ]; then echo "- âš¡ Performance issues detected"; fi)
        $(if [ "$security_status" = "failure" ]; then echo "- ðŸ›¡ï¸ Security vulnerabilities found"; fi)

        ## ðŸ“ˆ Metrics

        - Total alerts: $(( $(if [ "$ci_status" = "failure" ]; then echo 1; else echo 0; fi) + $(if [ "$perf_status" = "failure" ]; then echo 1; else echo 0; fi) + $(if [ "$security_status" = "failure" ]; then echo 1; else echo 0; fi) ))
        - Success rate: $(( (3 - $(if [ "$ci_status" = "failure" ]; then echo 1; else echo 0; fi) - $(if [ "$perf_status" = "failure" ]; then echo 1; else echo 0; fi) - $(if [ "$security_status" = "failure" ]; then echo 1; else echo 0; fi)) * 100 / 3 ))%

        ---
        *Generated by Smart Notifications System*
        EOF

    - name: ðŸ“§ Send Alert Summary
      run: |
        python3 scripts/send_alert_summary.py --input alert_summary.md --output alert_notification.md

    - name: ðŸ“¤ Upload Alert Summary
      uses: actions/upload-artifact@v4
      with:
        name: alert-summary
        path: alert_summary.md
        retention-days: 7