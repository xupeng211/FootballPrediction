name: Issueæ ‡ç­¾ç®¡ç†

on:
  # æ¯å‘¨æ—¥æ™šä¸Šæ‰§è¡Œæ ‡ç­¾æ£€æŸ¥
  schedule:
    - cron: '0 20 * * 0'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡Œæ“ä½œ'
        required: true
        default: 'check'
        type: choice
        options:
        - check
        - fix
        - report
      dry_run:
        description: 'è¯•è¿è¡Œæ¨¡å¼'
        required: false
        default: true
        type: boolean

  # å½“åˆ›å»ºæˆ–æ›´æ–°Issueæ—¶è§¦å‘æ ‡ç­¾æ£€æŸ¥
  issues:
    types: [opened, edited, closed]

jobs:
  label-management:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: åˆ›å»ºæŠ¥å‘Šç›®å½•
        run: |
          mkdir -p reports

      - name: è¿è¡Œæ ‡ç­¾ä¸€è‡´æ€§æ£€æŸ¥
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ·ï¸ å¼€å§‹æ ‡ç­¾ç®¡ç†æ£€æŸ¥..."

          # æ ¹æ®è¾“å…¥å‚æ•°å†³å®šæ“ä½œç±»å‹
          ACTION="${{ github.event.inputs.action || 'check' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"

          if [ "$ACTION" = "check" ]; then
            echo "ğŸ” æ£€æŸ¥æ ‡ç­¾ä¸€è‡´æ€§..."
            python scripts/check_label_consistency.py --repo ${{ github.repository }} --output reports/label_consistency_report.md
          elif [ "$ACTION" = "fix" ] && [ "$DRY_RUN" = "false" ]; then
            echo "ğŸ”§ ä¿®å¤æ ‡ç­¾é—®é¢˜..."
            python scripts/fix_label_issues.py --repo ${{ github.repository }} --execute
          elif [ "$ACTION" = "report" ]; then
            echo "ğŸ“Š ç”Ÿæˆæ ‡ç­¾ä½¿ç”¨æŠ¥å‘Š..."
            python scripts/generate_label_usage_report.py --repo ${{ github.repository }}
          else
            echo "ğŸ” è¯•è¿è¡Œæ¨¡å¼ - ä»…ç”ŸæˆæŠ¥å‘Š"
            python scripts/fix_label_issues.py --repo ${{ github.repository }} --dry-run
          fi

      - name: éªŒè¯æ ‡ç­¾è§„èŒƒ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“‹ éªŒè¯æ ‡ç­¾æ˜¯å¦ç¬¦åˆè§„èŒƒ..."
          python scripts/validate_label_standards.py --repo ${{ github.repository }} --config docs/github_issues_guidelines.md

      - name: ä¸Šä¼ æ ‡ç­¾ç®¡ç†æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: label-management-reports-${{ github.run_number }}
          path: |
            reports/label_consistency_report.md
            reports/label_usage_report_*.md
            reports/label_validation_report.md
          retention-days: 30

      - name: åˆ›å»ºæ ‡ç­¾é—®é¢˜Issue
        if: failure() && github.event_name != 'issues'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            try {
              const consistencyReport = fs.readFileSync('reports/label_consistency_report.md', 'utf8');

              const issueBody = `
## ğŸ·ï¸ Issueæ ‡ç­¾ç®¡ç†å‘ç°é—®é¢˜

**æ‰§è¡Œæ—¶é—´**: ${new Date().toISOString()}
**å·¥ä½œæµè¿è¡Œ**: #${{ github.run_number }}
**ä»“åº“**: ${{ github.repository }}

### ğŸ“‹ æ ‡ç­¾ä¸€è‡´æ€§æŠ¥å‘Š
${consistencyReport}

### ğŸ”§ éœ€è¦å¤„ç†çš„é—®é¢˜
è¯·æ£€æŸ¥å¹¶ä¿®å¤æ ‡ç­¾ä½¿ç”¨ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

### ğŸ“š å‚è€ƒèµ„æ–™
- [GitHub Issuesç®¡ç†æŒ‡å—](docs/github_issues_guidelines.md)

---
*æ­¤Issueç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*
              `;

              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ·ï¸ Issueæ ‡ç­¾ç®¡ç†å‘ç°é—®é¢˜ - éœ€è¦ä¿®å¤',
                body: issueBody,
                labels: ['maintenance', 'automated', 'priority/low']
              });

            } catch (error) {
              console.log('æ— æ³•è¯»å–æŠ¥å‘Šæ–‡ä»¶:', error.message);
            }

  # è‡ªåŠ¨ä¸ºæ–°åˆ›å»ºçš„Issueæ·»åŠ åŸºç¡€æ ‡ç­¾
  auto-label-new-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    if: github.event_name == 'issues' && github.event.action == 'opened'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: è‡ªåŠ¨æ·»åŠ åŸºç¡€æ ‡ç­¾
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ·ï¸ ä¸ºæ–°Issue #${{ github.event.issue.number }}æ·»åŠ åŸºç¡€æ ‡ç­¾..."

          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"

          # åˆ†æIssueæ ‡é¢˜å’Œå†…å®¹ï¼Œè‡ªåŠ¨æ·»åŠ åˆé€‚çš„æ ‡ç­¾
          python scripts/auto_label_issues.py \
            --issue-number "$ISSUE_NUMBER" \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --repo ${{ github.repository }}