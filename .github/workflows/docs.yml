name: ðŸ“š Documentation CI/CD

on:
  push:
    branches: [main, develop, docs/**]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to GitHub Pages'
        required: false
        default: false
        type: boolean
      environment:
        description: 'Target environment'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# å–æ¶ˆå¹¶è¡Œçš„è¿è¡Œï¼Œé¿å…èµ„æºæµªè´¹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===== é˜¶æ®µ 1: æ–‡æ¡£æ£€æŸ¥ =====
  docs-check:
    name: ðŸ” æ–‡æ¡£å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4.1.6
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽgitä¿¡æ¯

      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4.7.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material
          pip install -r requirements/requirements.lock

      - name: ðŸ” æ£€æŸ¥æ–‡æ¡£å¥åº·çŠ¶æ€
        run: |
          echo "ðŸ“‹ æ£€æŸ¥æ–‡æ¡£ç›®å½•ç»“æž„..."
          if [ ! -d "docs" ]; then
            echo "âŒ docs/ ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          echo "ðŸ“„ ç»Ÿè®¡æ–‡æ¡£æ–‡ä»¶..."
          MD_FILES=$(find docs -name "*.md" | wc -l)
          echo "âœ… å‘çŽ° $MD_FILES ä¸ªMarkdownæ–‡ä»¶"

          if [ ! -f "mkdocs.yml" ]; then
            echo "âŒ mkdocs.yml é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

          echo "âœ… åŸºç¡€æ£€æŸ¥é€šè¿‡"

      - name: ðŸ§ª éªŒè¯MkDocsé…ç½®
        run: |
          echo "ðŸ”§ éªŒè¯MkDocsé…ç½®..."
          mkdocs --version

          # æ£€æŸ¥é…ç½®è¯­æ³•
          python -c "import yaml; yaml.safe_load(open('mkdocs.yml'))"
          echo "âœ… mkdocs.yml è¯­æ³•æ­£ç¡®"

          # æž„å»ºæµ‹è¯•ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
          mkdocs build --strict --quiet
          echo "âœ… MkDocsæž„å»ºæˆåŠŸ"

      - name: ðŸ”— æ£€æŸ¥æ–‡æ¡£é“¾æŽ¥
        run: |
          echo "ðŸ”— æ£€æŸ¥æ–‡æ¡£é“¾æŽ¥..."

          # å®‰è£…é“¾æŽ¥æ£€æŸ¥å·¥å…·
          pip install markdown-link-check

          # æ£€æŸ¥æ–‡æ¡£é“¾æŽ¥
          markdown-link-check docs/ -v --config .mlc_config.json 2>/dev/null || {
            echo "âš ï¸  é“¾æŽ¥æ£€æŸ¥å‘çŽ°é—®é¢˜ï¼Œä½†ä¸é˜»æ­¢æž„å»º"
          }

          echo "âœ… é“¾æŽ¥æ£€æŸ¥å®Œæˆ"

      - name: ðŸ“Š ç”Ÿæˆæ–‡æ¡£ç»Ÿè®¡
        run: |
          echo "ðŸ“Š ç”Ÿæˆæ–‡æ¡£ç»Ÿè®¡æŠ¥å‘Š..."

          cat > docs-stats.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "total_files": $(find docs -name "*.md" | wc -l),
            "total_lines": $(find docs -name "*.md" -exec wc -l {} + | tail -1 | awk '{print $1}'),
            "directories": $(find docs -type d | wc -l),
            "largest_file": "$(find docs -name "*.md" -exec wc -l {} + | sort -nr | head -1 | awk '{print $2}')",
            "git_commit": "$(git rev-parse --short HEAD)",
            "git_branch": "$(git rev-parse --abbrev-ref HEAD)"
          }
          EOF

          echo "ðŸ“ˆ æ–‡æ¡£ç»Ÿè®¡å·²ç”Ÿæˆ"

  # ===== é˜¶æ®µ 2: æž„å»ºæ–‡æ¡£ =====
  docs-build:
    name: ðŸ”¨ æž„å»ºæ–‡æ¡£ç«™ç‚¹
    runs-on: ubuntu-latest
    needs: docs-check
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4.1.6
        with:
          fetch-depth: 0

      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4.7.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material
          pip install -r requirements/requirements.lock

      - name: ðŸ”¨ æž„å»ºæ–‡æ¡£
        run: |
          echo "ðŸ”¨ å¼€å§‹æž„å»ºæ–‡æ¡£ç«™ç‚¹..."

          # æ¸…ç†ä¹‹å‰çš„æž„å»º
          rm -rf site/

          # æž„å»ºæ–‡æ¡£
          mkdocs build --verbose

          # æ£€æŸ¥æž„å»ºç»“æžœ
          if [ ! -f "site/index.html" ]; then
            echo "âŒ æž„å»ºå¤±è´¥ï¼šä¸»é¡µé¢æœªç”Ÿæˆ"
            exit 1
          fi

          # ç»Ÿè®¡ç”Ÿæˆçš„é¡µé¢
          HTML_FILES=$(find site -name "*.html" | wc -l)
          echo "âœ… æž„å»ºæˆåŠŸï¼šç”Ÿæˆ $HTML_FILES ä¸ªHTMLé¡µé¢"

          # æ£€æŸ¥ç«™ç‚¹å¤§å°
          SITE_SIZE=$(du -sh site/ | cut -f1)
          echo "ðŸ“¦ ç«™ç‚¹å¤§å°ï¼š$SITE_SIZE"

      - name: ðŸ“Š æž„å»ºæŠ¥å‘Š
        run: |
          echo "ðŸ“Š ç”Ÿæˆæž„å»ºæŠ¥å‘Š..."

          cat > build-report.json << EOF
          {
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "$(git rev-parse --short HEAD)",
            "branch": "$(git rev-parse --abbrev-ref HEAD)",
            "html_pages": $(find site -name "*.html" | wc -l),
            "site_size": "$(du -sh site/ | cut -f1)",
            "build_status": "success"
          }
          EOF

      - name: ðŸ“¦ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4.1.3
        with:
          name: docs-site-${{ github.sha }}
          path: site/
          retention-days: 30

  # ===== é˜¶æ®µ 3: éƒ¨ç½²åˆ°GitHub Pages =====
  docs-deploy:
    name: ðŸš€ éƒ¨ç½²åˆ°GitHub Pages
    runs-on: ubuntu-latest
    needs: docs-build
    if: |
      github.ref == 'refs/heads/main' ||
      github.ref == 'refs/heads/develop' ||
      github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true'
    timeout-minutes: 10
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4.1.6

      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4.7.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material
          pip install -r requirements/requirements.lock

      - name: ðŸ“¦ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4.0.2
        with:
          name: docs-site-${{ github.sha }}
          path: site/

      - name: ðŸš€ é…ç½®GitHub Pages
        uses: actions/configure-pages@v4.0.0

      - name: ðŸš€ éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4.0.5

      - name: ðŸ“Š éƒ¨ç½²æŠ¥å‘Š
        run: |
          echo "ðŸŽ‰ æ–‡æ¡£å·²æˆåŠŸéƒ¨ç½²åˆ°GitHub Pages!"
          echo "ðŸ”— è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}"

  # ===== é˜¶æ®µ 4: è´¨é‡æ£€æŸ¥ =====
  docs-quality:
    name: ðŸ“ˆ æ–‡æ¡£è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: docs-build
    if: github.event_name == 'pull_request'
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4.1.6

      - name: ðŸ“¦ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4.0.2
        with:
          name: docs-site-${{ github.sha }}
          path: site/

      - name: ðŸ“ˆ è´¨é‡åˆ†æž
        run: |
          echo "ðŸ“ˆ æ‰§è¡Œæ–‡æ¡£è´¨é‡åˆ†æž..."

          # æ£€æŸ¥é¡µé¢å¤§å°
          LARGE_PAGES=$(find site -name "*.html" -exec wc -c {} + | awk '$1 > 50000' | wc -l)
          if [ "$LARGE_PAGES" -gt 0 ]; then
            echo "âš ï¸  å‘çŽ° $LARGE_PAGES ä¸ªå¤§åž‹é¡µé¢ï¼ˆ>50KBï¼‰"
          fi

          # æ£€æŸ¥å›¾ç‰‡ä¼˜åŒ–
          IMAGES=$(find site -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" | wc -l)
          echo "ðŸ“· å›¾ç‰‡æ•°é‡ï¼š$IMAGES"

          # ç”Ÿæˆè´¨é‡æŠ¥å‘Š
          cat > quality-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "large_pages": $LARGE_PAGES,
            "image_count": $IMAGES,
            "quality_score": "good"
          }
          EOF

  # ===== é˜¶æ®µ 5: é€šçŸ¥ =====
  docs-notify:
    name: ðŸ“¢ é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [docs-build, docs-deploy]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ðŸ“¢ éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: needs.docs-deploy.result == 'success'
        run: |
          echo "ðŸŽ‰ æ–‡æ¡£éƒ¨ç½²æˆåŠŸï¼"
          echo "ðŸ“– è®¿é—®åœ°å€ï¼šhttps://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

      - name: âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ æ–‡æ¡£éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          echo "ðŸ”— æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

# ===== å·¥ä½œæµä¿¡æ¯ =====
outputs:
  site_url:
    description: "éƒ¨ç½²çš„æ–‡æ¡£ç«™ç‚¹URL"
    value: ${{ jobs.docs-deploy.outputs.page_url }}
  build_status:
    description: "æž„å»ºçŠ¶æ€"
    value: ${{ jobs.docs-build.result }}