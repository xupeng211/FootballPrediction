name: ğŸšª Enhanced Quality Gate

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  MIN_COVERAGE_THRESHOLD: 25
  MAX_RUFF_ISSUES: 50
  MAX_SECURITY_ISSUES: 5

jobs:
  # 1. é¢„æ£€æŸ¥
  pre-checks:
    name: ğŸ” Pre-Quality Checks
    runs-on: ubuntu-latest
    outputs:
      should-continue: ${{ steps.changes.outputs.should-continue }}

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” Detect Changes
      id: changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰é‡è¦çš„ä»£ç å˜æ›´
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "should-continue=true" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "push" ]; then
          # æ£€æŸ¥æœ€è¿‘æäº¤æ˜¯å¦æœ‰Pythonæ–‡ä»¶å˜æ›´
          if git diff --name-only HEAD~1 HEAD | grep -E '\.(py|yml|yaml|toml|ini)$'; then
            echo "should-continue=true" >> $GITHUB_OUTPUT
          else
            echo "should-continue=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "should-continue=true" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“‹ Changes Summary
      run: |
        echo "ğŸ“‹ Changed files in this push/PR:"
        git diff --name-only HEAD~1 HEAD | head -10 || echo "No changes detected"

  # 2. ä»£ç é£æ ¼æ£€æŸ¥
  style-check:
    name: ğŸ¨ Code Style Check
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-continue == 'true'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Ruff
      run: pip install ruff

    - name: ğŸ” Ruff Linting
      run: |
        echo "ğŸ” Running Ruff linting..."
        ruff check src/ tests/ --output-format=github --show-fixes

        # ç»Ÿè®¡é—®é¢˜æ•°é‡
        issues=$(ruff check src/ tests/ --output-format=json | python -c "import json, sys; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0")
        echo "ğŸ“Š Found $issues Ruff issues"

        if [ $issues -gt ${{ env.MAX_RUFF_ISSUES }} ]; then
          echo "âŒ Too many Ruff issues ($issues > ${{ env.MAX_RUFF_ISSUES }})"
          echo "ğŸ’¡ Consider running 'ruff check --fix' to auto-fix issues"
          exit 1
        fi

    - name: ğŸ¨ Ruff Formatting Check
      run: |
        echo "ğŸ¨ Checking code formatting..."
        ruff format --check src/ tests/

  # 3. ç±»å‹æ£€æŸ¥
  type-check:
    name: ğŸ”¤ Type Checking
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-continue == 'true'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install MyPy
      run: pip install mypy

    - name: ğŸ”¤ MyPy Type Checking
      run: |
        echo "ğŸ”¤ Running MyPy type checking..."

        # æ£€æŸ¥æ˜¯å¦æœ‰mypyé…ç½®
        if [ -f "pyproject.toml" ] && grep -q "\[tool.mypy\]" pyproject.toml; then
          echo "ğŸ“‹ Found MyPy configuration"
          mypy src/ --no-error-summary || echo "âš ï¸ MyPy found type issues"
        else
          echo "ğŸ“‹ No MyPy config found, running basic check"
          mypy src/ --ignore-missing-imports --no-error-summary || echo "âš ï¸ MyPy found type issues"
        fi

  # 4. å®‰å…¨æ£€æŸ¥
  security-check:
    name: ğŸ›¡ï¸ Security Check
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-continue == 'true'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Security Tools
      run: pip install bandit safety

    - name: ğŸ›¡ï¸ Bandit Security Scan
      run: |
        echo "ğŸ›¡ï¸ Running Bandit security scan..."
        bandit -r src/ -f json -o bandit-report.json || true

        # æ£€æŸ¥å®‰å…¨é—®é¢˜æ•°é‡
        high_issues=$(cat bandit-report.json | python -c "
import json, sys
try:
    data = json.load(sys.stdin)
    high = len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH'])
    print(high)
except:
    print(0)
" 2>/dev/null || echo "0")

        medium_issues=$(cat bandit-report.json | python -c "
import json, sys
try:
    data = json.load(sys.stdin)
    medium = len([r for r in data.get('results', []) if r.get('issue_severity') == 'MEDIUM'])
    print(medium)
except:
    print(0)
" 2>/dev/null || echo "0")

        echo "ğŸ”’ Security Issues - High: $high_issues, Medium: $medium_issues"

        total_issues=$((high_issues + medium_issues))
        if [ $high_issues -gt 0 ] || [ $total_issues -gt ${{ env.MAX_SECURITY_ISSUES }} ]; then
          echo "âŒ Security issues found that need attention"
          echo "ğŸš¨ High severity issues: $high_issues"
          echo "âš ï¸ Total security issues: $total_issues"
          exit 1
        fi

    - name: ğŸ”’ Dependency Safety Check
      run: |
        echo "ğŸ”’ Checking dependency safety..."
        safety check --json --output safety-report.json || echo "âš ï¸ Safety check found vulnerabilities"

    - name: ğŸ“¤ Upload Security Reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 30

  # 5. æµ‹è¯•è´¨é‡æ£€æŸ¥
  test-quality:
    name: ğŸ§ª Test Quality Check
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-continue == 'true'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Test Dependencies
      run: |
        pip install --upgrade pip
        pip install pytest pytest-cov pytest-mock

    - name: ğŸ§ª Test Collection Check
      run: |
        echo "ğŸ§ª Checking test collection..."

        # æ£€æŸ¥æ˜¯å¦èƒ½æˆåŠŸæ”¶é›†æµ‹è¯•
        if pytest --collect-only -q tests/ 2>/dev/null | grep -q "test session starts"; then
          echo "âœ… Tests can be collected successfully"
        else
          echo "âš ï¸ Some test collection issues detected"
        fi

        # ç»Ÿè®¡æµ‹è¯•æ•°é‡
        test_count=$(pytest --collect-only -q tests/ 2>/dev/null | grep -c "def test_" || echo "0")
        echo "ğŸ“Š Found $test_count test functions"

        if [ $test_count -eq 0 ]; then
          echo "âš ï¸ No tests found. Consider adding tests for new code."
        fi

    - name: ğŸƒ Quick Test Run (Sample)
      run: |
        echo "ğŸƒ Running quick sample tests..."
        timeout 300 pytest tests/ --maxfail=3 -x --tb=short || echo "âš ï¸ Some tests failed, but continuing..."

  # 6. è¦†ç›–ç‡æ£€æŸ¥
  coverage-check:
    name: ğŸ“Š Coverage Check
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-continue == 'true'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Coverage Tools
      run: |
        pip install --upgrade pip
        pip install pytest pytest-cov

    - name: ğŸ“Š Coverage Measurement
      run: |
        echo "ğŸ“Š Measuring test coverage..."

        # è¿è¡Œè¦†ç›–ç‡æµ‹è¯•ï¼ˆå¸¦è¶…æ—¶ï¼‰
        timeout 600 pytest --cov=src --cov-report=xml --cov-report=term-missing tests/ || echo "âš ï¸ Coverage measurement incomplete"

        # æ£€æŸ¥è¦†ç›–ç‡æŠ¥å‘Š
        if [ -f "coverage.xml" ]; then
          coverage_percent=$(python -c "
import xml.etree.ElementTree as ET
try:
    tree = ET.parse('coverage.xml')
    root = tree.getroot()
    coverage = root.find('.//coverage')
    if coverage is not None:
        print(coverage.get('line-rate', '0'))
    else:
        print('0')
except:
    print('0')
" | python -c "import sys; print(float(sys.stdin.read()) * 100)")

          echo "ğŸ“Š Current coverage: ${coverage_percent}%"
          echo "ğŸ¯ Minimum required: ${{ env.MIN_COVERAGE_THRESHOLD }}%"

          if (( $(echo "$coverage_percent < ${{ env.MIN_COVERAGE_THRESHOLD }}" | bc -l) )); then
            echo "âš ï¸ Coverage below threshold (${coverage_percent}% < ${{ env.MIN_COVERAGE_THRESHOLD }}%)"
            echo "ğŸ’¡ Consider adding more tests to improve coverage"
            # ä¸é˜»æ­¢æ„å»ºï¼Œåªæ˜¯è­¦å‘Š
          else
            echo "âœ… Coverage meets minimum requirements"
          fi
        else
          echo "âš ï¸ Coverage report not generated"
        fi

    - name: ğŸ“¤ Upload Coverage Reports
      uses: actions/upload-artifact@v3
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/
        retention-days: 30

  # 7. è´¨é‡é—¨æ§å†³ç­–
  quality-gate-decision:
    name: ğŸšª Quality Gate Decision
    runs-on: ubuntu-latest
    needs: [pre-checks, style-check, type-check, security-check, test-quality, coverage-check]
    if: always() && needs.pre-checks.outputs.should-continue == 'true'

    steps:
    - name: ğŸšª Quality Gate Evaluation
      run: |
        echo "ğŸšª Quality Gate Evaluation"
        echo "=========================="

        # æ”¶é›†å„é˜¶æ®µç»“æœ
        style_result="${{ needs.style-check.result }}"
        type_result="${{ needs.type-check.result }}"
        security_result="${{ needs.security-check.result }}"
        test_result="${{ needs.test-quality.result }}"
        coverage_result="${{ needs.coverage-check.result }}"

        echo "ğŸ“‹ Quality Check Results:"
        echo "  ğŸ¨ Code Style: $style_result"
        echo "  ğŸ”¤ Type Checking: $type_result"
        echo "  ğŸ›¡ï¸ Security: $security_result"
        echo "  ğŸ§ª Test Quality: $test_result"
        echo "  ğŸ“Š Coverage: $coverage_result"

        # è®¡ç®—è´¨é‡åˆ†æ•°
        total_checks=5
        passed_checks=0

        [ "$style_result" = "success" ] && passed_checks=$((passed_checks + 1))
        [ "$type_result" = "success" ] && passed_checks=$((passed_checks + 1))
        [ "$security_result" = "success" ] && passed_checks=$((passed_checks + 1))
        [ "$test_result" = "success" ] && passed_checks=$((passed_checks + 1))
        [ "$coverage_result" = "success" ] && passed_checks=$((passed_checks + 1))

        quality_score=$((passed_checks * 100 / total_checks))
        echo "ğŸ“Š Overall Quality Score: $quality_score% ($passed_checks/$total_checks checks passed)"

        # è´¨é‡é—¨æ§å†³ç­–
        if [ $quality_score -eq 100 ]; then
          echo "ğŸ‰ EXCELLENT: All quality checks passed!"
          echo "âœ… Code is ready for production"
          exit 0
        elif [ $quality_score -ge 80 ]; then
          echo "âœ… GOOD: Most quality checks passed"
          echo "ğŸ’¡ Code is acceptable, consider fixing remaining issues"
          exit 0
        elif [ $quality_score -ge 60 ]; then
          echo "âš ï¸ ACCEPTABLE: Some quality issues found"
          echo "ğŸ”§ Code can proceed but should be improved"
          exit 0
        else
          echo "âŒ POOR: Multiple quality issues found"
          echo "ğŸš¨ Code quality below acceptable standards"
          echo "ğŸ› ï¸ Please address quality issues before merging"
          exit 1
        fi

    - name: ğŸ“‹ Quality Recommendations
      if: always()
      run: |
        echo "ğŸ’¡ Quality Improvement Recommendations:"
        echo ""

        if [ "${{ needs.style-check.result }}" != "success" ]; then
          echo "ğŸ¨ Run 'ruff check --fix' to auto-fix style issues"
        fi

        if [ "${{ needs.type-check.result }}" != "success" ]; then
          echo "ğŸ”¤ Add type hints to improve type checking"
        fi

        if [ "${{ needs.security-check.result }}" != "success" ]; then
          echo "ğŸ›¡ï¸ Address security vulnerabilities immediately"
        fi

        if [ "${{ needs.test-quality.result }}" != "success" ]; then
          echo "ğŸ§ª Fix failing tests and improve test coverage"
        fi

        if [ "${{ needs.coverage-check.result }}" != "success" ]; then
          echo "ğŸ“Š Add more tests to improve code coverage"
        fi