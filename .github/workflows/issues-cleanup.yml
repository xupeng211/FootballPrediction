name: GitHub Issues Cleanup

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'è¯•è¿è¡Œæ¨¡å¼'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  cleanup-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install GitHub CLI
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh

    - name: Authenticate GitHub CLI
      run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

    - name: Run Issues Cleanup
      run: |
        if [ "${{ github.event.inputs.dry_run || 'true' }}" = "true" ]; then
          python3 scripts/github_issues_cleaner.py --dry-run
        else
          python3 scripts/github_issues_cleaner.py
        fi

    - name: Upload Cleanup Report
      uses: actions/upload-artifact@v3
      with:
        name: cleanup-report
        path: github_issues_cleanup_report.json

    - name: Comment on Issue if Actions Taken
      if: github.event.inputs.dry_run == 'false'
      run: |
        python3 -c "
        import json
        with open('github_issues_cleanup_report.json', 'r') as f:
            report = json.load(f)

        executed = report['result']['executed']
        if executed > 0:
            print(f'âœ… æ‰§è¡Œäº† {executed} ä¸ªæ¸…ç†æ“ä½œ')

            # åœ¨Phase 9.0æ€»è§ˆIssueä¸­æ·»åŠ è¯„è®º
            subprocess.run([
                'gh', 'issue', 'comment', '964',
                '--repo', 'xupeng211/FootballPrediction',
                '--body', f'ğŸ¤– **è‡ªåŠ¨åŒ–GitHub Issuesæ¸…ç†æ‰§è¡Œå®Œæˆ**\n\nğŸ“Š **æ¸…ç†ç»“æœ**:\n- æ‰§è¡Œæ“ä½œæ•°: {executed}\n- æ‰§è¡Œæ—¶é—´: {report[\"timestamp\"]}\n- è¯¦ç»†æŠ¥å‘Š: [æŸ¥çœ‹æ¸…ç†æŠ¥å‘Š](https://github.com/xupeng211/FootballPrediction/actions/runs/${{ github.run_id }})\n\n---\n*ç”±GitHub Actionsè‡ªåŠ¨æ‰§è¡Œ*'
            ])
        "
