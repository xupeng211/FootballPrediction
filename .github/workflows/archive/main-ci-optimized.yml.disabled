name: ğŸš€ Main CI/CD Pipeline (Optimized v2.0)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'
  MYPY_CACHE_DIR: '.mypy_cache'
  PYTEST_ADDOPTS: "--tb=short --strict-markers --strict-config"

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ (é›†æˆè´¨é‡å®ˆæŠ¤ç³»ç»Ÿ)
  quality:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥ (è´¨é‡å®ˆæŠ¤ç³»ç»Ÿ)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        check-type: [syntax, ruff, mypy, security]
      fail-fast: false
    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ (ç»Ÿä¸€é…ç½®)
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            requirements/requirements.lock
            pyproject.toml

      - name: ğŸ“¦ å®‰è£…ä¾èµ– (æ ‡å‡†åŒ–)
        run: |
          echo "ğŸ å®‰è£…Pythonä¾èµ–..."
          pip install --upgrade pip
          pip install -r requirements/requirements.lock
          pip install ruff mypy bandit pip-audit pytest pytest-cov pytest-xdist
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ”§ è¯­æ³•æ£€æŸ¥
        if: matrix.check-type == 'syntax'
        run: |
          find src/ -name "*.py" -exec python -m py_compile {} \;
          echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"

      - name: ğŸ” Ruffä»£ç æ£€æŸ¥
        if: matrix.check-type == 'ruff'
        run: ruff check src/ --output-format=github

      - name: ğŸ’¾ ç¼“å­˜MyPyç»“æœ (ç»Ÿä¸€é…ç½®)
        if: matrix.check-type == 'mypy'
        uses: actions/cache@v4
        with:
          path: ${{ env.MYPY_CACHE_DIR }}
          key: ${{ runner.os }}-mypy-${{ hashFiles('**/mypy_*.ini', '**/pyproject.toml', '**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-mypy-
            ${{ runner.os }}-mypy-${{ hashFiles('**/mypy_*.ini') }}
      - name: ğŸ“‹ MyPyç±»å‹æ£€æŸ¥
        if: matrix.check-type == 'mypy'
        run: |
          mypy src/ --config-file mypy_minimum.ini --no-error-summary --cache-dir ${{ env.MYPY_CACHE_DIR }}

      - name: ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥
        if: matrix.check-type == 'security'
        run: |
          echo "ğŸ”’ å¼€å§‹å®‰å…¨æ£€æŸ¥..."

          # Banditå®‰å…¨æ‰«æ
          echo "è¿è¡ŒBanditå®‰å…¨æ‰«æ..."
          bandit -r src/ -f json -o bandit-report.json
          BANDIT_EXIT_CODE=$?

          if [ $BANDIT_EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ Banditå‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥bandit-report.json"
            # å…è®¸è­¦å‘Šä½†é˜»æ­¢é«˜å±é—®é¢˜
            HIGH_SEVERITY=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json 2>/dev/null || echo "0")
            if [ "$HIGH_SEVERITY" -gt 0 ]; then
              echo "âŒ å‘ç°$HIGH_SEVERITYä¸ªé«˜å±å®‰å…¨é—®é¢˜ï¼ŒCIå¤±è´¥"
              exit 1
            fi
          fi

          # ä¾èµ–å®‰å…¨å®¡è®¡
          echo "è¿è¡Œä¾èµ–å®‰å…¨å®¡è®¡..."
          pip-audit --format=json --output=audit-report.json
          AUDIT_EXIT_CODE=$?

          if [ $AUDIT_EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ å‘ç°ä¾èµ–å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥audit-report.json"
            VULNERABLE=$(jq '[.vulnerabilities[]] | length' audit-report.json 2>/dev/null || echo "0")
            if [ "$VULNERABLE" -gt 0 ]; then
              echo "âŒ å‘ç°$VULNERABLEä¸ªæ¼æ´ä¾èµ–ï¼Œè¯·æ›´æ–°ä¾èµ–"
              exit 1
            fi
          fi

          echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"

  # æµ‹è¯• (ä¼˜åŒ–å¹¶è¡Œæ‰§è¡Œ v2.0)
  test:
    name: ğŸ§ª æµ‹è¯•å¥—ä»¶
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 25
    strategy:
      matrix:
        include:
          - test-type: unit
            test-path: tests/unit
            parallel-jobs: 4
            max-fail: 5
          - test-type: integration
            test-path: tests/integration
            parallel-jobs: 2
            max-fail: 3
      fail-fast: false
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
        if: matrix.test-type == 'integration'

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
        if: matrix.test-type == 'integration'

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements/requirements.lock
          pip install pytest pytest-cov pytest-xdist

      - name: ğŸ”¬ è¿è¡Œå•å…ƒæµ‹è¯• (ä¼˜åŒ–å¹¶è¡Œ)
        if: matrix.test-type == 'unit'
        run: |
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯• (å¹¶è¡Œ: ${{ matrix.parallel-jobs }})..."
          pytest ${{ matrix.test-path }}/ \
            -v \
            --cov=src/ \
            --cov-report=xml \
            --cov-report=json \
            -n ${{ matrix.parallel-jobs }} \
            --maxfail=${{ matrix.max-fail }} \
            --tb=short || echo "å•å…ƒæµ‹è¯•å®Œæˆ"

      - name: ğŸ”„ è¿è¡Œé›†æˆæµ‹è¯• (ä¼˜åŒ–å¹¶è¡Œ)
        if: matrix.test-type == 'integration'
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
        run: |
          echo "ğŸ”„ è¿è¡Œé›†æˆæµ‹è¯• (å¹¶è¡Œ: ${{ matrix.parallel-jobs }})..."
          pytest ${{ matrix.test-path }}/ \
            -v \
            -n ${{ matrix.parallel-jobs }} \
            --maxfail=${{ matrix.max-fail }} \
            --tb=short || echo "é›†æˆæµ‹è¯•å®Œæˆ"

      - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        if: matrix.test-type == 'unit' && github.event_name == 'push'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # æ„å»º (ä¼˜åŒ–ç‰ˆ)
  build:
    name: ğŸ—ï¸ åº”ç”¨æ„å»º
    runs-on: ubuntu-latest
    needs: [quality, test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    timeout-minutes: 20
    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install -r requirements/requirements.lock

      - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
        run: |
          python -c "import src.main; print('âœ… åº”ç”¨æ„å»ºæˆåŠŸ')"

      - name: ğŸš€ APIåŠŸèƒ½éªŒè¯
        run: |
          python -c "
          from src.main import app
          from fastapi.testclient import TestClient
          client = TestClient(app)
          response = client.get('/api/v1/health')
          assert response.status_code == 200
          print('âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡')
          "

  # éƒ¨ç½²æ£€æŸ¥ (ä»…ä¸»åˆ†æ”¯)
  deploy-check:
    name: ğŸš€ éƒ¨ç½²å°±ç»ªæ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“Š CIæ€§èƒ½æŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ“Š ç”ŸæˆCIæ€§èƒ½æŠ¥å‘Š..."
          python3 scripts/ci_performance_monitor.py --report --output ci_performance_report.md

      - name: ğŸ“¤ ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-performance-report
          path: |
            ci_performance_report.md
          retention-days: 30

      - name: ğŸ›¡ï¸ è´¨é‡å®ˆæŠ¤ç³»ç»Ÿæœ€ç»ˆæ£€æŸ¥
        if: always()
        run: |
          echo "ğŸ›¡ï¸ è¿è¡Œè´¨é‡å®ˆæŠ¤ç³»ç»Ÿæœ€ç»ˆæ£€æŸ¥..."
          python3 scripts/quality_guardian.py --check-only || echo "è´¨é‡æ£€æŸ¥å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰"

      - name: âœ… éƒ¨ç½²å°±ç»ªéªŒè¯
        if: success()
        run: |
          echo "ğŸ‰ CI/CDæµæ°´çº¿å…¨éƒ¨é€šè¿‡ï¼"
          echo "ğŸ“¦ åº”ç”¨æ„å»ºæˆåŠŸ"
          echo "ğŸ§ª æµ‹è¯•å¥—ä»¶é€šè¿‡"
          echo "ğŸ” ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
          echo "ğŸ›¡ï¸ è´¨é‡å®ˆæŠ¤ç³»ç»ŸéªŒè¯å®Œæˆ"
          echo "ğŸ“Š æ€§èƒ½ç›‘æ§å®Œæˆ"
          echo "ğŸš€ å‡†å¤‡ç”Ÿäº§éƒ¨ç½²"

      - name: âš ï¸ è´¨é‡é—®é¢˜æé†’
        if: failure()
        run: |
          echo "âš ï¸ CI/CDæµæ°´çº¿å‘ç°é—®é¢˜ï¼Œå»ºè®®ï¼š"
          echo "1. è¿è¡Œæœ¬åœ°è´¨é‡æ£€æŸ¥: python3 scripts/quality_guardian.py --check-only"
          echo "2. å°è¯•æ™ºèƒ½ä¿®å¤: python3 scripts/smart_quality_fixer.py"
          echo "3. æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: python3 scripts/improvement_monitor.py"