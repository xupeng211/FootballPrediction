name: Kanban Audit

on:
  pull_request:
    types: [closed]

jobs:
  kanban-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git config
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Run Kanban audit
        id: audit
        run: |
          # è®¾ç½®å˜é‡
          REPORT_FILE="docs/_reports/TEST_IMPROVEMENT_AUDIT.md"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          COMMIT_SHA="${{ github.sha }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # ç¡®ä¿æŠ¥å‘Šç›®å½•å­˜åœ¨
          mkdir -p docs/_reports

          echo "ğŸ” å¼€å§‹ Kanban éªŒæ”¶å®¡è®¡..."
          echo "PR: #$PR_NUMBER"
          echo "Commit: $COMMIT_SHA"

          # åˆå§‹åŒ–å®¡è®¡ç»“æœ
          TOTAL_CHECKS=0
          PASSED_CHECKS=0
          FAILED_CHECKS=0

          # ç”ŸæˆæŠ¥å‘Šå¤´éƒ¨
          cat > "$REPORT_FILE" << EOF
          # ğŸ“‹ Kanban è‡ªåŠ¨éªŒæ”¶æŠ¥å‘Š

          **å®¡è®¡æ—¶é—´**: $TIMESTAMP
          **è§¦å‘åŸå› **: PR #$PR_NUMBER åˆå¹¶
          **æäº¤ SHA**: $COMMIT_SHA
          **å®¡è®¡ç±»å‹**: è‡ªåŠ¨åŒ–éªŒæ”¶å®¡è®¡

          ---

          ## ğŸ“Š éªŒæ”¶ç»“æœæ±‡æ€»

          EOF

          # æ£€æŸ¥å‡½æ•°
          check_item() {
            local description="$1"
            local check_command="$2"
            local notes="$3"

            TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
            echo "æ£€æŸ¥: $description"

            if eval "$check_command" >/dev/null 2>&1; then
              echo "  âœ… é€šè¿‡"
              echo "- âœ… **$description**" >> "$REPORT_FILE"
              PASSED_CHECKS=$((PASSED_CHECKS + 1))
              return 0
            else
              echo "  âŒ å¤±è´¥"
              echo "- âŒ **$description**" >> "$REPORT_FILE"
              if [ -n "$notes" ]; then
                echo "  *åŸå› : $notes*" >> "$REPORT_FILE"
              fi
              FAILED_CHECKS=$((FAILED_CHECKS + 1))
              return 1
            fi
          }

          # å¼€å§‹å„é¡¹æ£€æŸ¥

          ## 1. Kanban çœ‹æ¿æ£€æŸ¥
          echo "" >> "$REPORT_FILE"
          echo "### 1. Kanban çœ‹æ¿" >> "$REPORT_FILE"

          check_item "æ–‡ä»¶ docs/_reports/TEST_OPTIMIZATION_KANBAN.md æ˜¯å¦å­˜åœ¨" \
                     "[ -f 'docs/_reports/TEST_OPTIMIZATION_KANBAN.md' ]" \
                     "Kanban çœ‹æ¿æ–‡ä»¶ä¸å­˜åœ¨"

          if [ -f "docs/_reports/TEST_OPTIMIZATION_KANBAN.md" ]; then
            check_item "æ–‡ä»¶å†…å®¹æ˜¯å¦åŒ…å« Phase 1/2/3 ä¸‰ä¸ªé˜¶æ®µ" \
                       "grep -q 'Phase 1.*çŸ­æœŸä¿®å¤' docs/_reports/TEST_OPTIMIZATION_KANBAN.md && grep -q 'Phase 2.*ç»“æ„ä¼˜åŒ–' docs/_reports/TEST_OPTIMIZATION_KANBAN.md && grep -q 'Phase 3.*é•¿æœŸè´¨é‡å»ºè®¾' docs/_reports/TEST_OPTIMIZATION_KANBAN.md" \
                       "ç¼ºå°‘å®Œæ•´çš„ä¸‰ä¸ªé˜¶æ®µå®šä¹‰"

            check_item "æ˜¯å¦å­˜åœ¨ In Progress å’Œ Done åŒºåŸŸ" \
                       "grep -q 'è¿›è¡Œä¸­.*In Progress' docs/_reports/TEST_OPTIMIZATION_KANBAN.md && grep -q 'å·²å®Œæˆ.*Done' docs/_reports/TEST_OPTIMIZATION_KANBAN.md" \
                       "ç¼ºå°‘çŠ¶æ€ç®¡ç†åŒºåŸŸ"

            check_item "æ˜¯å¦æœ‰è‡ªåŠ¨ç»´æŠ¤è§„åˆ™" \
                       "grep -q 'è‡ªåŠ¨ç»´æŠ¤è§„åˆ™' docs/_reports/TEST_OPTIMIZATION_KANBAN.md" \
                       "ç¼ºå°‘è‡ªåŠ¨ç»´æŠ¤è§„åˆ™"
          fi

          ## 2. CI Hook å®ˆæŠ¤æ£€æŸ¥
          echo "" >> "$REPORT_FILE"
          echo "### 2. CI Hook å®ˆæŠ¤" >> "$REPORT_FILE"

          check_item "æœ¬åœ° pre-commit hook æ˜¯å¦å­˜åœ¨" \
                     "[ -f '.git/hooks/pre-commit' ]" \
                     "pre-commit hook æ–‡ä»¶ä¸å­˜åœ¨"

          if [ -f ".git/hooks/pre-commit" ]; then
            check_item "pre-commit hook æ˜¯å¦åŒ…å«æ£€æŸ¥é€»è¾‘" \
                       "grep -q 'TEST_OPTIMIZATION_KANBAN.md' .git/hooks/pre-commit" \
                       "pre-commit hook ç¼ºå°‘æ£€æŸ¥é€»è¾‘"
          fi

          check_item "Makefile æ˜¯å¦æœ‰ setup-hooks ç›®æ ‡" \
                     "grep -q '^setup-hooks:' Makefile" \
                     "Makefile ç¼ºå°‘ setup-hooks ç›®æ ‡"

          check_item "GitHub Actions kanban-check.yml æ˜¯å¦å­˜åœ¨" \
                     "[ -f '.github/workflows/kanban-check.yml' ]" \
                     "GitHub Actions å·¥ä½œæµæ–‡ä»¶ä¸å­˜åœ¨"

          if [ -f ".github/workflows/kanban-check.yml" ]; then
            check_item "CI æ˜¯å¦æ£€æŸ¥ Kanban æ–‡ä»¶æ›´æ–°" \
                       "grep -q 'Check if Kanban updated' .github/workflows/kanban-check.yml" \
                       "ç¼ºå°‘ Kanban æ£€æŸ¥æ­¥éª¤"

            check_item "æ—¥å¿—è¾“å‡ºæ˜¯å¦ç¾åŒ–ï¼ˆå½©è‰²æç¤ºï¼‰" \
                       "grep -q '\033\[' .github/workflows/kanban-check.yml" \
                       "ç¼ºå°‘å½©è‰²æ—¥å¿—è¾“å‡º"
          fi

          ## 3. ç¼“å­˜ä¸ä¼˜åŒ–æ£€æŸ¥
          echo "" >> "$REPORT_FILE"
          echo "### 3. ç¼“å­˜ä¸ä¼˜åŒ–" >> "$REPORT_FILE"

          if [ -f ".github/workflows/kanban-check.yml" ]; then
            check_item "æ˜¯å¦æœ‰ç»Ÿä¸€çš„ç¼“å­˜æ­¥éª¤" \
                       "grep -A5 'Cache hooks and Kanban file' .github/workflows/kanban-check.yml | grep -q '\.git/hooks'" \
                       "ç¼ºå°‘ç»Ÿä¸€çš„ç¼“å­˜æ­¥éª¤"

            check_item "ç¼“å­˜æ˜¯å¦åŒ…å« .git/hooks å’Œ Kanban æ–‡ä»¶ hash" \
                       "grep -A10 'key: kanban-check-' .github/workflows/kanban-check.yml | grep -q 'hashFiles'" \
                       "ç¼“å­˜ key é…ç½®ä¸æ­£ç¡®"

            check_item "æ˜¯å¦æœ‰ cache hit çŠ¶æ€è¾“å‡º" \
                       "grep -q 'Cache hit:' .github/workflows/kanban-check.yml" \
                       "ç¼ºå°‘ç¼“å­˜çŠ¶æ€è¾“å‡º"
          fi

          ## 4. CI å¤±è´¥æŠ¥å‘Šæ£€æŸ¥
          echo "" >> "$REPORT_FILE"
          echo "### 4. CI å¤±è´¥æŠ¥å‘Š" >> "$REPORT_FILE"

          if [ -f ".github/workflows/kanban-check.yml" ]; then
            check_item "æ£€æŸ¥å¤±è´¥æ—¶æ˜¯å¦ä¼šç”Ÿæˆ KANBAN_CHECK_REPORT.md" \
                       "grep -q 'KANBAN_CHECK_REPORT.md' .github/workflows/kanban-check.yml" \
                       "ç¼ºå°‘å¤±è´¥æŠ¥å‘Šç”Ÿæˆé€»è¾‘"

            check_item "æŠ¥å‘Šå†…å®¹æ˜¯å¦åŒ…å«æ—¶é—´/æäº¤ SHA/CI Run ID" \
                       "grep -q 'ç”Ÿæˆæ—¶é—´.*GITHUB_RUN_ID.*GITHUB_SHA' .github/workflows/kanban-check.yml" \
                       "æŠ¥å‘Šå†…å®¹ä¸å®Œæ•´"
          fi

          ## 5. å‘¨æŠ¥æœºåˆ¶æ£€æŸ¥
          echo "" >> "$REPORT_FILE"
          echo "### 5. å‘¨æŠ¥æœºåˆ¶" >> "$REPORT_FILE"

          check_item "æ˜¯å¦æœ‰ kanban-history.yml å·¥ä½œæµ" \
                     "[ -f '.github/workflows/kanban-history.yml' ]" \
                     "å‘¨æŠ¥å·¥ä½œæµæ–‡ä»¶ä¸å­˜åœ¨"

          if [ -f ".github/workflows/kanban-history.yml" ]; then
            check_item "æ˜¯å¦ä¼šå®šæ—¶ç”Ÿæˆ KANBAN_HISTORY.md" \
                       "grep -q 'KANBAN_HISTORY.md' .github/workflows/kanban-history.yml" \
                       "ç¼ºå°‘å†å²æ±‡æ€»ç”Ÿæˆé€»è¾‘"

            check_item "æ˜¯å¦é…ç½®äº†å®šæ—¶è§¦å‘" \
                       "grep -q 'cron.*0 2 \* \* 1' .github/workflows/kanban-history.yml" \
                       "ç¼ºå°‘å®šæ—¶è§¦å‘é…ç½®"
          fi

          ## 6. æŒ‡å—æ–‡æ¡£æ£€æŸ¥
          echo "" >> "$REPORT_FILE"
          echo "### 6. æŒ‡å—æ–‡æ¡£" >> "$REPORT_FILE"

          check_item "æ˜¯å¦å­˜åœ¨ TEST_IMPROVEMENT_GUIDE.md" \
                     "[ -f 'docs/TEST_IMPROVEMENT_GUIDE.md' ]" \
                     "æŒ‡å—æ–‡æ¡£æ–‡ä»¶ä¸å­˜åœ¨"

          if [ -f "docs/TEST_IMPROVEMENT_GUIDE.md" ]; then
            check_item "æ˜¯å¦åŒ…å« Kanban è¯´æ˜" \
                       "grep -q 'Kanban çœ‹æ¿' docs/TEST_IMPROVEMENT_GUIDE.md" \
                       "ç¼ºå°‘ Kanban è¯´æ˜"

            check_item "æ˜¯å¦åŒ…å« CI Hook è¯´æ˜" \
                       "grep -q 'CI Hook å®ˆæŠ¤' docs/TEST_IMPROVEMENT_GUIDE.md" \
                       "ç¼ºå°‘ CI Hook è¯´æ˜"

            check_item "æ˜¯å¦åŒ…å«å‘¨æŠ¥è¯´æ˜" \
                       "grep -q 'å‘¨æŠ¥æœºåˆ¶' docs/TEST_IMPROVEMENT_GUIDE.md" \
                       "ç¼ºå°‘å‘¨æŠ¥è¯´æ˜"
          fi

          ## 7. README é›†æˆæ£€æŸ¥
          echo "" >> "$REPORT_FILE"
          echo "### 7. README é›†æˆ" >> "$REPORT_FILE"

          check_item "README.md æ˜¯å¦åŒ…å«æµ‹è¯•æ”¹è¿›æœºåˆ¶æŒ‡å—é“¾æ¥" \
                     "grep -q 'æµ‹è¯•æ”¹è¿›æœºåˆ¶æŒ‡å—' README.md" \
                     "ç¼ºå°‘æŒ‡å—é“¾æ¥"

          check_item "README.md é¡¶éƒ¨æ˜¯å¦æœ‰ Test Improvement Guide å¾½ç« " \
                     "grep -q 'Test Improvement Guide.*blue' README.md" \
                     "ç¼ºå°‘æŒ‡å—å¾½ç« "

          check_item "README.md é¡¶éƒ¨æ˜¯å¦æœ‰ Kanban Check CI çŠ¶æ€å¾½ç« " \
                     "grep -q 'Kanban Check.*badge.svg' README.md" \
                     "ç¼ºå°‘ CI çŠ¶æ€å¾½ç« "

          # è®¡ç®—é€šè¿‡ç‡
          PASS_RATE=$(( PASSED_CHECKS * 100 / TOTAL_CHECKS ))

          # ç”Ÿæˆæ±‡æ€»ç»“æœ
          echo "" >> "$REPORT_FILE"
          echo "---" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## ğŸ“ˆ å®¡è®¡ç»Ÿè®¡" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "- **æ€»æ£€æŸ¥é¡¹**: $TOTAL_CHECKS" >> "$REPORT_FILE"
          echo "- **é€šè¿‡é¡¹**: $PASSED_CHECKS" >> "$REPORT_FILE"
          echo "- **å¤±è´¥é¡¹**: $FAILED_CHECKS" >> "$REPORT_FILE"
          echo "- **é€šè¿‡ç‡**: $PASS_RATE%" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          # ç”Ÿæˆç»“è®º
          echo "## ğŸ¯ å®¡è®¡ç»“è®º" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          if [ $FAILED_CHECKS -eq 0 ]; then
            echo "âœ… **æ‰€æœ‰æ£€æŸ¥é¡¹å‡é€šè¿‡ï¼æµ‹è¯•æ”¹è¿›æœºåˆ¶è¿è¡Œæ­£å¸¸ã€‚**" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "å»ºè®®ç»§ç»­ä¿æŒå½“å‰çŠ¶æ€ï¼Œå®šæœŸå›é¡¾æœºåˆ¶æ‰§è¡Œæ•ˆæœã€‚" >> "$REPORT_FILE"
            AUDIT_STATUS="âœ… å…¨éƒ¨é€šè¿‡"
          else
            echo "âš ï¸ **å‘ç° $FAILED_CHECKS ä¸ªé—®é¢˜éœ€è¦ä¿®å¤ã€‚**" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "### ğŸ”§ å¾…ä¿®å¤ä»»åŠ¡" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "è¯·æ ¹æ®ä¸Šè¿° âŒ æ ‡è®°çš„æ£€æŸ¥é¡¹è¿›è¡Œä¿®å¤ï¼š" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "1. ä¼˜å…ˆä¿®å¤å½±å“æ ¸å¿ƒåŠŸèƒ½çš„é—®é¢˜" >> "$REPORT_FILE"
            echo "2. ç¡®ä¿æ‰€æœ‰æ–‡ä»¶å’Œé…ç½®æ­£ç¡®" >> "$REPORT_FILE"
            echo "3. éªŒè¯ä¿®å¤åçš„åŠŸèƒ½æ­£å¸¸å·¥ä½œ" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "å»ºè®®åœ¨ä¸‹ä¸€æ¬¡æäº¤å‰å®Œæˆä¿®å¤ã€‚" >> "$REPORT_FILE"
            AUDIT_STATUS="âš ï¸ éƒ¨åˆ†é—®é¢˜å¾…ä¿®å¤"
          fi

          # æ·»åŠ å®¡è®¡å®Œæˆä¿¡æ¯
          echo "" >> "$REPORT_FILE"
          echo "---" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**å®¡è®¡å®Œæˆæ—¶é—´**: $TIMESTAMP" >> "$REPORT_FILE"
          echo "**å®¡è®¡å·¥å…·**: GitHub Actions è‡ªåŠ¨åŒ–å®¡è®¡" >> "$REPORT_FILE"
          echo "**å®¡è®¡çŠ¶æ€**: $AUDIT_STATUS" >> "$REPORT_FILE"

          echo "âœ… å®¡è®¡å®Œæˆï¼Œé€šè¿‡ç‡: $PASS_RATE% ($PASSED_CHECKS/$TOTAL_CHECKS)"
          echo "audit_status=$AUDIT_STATUS" >> $GITHUB_OUTPUT
          echo "pass_rate=$PASS_RATE%" >> $GITHUB_OUTPUT

      - name: Commit audit report
        run: |
          REPORT_FILE="docs/_reports/TEST_IMPROVEMENT_AUDIT.md"

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if ! git diff --quiet "$REPORT_FILE" || [ ! -f "$REPORT_FILE" ]; then
            echo "ğŸ“¤ æäº¤å®¡è®¡æŠ¥å‘Š..."
            git add "$REPORT_FILE"
            git commit -m "chore(audit): update TEST_IMPROVEMENT_AUDIT.md after PR merge

            Auto-generated audit report for PR #${{ github.event.pull_request.number }}
            Audit status: ${{ steps.audit.outputs.audit_status }}
            Pass rate: ${{ steps.audit.outputs.pass_rate }}"
            git push origin main
            echo "âœ… å®¡è®¡æŠ¥å‘Šå·²æäº¤"
          else
            echo "â„¹ï¸ å®¡è®¡æŠ¥å‘Šæ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi

      - name: Audit summary
        run: |
          echo "ğŸ¯ Kanban å®¡è®¡å®Œæˆ"
          echo "   çŠ¶æ€: ${{ steps.audit.outputs.audit_status }}"
          echo "   é€šè¿‡ç‡: ${{ steps.audit.outputs.pass_rate }}"
          echo "   PR: #${{ github.event.pull_request.number }}"
          echo "   æäº¤: ${{ github.sha }}"