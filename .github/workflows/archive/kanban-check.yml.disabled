name: Kanban Check

on:
  pull_request:
  push:

jobs:
  check-kanban:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Cache hooks and Kanban file
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            .git/hooks
            docs/_reports/TEST_OPTIMIZATION_KANBAN.md
          key: kanban-check-${{ hashFiles('.git/hooks/*', 'docs/_reports/TEST_OPTIMIZATION_KANBAN.md') }}
          restore-keys: |
            kanban-check-

      - name: Show cache hit status
        run: |
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "âš¡ Cache hit: true (hooks & Kanban æ–‡ä»¶å·²ç¼“å­˜)"
          else
            echo "âš¡ Cache hit: false (é¦–æ¬¡è¿è¡Œæˆ–æ–‡ä»¶å·²å˜åŒ–)"
          fi

      - name: Setup pre-commit hook permissions
        run: make setup-hooks

      - name: Check if Kanban updated
        run: |
          KANBAN_FILE="docs/_reports/TEST_OPTIMIZATION_KANBAN.md"
          REPORT_FILE="docs/_reports/KANBAN_CHECK_REPORT.md"

          # ç¡®ä¿æŠ¥å‘Šç›®å½•å­˜åœ¨
          mkdir -p docs/_reports

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$KANBAN_FILE" ]; then
            echo "âŒ \033[31mKanban æ–‡ä»¶ç¼ºå¤±: $KANBAN_FILE\033[0m"
            echo "ðŸ‘‰ \033[33mè¯·åˆ›å»º Kanban æ–‡ä»¶ä»¥ç»§ç»­\033[0m"
            echo "ðŸ“‹ \033[36mç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š...\033[0m"

            # ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            cat > "$REPORT_FILE" << EOF
# ðŸ“‹ Kanban æ–‡ä»¶æ£€æŸ¥æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: $TIMESTAMP
**CI è¿è¡Œç¼–å·**: $GITHUB_RUN_ID
**æäº¤ SHA**: $GITHUB_SHA

## ðŸš¨ æ£€æŸ¥ç»“æžœ
- çŠ¶æ€: âŒ å¤±è´¥
- åŽŸå› : Kanban æ–‡ä»¶ç¼ºå¤±

## ðŸ“‚ æ–‡ä»¶è·¯å¾„
- docs/_reports/TEST_OPTIMIZATION_KANBAN.md

## ðŸ“Œ æç¤º
ðŸ‘‰ æ¯æ¬¡æäº¤å¿…é¡»åŒæ­¥æ›´æ–° Kanban æ–‡ä»¶ï¼Œä»¥ä¿æŒä»»åŠ¡è¿›åº¦ä¸Žä»£ç ä¸€è‡´ã€‚
EOF

            echo "âœ… \033[32mæ£€æŸ¥æŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE\033[0m"
            exit 1
          fi

          # æ£€æŸ¥ç¼“å­˜æ˜¯å¦å‘½ä¸­ï¼ˆhookså’ŒKanbanæ–‡ä»¶æ˜¯å¦éƒ½æœªå˜åŒ–ï¼‰
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "âœ… \033[32mKanban æœªå˜ï¼Œè·³è¿‡æ£€æŸ¥\033[0m"
            echo "ðŸ“‹ \033[36mç¼“å­˜å‘½ä¸­ï¼Œæ— éœ€é‡å¤éªŒè¯\033[0m"
            exit 0
          fi

          # æ£€æŸ¥æ˜¯å¦åœ¨æœ¬æ¬¡æäº¤é‡Œè¢«ä¿®æ”¹
          if ! git diff --name-only HEAD^ HEAD | grep -q "$KANBAN_FILE"; then
            echo "âŒ \033[31mCI é˜»æ­¢åˆå¹¶: $KANBAN_FILE æœªæ›´æ–°\033[0m"
            echo "ðŸ‘‰ \033[33mæ¯æ¬¡æäº¤å¿…é¡»åŒæ­¥æ›´æ–° Kanban æ–‡ä»¶\033[0m"
            echo "ðŸ’¡ \033[36mæç¤º: è¿è¡Œ 'make context' æŸ¥çœ‹é¡¹ç›®çŠ¶æ€\033[0m"
            echo "ðŸ“‹ \033[36mç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š...\033[0m"

            # ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
            cat > "$REPORT_FILE" << EOF
# ðŸ“‹ Kanban æ–‡ä»¶æ£€æŸ¥æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: \$(date -u +"%Y-%m-%d %H:%M:%S UTC")
**CI è¿è¡Œç¼–å·**: $GITHUB_RUN_ID
**æäº¤ SHA**: $GITHUB_SHA

## ðŸš¨ æ£€æŸ¥ç»“æžœ
- çŠ¶æ€: âŒ å¤±è´¥
- åŽŸå› : Kanban æ–‡ä»¶æœªæ›´æ–°

## ðŸ“‚ æ–‡ä»¶è·¯å¾„
- docs/_reports/TEST_OPTIMIZATION_KANBAN.md

## ðŸ“Œ æç¤º
ðŸ‘‰ æ¯æ¬¡æäº¤å¿…é¡»åŒæ­¥æ›´æ–° Kanban æ–‡ä»¶ï¼Œä»¥ä¿æŒä»»åŠ¡è¿›åº¦ä¸Žä»£ç ä¸€è‡´ã€‚
EOF

            echo "âœ… \033[32mæ£€æŸ¥æŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE\033[0m"
            exit 1
          fi

          echo "âœ… \033[32mKanban æ–‡ä»¶æ£€æŸ¥é€šè¿‡\033[0m"
          echo "ðŸŽ‰ \033[32mCI éªŒè¯æˆåŠŸï¼Œå¯ä»¥ç»§ç»­\033[0m"