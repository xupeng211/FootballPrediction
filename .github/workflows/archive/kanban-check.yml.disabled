name: Kanban Check

on:
  pull_request:
  push:

jobs:
  check-kanban:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Cache hooks and Kanban file
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            .git/hooks
            docs/_reports/TEST_OPTIMIZATION_KANBAN.md
          key: kanban-check-${{ hashFiles('.git/hooks/*', 'docs/_reports/TEST_OPTIMIZATION_KANBAN.md') }}
          restore-keys: |
            kanban-check-

      - name: Show cache hit status
        run: |
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "⚡ Cache hit: true (hooks & Kanban 文件已缓存)"
          else
            echo "⚡ Cache hit: false (首次运行或文件已变化)"
          fi

      - name: Setup pre-commit hook permissions
        run: make setup-hooks

      - name: Check if Kanban updated
        run: |
          KANBAN_FILE="docs/_reports/TEST_OPTIMIZATION_KANBAN.md"
          REPORT_FILE="docs/_reports/KANBAN_CHECK_REPORT.md"

          # 确保报告目录存在
          mkdir -p docs/_reports

          # 检查文件是否存在
          if [ ! -f "$KANBAN_FILE" ]; then
            echo "❌ \033[31mKanban 文件缺失: $KANBAN_FILE\033[0m"
            echo "👉 \033[33m请创建 Kanban 文件以继续\033[0m"
            echo "📋 \033[36m生成检查报告...\033[0m"

            # 生成检查报告
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            cat > "$REPORT_FILE" << EOF
# 📋 Kanban 文件检查报告

**生成时间**: $TIMESTAMP
**CI 运行编号**: $GITHUB_RUN_ID
**提交 SHA**: $GITHUB_SHA

## 🚨 检查结果
- 状态: ❌ 失败
- 原因: Kanban 文件缺失

## 📂 文件路径
- docs/_reports/TEST_OPTIMIZATION_KANBAN.md

## 📌 提示
👉 每次提交必须同步更新 Kanban 文件，以保持任务进度与代码一致。
EOF

            echo "✅ \033[32m检查报告已生成: $REPORT_FILE\033[0m"
            exit 1
          fi

          # 检查缓存是否命中（hooks和Kanban文件是否都未变化）
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "✅ \033[32mKanban 未变，跳过检查\033[0m"
            echo "📋 \033[36m缓存命中，无需重复验证\033[0m"
            exit 0
          fi

          # 检查是否在本次提交里被修改
          if ! git diff --name-only HEAD^ HEAD | grep -q "$KANBAN_FILE"; then
            echo "❌ \033[31mCI 阻止合并: $KANBAN_FILE 未更新\033[0m"
            echo "👉 \033[33m每次提交必须同步更新 Kanban 文件\033[0m"
            echo "💡 \033[36m提示: 运行 'make context' 查看项目状态\033[0m"
            echo "📋 \033[36m生成检查报告...\033[0m"

            # 生成检查报告
            cat > "$REPORT_FILE" << EOF
# 📋 Kanban 文件检查报告

**生成时间**: \$(date -u +"%Y-%m-%d %H:%M:%S UTC")
**CI 运行编号**: $GITHUB_RUN_ID
**提交 SHA**: $GITHUB_SHA

## 🚨 检查结果
- 状态: ❌ 失败
- 原因: Kanban 文件未更新

## 📂 文件路径
- docs/_reports/TEST_OPTIMIZATION_KANBAN.md

## 📌 提示
👉 每次提交必须同步更新 Kanban 文件，以保持任务进度与代码一致。
EOF

            echo "✅ \033[32m检查报告已生成: $REPORT_FILE\033[0m"
            exit 1
          fi

          echo "✅ \033[32mKanban 文件检查通过\033[0m"
          echo "🎉 \033[32mCI 验证成功，可以继续\033[0m"