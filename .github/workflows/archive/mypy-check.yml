# CI/CD MyPyé…ç½® (ä¼˜åŒ–ç‰ˆ)
name: ğŸ” MyPy Type Check (Optimized)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'
  MYPY_CACHE_DIR: '.mypy_cache'

jobs:
  mypy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ’¾ ç¼“å­˜MyPyç»“æœ
        uses: actions/cache@v3
        with:
          path: ${{ env.MYPY_CACHE_DIR }}
          key: ${{ runner.os }}-mypy-${{ hashFiles('**/mypy_*.ini', '**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-mypy-
            ${{ runner.os }}-mypy-${{ hashFiles('**/mypy_*.ini') }}

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install mypy
          pip install -r requirements/requirements.lock

      - name: ğŸ” è¿è¡ŒMyPyç±»å‹æ£€æŸ¥
        run: |
          echo "ğŸ” å¼€å§‹MyPyç±»å‹æ£€æŸ¥..."
          mypy src/ \
            --config-file mypy_minimum.ini \
            --no-error-summary \
            --cache-dir ${{ env.MYPY_CACHE_DIR }} \
            --show-error-codes \
            --show-column-numbers
          echo "âœ… MyPyæ£€æŸ¥å®Œæˆ"

      - name: ğŸ“Š ç”ŸæˆMyPyæŠ¥å‘Š
        if: failure()
        run: |
          mypy src/ \
            --config-file mypy_minimum.ini \
            --cache-dir ${{ env.MYPY_CACHE_DIR }} \
            --html-report mypy-report \
            --junit-xml mypy-report.xml
          echo "ğŸ“‹ MyPyæŠ¥å‘Šå·²ç”Ÿæˆ"

      - name: ğŸ“¤ ä¸Šä¼ MyPyæŠ¥å‘Š
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: mypy-report
          path: |
            mypy-report/
            mypy-report.xml
          retention-days: 7
