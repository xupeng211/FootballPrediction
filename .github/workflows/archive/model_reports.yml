name: Model Performance Reports

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/model_reports.yml'
  schedule:
    # æ¯å¤©æ—©ä¸Š 8:00 UTC (åŒ—äº¬æ—¶é—´ 16:00) ç”ŸæˆæŠ¥è¡¨
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      days_back:
        description: 'åˆ†æå›çœ‹å¤©æ•°'
        required: false
        default: '30'
        type: string
      force_retrain:
        description: 'å¼ºåˆ¶è§¦å‘é‡è®­ç»ƒè¯„ä¼°'
        required: false
        default: false
        type: boolean

env:
  PYTHONPATH: ${{ github.workspace }}
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}

jobs:
  skip-on-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Skip model reports on push
        run: echo "Model performance reports only run on schedule or manual dispatch."

  generate-reports:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: football_prediction_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å‡†å¤‡æŠ¥è¡¨å‚æ•°
      env:
        DAYS_BACK: ${{ github.event.inputs.days_back || '30' }}
        FORCE_RETRAIN: ${{ github.event.inputs.force_retrain || 'false' }}
      run: |
        echo "REPORT_DAYS=${DAYS_BACK}" >> $GITHUB_ENV
        echo "INPUT_FORCE_RETRAIN=${FORCE_RETRAIN}" >> $GITHUB_ENV

    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: è®¾ç½®ç¯å¢ƒå˜é‡
      run: |
        echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/football_prediction_test" >> $GITHUB_ENV
        echo "REDIS_URL=redis://localhost:6379" >> $GITHUB_ENV
        echo "MLFLOW_TRACKING_URI=http://localhost:5002" >> $GITHUB_ENV

    - name: è¿è¡Œæ•°æ®åº“è¿ç§»
      run: |
        alembic upgrade head

    - name: æ›´æ–°é¢„æµ‹ç»“æœ
      run: |
        python scripts/update_predictions_results.py --update --report --trends --days "$REPORT_DAYS" --verbose
      continue-on-error: true

    - name: ç”Ÿæˆæ€§èƒ½æŠ¥è¡¨
      run: |
        python reports/model_performance_report.py --days "$REPORT_DAYS" --output reports/generated --verbose
      continue-on-error: true

    - name: è¿è¡Œè‡ªåŠ¨é‡è®­ç»ƒè¯„ä¼°
      if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && env.INPUT_FORCE_RETRAIN == 'true')
      run: |
        python scripts/retrain_pipeline.py --threshold 0.45 --min-predictions 50 --window-days "$REPORT_DAYS" --verbose
      continue-on-error: true

    - name: è¿è¡Œæ¨¡å‹ç›‘æ§
      run: |
        python -c "
        import asyncio
        from monitoring.enhanced_model_monitor import EnhancedModelMonitor

        async def run_monitoring():
            async with EnhancedModelMonitor() as monitor:
                results = await monitor.run_monitoring_cycle()
                print(f'ç›‘æ§å®Œæˆ: {results[\"models_monitored\"]} ä¸ªæ¨¡å‹')

        asyncio.run(run_monitoring())
        "
      continue-on-error: true

    - name: æ”¶é›†ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        mkdir -p artifacts

        # å¤åˆ¶æŠ¥è¡¨æ–‡ä»¶
        if [ -d "reports/generated" ]; then
          cp -r reports/generated artifacts/
        fi

        # å¤åˆ¶é‡è®­ç»ƒæŠ¥å‘Š
        if [ -d "models/retrain_reports" ]; then
          cp -r models/retrain_reports artifacts/
        fi

        # ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
        echo "# æ¨¡å‹æ€§èƒ½æŠ¥è¡¨ç”Ÿæˆæ€»ç»“" > artifacts/summary.md
        echo "" >> artifacts/summary.md
        echo "**ç”Ÿæˆæ—¶é—´**: $(date)" >> artifacts/summary.md
        echo "**åˆ†æå‘¨æœŸ**: $REPORT_DAYS å¤©" >> artifacts/summary.md
        echo "" >> artifacts/summary.md

        if [ -d "reports/generated" ]; then
          echo "## ğŸ“Š æ€§èƒ½æŠ¥è¡¨" >> artifacts/summary.md
          find reports/generated -name "*.md" -exec basename {} \; | while read file; do
            echo "- [$file](generated/$file)" >> artifacts/summary.md
          done
          echo "" >> artifacts/summary.md
        fi

        if [ -d "models/retrain_reports" ]; then
          echo "## ğŸ”„ é‡è®­ç»ƒæŠ¥å‘Š" >> artifacts/summary.md
          find models/retrain_reports -name "*.md" -exec basename {} \; | while read file; do
            echo "- [$file](../models/retrain_reports/$file)" >> artifacts/summary.md
          done
        fi

    - name: ä¸Šä¼ æŠ¥è¡¨æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: model-reports-${{ github.run_number }}
        path: artifacts/
        retention-days: 30

    - name: å‘é€é€šçŸ¥åˆ° Slack (å¯é€‰)
      if: always() && secrets.SLACK_WEBHOOK_URL
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          æ¨¡å‹æ€§èƒ½æŠ¥è¡¨ç”Ÿæˆå®Œæˆ
          - åˆ†æå‘¨æœŸ: $REPORT_DAYS å¤©
          - çŠ¶æ€: ${{ job.status }}
          - ä¸‹è½½é“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # å¯é€‰çš„éƒ¨ç½²åˆ° GitHub Pages
  deploy-reports:
    needs: generate-reports
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
    - name: ä¸‹è½½æŠ¥è¡¨æ–‡ä»¶
      uses: actions/download-artifact@v4
      with:
        name: model-reports-${{ github.run_number }}
        path: ./reports-site

    - name: è®¾ç½® GitHub Pages
      uses: actions/configure-pages@v3

    - name: æ„å»º Pages ç«™ç‚¹
      run: |
        cd reports-site

        # åˆ›å»ºç®€å•çš„ HTML ç´¢å¼•é¡µ
        cat > index.html << EOF
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>è¶³çƒé¢„æµ‹æ¨¡å‹æ€§èƒ½æŠ¥è¡¨</title>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; }
                h1 { color: #2c3e50; }
                .report-list { list-style: none; padding: 0; }
                .report-item { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                .report-item a { text-decoration: none; color: #3498db; font-weight: bold; }
                .timestamp { color: #7f8c8d; font-size: 0.9em; }
                .chart { margin: 20px 0; }
                .chart img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 5px; }
            </style>
        </head>
        <body>
            <h1>ğŸˆ è¶³çƒé¢„æµ‹æ¨¡å‹æ€§èƒ½æŠ¥è¡¨</h1>
            <p class="timestamp">æœ€åæ›´æ–°: $(date)</p>

            <h2>ğŸ“Š æœ€æ–°æŠ¥è¡¨</h2>
            <ul class="report-list">
        EOF

        # æ·»åŠ  Markdown æŠ¥è¡¨é“¾æ¥
        find . -name "*.md" -type f | sort -r | head -10 | while read file; do
          filename=$(basename "$file")
          echo "                <li class=\"report-item\"><a href=\"$file\">$filename</a></li>" >> index.html
        done

        # æ·»åŠ å›¾è¡¨å±•ç¤º
        echo "            </ul>" >> index.html
        echo "            <h2>ğŸ“ˆ æ€§èƒ½å›¾è¡¨</h2>" >> index.html
        echo "            <div class=\"chart\">" >> index.html

        find . -name "*.png" -type f | head -5 | while read chart; do
          echo "                <img src=\"$chart\" alt=\"Performance Chart\">" >> index.html
        done

        cat >> index.html << EOF
            </div>

            <hr>
            <p><em>æœ¬æŠ¥è¡¨ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ</em></p>
        </body>
        </html>
        EOF

    - name: ä¸Šä¼ åˆ° GitHub Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./reports-site

    - name: éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
