name: Coverage Monitor

on:
  # æ¯å¤©æ—©ä¸Š8ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 8 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # PRæ—¶è¿è¡Œ
  pull_request:
    paths:
      - 'src/api/**'
      - 'tests/unit/api/**'
  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è¿è¡Œ
  push:
    branches:
      - main
      - develop
      - 'hotfix/*'
    paths:
      - 'src/api/**'
      - 'tests/unit/api/**'

jobs:
  coverage-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.local/share/virtualenvs
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
        pip install pytest pytest-cov pytest-mock pytest-asyncio

    - name: Run coverage analysis
      run: |
        cd ${{ github.workspace }}
        python scripts/coverage_monitor.py > coverage_report.txt 2>&1 || true

    - name: Parse coverage results
      id: coverage
      run: |
        if [ -f coverage_report.txt ]; then
          # æå–å¹³å‡è¦†ç›–ç‡
          AVG_COVERAGE=$(grep "ğŸ“ˆ å¹³å‡è¦†ç›–ç‡:" coverage_report.txt | tail -1 | awk '{print $2}' | sed 's/%//')
          echo "average_coverage=$AVG_COVERAGE" >> $GITHUB_OUTPUT

          # æå–éœ€è¦æ”¹è¿›çš„æ¨¡å—
          NEEDS_IMPROVEMENT=$(grep -A1 "ã€HIGHã€‘" coverage_report.txt | grep -v "ã€HIGHã€‘" | grep -v "^--" | wc -l)
          echo "needs_improvement=$NEEDS_IMPROVEMENT" >> $GITHUB_OUTPUT

          # æ˜¾ç¤ºæŠ¥å‘Š
          cat coverage_report.txt
        else
          echo "average_coverage=0" >> $GITHUB_OUTPUT
          echo "needs_improvement=0" >> $GITHUB_OUTPUT
        fi

    - name: Generate coverage badge
      run: |
        AVG=${{ steps.coverage.outputs.average_coverage }}

        # ç¡®å®šé¢œè‰²
        if (( $(echo "$AVG >= 50" | bc -l) )); then
          COLOR="brightgreen"
        elif (( $(echo "$AVG >= 30" | bc -l) )); then
          COLOR="yellow"
        else
          COLOR="red"
        fi

        # ç”Ÿæˆbadge
        echo "![Coverage](https://img.shields.io/badge/coverage-${AVG}%25-${COLOR})" > coverage_badge.md

    - name: Auto boost low coverage modules
      if: steps.coverage.outputs.needs_improvement > 0
      run: |
        echo "ğŸš€ è‡ªåŠ¨æå‡ä½è¦†ç›–ç‡æ¨¡å—..."
        python scripts/auto_boost_coverage.py 2>&1 || true

    - name: Run tests with coverage
      run: |
        python -m pytest tests/unit/api/ -v --cov=src.api --cov-report=xml --cov-report=html --cov-report=term-missing || true

    - name: Upload coverage to Codecov
      if: github.event_name == 'push' || github.event_name == 'pull_request'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: api
        name: api-coverage
        fail_ci_if_error: false

    - name: Comment PR with coverage report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          if (fs.existsSync('coverage_report.txt')) {
            const report = fs.readFileSync('coverage_report.txt', 'utf8');
            const badge = fs.readFileSync('coverage_badge.md', 'utf8');

            const comment = `## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š

            ${badge}

            <details>
            <summary>æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š</summary>

            \`\`\`
            ${report}
            \`\`\`

            </details>

            ---
            *æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

    - name: Update coverage data
      if: github.event_name == 'push'
      run: |
        # æäº¤è‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•ï¼ˆå¦‚æœæœ‰ï¼‰
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add tests/unit/api/test_*.py 2>/dev/null || true
        git add coverage_data.json 2>/dev/null || true

        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ¤– auto: å¢åŠ æµ‹è¯•æå‡è¦†ç›–ç‡

          - ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ
          - è¦†ç›–ç‡: ${{ steps.coverage.outputs.average_coverage }}%

          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

          Co-Authored-By: GitHub Actions <action@github.com>"
          git push
        fi

    - name: Create coverage issue if needed
      if: steps.coverage.outputs.needs_improvement > 0 && github.event_name == 'push'
      uses: actions/github-script@v6
      with:
        script: |
          const avg = '${{ steps.coverage.outputs.average_coverage }}';
          const needs = '${{ steps.coverage.outputs.needs_improvement }}';

          if (parseFloat(avg) < 30) {
            const title = `ğŸ“‰ æµ‹è¯•è¦†ç›–ç‡åä½: ${avg}%`;
            const body = `## æµ‹è¯•è¦†ç›–ç‡è­¦å‘Š

            å½“å‰APIæ¨¡å—çš„æµ‹è¯•è¦†ç›–ç‡ä¸º **${avg}%**ï¼Œä½äºç›®æ ‡çš„30%ã€‚

            ### ğŸ“Š éœ€è¦æ”¹è¿›çš„æ¨¡å—æ•°é‡: ${needs}

            ### ğŸ”§ å»ºè®®è¡ŒåŠ¨:
            1. è¿è¡Œ \`python scripts/auto_boost_coverage.py\` è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•
            2. ä¸º0è¦†ç›–ç‡æ¨¡å—åˆ›å»ºåŸºç¡€æµ‹è¯•
            3. è¡¥å……ç°æœ‰æµ‹è¯•çš„è¾¹ç•Œæ¡ä»¶æµ‹è¯•
            4. ä¿®å¤æ— æ³•è¿è¡Œçš„æµ‹è¯•

            ### ğŸ“ˆ ç›®æ ‡:
            - çŸ­æœŸ: æå‡åˆ°30%+
            - ä¸­æœŸ: æå‡åˆ°50%+
            - é•¿æœŸ: è¾¾åˆ°80%+

            ---
            *æ­¤Issueç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`;

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['coverage'],
              state: 'open'
            });

            const exists = issues.data.some(issue =>
              issue.title.includes('æµ‹è¯•è¦†ç›–ç‡åä½')
            );

            if (!exists) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['coverage', 'improvement']
              });
            }
          }

    - name: Archive coverage reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-reports
        path: |
          coverage_report.txt
          coverage_badge.md
          htmlcov/
          coverage_data.json
        retention-days: 30