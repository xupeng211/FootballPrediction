name: æµ‹è¯•è¦†ç›–ç‡å±æœºç›‘æ§

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©UTC 8:00æ£€æŸ¥ä¸€æ¬¡
    - cron: '0 8 * * *'

jobs:
  crisis-monitor:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov

    - name: è¿è¡Œå±æœºä¿®å¤è„šæœ¬
      run: python scripts/fix_test_crisis.py

    - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      run: |
        python -m pytest --cov=src --cov-report=html --cov-report=xml --maxfail=5

    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/

    - name: æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼
      run: |
        COVERAGE=$(python -c "
import xml.etree.ElementTree as ET
try:
    tree = ET.parse('coverage.xml')
    root = tree.getroot()
    coverage = float(root.attrib.get('line-rate', 0)) * 100
    print(coverage)
except:
    print(0)
")

        echo "å½“å‰è¦†ç›–ç‡: $COVERAGE%"

        if (( $(echo "$COVERAGE < 15" | bc -l) )); then
          echo "âŒ è¦†ç›–ç‡ä½äº15%ï¼Œéœ€è¦ç´§æ€¥å…³æ³¨"
          exit 1
        elif (( $(echo "$COVERAGE < 30" | bc -l) )); then
          echo "âš ï¸ è¦†ç›–ç‡ä½äº30%ï¼Œéœ€è¦æ”¹è¿›"
        else
          echo "âœ… è¦†ç›–ç‡è‰¯å¥½"
        fi

    - name: æ›´æ–°çŠ¶æ€æŠ¥å‘Š
      run: python scripts/github_issue_manager.py --generate-report

    - name: åˆ›å»ºæˆ–æ›´æ–°Issue
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('crisis_status_report.md', 'utf8');

          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: "ğŸš¨ æµ‹è¯•è¦†ç›–ç‡è­¦æŠ¥ - " + new Date().toISOString().split('T')[0],
            body: report,
            labels: ['testing', 'coverage', 'critical', 'auto-generated']
          });
