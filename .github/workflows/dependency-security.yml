name: ä¾èµ–å®‰å…¨æ‰«æ

on:
  push:
    branches: [ main, develop, hotfix/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8:00 è¿è¡Œ
    - cron: '0 8 * * 1'

env:
  PYTHON_VERSION: '3.11'

jobs:
  dependency-security:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ç¼“å­˜ pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pip-audit safety
        pip install -r requirements-minimal.txt 2>/dev/null || true

    - name: è¿è¡Œ pip-audit æ‰«æ
      id: audit
      run: |
        echo "è¿è¡Œ pip-audit ä¾èµ–å®‰å…¨æ‰«æ..."
        pip-audit --format json --output vulnerability-report.json || true

        # æ£€æŸ¥æ˜¯å¦æœ‰é«˜å±æ¼æ´
        if [ -f vulnerability-report.json ]; then
          HIGH_VULNS=$(jq -r '.dependencies[] | select(.vulns != []) | .vulns[] | select(.id | startswith("GHSA-")) | .id' vulnerability-report.json | wc -l || echo "0")
          CRITICAL_VULNS=$(jq -r '.dependencies[] | select(.vulns != []) | .vulns[] | select(.id | startswith("CVE-")) | .id' vulnerability-report.json | wc -l || echo "0")

          echo "high-vulnerabilities=$HIGH_VULNS" >> $GITHUB_OUTPUT
          echo "critical-vulnerabilities=$CRITICAL_VULNS" >> $GITHUB_OUTPUT

          if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âŒ å‘ç°é«˜å±æˆ–ä¸¥é‡æ¼æ´ï¼"
            pip-audit
            exit 1
          fi
        fi

    - name: ä¸Šä¼ æ¼æ´æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: vulnerability-report
        path: vulnerability-report.json

    - name: è¿è¡Œ MLflow å®‰å…¨å®¡è®¡
      run: |
        echo "è¿è¡Œ MLflow å®‰å…¨å®¡è®¡..."
        python scripts/security/mlflow_audit.py --project-root . --output mlflow-security-report.md || true

        # æ£€æŸ¥é«˜å±é—®é¢˜
        HIGH_ISSUES=$(grep -c "ğŸš¨ é«˜å±é—®é¢˜:" mlflow-security-report.md || echo "0")
        if [ "$HIGH_ISSUES" -gt 0 ]; then
          echo "âŒ å‘ç° MLflow é«˜å±å®‰å…¨é—®é¢˜ï¼"
          cat mlflow-security-report.md
          exit 1
        fi

    - name: ä¸Šä¼  MLflow å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: mlflow-security-report
        path: mlflow-security-report.md

    - name: åˆ›å»ºå®‰å…¨ Issueï¼ˆå¦‚æœå‘ç°é—®é¢˜ï¼‰
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          // è¯»å–æ¼æ´æŠ¥å‘Š
          let vulnerabilityText = '';
          if (fs.existsSync('vulnerability-report.json')) {
            const report = JSON.parse(fs.readFileSync('vulnerability-report.json', 'utf8'));
            const vulns = report.dependencies.filter(d => d.vulns && d.vulns.length > 0);
            if (vulns.length > 0) {
              vulnerabilityText = '\n### ğŸš¨ å‘ç°çš„ä¾èµ–æ¼æ´\n\n';
              vulns.forEach(vuln => {
                vuln.vulns.forEach(v => {
                  vulnerabilityText += `- **${vuln.name}**: ${v.id} (${v.aliases?.join(', ') || ''})\n`;
                  vulnerabilityText += `  - ä¸¥é‡æ€§: ${v.id.includes('CRITICAL') ? 'ä¸¥é‡' : v.id.includes('HIGH') ? 'é«˜å±' : 'ä¸­å±'}\n`;
                  vulnerabilityText += `  - æè¿°: ${v.description?.substring(0, 200)}...\n\n`;
                });
              });
            }
          }

          // è¯»å– MLflow å®‰å…¨æŠ¥å‘Š
          let mlflowText = '';
          if (fs.existsSync('mlflow-security-report.md')) {
            const report = fs.readFileSync('mlflow-security-report.md', 'utf8');
            if (report.includes('ğŸš¨ é«˜å±é—®é¢˜:')) {
              mlflowText = '\n### ğŸ” MLflow å®‰å…¨é—®é¢˜\n\nè¯·æŸ¥çœ‹ [MLflow å®‰å…¨æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚\n';
            }
          }

          if (vulnerabilityText || mlflowText) {
            const title = `ğŸ”’ å®‰å…¨æ‰«æå‘ç°é—®é¢˜ - ${new Date().toISOString().split('T')[0]}`;
            const body = `## å®‰å…¨æ‰«ææŠ¥å‘Š

            æ‰«ææ—¶é—´: ${new Date().toISOString()}
            åˆ†æ”¯: ${{ github.ref_name }}
            æäº¤: ${{ github.sha }}

            ${vulnerabilityText}
            ${mlflowText}

            ### ğŸ“‹ ä¿®å¤å»ºè®®

            1. ç«‹å³å‡çº§æœ‰æ¼æ´çš„ä¾èµ–åŒ…
            2. å¯¹äºæ— æ³•å‡çº§çš„ä¾èµ–ï¼Œè¯„ä¼°é£é™©å¹¶å®æ–½ç¼“è§£æªæ–½
            3. æ›´æ–° SECURITY_RISK_ACCEPTED.md æ–‡æ¡£
            4. åœ¨ CI ä¸­é˜»æ­¢å¼•å…¥æ–°çš„é«˜å±ä¾èµ–

            ---
            æ­¤ Issue ç”±è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æåˆ›å»ºã€‚`;

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„ Issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security']
            });

            const hasSimilarIssue = existingIssues.data.some(issue =>
              issue.title.includes('å®‰å…¨æ‰«æå‘ç°é—®é¢˜') &&
              issue.title.includes(new Date().toISOString().split('T')[0])
            );

            if (!hasSimilarIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'high-priority']
              });
            }
          }

    - name: é€šçŸ¥å®‰å…¨å›¢é˜Ÿï¼ˆå¦‚æœæœ‰ä¸¥é‡æ¼æ´ï¼‰
      if: failure() && (steps.audit.outputs.critical-vulnerabilities > 0)
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |
          ğŸš¨ å‘ç°ä¸¥é‡ä¾èµ–æ¼æ´ï¼

          åˆ†æ”¯: ${{ github.ref_name }}
          æäº¤: ${{ github.sha }}
          ä¸¥é‡æ¼æ´æ•°: ${{ steps.audit.outputs.critical-vulnerabilities }}
          é«˜å±æ¼æ´æ•°: ${{ steps.audit.outputs.high-vulnerabilities }}

          è¯·ç«‹å³æŸ¥çœ‹å¹¶ä¿®å¤å®‰å…¨é—®é¢˜ã€‚
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_SLACK_WEBHOOK }}