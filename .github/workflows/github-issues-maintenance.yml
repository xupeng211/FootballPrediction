name: GitHub Issues Maintenance

on:
  schedule:
    # 每周一早上8点运行
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'schedule'
        type: choice
        options:
        - schedule
        - health
        - cleanup
        - labels
      dry_run:
        description: 'Dry run mode only'
        required: false
        default: true
        type: boolean
      limit:
        description: 'Issue processing limit'
        required: false
        default: '10'
        type: string

jobs:
  maintain-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests aiosqlite

    - name: Validate GitHub CLI authentication
      run: |
        echo "Checking GitHub CLI authentication..."
        gh auth status
        if [ $? -ne 0 ]; then
          echo "GitHub CLI authentication failed"
          exit 1
        fi
        echo "GitHub CLI authentication successful"

    - name: Run GitHub Issues maintenance
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ACTION: ${{ github.event.inputs.action || 'schedule' }}
        DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
        LIMIT: ${{ github.event.inputs.limit || '10' }}
      run: |
        echo "Starting GitHub Issues maintenance..."
        echo "Action: $ACTION"
        echo "Dry-run: $DRY_RUN"
        echo "Limit: $LIMIT"

        # Create reports directory
        mkdir -p reports

        case $ACTION in
          "health")
            echo "Executing health check..."
            python3 scripts/github_issues_lifecycle_manager.py health
            ;;
          "cleanup")
            echo "Executing Issues cleanup..."
            if [ "$DRY_RUN" = "true" ]; then
              python3 scripts/github_issues_lifecycle_manager.py cleanup --dry-run --limit $LIMIT
            else
              python3 scripts/github_issues_lifecycle_manager.py cleanup --limit $LIMIT
            fi
            ;;
          "labels")
            echo "Executing label optimization..."
            if [ "$DRY_RUN" = "true" ]; then
              python3 scripts/github_issues_lifecycle_manager.py labels --dry-run
            else
              python3 scripts/github_issues_lifecycle_manager.py labels
            fi
            ;;
          "schedule"|*)
            echo "Executing scheduled maintenance..."
            python3 scripts/automate_github_issues_cleanup.py
            ;;
        esac

    - name: Generate maintenance report
      if: always()
      run: |
        echo "Generating maintenance report..."
        REPORT_FILE="reports/maintenance-report-$(date +%Y%m%d-%H%M%S).md"

        echo "# GitHub Issues Maintenance Report" > $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "## Execution Time" >> $REPORT_FILE
        echo "$(date)" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "## Execution Environment" >> $REPORT_FILE
        echo "- Repository: ${{ github.repository }}" >> $REPORT_FILE
        echo "- Branch: ${{ github.ref_name }}" >> $REPORT_FILE
        echo "- Action: ${{ github.event.inputs.action || 'schedule' }}" >> $REPORT_FILE
        echo "- Dry-run: ${{ github.event.inputs.dry_run || 'true' }}" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "## Executed Steps" >> $REPORT_FILE
        echo "1. Code checkout completed" >> $REPORT_FILE
        echo "2. Python environment setup completed" >> $REPORT_FILE
        echo "3. GitHub CLI authentication verified" >> $REPORT_FILE
        echo "4. Maintenance task execution completed" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "## Maintenance Results" >> $REPORT_FILE
        echo "Please review the detailed output from the previous step for specific maintenance results." >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "---" >> $REPORT_FILE
        echo "Generated by GitHub Actions" >> $REPORT_FILE

        echo "Maintenance report generated: $REPORT_FILE"

    - name: Upload maintenance artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: maintenance-reports
        path: reports/
        retention-days: 30

    - name: Create Issue for manual action
      if: failure() && github.event_name == 'workflow_dispatch'
      run: |
        gh issue create \
          --title "GitHub Issues Maintenance Failed" \
          --body "GitHub Issues maintenance task failed at $(date).

        **Failure Information:**
        - Workflow: ${{ github.workflow }}
        - Run ID: ${{ github.run_id }}
        - Action: ${{ github.event.inputs.action }}
        - Dry-run: ${{ github.event.inputs.dry_run }}

        Please check workflow logs for detailed error information." \
          --label "maintenance" \
          --label "failed" \
          --label "priority-high" || echo "Issue creation failed"