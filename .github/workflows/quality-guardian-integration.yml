name: ğŸ›¡ï¸ è´¨é‡å®ˆæŠ¤ç³»ç»Ÿé›†æˆ

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'scripts/quality_*.py'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡è´¨é‡æ£€æŸ¥
    - cron: '0 * * * *'

env:
  PYTHON_VERSION: '3.11'
  QUALITY_REPORT_DIR: 'quality_reports'

jobs:
  # è´¨é‡å®ˆæŠ¤ç³»ç»Ÿå®Œæ•´æ£€æŸ¥
  comprehensive-quality-check:
    name: ğŸ›¡ï¸ å…¨é¢è´¨é‡å®ˆæŠ¤æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            requirements/requirements.lock
            pyproject.toml

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements/requirements.lock
          pip install ruff mypy bandit pip-audit pytest pytest-cov

      - name: ğŸ“ åˆ›å»ºè´¨é‡æŠ¥å‘Šç›®å½•
        run: mkdir -p ${{ env.QUALITY_REPORT_DIR }}

      - name: ğŸ›¡ï¸ è¿è¡Œè´¨é‡å®ˆæŠ¤ç³»ç»Ÿ
        env:
          REPORT_FORMAT: json
          REPORT_OUTPUT: ${{ env.QUALITY_REPORT_DIR }}/quality_guardian_report.json
        run: |
          echo "ğŸ›¡ï¸ å¯åŠ¨è´¨é‡å®ˆæŠ¤ç³»ç»Ÿ..."
          python3 scripts/quality_guardian.py --check-only --format json --output "$REPORT_OUTPUT"

      - name: ğŸ”§ æ™ºèƒ½ä¿®å¤å°è¯•
        if: failure()
        run: |
          echo "ğŸ”§ å°è¯•æ™ºèƒ½ä¿®å¤..."
          python3 scripts/smart_quality_fixer.py --auto-fix || true

      - name: ğŸ“Š ç”Ÿæˆè´¨é‡è¯„åˆ†
        run: |
          echo "ğŸ“Š è®¡ç®—è´¨é‡è¯„åˆ†..."
          python3 -c "
import json
import os

report_file = '${{ env.QUALITY_REPORT_DIR }}/quality_guardian_report.json'
if os.path.exists(report_file):
    with open(report_file, 'r') as f:
        report = json.load(f)

    # è®¡ç®—ç»¼åˆè´¨é‡è¯„åˆ†
    scores = []
    if 'syntax' in report:
        scores.append(100 if report['syntax']['passed'] else 0)
    if 'style' in report:
        scores.append(report['style'].get('score', 0))
    if 'type_check' in report:
        scores.append(report['type_check'].get('score', 0))
    if 'security' in report:
        scores.append(report['security'].get('score', 0))

    overall_score = sum(scores) / len(scores) if scores else 0

    # ç”Ÿæˆè¯„åˆ†æŠ¥å‘Š
    score_report = {
        'timestamp': '${{ github.run_started_at }}',
        'commit': '${{ github.sha }}',
        'overall_score': round(overall_score, 2),
        'detailed_scores': {
            'syntax': report.get('syntax', {}).get('score', 0),
            'style': report.get('style', {}).get('score', 0),
            'type_check': report.get('type_check', {}).get('score', 0),
            'security': report.get('security', {}).get('score', 0)
        },
        'recommendations': []
    }

    # æ·»åŠ å»ºè®®
    if overall_score < 80:
        score_report['recommendations'].append('å»ºè®®è¿è¡Œæ™ºèƒ½ä¿®å¤å·¥å…·')
    if overall_score < 60:
        score_report['recommendations'].append('å»ºè®®æ‰‹åŠ¨å®¡æŸ¥ä»£ç è´¨é‡')

    with open('${{ env.QUALITY_REPORT_DIR }}/quality_score.json', 'w') as f:
        json.dump(score_report, f, indent=2)

    print(f'ğŸ¯ è´¨é‡è¯„åˆ†: {overall_score:.2f}/100')
    "

      - name: ğŸ“¤ ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-guardian-reports
          path: ${{ env.QUALITY_REPORT_DIR }}/
          retention-days: 30

      - name: ğŸ’¬ è´¨é‡æ£€æŸ¥è¯„è®º (PR)
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "ğŸ’¬ ç”ŸæˆPRè´¨é‡æ£€æŸ¥è¯„è®º..."

          if [ -f "${{ env.QUALITY_REPORT_DIR }}/quality_score.json" ]; then
            python3 -c "
import json

with open('${{ env.QUALITY_REPORT_DIR }}/quality_score.json', 'r') as f:
    score_report = json.load(f)

score = score_report['overall_score']
emoji = 'ğŸŸ¢' if score >= 80 else 'ğŸŸ¡' if score >= 60 else 'ğŸ”´'

comment = f'''## ğŸ›¡ï¸ è´¨é‡å®ˆæŠ¤ç³»ç»Ÿæ£€æŸ¥æŠ¥å‘Š

{emoji} **ç»¼åˆè´¨é‡è¯„åˆ†**: {score}/100

### ğŸ“Š è¯¦ç»†è¯„åˆ†
- **è¯­æ³•æ£€æŸ¥**: {score_report['detailed_scores']['score']}/100
- **ä»£ç é£æ ¼**: {score_report['detailed_scores']['style']}/100
- **ç±»å‹æ£€æŸ¥**: {score_report['detailed_scores']['type_check']}/100
- **å®‰å…¨æ£€æŸ¥**: {score_report['detailed_scores']['security']}/100

### ğŸ”§ AIç¼–ç¨‹åŠ©æ‰‹å»ºè®®
'''

for rec in score_report['recommendations']:
    comment += f'- {rec}\n'

comment += '''
### ğŸ“‹ è´¨é‡æå‡æ­¥éª¤
1. è¿è¡Œæœ¬åœ°æ£€æŸ¥: `python3 scripts/quality_guardian.py --check-only`
2. å°è¯•è‡ªåŠ¨ä¿®å¤: `python3 scripts/smart_quality_fixer.py`
3. éªŒè¯ä¿®å¤æ•ˆæœ: `python3 scripts/improvement_monitor.py`

---
*ğŸ›¡ï¸ æ­¤æŠ¥å‘Šç”±è´¨é‡å®ˆæŠ¤ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*
'''

with open('quality_comment.md', 'w') as f:
    f.write(comment)
"

            gh pr comment "$PR_NUMBER" --body "$(cat quality_comment.md)"
          fi

  # æŒç»­æ”¹è¿›å¼•æ“é›†æˆ
  continuous-improvement:
    name: ğŸ”„ æŒç»­æ”¹è¿›å¼•æ“
    runs-on: ubuntu-latest
    needs: comprehensive-quality-check
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            requirements/requirements.lock
            pyproject.toml

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements/requirements.lock

      - name: ğŸ”„ è¿è¡ŒæŒç»­æ”¹è¿›å¼•æ“
        env:
          IMPROVEMENT_MODE: 'automated'
          ANALYSIS_DEPTH: 'comprehensive'
        run: |
          echo "ğŸ”„ å¯åŠ¨æŒç»­æ”¹è¿›å¼•æ“..."
          python3 scripts/continuous_improvement_engine.py \
            --automated \
            --analysis-depth comprehensive \
            --generate-report || true

      - name: ğŸ“Š ç”Ÿæˆæ”¹è¿›æŠ¥å‘Š
        run: |
          echo "ğŸ“Š ç”Ÿæˆæ”¹è¿›æŠ¥å‘Š..."
          python3 scripts/improvement_monitor.py --export-formats json,markdown || true

      - name: ğŸ“¤ ä¸Šä¼ æ”¹è¿›æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: continuous-improvement-reports
          path: |
            improvement_reports/
            continuous_improvement_*.json
          retention-days: 30

  # AIç¼–ç¨‹åŠ©æ‰‹å‹å¥½æ€§æ£€æŸ¥
  ai-programming-friendliness:
    name: ğŸ¤– AIç¼–ç¨‹å‹å¥½æ€§æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements/requirements.lock

      - name: ğŸ¤– AIç¼–ç¨‹å‹å¥½æ€§æ£€æŸ¥
        run: |
          echo "ğŸ¤– æ£€æŸ¥AIç¼–ç¨‹å‹å¥½æ€§..."

          # æ£€æŸ¥å…³é”®è„šæœ¬
          ai_scripts=(
            "scripts/quality_guardian.py"
            "scripts/smart_quality_fixer.py"
            "scripts/improvement_monitor.py"
            "scripts/ai_issue_analyzer.py"
            "scripts/ci_performance_monitor.py"
          )

          missing_scripts=()
          for script in "${ai_scripts[@]}"; do
            if [ ! -f "$script" ]; then
              missing_scripts+=("$script")
            fi
          done

          if [ ${#missing_scripts[@]} -gt 0 ]; then
            echo "âŒ ç¼ºå¤±AIç¼–ç¨‹è„šæœ¬:"
            printf '%s\n' "${missing_scripts[@]}"
            exit 1
          fi

          # æ£€æŸ¥å·¥ä½œæµ
          ai_workflows=(
            ".github/workflows/ai-feedback.yml"
            ".github/workflows/project-health-monitor.yml"
            ".github/workflows/issue-tracking-pipeline.yml"
          )

          missing_workflows=()
          for workflow in "${ai_workflows[@]}"; do
            if [ ! -f "$workflow" ]; then
              missing_workflows+=("$workflow")
            fi
          done

          if [ ${#missing_workflows[@]} -gt 0 ]; then
            echo "âŒ ç¼ºå¤±AIç¼–ç¨‹å·¥ä½œæµ:"
            printf '%s\n' "${missing_workflows[@]}"
            exit 1
          fi

          echo "âœ… AIç¼–ç¨‹å‹å¥½æ€§æ£€æŸ¥é€šè¿‡"

      - name: ğŸ“š ç”ŸæˆAIç¼–ç¨‹æŒ‡å—
        run: |
          echo "ğŸ“š ç”ŸæˆAIç¼–ç¨‹ä½¿ç”¨æŒ‡å—..."
          python3 -c "
import json
from datetime import datetime

# ç”ŸæˆAIç¼–ç¨‹å¿«é€ŸæŒ‡å—
guide = '''# ğŸ¤– AIç¼–ç¨‹åŠ©æ‰‹å¿«é€Ÿä½¿ç”¨æŒ‡å—

**ç”Ÿæˆæ—¶é—´**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

## ğŸš€ Claude Code å¿«é€Ÿå¯åŠ¨

### ä»£ç ä¿®æ”¹åç«‹å³æ‰§è¡Œ
\`\`\`bash
# 1. è¯­æ³•æ£€æŸ¥
python3 scripts/smart_quality_fixer.py --syntax-only

# 2. å…¨é¢è´¨é‡æ£€æŸ¥
python3 scripts/quality_guardian.py --check-only

# 3. æ™ºèƒ½ä¿®å¤å‘ç°é—®é¢˜
python3 scripts/smart_quality_fixer.py

# 4. éªŒè¯ä¿®å¤æ•ˆæœ
python3 scripts/improvement_monitor.py
\`\`\`

### æ‰¹é‡ä»£ç ä¿®æ”¹åå¤„ç†
\`\`\`bash
# è¿è¡Œå®Œæ•´æ”¹è¿›å‘¨æœŸ
./scripts/start_improvement.sh

# æˆ–å¯åŠ¨è‡ªåŠ¨åŒ–æ”¹è¿›
python3 scripts/continuous_improvement_engine.py --automated --interval 30

# ç›‘æ§æ”¹è¿›çŠ¶æ€
python3 scripts/improvement_monitor.py
\`\`\`

### æ¯æ—¥å¼€å‘å‰æ£€æŸ¥æ¸…å•
- [ ] è¿è¡Œè´¨é‡çŠ¶æ€æ£€æŸ¥: \`python3 scripts/quality_guardian.py --check-only\`
- [ ] æ£€æŸ¥æ”¹è¿›è¶‹åŠ¿: \`python3 scripts/improvement_monitor.py\`
- [ ] éªŒè¯ç¯å¢ƒå¥åº·: \`make env-check\`
- [ ] è¿è¡Œå¿«é€Ÿæµ‹è¯•: \`make test-quick\`

### æäº¤å‰æœ€ç»ˆéªŒè¯
\`\`\`bash
# å®Œæ•´é¢„æ¨é€éªŒè¯
make prepush

# æˆ–æ‰‹åŠ¨æ‰§è¡Œ
python3 scripts/quality_guardian.py --check-only
python3 scripts/smart_quality_fixer.py
python3 scripts/improvement_monitor.py
make test-quick
\`\`\`

## ğŸ›¡ï¸ è´¨é‡å®ˆæŠ¤ç³»ç»Ÿ

### æ ¸å¿ƒç»„ä»¶
1. **è´¨é‡å®ˆæŠ¤å™¨** (\`scripts/quality_guardian.py\`) - å…¨é¢è´¨é‡æ£€æŸ¥
2. **æ™ºèƒ½ä¿®å¤å™¨** (\`scripts/smart_quality_fixer.py\`) - è‡ªåŠ¨é—®é¢˜ä¿®å¤
3. **æ”¹è¿›ç›‘æ§å™¨** (\`scripts/improvement_monitor.py\`) - æ”¹è¿›çŠ¶æ€è·Ÿè¸ª
4. **æŒç»­æ”¹è¿›å¼•æ“** (\`scripts/continuous_improvement_engine.py\`) - è‡ªåŠ¨åŒ–æ”¹è¿›

### ä½¿ç”¨å»ºè®®
- ä»£ç ä¿®æ”¹åå§‹ç»ˆè¿è¡Œè´¨é‡æ£€æŸ¥
- ä¿¡ä»»æ™ºèƒ½ä¿®å¤å™¨çš„å»ºè®®
- å…³æ³¨æ”¹è¿›ç›‘æ§å™¨çš„è¶‹åŠ¿
- åˆ©ç”¨æŒç»­æ”¹è¿›å¼•æ“è¿›è¡Œè‡ªåŠ¨åŒ–ä¼˜åŒ–

---
*ğŸ“š æ­¤æŒ‡å—ç”±AIç¼–ç¨‹å‹å¥½æ€§æ£€æŸ¥è‡ªåŠ¨ç”Ÿæˆ*
'''

with open('AI_PROGRAMMING_GUIDE.md', 'w') as f:
    f.write(guide)

print('ğŸ“š AIç¼–ç¨‹æŒ‡å—å·²ç”Ÿæˆ')
"

      - name: ğŸ“¤ ä¸Šä¼ AIç¼–ç¨‹æŒ‡å—
        uses: actions/upload-artifact@v4
        with:
          name: ai-programming-guide
          path: AI_PROGRAMMING_GUIDE.md
          retention-days: 7