name: GitHub Issueså®šæœŸæ¸…ç†

on:
  # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è‡ªåŠ¨æ‰§è¡Œ
  schedule:
    - cron: '0 8 * * 1'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'è¯•è¿è¡Œæ¨¡å¼ (ä¸å®é™…ä¿®æ”¹Issues)'
        required: false
        default: 'true'
        type: boolean
      execute_cleanup:
        description: 'æ‰§è¡Œå®é™…æ¸…ç†æ“ä½œ'
        required: false
        default: 'false'
        type: boolean

jobs:
  # Issuesæ¸…ç†ä»»åŠ¡
  cleanup-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: éªŒè¯GitHub CLI
        run: |
          gh --version
          echo "âœ… GitHub CLIå·²å®‰è£…"

      - name: åˆ›å»ºæŠ¥å‘Šç›®å½•
        run: |
          mkdir -p reports

      - name: è¿è¡Œæ¯å‘¨Issueæ¸…ç†
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç¡®å®šè¿è¡Œæ¨¡å¼
          if [ "${{ github.event.inputs.execute_cleanup }}" = "true" ]; then
            echo "ğŸ”§ æ‰§è¡Œæ¨¡å¼ - å°†å®é™…æ¸…ç†Issues"
            python scripts/weekly_issues_cleanup.py --repo ${{ github.repository }} --execute
          else
            echo "ğŸ” è¯•è¿è¡Œæ¨¡å¼ - ä»…ç”ŸæˆæŠ¥å‘Š"
            python scripts/weekly_issues_cleanup.py --repo ${{ github.repository }} --dry-run
          fi

      - name: è¿è¡Œæ ‡ç­¾ä¿®æ­£
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç¡®å®šè¿è¡Œæ¨¡å¼
          if [ "${{ github.event.inputs.execute_cleanup }}" = "true" ]; then
            echo "ğŸ”§ æ‰§è¡Œæ¨¡å¼ - å°†å®é™…ä¿®æ­£æ ‡ç­¾"
            python scripts/github_label_fixer.py --repo ${{ github.repository }} --execute
          else
            echo "ğŸ” è¯•è¿è¡Œæ¨¡å¼ - ä»…ç”ŸæˆæŠ¥å‘Š"
            python scripts/github_label_fixer.py --repo ${{ github.repository }} --dry-run
          fi

      - name: ç”Ÿæˆç»¼åˆæŠ¥å‘Š
        run: |
          python scripts/generate_cleanup_summary.py --repo ${{ github.repository }}

      - name: ä¸Šä¼ æ¸…ç†æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cleanup-reports-${{ github.run_number }}
          path: |
            reports/weekly_issues_cleanup_*.md
            reports/github_label_fix_report.md
            reports/cleanup_summary_report.md
          retention-days: 30

      - name: åˆ›å»ºIssueå¹¶é™„åŠ æŠ¥å‘Š (å¦‚æœå‘ç°é—®é¢˜)
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            try {
              const cleanupReport = fs.readFileSync('reports/github_issues_cleanup_report.md', 'utf8');
              const labelReport = fs.readFileSync('reports/github_label_fix_report.md', 'utf8');

              const issueBody = `
## ğŸš¨ GitHub Issuesæ¸…ç†ä»»åŠ¡å‘ç°é—®é¢˜

**æ‰§è¡Œæ—¶é—´**: ${new Date().toISOString()}
**å·¥ä½œæµè¿è¡Œ**: #${{ github.run_number }}
**ä»“åº“**: ${{ github.repository }}

### ğŸ“‹ Issuesæ¸…ç†æŠ¥å‘Š
${cleanupReport}

### ğŸ·ï¸ æ ‡ç­¾ä¿®æ­£æŠ¥å‘Š
${labelReport}

### ğŸ”§ éœ€è¦äººå·¥å¤„ç†
è¯·æŸ¥çœ‹ä¸Šè¿°æŠ¥å‘Šï¼Œæ‰‹åŠ¨å¤„ç†éœ€è¦å¹²é¢„çš„Issuesã€‚

---
*æ­¤Issueç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*
              `;

              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸš¨ GitHub Issuesæ¸…ç†å‘ç°é—®é¢˜ - éœ€è¦äººå·¥å¤„ç†',
                body: issueBody,
                labels: ['maintenance', 'automated', 'priority/medium']
              });

            } catch (error) {
              console.log('æ— æ³•è¯»å–æŠ¥å‘Šæ–‡ä»¶:', error.message);
            }

  # æ¯æœˆæ·±åº¦æ¸…ç†ä»»åŠ¡
  deep-cleanup:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    # æ¯æœˆ1å·æ‰§è¡Œ
    if: github.event_name == 'schedule' && github.event.schedule == '0 8 1 * *'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: è¿è¡Œæ·±åº¦æ¸…ç†
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ§¹ å¼€å§‹æœˆåº¦æ·±åº¦æ¸…ç†..."
          python scripts/deep_cleanup.py --repo ${{ github.repository }} --execute

      - name: ç”Ÿæˆæœˆåº¦æŠ¥å‘Š
        run: |
          python scripts/generate_monthly_report.py --repo ${{ github.repository }}

  # Issueç”Ÿå‘½å‘¨æœŸç›‘æ§
  lifecycle-monitoring:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      contents: read

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: è¿è¡Œç”Ÿå‘½å‘¨æœŸç›‘æ§
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“Š åˆ†æIssueç”Ÿå‘½å‘¨æœŸ..."
          python scripts/issue_lifecycle_monitor.py --repo ${{ github.repository }}

      - name: æ›´æ–°ç”Ÿå‘½å‘¨æœŸä»ªè¡¨æ¿
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ“ˆ æ›´æ–°ç”Ÿå‘½å‘¨æœŸä»ªè¡¨æ¿..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ–°READMEæˆ–Wikiçš„ä»£ç 