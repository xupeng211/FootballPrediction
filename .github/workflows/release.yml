name: ğŸš€ Release Automation

on:
  # å½“æ¨é€åŒ…å«ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - 'v*'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•å‘å¸ƒæµç¨‹ï¼‰
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_notes:
        description: 'Release notes'
        required: false
        default: 'Automated release'

# ç¡®ä¿åŒæ—¶åªè¿è¡Œä¸€ä¸ªå‘å¸ƒå·¥ä½œæµ
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  create-release:
    name: ğŸ·ï¸ Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»ºRelease
      contents: write
      # éœ€è¦å†™å…¥æƒé™æ¥ç®¡ç†GitHub Packages
      packages: write

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬åˆ†æ
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine wheel setuptools
          # å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆç”¨äºéªŒè¯ï¼‰
          pip install -e ".[dev]"

      - name: ğŸ” Verify Package Build
        run: |
          echo "ğŸ” Verifying package build..."
          python -m build --version
          # æ£€æŸ¥pyproject.tomlé…ç½®
          python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
          print('âœ… Project configuration valid')
          print(f'ğŸ“¦ Project name: {data.get('project', {}).get('name', 'N/A')}')
          print(f'ğŸ”¢ Project version: {data.get('project', {}).get('version', 'N/A')}')
          "

      - name: ğŸ—ï¸ Build Package
        run: |
          echo "ğŸ—ï¸ Building package..."
          python -m build

          # æ˜¾ç¤ºæ„å»ºç»“æœ
          echo "ğŸ“ Build artifacts:"
          ls -la dist/

          # éªŒè¯åŒ…
          twine check dist/*
          echo "âœ… Package build and validation completed"

      - name: ğŸ“‹ Extract Version Info
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
            RELEASE_NOTES="${{ github.event.inputs.release_notes }}"
          else
            TAG_NAME="${{ github.ref_name }}"
            RELEASE_NOTES=""
          fi

          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_notes=$RELEASE_NOTES" >> $GITHUB_OUTPUT

          # æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰vå‰ç¼€ï¼‰
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # ç”Ÿæˆæ—¶é—´æˆ³
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S UTC')
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

          echo "ğŸ·ï¸ Release Information:"
          echo "  Tag: $TAG_NAME"
          echo "  Version: $VERSION"
          echo "  Timestamp: $TIMESTAMP"

      - name: ğŸ“ Generate Release Notes
        id: release_notes
        run: |
          # è·å–æœ€è¿‘ä¸€æ¬¡æäº¤ä¿¡æ¯
          LATEST_COMMIT=$(git log -1 --pretty=format:'%H')
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT_DATE=$(git log -1 --pretty=format:'ad' --date=iso)

          # è·å–ç‰ˆæœ¬é—´çš„å·®å¼‚
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ -n "$PREVIOUS_TAG" ]]; then
            CHANGES=$(git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD | head -20)
          else
            CHANGES=$(git log --pretty=format:"- %s (%h)" | head -20)
          fi

          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          RELEASE_NOTES_FILE="release_notes.md"
          cat > $RELEASE_NOTES_FILE << EOF
# ğŸš€ Release ${{ steps.version.outputs.tag_name }}

> ğŸ“… Release Date: ${{ steps.version.outputs.timestamp }}
> ğŸ‘¤ Released By: GitHub Actions
> ğŸ”— Commit: [$LATEST_COMMIT](https://github.com/${{ github.repository }}/commit/$LATEST_COMMIT)

## ğŸ¯ Overview

This release includes the latest changes and improvements to the Football Prediction System.

## ğŸ“‹ Changes Since Last Release

$CHANGES

---

## ğŸ”§ Technical Details

- **Python Version**: 3.11+
- **Build System**: modern \`pyproject.toml\` based
- **CI/CD**: Automated testing and validation
- **Dependencies**: Updated and secured

## ğŸ›¡ï¸ Quality Assurance

- âœ… Code quality checks passed
- âœ… Security scan completed
- âœ… Automated testing successful
- âœ… Package build validated

## ğŸ“¦ Installation

\`\`\`bash
pip install football-prediction==${{ steps.version.outputs.version }}
\`\`\`

## ğŸš€ Quick Start

\`\`\`python
from football_prediction import Predictor

# Initialize predictor
predictor = Predictor()

# Make predictions
result = predictor.predict(match_data)
print(f"Prediction: {result}")
\`\`\`

## ğŸ“š Documentation

For detailed documentation and usage examples, visit:
- [Project README](https://github.com/${{ github.repository }})
- [API Documentation](https://github.com/${{ github.repository }}/docs)

---

**ğŸ™ Automated Release by GitHub Actions**
EOF

          # å¦‚æœæ‰‹åŠ¨æä¾›äº†å‘å¸ƒè¯´æ˜ï¼Œåˆ™æ·»åŠ åˆ°å¼€å¤´
          if [[ -n "${{ steps.version.outputs.release_notes }}" ]]; then
            TEMP_FILE=$(mktemp)
            echo "${{ steps.version.outputs.release_notes }}" > $TEMP_FILE
            echo "" >> $TEMP_FILE
            cat $RELEASE_NOTES_FILE >> $TEMP_FILE
            mv $TEMP_FILE $RELEASE_NOTES_FILE
          fi

          # è¾“å‡ºå‘å¸ƒè¯´æ˜å†…å®¹ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "release_notes_file=$RELEASE_NOTES_FILE" >> $GITHUB_OUTPUT

          echo "ğŸ“ Release notes generated: $RELEASE_NOTES_FILE"
          echo "ğŸ“Š Changes included: $(echo "$CHANGES" | wc -l)"

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: ğŸš€ Release ${{ steps.version.outputs.tag_name }}
          body_path: ${{ steps.release_notes.outputs.release_notes_file }}
          files: |
            dist/*
            LICENSE
            README.md
            docs/
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Upload to PyPI (Optional)
        # è¿™æ˜¯ä¸€ä¸ªæ¡ä»¶æ­¥éª¤ï¼Œåªæœ‰è®¾ç½®äº†APIå¯†é’¥æ—¶æ‰ä¼šæ‰§è¡Œ
        if: env.PYPI_API_TOKEN != ''
        run: |
          echo "ğŸ“¦ Uploading to PyPI..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ PyPIä¸Šä¼ é€»è¾‘
          # twine upload dist/* --username __token__ --password $PYPI_API_TOKEN
          echo "âš ï¸ PyPI upload configured but skipped - API token required"

      - name: ğŸ‰ Release Summary
        run: |
          echo ""
          echo "ğŸ‰ Release ${{ steps.version.outputs.tag_name }} Created Successfully!"
          echo ""
          echo "ğŸ“Š Release Summary:"
          echo "  ğŸ·ï¸  Tag: ${{ steps.version.outputs.tag_name }}"
          echo "  ğŸ”¢ Version: ${{ steps.version.outputs.version }}"
          echo "  ğŸ“… Release Date: ${{ steps.version.outputs.timestamp }}"
          echo "  ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag_name }}"
          echo ""
          echo "ğŸ“¦ Package Files:"
          ls -la dist/ | awk '{print "  " $9 " (" $5 " bytes)"}'
          echo ""
          echo "âœ… Automated Release Workflow Completed!"

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘çš„ï¼Œæä¾›é¢å¤–ä¿¡æ¯
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo ""
            echo "ğŸ’¡ Manual release triggered by ${{ github.actor }}"
            echo "ğŸ“ Custom release notes included"
          fi

  security-scan:
    name: ğŸ” Security Scan Release
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Run Security Scan
        run: |
          echo "ğŸ” Running security scan on release..."
          # è¿è¡Œå®‰å…¨æ‰«æç¡®ä¿å‘å¸ƒå®‰å…¨
          python -m pip install safety bandit

          # æ£€æŸ¥ä¾èµ–å®‰å…¨
          safety check --json --output safety-report.json || true

          # ä»£ç å®‰å…¨æ‰«æ
          bandit -r src/ -f json -o bandit-report.json || true

          echo "âœ… Security scan completed"
          echo "ğŸ“Š Reports generated:"
          ls -la *-report.json

  notify-success:
    name: ğŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: [create-release, security-scan]
    if: success()
    steps:
      - name: ğŸ“¢ Release Success Notification
        run: |
          echo "ğŸ‰ Release ${{ github.ref_name }} completed successfully!"
          echo "ğŸ“Š All validation checks passed"
          echo "ğŸš€ Release is now available for users"
