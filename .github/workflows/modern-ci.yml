name: Modern CI/CD Pipeline

on:
  push:
    branches: [ main, develop, "feature/*" ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œè´¨é‡æ£€æŸ¥
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"
  # æ¸è¿›å¼è¦†ç›–çŽ‡ç›®æ ‡ - ä»Žé¡¹ç›®å®žé™…æ°´å¹³å¼€å§‹
  COVERAGE_THRESHOLD: "12"
  # å…è®¸çš„è¯­æ³•é”™è¯¯æ•°é‡ - é€æ­¥å‡å°‘
  SYNTAX_ERROR_LIMIT: "1200"

jobs:
  # æ™ºèƒ½è´¨é‡æ£€æŸ¥å’Œä¿®å¤
  intelligent-quality-check:
    name: Intelligent Quality Check & Fix
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff black mypy bandit safety pytest pytest-cov
        # å®‰è£…é¡¹ç›®ä¾èµ–
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    - name: Run Smart Quality Fixer
      run: |
        echo "ðŸ”§ è¿è¡Œæ™ºèƒ½è´¨é‡ä¿®å¤å™¨..."
        if [ -f scripts/smart_quality_fixer.py ]; then
          python3 scripts/smart_quality_fixer.py --verbose || true
        else
          echo "âš ï¸ æ™ºèƒ½ä¿®å¤å·¥å…·æœªæ‰¾åˆ°ï¼Œä½¿ç”¨åŸºç¡€ä¿®å¤"
          make fix-code || ruff check src/ tests/ --fix --unsafe-fixes || true
        fi

    - name: Count Syntax Errors
      id: syntax-check
      run: |
        SYNTAX_ERRORS=$(ruff check src/ --output-format=concise | grep "invalid-syntax" | wc -l)
        echo "syntax_errors=$SYNTAX_ERRORS" >> $GITHUB_OUTPUT
        echo "ðŸ“Š å‘çŽ°è¯­æ³•é”™è¯¯: $SYNTAX_ERRORS ä¸ª"

    - name: Syntax Error Check
      run: |
        if [ "${{ steps.syntax-check.outputs.syntax_errors }}" -gt "${{ env.SYNTAX_ERROR_LIMIT }}" ]; then
          echo "âŒ è¯­æ³•é”™è¯¯è¿‡å¤š (${{ steps.syntax-check.outputs.syntax_errors }} > ${{ env.SYNTAX_ERROR_LIMIT }})"
          echo "ðŸ’¡ å»ºè®®: è¿è¡Œ 'python3 scripts/smart_quality_fixer.py' ä¿®å¤è¯­æ³•é”™è¯¯"
          exit 1
        else
          echo "âœ… è¯­æ³•é”™è¯¯åœ¨å¯æŽ¥å—èŒƒå›´å†…"
        fi

    - name: Code Quality Checks
      run: |
        echo "ðŸ” æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥..."

        # Ruffæ£€æŸ¥ - ä½¿ç”¨é¡¹ç›®çŽ°æœ‰é…ç½®
        ruff check src/ tests/ --output-format=github

        # æ ¼å¼æ£€æŸ¥
        black --check --diff src/ tests/ || echo "âš ï¸ ä»£ç æ ¼å¼éœ€è¦ä¿®å¤"

        # å®‰å…¨æ£€æŸ¥
        bandit -r src/ -f json -o bandit-report.json || echo "âš ï¸ å®‰å…¨æ£€æŸ¥å‘çŽ°é—®é¢˜"

        # ä¾èµ–å®‰å…¨æ£€æŸ¥
        safety check --json --output safety-report.json || echo "âš ï¸ ä¾èµ–å®‰å…¨æ£€æŸ¥å‘çŽ°é—®é¢˜"

    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 30

  # å¢žå¼ºçš„æµ‹è¯•å¥—ä»¶
  enhanced-tests:
    name: Enhanced Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        pip install pytest pytest-cov pytest-mock pytest-asyncio pytest-xdist

    - name: Run Quality Fix Before Tests
      run: |
        echo "ðŸ”§ æµ‹è¯•å‰è´¨é‡ä¿®å¤..."
        if [ -f scripts/fix_test_crisis.py ]; then
          python3 scripts/fix_test_crisis.py --diagnose || true
        fi

    - name: Run Unit Tests
      run: |
        echo "ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
        pytest tests/unit/ -v \
          --maxfail=5 \
          --tb=short \
          --cov=src \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --junitxml=test-results.xml \
          --cov-fail-under=${{ env.COVERAGE_THRESHOLD }} || {
            echo "âš ï¸ å•å…ƒæµ‹è¯•å¤±è´¥æˆ–è¦†ç›–çŽ‡ä¸è¶³ (${{ env.COVERAGE_THRESHOLD }}%)"
            echo "ðŸ’¡ å½“å‰é¡¹ç›®é‡‡ç”¨æ¸è¿›å¼è¦†ç›–çŽ‡æ”¹è¿›ç­–ç•¥"
            # ä¸è®©è¦†ç›–çŽ‡æ£€æŸ¥å¤±è´¥ï¼Œåªè®°å½•è­¦å‘Š
          }

    - name: Run API Performance Tests
      run: |
        echo "ðŸš€ è¿è¡ŒAPIæ€§èƒ½ä¼˜åŒ–ç³»ç»Ÿæµ‹è¯•..."
        if [ -d tests/unit/api ]; then
          pytest tests/unit/api/test_performance_optimization.py -v \
            --junitxml=api-performance-results.xml || echo "âš ï¸ APIæ€§èƒ½æµ‹è¯•æœ‰é—®é¢˜"
        fi

    - name: Run Cache Optimization Tests
      run: |
        echo "ðŸ—„ï¸ è¿è¡Œç¼“å­˜ä¼˜åŒ–æµ‹è¯•..."
        if [ -d tests/unit/cache ]; then
          pytest tests/unit/cache/test_cache_optimization.py -v \
            --junitxml=cache-results.xml || echo "âš ï¸ ç¼“å­˜æµ‹è¯•æœ‰é—®é¢˜"
        fi

    - name: Run Critical Function Tests
      run: |
        echo "ðŸ”¥ è¿è¡Œå…³é”®åŠŸèƒ½æµ‹è¯•..."
        pytest tests/unit/ -v \
          -m "critical" \
          --maxfail=3 \
          --junitxml=critical-results.xml || echo "âš ï¸ å…³é”®åŠŸèƒ½æµ‹è¯•å¤±è´¥"

    - name: Generate Coverage Report
      if: always()
      run: |
        echo "ðŸ“Š ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š..."
        if [ -f htmlcov/index.html ]; then
          echo "âœ… è¦†ç›–çŽ‡æŠ¥å‘Šå·²ç”Ÿæˆ"
          coverage report --show-missing || true
        fi

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-py${{ matrix.python-version }}
        path: |
          test-results.xml
          api-performance-results.xml
          cache-results.xml
          critical-results.xml
          htmlcov/
          coverage.xml
        retention-days: 30

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    needs: intelligent-quality-check
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    - name: Run Performance Tests
      run: |
        echo "âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        if [ -d tests/performance ]; then
          pytest tests/performance/ -v \
            --junitxml=performance-results.xml || echo "âš ï¸ æ€§èƒ½æµ‹è¯•æœªé€šè¿‡"
        else
          echo "ðŸ“ æ€§èƒ½æµ‹è¯•ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ€§èƒ½æµ‹è¯•"
        fi

    - name: API Response Time Test
      run: |
        echo "ðŸŒ APIå“åº”æ—¶é—´æµ‹è¯•..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ APIå“åº”æ—¶é—´æµ‹è¯•
        echo "APIæ€§èƒ½æµ‹è¯•å ä½ç¬¦"

    - name: Upload Performance Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: |
          performance-results.xml
        retention-days: 30

  # Dockeræž„å»ºæµ‹è¯•
  build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [enhanced-tests]
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Test Docker Build
      run: |
        echo "ðŸ³ æµ‹è¯•Dockeræž„å»º..."
        if [ -f Dockerfile ]; then
          docker build -t football-prediction:test .
          echo "âœ… Dockeræž„å»ºæˆåŠŸ"
        else
          echo "âš ï¸ Dockerfileä¸å­˜åœ¨ï¼Œè·³è¿‡Dockeræž„å»ºæµ‹è¯•"
        fi

  # æž„å»ºå’Œéƒ¨ç½² (ä»…mainåˆ†æ”¯)
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [intelligent-quality-check, enhanced-tests, build-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      if: vars.DOCKER_USERNAME != ''
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: xupeng211/football-prediction
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      if: vars.DOCKER_USERNAME != ''
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Deploy to Production
      if: vars.DOCKER_USERNAME != ''
      run: |
        echo "ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ..."
        echo "éƒ¨ç½²é€»è¾‘å ä½ç¬¦"
        echo "å®žé™…éƒ¨ç½²è„šæœ¬å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ "

  # è´¨é‡æŠ¥å‘Š
  quality-report:
    name: Quality Report
    runs-on: ubuntu-latest
    needs: [intelligent-quality-check, enhanced-tests]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts/

    - name: Generate Quality Report
      run: |
        echo "ðŸ“Š ç”Ÿæˆè´¨é‡æŠ¥å‘Š..."
        cat > quality-report.md << 'EOF'
        # ðŸ† é¡¹ç›®è´¨é‡æŠ¥å‘Š

        **ç”Ÿæˆæ—¶é—´**: $(date)
        **åˆ†æ”¯**: ${{ github.ref_name }}
        **æäº¤**: ${{ github.sha }}

        ## ðŸ“ˆ è´¨é‡æŒ‡æ ‡

        - **è¯­æ³•é”™è¯¯**: ${{ needs.intelligent-quality-check.outputs.syntax-errors || 'N/A' }}
        - **æµ‹è¯•è¦†ç›–çŽ‡**: ${{ env.COVERAGE_THRESHOLD }}% (æ¸è¿›å¼ç›®æ ‡)
        - **æµ‹è¯•çŠ¶æ€**: ${{ needs.enhanced-tests.result }}
        - **æž„å»ºçŠ¶æ€**: ${{ needs.build-test.result }}

        ## ðŸŽ¯ æ”¹è¿›å»ºè®®

        1. ç»§ç»­ä½¿ç”¨æ™ºèƒ½ä¿®å¤å·¥å…·æå‡ä»£ç è´¨é‡
        2. é€æ­¥æå‡æµ‹è¯•è¦†ç›–çŽ‡
        3. ä¿®å¤å‘çŽ°çš„å®‰å…¨é—®é¢˜
        4. å®Œå–„æ€§èƒ½ç›‘æŽ§

        EOF

    - name: Upload Quality Report
      uses: actions/upload-artifact@v4
      with:
        name: quality-report
        path: quality-report.md
        retention-days: 90

  # é€šçŸ¥
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [intelligent-quality-check, enhanced-tests, build-and-deploy]
    if: always()

    steps:
    - name: Notify on Success
      if: needs.intelligent-quality-check.result == 'success' && needs.enhanced-tests.result == 'success'
      run: |
        echo "âœ… çŽ°ä»£åŒ–CI/CDæµæ°´çº¿æ‰§è¡ŒæˆåŠŸ!"
        echo "ðŸŽ¯ é¡¹ç›®è´¨é‡æŒç»­æ”¹è¿›ä¸­"

    - name: Notify on Failure
      if: needs.intelligent-quality-check.result == 'failure' || needs.enhanced-tests.result == 'failure'
      run: |
        echo "âŒ CI/CDæµæ°´çº¿æ‰§è¡Œå¤±è´¥"
        echo "ðŸ’¡ è¯·æ£€æŸ¥æ—¥å¿—å¹¶ä½¿ç”¨æ™ºèƒ½ä¿®å¤å·¥å…·è§£å†³é—®é¢˜"
        exit 1