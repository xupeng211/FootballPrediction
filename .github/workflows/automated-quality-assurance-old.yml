name: 🚀 自动化质量保障系统

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # 每天UTC 8:00执行完整质量检查
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: '要执行的操作'
        required: false
        default: 'full-check'
        type: choice
        options:
          - full-check
          - quick-fix
          - coverage-report
          - quality-report
      severity:
        description: '检查严重程度'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - critical
          - warning
          - info

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # 快速检查 - 每次提交都执行
  quick-check:
    name: ⚡ 快速检查
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' || github.event.inputs.action == 'quick-fix'

    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4

    - name: 🐍 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 📦 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov ruff mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

    - name: 🔧 运行快速修复
      run: |
        echo "🔧 运行自动化修复工具..."
        python scripts/fix_test_crisis.py
        python scripts/precise_error_fixer.py

    - name: 🔍 快速语法检查
      run: |
        echo "🔍 运行快速语法检查..."
        python scripts/smart_quality_fixer.py --syntax-only

    - name: 📊 快速测试收集
      run: |
        echo "📊 验证测试收集..."
        python -m pytest --collect-only -q --disable-warnings || true

    - name: 🎯 生成快速报告
      run: |
        echo "🎯 生成快速质量报告..."
        python scripts/github_issue_manager.py --generate-report > quick-quality-report.md

    - name: 📤 上传快速报告
      uses: actions/upload-artifact@v3
      with:
        name: quick-quality-report
        path: quick-quality-report.md

    - name: 💬 快速状态评论 (PR only)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            const report = fs.readFileSync('quick-quality-report.md', 'utf8');
            const lines = report.split('\n');

            // 提取关键信息
            const summary = lines.slice(0, 10).join('\n');

            github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## 🚀 自动化质量检查报告

${summary}

---
🤖 *由自动化质量保障系统生成*
            `});
          } catch (error) {
            console.log('无法读取报告文件:', error.message);
          }

  # 完整质量检查 - 每日或手动触发
  full-quality-check:
    name: 🔍 完整质量检查
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.action == 'full-check'

    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4

    - name: 🐍 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 📦 安装完整依赖
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-xdist ruff mypy bandit pip-audit
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: 🧹 清理环境
      run: |
        echo "🧹 清理Python缓存..."
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true

    - name: 🔧 运行完整修复
      run: |
        echo "🔧 运行完整自动化修复..."
        python scripts/fix_test_crisis.py
        python scripts/fix_remaining_test_errors.py
        python scripts/precise_error_fixer.py

    - name: 🎯 执行质量提升
      run: |
        echo "🎯 执行质量提升分析..."
        python scripts/test_quality_improvement_engine.py --analyze
        python scripts/test_quality_improvement_engine.py --execute-phase 1
        python scripts/test_quality_improvement_engine.py --execute-phase 2

    - name: 📊 生成覆盖率报告
      run: |
        echo "📊 生成完整覆盖率报告..."
        python -m pytest --cov=src --cov-report=html --cov-report=xml --cov-report=term-missing --maxfail=10 --disable-warnings -q || true

    - name: 🔍 代码质量检查
      run: |
        echo "🔍 运行代码质量检查..."
        make lint || echo "代码检查有警告，但继续执行"
        make type-check || echo "类型检查有警告，但继续执行"

    - name: 🛡️ 安全扫描
      run: |
        echo "🛡️ 运行安全扫描..."
        bandit -r src/ -f json -o security-report.json || echo "安全扫描完成"
        pip-audit --format=json --output=audit-report.json || echo "依赖审计完成"

    - name: 📈 性能测试
      run: |
        echo "📈 运行性能测试..."
        python -m pytest tests/unit/utils/test_crypto_utils.py --benchmark-only --benchmark-json=benchmark.json || echo "性能测试完成"

    - name: 📋 生成完整报告
      run: |
        echo "📋 生成完整质量报告..."
        python scripts/github_issue_manager.py --generate-report > full-quality-report.md
        python scripts/test_quality_improvement_engine.py --report >> full-quality-report.md

    - name: 📤 上传所有报告
      uses: actions/upload-artifact@v3
      with:
        name: full-quality-reports
        path: |
          htmlcov/
          full-quality-report.md
          security-report.json
          audit-report.json
          benchmark.json
          coverage.xml

    - name: 🎯 覆盖率检查
      run: |
        echo "🎯 检查覆盖率阈值..."
        if [ -f coverage.xml ]; then
          COVERAGE=$(python -c "
import xml.etree.ElementTree as ET
try:
    tree = ET.parse('coverage.xml')
    root = tree.getroot()
    coverage = float(root.attrib.get('line-rate', 0)) * 100
    print(f'当前覆盖率: {coverage:.2f}%')

    if coverage < 15:
        print('❌ 覆盖率低于15%，需要关注')
        exit(1)
    elif coverage < 30:
        print('⚠️ 覆盖率低于30%，建议改进')
    else:
        print('✅ 覆盖率良好')
except Exception as e:
    print(f'无法解析覆盖率: {e}')
    exit(1)
")
          echo "$COVERAGE"
        else
          echo "⚠️ 覆盖率报告未生成"
        fi

    - name: 🚨 创建Issue (仅当有问题时)
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            const report = fs.readFileSync('full-quality-report.md', 'utf8');

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `🚨 质量警报 - ${new Date().toISOString().split('T')[0]}`,
              body: `## 自动化质量检查发现问题

${report}

## 🔧 建议行动
1. 查看详细报告和日志
2. 修复发现的问题
3. 重新运行质量检查

---
🤖 *由自动化质量保障系统生成*
              `,
              labels: ['quality', 'automated-check', 'needs-attention']
            });
          } catch (error) {
            console.log('无法创建Issue:', error.message);
          }

  # 覆盖率专项检查
  coverage-report:
    name: 📊 覆盖率报告
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'coverage-report'

    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4

    - name: 🐍 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 📦 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-xdist
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: 📊 生成详细覆盖率报告
      run: |
        echo "📊 生成详细覆盖率报告..."
        python -m pytest --cov=src --cov-report=html --cov-report=xml --cov-report=term --cov-report=json -n auto --disable-warnings

    - name: 📤 上传覆盖率报告
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: |
          htmlcov/
          coverage.xml
          coverage.json

    - name: 💬 覆盖率评论 (PR only)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            const coverage = JSON.parse(fs.readFileSync('coverage.json', 'utf8'));
            const totalCoverage = coverage.totals.lines.covered / coverage.totals.lines.count * 100;

            github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## 📊 覆盖率报告

**总覆盖率**: ${totalCoverage.toFixed(2)}%

### 覆盖率详情
- **行覆盖率**: ${coverage.totals.lines.percent}%
- **分支覆盖率**: ${coverage.totals.branches.percent}%
- **函数覆盖率**: ${coverage.totals.functions.percent}%

### 覆盖率趋势
${totalCoverage >= 30 ? '✅ 覆盖率良好' : '⚠️ 需要提升覆盖率'}

📊 [查看详细覆盖率报告](https://github.com/${{context.repository.owner}/${{context.repository.repo}}/actions/runs/${{context.runId}})

---
🤖 *由自动化质量保障系统生成*
            `});
          } catch (error) {
            console.log('无法解析覆盖率报告:', error.message);
          }

  # 质量趋势分析
  quality-trends:
    name: 📈 质量趋势分析
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'quality-report'

    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4

    - name: 🐍 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 📦 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov ruff mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: 📈 分析质量趋势
      run: |
        echo "📈 分析质量趋势..."
        python scripts/github_issue_manager.py --generate-report > quality-trends.md
        python scripts/test_quality_improvement_engine.py --report >> quality-trends.md

    - name: 📤 上传趋势报告
      uses: actions/upload-artifact@v3
      with:
        name: quality-trends
        path: quality-trends.md

  # 智能优化建议
  optimization-suggestions:
    name: 🤖 智能优化建议
    runs-on: ubuntu-latest
    if: github.event.inputs.severity == 'all' || github.event.inputs.severity == 'warning'

    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4

    - name: 🤖 生成优化建议
      run: |
        echo "🤖 生成智能优化建议..."
        python scripts/smart_quality_fixer.py --suggestions-only > optimization-suggestions.md

    - name: 📤 上传优化建议
      uses: actions/upload-artifact@v3
      with:
        name: optimization-suggestions
        path: optimization-suggestions.md

  # 工作流状态总结
  workflow-summary:
    name: 📋 工作流总结
    runs-on: ubuntu-latest
    needs: [quick-check, full-quality-check]
    if: always()

    steps:
    - name: 📋 生成工作流总结
      run: |
        echo "📋 工作流执行总结"
        echo "=================="
        echo "快速检查状态: ${{ needs.quick-check.result }}"
        echo "完整检查状态: ${{ needs.full-quality-check.result }}"
        echo "执行时间: $(date)"
        echo "=================="

    - name: 📤 上传总结
      uses: actions/upload-artifact@v3
      with:
        name: workflow-summary
        path: workflow-summary.md