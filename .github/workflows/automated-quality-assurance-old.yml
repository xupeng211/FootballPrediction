name: ğŸš€ è‡ªåŠ¨åŒ–è´¨é‡ä¿éšœç³»ç»Ÿ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©UTC 8:00æ‰§è¡Œå®Œæ•´è´¨é‡æ£€æŸ¥
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'è¦æ‰§è¡Œçš„æ“ä½œ'
        required: false
        default: 'full-check'
        type: choice
        options:
          - full-check
          - quick-fix
          - coverage-report
          - quality-report
      severity:
        description: 'æ£€æŸ¥ä¸¥é‡ç¨‹åº¦'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - critical
          - warning
          - info

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # å¿«é€Ÿæ£€æŸ¥ - æ¯æ¬¡æäº¤éƒ½æ‰§è¡Œ
  quick-check:
    name: âš¡ å¿«é€Ÿæ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' || github.event.inputs.action == 'quick-fix'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov ruff mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

    - name: ğŸ”§ è¿è¡Œå¿«é€Ÿä¿®å¤
      run: |
        echo "ğŸ”§ è¿è¡Œè‡ªåŠ¨åŒ–ä¿®å¤å·¥å…·..."
        python scripts/fix_test_crisis.py
        python scripts/precise_error_fixer.py

    - name: ğŸ” å¿«é€Ÿè¯­æ³•æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œå¿«é€Ÿè¯­æ³•æ£€æŸ¥..."
        python scripts/smart_quality_fixer.py --syntax-only

    - name: ğŸ“Š å¿«é€Ÿæµ‹è¯•æ”¶é›†
      run: |
        echo "ğŸ“Š éªŒè¯æµ‹è¯•æ”¶é›†..."
        python -m pytest --collect-only -q --disable-warnings || true

    - name: ğŸ¯ ç”Ÿæˆå¿«é€ŸæŠ¥å‘Š
      run: |
        echo "ğŸ¯ ç”Ÿæˆå¿«é€Ÿè´¨é‡æŠ¥å‘Š..."
        python scripts/github_issue_manager.py --generate-report > quick-quality-report.md

    - name: ğŸ“¤ ä¸Šä¼ å¿«é€ŸæŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: quick-quality-report
        path: quick-quality-report.md

    - name: ğŸ’¬ å¿«é€ŸçŠ¶æ€è¯„è®º (PR only)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            const report = fs.readFileSync('quick-quality-report.md', 'utf8');
            const lines = report.split('\n');

            // æå–å…³é”®ä¿¡æ¯
            const summary = lines.slice(0, 10).join('\n');

            github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸš€ è‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥æŠ¥å‘Š

${summary}

---
ğŸ¤– *ç”±è‡ªåŠ¨åŒ–è´¨é‡ä¿éšœç³»ç»Ÿç”Ÿæˆ*
            `});
          } catch (error) {
            console.log('æ— æ³•è¯»å–æŠ¥å‘Šæ–‡ä»¶:', error.message);
          }

  # å®Œæ•´è´¨é‡æ£€æŸ¥ - æ¯æ—¥æˆ–æ‰‹åŠ¨è§¦å‘
  full-quality-check:
    name: ğŸ” å®Œæ•´è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.action == 'full-check'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ å®‰è£…å®Œæ•´ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-xdist ruff mypy bandit pip-audit
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: ğŸ§¹ æ¸…ç†ç¯å¢ƒ
      run: |
        echo "ğŸ§¹ æ¸…ç†Pythonç¼“å­˜..."
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true

    - name: ğŸ”§ è¿è¡Œå®Œæ•´ä¿®å¤
      run: |
        echo "ğŸ”§ è¿è¡Œå®Œæ•´è‡ªåŠ¨åŒ–ä¿®å¤..."
        python scripts/fix_test_crisis.py
        python scripts/fix_remaining_test_errors.py
        python scripts/precise_error_fixer.py

    - name: ğŸ¯ æ‰§è¡Œè´¨é‡æå‡
      run: |
        echo "ğŸ¯ æ‰§è¡Œè´¨é‡æå‡åˆ†æ..."
        python scripts/test_quality_improvement_engine.py --analyze
        python scripts/test_quality_improvement_engine.py --execute-phase 1
        python scripts/test_quality_improvement_engine.py --execute-phase 2

    - name: ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆå®Œæ•´è¦†ç›–ç‡æŠ¥å‘Š..."
        python -m pytest --cov=src --cov-report=html --cov-report=xml --cov-report=term-missing --maxfail=10 --disable-warnings -q || true

    - name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
        make lint || echo "ä»£ç æ£€æŸ¥æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ"
        make type-check || echo "ç±»å‹æ£€æŸ¥æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ"

    - name: ğŸ›¡ï¸ å®‰å…¨æ‰«æ
      run: |
        echo "ğŸ›¡ï¸ è¿è¡Œå®‰å…¨æ‰«æ..."
        bandit -r src/ -f json -o security-report.json || echo "å®‰å…¨æ‰«æå®Œæˆ"
        pip-audit --format=json --output=audit-report.json || echo "ä¾èµ–å®¡è®¡å®Œæˆ"

    - name: ğŸ“ˆ æ€§èƒ½æµ‹è¯•
      run: |
        echo "ğŸ“ˆ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
        python -m pytest tests/unit/utils/test_crypto_utils.py --benchmark-only --benchmark-json=benchmark.json || echo "æ€§èƒ½æµ‹è¯•å®Œæˆ"

    - name: ğŸ“‹ ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
      run: |
        echo "ğŸ“‹ ç”Ÿæˆå®Œæ•´è´¨é‡æŠ¥å‘Š..."
        python scripts/github_issue_manager.py --generate-report > full-quality-report.md
        python scripts/test_quality_improvement_engine.py --report >> full-quality-report.md

    - name: ğŸ“¤ ä¸Šä¼ æ‰€æœ‰æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: full-quality-reports
        path: |
          htmlcov/
          full-quality-report.md
          security-report.json
          audit-report.json
          benchmark.json
          coverage.xml

    - name: ğŸ¯ è¦†ç›–ç‡æ£€æŸ¥
      run: |
        echo "ğŸ¯ æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼..."
        if [ -f coverage.xml ]; then
          COVERAGE=$(python -c "
import xml.etree.ElementTree as ET
try:
    tree = ET.parse('coverage.xml')
    root = tree.getroot()
    coverage = float(root.attrib.get('line-rate', 0)) * 100
    print(f'å½“å‰è¦†ç›–ç‡: {coverage:.2f}%')

    if coverage < 15:
        print('âŒ è¦†ç›–ç‡ä½äº15%ï¼Œéœ€è¦å…³æ³¨')
        exit(1)
    elif coverage < 30:
        print('âš ï¸ è¦†ç›–ç‡ä½äº30%ï¼Œå»ºè®®æ”¹è¿›')
    else:
        print('âœ… è¦†ç›–ç‡è‰¯å¥½')
except Exception as e:
    print(f'æ— æ³•è§£æè¦†ç›–ç‡: {e}')
    exit(1)
")
          echo "$COVERAGE"
        else
          echo "âš ï¸ è¦†ç›–ç‡æŠ¥å‘Šæœªç”Ÿæˆ"
        fi

    - name: ğŸš¨ åˆ›å»ºIssue (ä»…å½“æœ‰é—®é¢˜æ—¶)
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            const report = fs.readFileSync('full-quality-report.md', 'utf8');

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ è´¨é‡è­¦æŠ¥ - ${new Date().toISOString().split('T')[0]}`,
              body: `## è‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥å‘ç°é—®é¢˜

${report}

## ğŸ”§ å»ºè®®è¡ŒåŠ¨
1. æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå’Œæ—¥å¿—
2. ä¿®å¤å‘ç°çš„é—®é¢˜
3. é‡æ–°è¿è¡Œè´¨é‡æ£€æŸ¥

---
ğŸ¤– *ç”±è‡ªåŠ¨åŒ–è´¨é‡ä¿éšœç³»ç»Ÿç”Ÿæˆ*
              `,
              labels: ['quality', 'automated-check', 'needs-attention']
            });
          } catch (error) {
            console.log('æ— æ³•åˆ›å»ºIssue:', error.message);
          }

  # è¦†ç›–ç‡ä¸“é¡¹æ£€æŸ¥
  coverage-report:
    name: ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Š
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'coverage-report'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-xdist
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: ğŸ“Š ç”Ÿæˆè¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆè¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š..."
        python -m pytest --cov=src --cov-report=html --cov-report=xml --cov-report=term --cov-report=json -n auto --disable-warnings

    - name: ğŸ“¤ ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: |
          htmlcov/
          coverage.xml
          coverage.json

    - name: ğŸ’¬ è¦†ç›–ç‡è¯„è®º (PR only)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            const coverage = JSON.parse(fs.readFileSync('coverage.json', 'utf8'));
            const totalCoverage = coverage.totals.lines.covered / coverage.totals.lines.count * 100;

            github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Š

**æ€»è¦†ç›–ç‡**: ${totalCoverage.toFixed(2)}%

### è¦†ç›–ç‡è¯¦æƒ…
- **è¡Œè¦†ç›–ç‡**: ${coverage.totals.lines.percent}%
- **åˆ†æ”¯è¦†ç›–ç‡**: ${coverage.totals.branches.percent}%
- **å‡½æ•°è¦†ç›–ç‡**: ${coverage.totals.functions.percent}%

### è¦†ç›–ç‡è¶‹åŠ¿
${totalCoverage >= 30 ? 'âœ… è¦†ç›–ç‡è‰¯å¥½' : 'âš ï¸ éœ€è¦æå‡è¦†ç›–ç‡'}

ğŸ“Š [æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š](https://github.com/${{context.repository.owner}/${{context.repository.repo}}/actions/runs/${{context.runId}})

---
ğŸ¤– *ç”±è‡ªåŠ¨åŒ–è´¨é‡ä¿éšœç³»ç»Ÿç”Ÿæˆ*
            `});
          } catch (error) {
            console.log('æ— æ³•è§£æè¦†ç›–ç‡æŠ¥å‘Š:', error.message);
          }

  # è´¨é‡è¶‹åŠ¿åˆ†æ
  quality-trends:
    name: ğŸ“ˆ è´¨é‡è¶‹åŠ¿åˆ†æ
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'quality-report'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov ruff mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: ğŸ“ˆ åˆ†æè´¨é‡è¶‹åŠ¿
      run: |
        echo "ğŸ“ˆ åˆ†æè´¨é‡è¶‹åŠ¿..."
        python scripts/github_issue_manager.py --generate-report > quality-trends.md
        python scripts/test_quality_improvement_engine.py --report >> quality-trends.md

    - name: ğŸ“¤ ä¸Šä¼ è¶‹åŠ¿æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: quality-trends
        path: quality-trends.md

  # æ™ºèƒ½ä¼˜åŒ–å»ºè®®
  optimization-suggestions:
    name: ğŸ¤– æ™ºèƒ½ä¼˜åŒ–å»ºè®®
    runs-on: ubuntu-latest
    if: github.event.inputs.severity == 'all' || github.event.inputs.severity == 'warning'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ¤– ç”Ÿæˆä¼˜åŒ–å»ºè®®
      run: |
        echo "ğŸ¤– ç”Ÿæˆæ™ºèƒ½ä¼˜åŒ–å»ºè®®..."
        python scripts/smart_quality_fixer.py --suggestions-only > optimization-suggestions.md

    - name: ğŸ“¤ ä¸Šä¼ ä¼˜åŒ–å»ºè®®
      uses: actions/upload-artifact@v3
      with:
        name: optimization-suggestions
        path: optimization-suggestions.md

  # å·¥ä½œæµçŠ¶æ€æ€»ç»“
  workflow-summary:
    name: ğŸ“‹ å·¥ä½œæµæ€»ç»“
    runs-on: ubuntu-latest
    needs: [quick-check, full-quality-check]
    if: always()

    steps:
    - name: ğŸ“‹ ç”Ÿæˆå·¥ä½œæµæ€»ç»“
      run: |
        echo "ğŸ“‹ å·¥ä½œæµæ‰§è¡Œæ€»ç»“"
        echo "=================="
        echo "å¿«é€Ÿæ£€æŸ¥çŠ¶æ€: ${{ needs.quick-check.result }}"
        echo "å®Œæ•´æ£€æŸ¥çŠ¶æ€: ${{ needs.full-quality-check.result }}"
        echo "æ‰§è¡Œæ—¶é—´: $(date)"
        echo "=================="

    - name: ğŸ“¤ ä¸Šä¼ æ€»ç»“
      uses: actions/upload-artifact@v3
      with:
        name: workflow-summary
        path: workflow-summary.md