name: License Compliance Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©UTC 04:00è¿è¡Œ (åŒ—äº¬æ—¶é—´12:00)
    - cron: '0 4 * * *'

env:
  PYTHON_VERSION: '3.11'

jobs:
  license-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pip-licenses
        pip install -r requirements.txt

    - name: Check license compliance
      run: |
        echo "ğŸ“„ Checking license compliance..."

        # ç”Ÿæˆè®¸å¯è¯æŠ¥å‘Š
        pip-licenses --from=mixed --format=json > license-report.json

        # æ£€æŸ¥ä¸å…¼å®¹çš„è®¸å¯è¯
        echo "ğŸ” Checking for incompatible licenses..."

        # æ£€æŸ¥ç¦æ­¢çš„è®¸å¯è¯
        if pip-licenses --from=mixed --fail-on="Commercial;Proprietary" 2>/dev/null; then
          echo "âœ… No prohibited licenses found"
        else
          echo "âŒ Prohibited licenses detected!"
          pip-licenses --from=mixed --format=table
          exit 1
        fi

        # è¿è¡Œè‡ªå®šä¹‰è®¸å¯è¯æ£€æŸ¥è„šæœ¬
        if [ -f "scripts/check_licenses.py" ]; then
          echo "ğŸ” Running custom license check..."
          python scripts/check_licenses.py --format json --output license-detailed-report.json

          # æ£€æŸ¥æ˜¯å¦æœ‰è®¸å¯è¯é—®é¢˜
          if python -c "
import json
with open('license-detailed-report.json', 'r') as f:
    report = json.load(f)

# ç»Ÿè®¡é—®é¢˜
issue_stats = report.get('issues', {})
if issue_stats.get('total', 0) > 0:
    print(f'âŒ Found {issue_stats[\"total\"]} license issues')
    if issue_stats.get('blocked', 0) > 0:
        print(f'  - {issue_stats[\"blocked\"]} blocked licenses')
    if issue_stats.get('warning', 0) > 0:
        print(f'  - {issue_stats[\"warning\"]} copyleft licenses')
    if issue_stats.get('unknown', 0) > 0:
        print(f'  - {issue_stats[\"unknown\"]} unknown licenses')
    exit(1)
else:
    print('âœ… All licenses are compliant')
"; then
            echo "âœ… License compliance check passed"
          else
            echo "âŒ License compliance check failed"
            exit 1
          fi
        fi

    - name: Generate license summary
      run: |
        echo "## ğŸ“„ License Summary" > license-summary.md
        echo "" >> license-summary.md

        # ç»Ÿè®¡è®¸å¯è¯ç±»å‹
        echo "### License Distribution" >> license-summary.md
        pip-licenses --from=mixed --format=markdown >> license-summary.md

        # æ·»åŠ ä¾èµ–æ€»æ•°
        TOTAL_DEPS=$(pip list --format=json | jq length)
        echo "" >> license-summary.md
        echo "**Total Dependencies:** $TOTAL_DEPS" >> license-summary.md

        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦ç‰¹åˆ«æ³¨æ„çš„è®¸å¯è¯
        echo "" >> license-summary.md
        echo "### âš ï¸ Licenses Requiring Attention" >> license-summary.md
        if pip-licenses --from=mixed --format=json | jq -r '.[] | select(.license | test("GPL|LGPL|AGPL")) | "\(.name)==\(.version) (\(.license))"' > gpl-licenses.txt; then
          if [ -s gpl-licenses.txt ]; then
            echo "The following packages use copyleft licenses:" >> license-summary.md
            cat gpl-licenses.txt | sed 's/^/- /' >> license-summary.md
          else
            echo "No copyleft licenses found." >> license-summary.md
          fi
        fi

        # ç”ŸæˆNOTICEæ–‡ä»¶å»ºè®®
        echo "" >> license-summary.md
        echo "### ğŸ“‹ NOTICE File Requirements" >> license-summary.md
        echo "The following packages require attribution in NOTICE file:" >> license-summary.md
        pip-licenses --from=mixed --format=json | jq -r '.[] | select(.license | test("MIT|BSD|Apache")) | "- \(.name) (\(.license))"' >> license-summary.md

        cat license-summary.md

    - name: Upload license reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: license-reports
        path: |
          license-report.json
          license-detailed-report.json
          license-summary.md
        retention-days: 90

    - name: Comment PR with license summary
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          try {
            const summary = fs.readFileSync('license-summary.md', 'utf8');

            const comment = `## ğŸ“„ License Compliance Check

            ${summary}

            ---

            ğŸ“Š [View detailed reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            This comment is automatically generated by license check workflow`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Could not read license summary:', error);
          }

    - name: Check for license policy violations
      run: |
        echo "ğŸ” Checking license policy compliance..."

        # å®šä¹‰å…è®¸çš„è®¸å¯è¯åˆ—è¡¨
        ALLOWED_LICENSES="MIT BSD Apache GPL LGPL AGPL ISC MPL PSF"

        # æ£€æŸ¥æ˜¯å¦æœ‰æœªåœ¨å…è®¸åˆ—è¡¨ä¸­çš„è®¸å¯è¯
        VIOLATIONS=0

        while IFS= read -r line; do
          if [[ $line == *"=="* ]]; then
            PACKAGE=$(echo $line | cut -d' ' -f1)
            LICENSE=$(echo $line | cut -d'(' -f2 | cut -d')' -f1)

            # æ£€æŸ¥è®¸å¯è¯æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
            if [[ ! " $ALLOWED_LICENSES " =~ " $LICENSE " ]]; then
              echo "âš ï¸ Unknown license: $PACKAGE uses $LICENSE"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          fi
        done <<< "$(pip-licenses --from=mixed --format=table | tail -n +3)"

        if [ $VIOLATIONS -gt 0 ]; then
          echo "âŒ Found $VIOLATIONS license policy violations"
          echo "Please review the license policy and add any new licenses to the allowed list"
          exit 1
        else
          echo "âœ… All licenses comply with policy"
        fi

    - name: Update dependency documentation
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸ“ Updating dependency documentation..."

        # åˆ›å»ºä¾èµ–åˆ—è¡¨æ–‡æ¡£
        mkdir -p docs/operations

        cat > docs/operations/DEPENDENCIES.md << 'EOF'
        # Dependencies Documentation

        ## Overview

        This document lists all dependencies used in the Football Prediction System.

        ## Production Dependencies

        EOF

        # æ·»åŠ ä¾èµ–åˆ—è¡¨
        pip-licenses --from=mixed --format=markdown >> docs/operations/DEPENDENCIES.md

        # æ·»åŠ ç”Ÿæˆæ—¶é—´
        echo "" >> docs/operations/DEPENDENCIES.md
        echo "---" >> docs/operations/DEPENDENCIES.md
        echo "*Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> docs/operations/DEPENDENCIES.md

        # æäº¤æ›´æ”¹
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/operations/DEPENDENCIES.md
        git diff --staged --quiet || git commit -m "docs: update dependency documentation"
        git push || echo "No changes to commit or push failed"