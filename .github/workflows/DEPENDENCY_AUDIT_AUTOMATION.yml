name: Dependency Security Audit

on:
  schedule:
    - cron: "0 9 * * 1"  # æ¯å‘¨ä¸€ 17:00 (åŒ—äº¬æ—¶é—´)
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘
  pull_request:
    paths:
      - "requirements/**"

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  security_audit:
    runs-on: ubuntu-latest
    name: Run pip-audit security check

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local/share/virtualenvs
          key: ${{ runner.os }}-pip-audit-${{ hashFiles('requirements/**') }}
          restore-keys: |
            ${{ runner.os }}-pip-audit-

      - name: Install dependencies
        run: |
          echo "Installing project dependencies..."
          # ä¼˜å…ˆä½¿ç”¨å®Œæ•´ä¾èµ–æ–‡ä»¶ï¼Œå›é€€åˆ°åŸºç¡€ä¾èµ–
          if [ -f requirements/requirements.lock ]; then
            pip install -r requirements/requirements.lock
          elif [ -f requirements/base.lock ]; then
            pip install -r requirements/base.lock
          else
            echo "âŒ No lock file found!"
            exit 1
          fi

          # å®‰è£…å®¡è®¡å·¥å…·
          pip install pip-audit[toml]

          # æ˜¾ç¤ºå®‰è£…çš„åŒ…ç‰ˆæœ¬
          echo "âœ… Dependencies installed successfully"
          pip list | head -20

      - name: Create reports directory
        run: |
          mkdir -p docs/_reports/security
          mkdir -p docs/_reports/security/archives
          echo "ğŸ“ Created reports directory"

      - name: Run pip-audit security scan
        id: audit
        run: |
          timestamp=$(date +"%Y-%m-%d_%H-%M-%S")
          report_file="docs/_reports/security/pip_audit_$timestamp.md"
          archive_file="docs/_reports/security/archives/pip_audit_$timestamp.json"

          echo "ğŸ” Running security audit..."
          echo "Report file: $report_file"

          # ç”Ÿæˆ Markdown æŠ¥å‘Š
          pip-audit \
            -r requirements/requirements.lock \
            --format markdown \
            --output "$report_file" \
            --strict || true  # å…è®¸å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ

          # ç”Ÿæˆ JSON å½’æ¡£
          pip-audit \
            -r requirements/requirements.lock \
            --format json \
            --output "$archive_file" \
            --strict || true

          # æ·»åŠ æŠ¥å‘Šå¤´éƒ¨ä¿¡æ¯
          cat > temp_report.md << EOF
          # ğŸ”’ ä¾èµ–å®‰å…¨å®¡è®¡æŠ¥å‘Š

          > **æ‰«ææ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          > **æ‰«æå·¥å…·**: pip-audit
          > **Pythonç‰ˆæœ¬**: $(python --version)
          > **åˆ†æ”¯**: ${{ github.ref_name }}
          > **æäº¤**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

          ---

          EOF

          # è¿½åŠ åŸå§‹æŠ¥å‘Šå†…å®¹
          cat "$report_file" >> temp_report.md
          mv temp_report.md "$report_file"

          # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
          echo "ğŸ“Š Audit Statistics:"
          if grep -q "No known vulnerabilities found" "$report_file"; then
            echo "âœ… No vulnerabilities found"
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
          else
            vuln_count=$(grep -c "CVE-" "$report_file" 2>/dev/null || echo "0")
            echo "âš ï¸ Found $vuln_count vulnerabilities"
            echo "vulnerability_count=$vuln_count" >> $GITHUB_OUTPUT

            # ç»Ÿè®¡ä¸¥é‡çº§åˆ«
            critical_count=$(grep -c "CRITICAL" "$report_file" 2>/dev/null || echo "0")
            high_count=$(grep -c "HIGH" "$report_file" 2>/dev/null || echo "0")
            medium_count=$(grep -c "MEDIUM" "$report_file" 2>/dev/null || echo "0")
            low_count=$(grep -c "LOW" "$report_file" 2>/dev/null || echo "0")

            echo "critical_count=$critical_count" >> $GITHUB_OUTPUT
            echo "high_count=$high_count" >> $GITHUB_OUTPUT
            echo "medium_count=$medium_count" >> $GITHUB_OUTPUT
            echo "low_count=$low_count" >> $GITHUB_OUTPUT
          fi

          # ä¿å­˜æŠ¥å‘Šæ–‡ä»¶åä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "report_file=$report_file" >> $GITHUB_OUTPUT
          echo "archive_file=$archive_file" >> $GITHUB_OUTPUT

      - name: Generate summary report
        run: |
          timestamp=$(date +"%Y-%m-%d")
          summary_file="docs/_reports/security/README.md"

          # åˆ›å»ºæˆ–æ›´æ–°æ‘˜è¦æ–‡ä»¶
          cat > "$summary_file" << EOF
          # ğŸ”’ ä¾èµ–å®‰å…¨å®¡è®¡æŠ¥å‘Šç´¢å¼• (Dependency Security Audit Reports)

          æœ¬ç›®å½•ç”¨äºå­˜æ”¾é¡¹ç›®çš„ **pip-audit è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æç»“æœ**ï¼Œç”± CI å·¥ä½œæµ
          [.github/workflows/DEPENDENCY_AUDIT_AUTOMATION.yml](../../../.github/workflows/DEPENDENCY_AUDIT_AUTOMATION.yml)
          è‡ªåŠ¨ç”Ÿæˆã€‚

          ---

          ## ğŸ“… å®¡è®¡ä»»åŠ¡è¯´æ˜

          | é¡¹ç›® | è¯´æ˜ |
          |------|------|
          | **æ‰§è¡Œé¢‘ç‡** | æ¯å‘¨ä¸€ 17:00 (åŒ—äº¬æ—¶é—´) è‡ªåŠ¨æ‰§è¡Œ |
          | **è§¦å‘æ¡ä»¶** | 1) å®šæ—¶ä»»åŠ¡ <br> 2) æ‰‹åŠ¨è§¦å‘ <br> 3) ä¿®æ”¹ \`requirements/**\` |
          | **å®¡è®¡å·¥å…·** | [pip-audit](https://github.com/pypa/pip-audit) |
          | **æŠ¥å‘Šæ ¼å¼** | Markdown (å¯è¯»æ€§é«˜ï¼Œä¾¿äºå½’æ¡£ä¸å®¡é˜…) |
          | **æŠ¥å‘Šå‘½åè§„åˆ™** | \`pip_audit_YYYY-MM-DD_HH-MM-SS.md\` |
          | **æŠ¥å‘Šå­˜æ”¾è·¯å¾„** | \`docs/_reports/security/\` |

          ## ğŸ§© æŠ¥å‘Šç¤ºä¾‹
          \`\`\`
          docs/_reports/security/
          â”œâ”€â”€ pip_audit_2025-01-06_09-00-00.md
          â”œâ”€â”€ pip_audit_2025-01-05_09-00-00.md
          â””â”€â”€ README.md
          \`\`\`

          ## âš ï¸ æ¼æ´çº§åˆ«åˆ†ç±»

          | ç­‰çº§ | è¯´æ˜ | è¡ŒåŠ¨å»ºè®® |
          |------|------|-----------|
          | ğŸŸ¥ **CRITICAL** | é«˜å±æ¼æ´ï¼Œå½±å“ç³»ç»Ÿå®‰å…¨ | ç«‹å³ä¿®å¤å¹¶åˆ›å»ºç´§æ€¥ Issue |
          | ğŸŸ§ **HIGH** | ä¸¥é‡æ¼æ´ï¼Œå¯èƒ½å¯¼è‡´ä¾èµ–å¤±æ•ˆæˆ–æ•°æ®é£é™© | ä¼˜å…ˆä¿®å¤ |
          | ğŸŸ¨ **MEDIUM** | ä¸­ç­‰é£é™©ï¼Œå­˜åœ¨å…¼å®¹æ€§é—®é¢˜ | è¯„ä¼°å½±å“åä¿®å¤ |
          | ğŸŸ© **LOW** | ä½é£é™©æˆ–ä¿¡æ¯æ€§æé†’ | å¯å»¶åå¤„ç† |

          ## ğŸš¨ å‘ç°é«˜å±æ¼æ´æ—¶çš„å“åº”æµç¨‹

          1. æ£€æŸ¥æœ€æ–°æŠ¥å‘Šï¼ˆæ–‡ä»¶åæ—¶é—´æˆ³æœ€å¤§è€…ï¼‰ï¼›
          2. è‹¥åŒ…å« "CRITICAL" å…³é”®å­—ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»º Issueï¼›
          3. ç»´æŠ¤è€…éœ€ï¼š
             - ç¡®è®¤æ¼æ´åŒ…ï¼›
             - åœ¨ \`requirements/*.in\` ä¸­å‡çº§ä¾èµ–ï¼›
             - æ‰§è¡Œ \`make lock-deps && make verify-deps\`ï¼›
             - æäº¤ä¿®å¤ PRï¼›
          4. å®¡æ ¸é€šè¿‡åå…³é—­ Issueã€‚

          ## ğŸ“Š æœ€è¿‘æ‰«æç»“æœ

          | æ—¥æœŸ | æ€»æ¼æ´æ•° | ä¸¥é‡ | é«˜å± | ä¸­å± | ä½å± | çŠ¶æ€ |
          |------|----------|------|------|------|------|------|
          EOF

          # æ”¶é›†æœ€è¿‘10æ¬¡æ‰«æç»“æœ
          for report in $(ls -t docs/_reports/security/pip_audit_*.md 2>/dev/null | head -10); do
            report_date=$(echo "$report" | grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
            if [ -f "$report" ]; then
              if grep -q "No known vulnerabilities found" "$report"; then
                echo "| $report_date | âœ… 0 | - | - | - | - | ğŸŸ¢ å®‰å…¨ |" >> "$summary_file"
              else
                total=$(grep -c "CVE-" "$report" 2>/dev/null || echo "0")
                critical=$(grep -c "CRITICAL" "$report" 2>/dev/null || echo "0")
                high=$(grep -c "HIGH" "$report" 2>/dev/null || echo "0")
                medium=$(grep -c "MEDIUM" "$report" 2>/dev/null || echo "0")
                low=$(grep -c "LOW" "$report" 2>/dev/null || echo "0")

                # æ ¹æ®æ¼æ´æ•°é‡ç¡®å®šçŠ¶æ€
                if [ "$critical" -gt 0 ]; then
                  status="ğŸŸ¥ ä¸¥é‡"
                elif [ "$high" -gt 0 ]; then
                  status="ğŸŸ§ é«˜å±"
                elif [ "$medium" -gt 0 ]; then
                  status="ğŸŸ¨ ä¸­å±"
                else
                  status="ğŸŸ© ä½å±"
                fi

                echo "| $report_date | $total | $critical | $high | $medium | $low | $status |" >> "$summary_file"
              fi
            fi
          done

          echo "" >> "$summary_file"
          echo "## ğŸ“Š å†å²æŠ¥å‘Šç®¡ç†" >> "$summary_file"
          echo "" >> "$summary_file"
          echo "- ä¿ç•™æœ€è¿‘ 12 ä»½æŠ¥å‘Šï¼›" >> "$summary_file"
          echo "- è¾ƒæ—§æŠ¥å‘Šå¯ç§»åŠ¨è‡³ \`docs/_archive/security/\`ï¼›" >> "$summary_file"
          echo "- å®¡è®¡æ±‡æ€»ä¿¡æ¯å¯åœ¨ \`docs/_reports/SECURITY_SUMMARY.md\` ç»´æŠ¤ã€‚" >> "$summary_file"

          echo "" >> "$summary_file"
          echo "## ğŸ§  å‚è€ƒå‘½ä»¤" >> "$summary_file"
          echo "" >> "$summary_file"
          echo '```bash' >> "$summary_file"
          echo "# æ‰‹åŠ¨è¿è¡Œå®‰å…¨æ‰«æ" >> "$summary_file"
          echo "pip install pip-audit" >> "$summary_file"
          echo "pip-audit -r requirements/requirements.lock -f markdown -o docs/_reports/security/pip_audit_manual.md" >> "$summary_file"
          echo '```' >> "$summary_file"

          echo "" >> "$summary_file"
          echo "---" >> "$summary_file"
          echo "" >> "$summary_file"
          echo "ğŸ“Œ **ç»´æŠ¤æç¤º**ï¼š" >> "$summary_file"
          echo "è¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹å†å²æŠ¥å‘Šå†…å®¹ï¼›CI ä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶è¦†ç›–ã€‚" >> "$summary_file"

          # æ›´æ–°ç´¢å¼•
          if [ ! -f docs/_reports/README.md ]; then
            mkdir -p docs/_reports
            cat > docs/_reports/README.md << EOF
          # ğŸ“Š é¡¹ç›®æŠ¥å‘Šæ±‡æ€»

          æœ¬ç›®å½•åŒ…å«é¡¹ç›®çš„å„ç±»è‡ªåŠ¨åŒ–æŠ¥å‘Šï¼š

          - ğŸ”’ **[å®‰å…¨å®¡è®¡æŠ¥å‘Š](./security/)** - ä¾èµ–å®‰å…¨æ‰«æç»“æœ
          - ğŸ“ˆ **[æ€§èƒ½æŠ¥å‘Š](./performance/)** - æ€§èƒ½æµ‹è¯•ç»“æœï¼ˆå¾…å®ç°ï¼‰
          - ğŸ“‹ **[ä»£ç è´¨é‡æŠ¥å‘Š](./quality/)** - ä»£ç è´¨é‡åˆ†æï¼ˆå¾…å®ç°ï¼‰

          ## ğŸ”— ç›¸å…³é“¾æ¥

          - [ä¾èµ–ç»´æŠ¤æŒ‡å—](../maintenance/DEPENDENCY_GUARDIAN_MAINTENANCE_GUIDE.md)
          - [å®‰å…¨å®¡è®¡æ‰‹å†Œ](../maintenance/SECURITY_AUDIT_GUIDE.md)
          - [CI/CD å·¥ä½œæµ](../../.github/workflows/)
          - [é¡¹ç›®é¦–é¡µ](../../README.md)

          ## ğŸ“ æŠ¥å‘Šå†å²

          æ‰€æœ‰å†å²æŠ¥å‘Šè‡ªåŠ¨å½’æ¡£ï¼Œä¿ç•™æœ€è¿‘ 90 å¤©çš„è¯¦ç»†æ•°æ®ã€‚

          ---

          > ğŸ“Œ **è¯´æ˜**: æœ¬ç›®å½•ç»“æ„ç”±è‡ªåŠ¨åŒ–å·¥ä½œæµç»´æŠ¤ï¼Œå¦‚éœ€ä¿®æ”¹è¯·æ›´æ–°ç›¸åº”çš„å·¥ä½œæµé…ç½®æ–‡ä»¶ã€‚
          EOF
          fi

      - name: Upload audit report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-report-${{ github.run_number }}
          path: |
            docs/_reports/security/pip_audit_*.md
            docs/_reports/security/archives/*.json
          retention-days: 90
          if-no-files-found: warn

      - name: Detect critical vulnerabilities
        run: |
          report_file="${{ steps.audit.outputs.report_file }}"
          critical_count="${{ steps.audit.outputs.critical_count }}"
          high_count="${{ steps.audit.outputs.high_count }}"

          if [ "$critical_count" -gt 0 ] || [ "$high_count" -gt 0 ]; then
            echo "ğŸš¨ High-severity vulnerabilities detected!"

            # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„å¼€æ”¾ Issue
            existing_issue=$(gh issue list \
              --label "security,dependencies" \
              --state open \
              --json number \
              --jq '.[0].number' 2>/dev/null || echo "")

            if [ -z "$existing_issue" ]; then
              # åˆ›å»ºæ–°çš„ Issue
              issue_body="## ğŸš¨ ä¾èµ–å®‰å…¨æ¼æ´å‘Šè­¦

              **æ‰«ææ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              **åˆ†æ”¯**: ${{ github.ref_name }}
              **ä¸¥é‡æ¼æ´**: $critical_count ä¸ª
              **é«˜å±æ¼æ´**: $high_count ä¸ª

              ### ğŸ“‹ å¤„ç†å»ºè®®

              1. ç«‹å³æŸ¥çœ‹æœ€æ–°çš„å®‰å…¨å®¡è®¡æŠ¥å‘Š
              2. è¯„ä¼°æ¼æ´å¯¹é¡¹ç›®çš„å½±å“
              3. æ›´æ–°å—å½±å“çš„ä¾èµ–åŒ…
              4. åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ä¿®å¤
              5. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

              ### ğŸ“Š è¯¦ç»†æŠ¥å‘Š

              [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/$report_file)

              ### ğŸ”§ ä¿®å¤å‘½ä»¤

              \`\`\`bash
              # æ›´æ–°ä¾èµ–
              vim requirements/base.in
              make lock-deps
              make verify-deps
              make test

              # æäº¤ä¿®å¤
              git add requirements/
              git commit -m \"fix(security): fix CVE vulnerabilities\"
              \`\`\`

              ---

              > æ­¤ Issue ç”± [Dependency Audit Automation](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) è‡ªåŠ¨åˆ›å»º

              **æ ‡ç­¾**: security, dependencies, automated"

              gh issue create \
                --title "ğŸš¨ ä¾èµ–å®‰å…¨æ¼æ´å‘Šè­¦ (å‘ç° $((critical_count + high_count)) ä¸ªé«˜å±æ¼æ´)" \
                --body "$issue_body" \
                --label "security,dependencies,automated" \
                --assignee "${{ github.actor }}" || echo "Failed to create issue"
            else
              echo "â„¹ï¸ ç›¸å…³ Issue å·²å­˜åœ¨: #$existing_issue"
            fi
          else
            echo "âœ… No critical or high vulnerabilities found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit reports
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ æŠ¥å‘Šæ–‡ä»¶
          git add docs/_reports/security/

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "docs(security): update dependency audit report

            - æ‰«ææ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            - æ¼æ´æ•°é‡: ${{ steps.audit.outputs.vulnerability_count }}
            - ä¸¥é‡æ¼æ´: ${{ steps.audit.outputs.critical_count }}

            [skip ci]"

            echo "ğŸ“ Committed security report"
          fi

          # æ¨é€åˆ°ä»“åº“
          git push

      - name: Notify team on failure
        if: failure()
        run: |
          echo "âŒ Security audit failed!"
          echo "Please check the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
