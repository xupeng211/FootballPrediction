name: Dependency Security Audit

on:
  schedule:
    # æ¯å‘¨ä¸€ 09:00 UTC è‡ªåŠ¨è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 17:00ï¼‰
    - cron: "0 9 * * 1"
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  pull_request:
    paths:
      - "requirements/**"

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  security_audit:
    runs-on: ubuntu-latest
    name: Run pip-audit security check

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆæ›´å¥½çš„æŠ¥å‘Š

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local/share/virtualenvs
          key: ${{ runner.os }}-pip-audit-${{ hashFiles('requirements/**') }}
          restore-keys: |
            ${{ runner.os }}-pip-audit-

      - name: Install dependencies
        run: |
          echo "Installing project dependencies..."
          # ä¼˜å…ˆä½¿ç”¨å®Œæ•´ä¾èµ–æ–‡ä»¶ï¼Œå›é€€åˆ°åŸºç¡€ä¾èµ–
          if [ -f requirements/requirements.lock ]; then
            pip install -r requirements/requirements.lock
          elif [ -f requirements/base.lock ]; then
            pip install -r requirements/base.lock
          else
            echo "âŒ No lock file found!"
            exit 1
          fi

          # å®‰è£…å®¡è®¡å·¥å…·
          pip install pip-audit[toml]

          # æ˜¾ç¤ºå®‰è£…çš„åŒ…ç‰ˆæœ¬
          echo "âœ… Dependencies installed successfully"
          pip list | head -20

      - name: Create reports directory
        run: |
          mkdir -p docs/_reports/security
          mkdir -p docs/_reports/security/archives
          echo "ğŸ“ Created reports directory"

      - name: Run pip-audit security scan
        id: audit
        run: |
          timestamp=$(date +"%Y-%m-%d_%H-%M-%S")
          report_file="docs/_reports/security/pip_audit_$timestamp.md"
          archive_file="docs/_reports/security/archives/pip_audit_$timestamp.json"

          echo "ğŸ” Running security audit..."
          echo "Report file: $report_file"

          # ç”Ÿæˆ Markdown æŠ¥å‘Š
          pip-audit \
            -r requirements/requirements.lock \
            --format markdown \
            --output "$report_file" \
            --strict || true  # å…è®¸å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ

          # ç”Ÿæˆ JSON å½’æ¡£
          pip-audit \
            -r requirements/requirements.lock \
            --format json \
            --output "$archive_file" \
            --strict || true

          # æ·»åŠ æŠ¥å‘Šå¤´éƒ¨ä¿¡æ¯
          cat > temp_report.md << EOF
          # ğŸ”’ ä¾èµ–å®‰å…¨å®¡è®¡æŠ¥å‘Š

          > **æ‰«ææ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          > **æ‰«æå·¥å…·**: pip-audit
          > **Pythonç‰ˆæœ¬**: $(python --version)
          > **åˆ†æ”¯**: ${{ github.ref_name }}
          > **æäº¤**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

          ---

          EOF

          # è¿½åŠ åŸå§‹æŠ¥å‘Šå†…å®¹
          cat "$report_file" >> temp_report.md
          mv temp_report.md "$report_file"

          # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
          echo "ğŸ“Š Audit Statistics:"
          if grep -q "No known vulnerabilities found" "$report_file"; then
            echo "âœ… No vulnerabilities found"
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
          else
            vuln_count=$(grep -c "CVE-" "$report_file" 2>/dev/null || echo "0")
            echo "âš ï¸ Found $vuln_count vulnerabilities"
            echo "vulnerability_count=$vuln_count" >> $GITHUB_OUTPUT

            # ç»Ÿè®¡ä¸¥é‡çº§åˆ«
            critical_count=$(grep -c "CRITICAL" "$report_file" 2>/dev/null || echo "0")
            high_count=$(grep -c "HIGH" "$report_file" 2>/dev/null || echo "0")
            medium_count=$(grep -c "MEDIUM" "$report_file" 2>/dev/null || echo "0")
            low_count=$(grep -c "LOW" "$report_file" 2>/dev/null || echo "0")

            echo "critical_count=$critical_count" >> $GITHUB_OUTPUT
            echo "high_count=$high_count" >> $GITHUB_OUTPUT
            echo "medium_count=$medium_count" >> $GITHUB_OUTPUT
            echo "low_count=$low_count" >> $GITHUB_OUTPUT
          fi

          # ä¿å­˜æŠ¥å‘Šæ–‡ä»¶åä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "report_file=$report_file" >> $GITHUB_OUTPUT
          echo "archive_file=$archive_file" >> $GITHUB_OUTPUT

      - name: Generate summary report
        run: |
          timestamp=$(date +"%Y-%m-%d")
          summary_file="docs/_reports/security/README.md"

          # åˆ›å»ºæˆ–æ›´æ–°æ‘˜è¦æ–‡ä»¶
          cat > "$summary_file" << EOF
          # ğŸ”’ ä¾èµ–å®‰å…¨å®¡è®¡æŠ¥å‘Šæ±‡æ€»

          > **æœ€åæ›´æ–°**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          > **æ‰«æå‘¨æœŸ**: æ¯å‘¨ä¸€ 09:00 UTC (åŒ—äº¬æ—¶é—´ 17:00)
          > **æ‰«æå·¥å…·**: [pip-audit](https://github.com/pypa/pip-audit)

          ## ğŸ“Š æœ€è¿‘æ‰«æç»“æœ

          | æ—¥æœŸ | æ€»æ¼æ´æ•° | ä¸¥é‡ | é«˜å± | ä¸­å± | ä½å± | æŠ¥å‘Šé“¾æ¥ |
          |------|----------|------|------|------|------|----------|
          EOF

          # æ”¶é›†æœ€è¿‘10æ¬¡æ‰«æç»“æœ
          for report in $(ls -t docs/_reports/security/pip_audit_*.md 2>/dev/null | head -10); do
            report_date=$(echo "$report" | grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
            if [ -f "$report" ]; then
              if grep -q "No known vulnerabilities found" "$report"; then
                echo "| $report_date | âœ… 0 | - | - | - | - | [æŸ¥çœ‹æŠ¥å‘Š]($report) |" >> "$summary_file"
              else
                total=$(grep -c "CVE-" "$report" 2>/dev/null || echo "0")
                critical=$(grep -c "CRITICAL" "$report" 2>/dev/null || echo "0")
                high=$(grep -c "HIGH" "$report" 2>/dev/null || echo "0")
                medium=$(grep -c "MEDIUM" "$report" 2>/dev/null || echo "0")
                low=$(grep -c "LOW" "$report" 2>/dev/null || echo "0")
                echo "| $report_date | $total | $critical | $high | $medium | $low | [æŸ¥çœ‹æŠ¥å‘Š]($report) |" >> "$summary_file"
              fi
            fi
          done

          echo "" >> "$summary_file"
          echo "## ğŸ“ å†å²æŠ¥å‘Šå½’æ¡£" >> "$summary_file"
          echo "" >> "$summary_file"
          echo "æ‰€æœ‰å†å²æŠ¥å‘Šä¿å­˜åœ¨ [archives/](./archives/) ç›®å½•ä¸­ï¼Œä»¥ JSON æ ¼å¼å­˜å‚¨ã€‚" >> "$summary_file"

          # æ›´æ–°ç´¢å¼•
          if [ ! -f docs/_reports/README.md ]; then
            mkdir -p docs/_reports
            cat > docs/_reports/README.md << EOF
          # ğŸ“Š é¡¹ç›®æŠ¥å‘Šæ±‡æ€»

          æœ¬ç›®å½•åŒ…å«é¡¹ç›®çš„å„ç±»è‡ªåŠ¨åŒ–æŠ¥å‘Šï¼š

          - ğŸ”’ [å®‰å…¨å®¡è®¡æŠ¥å‘Š](./security/) - ä¾èµ–å®‰å…¨æ‰«æç»“æœ
          - ğŸ“ˆ [æ€§èƒ½æŠ¥å‘Š](./performance/) - æ€§èƒ½æµ‹è¯•ç»“æœï¼ˆå¾…å®ç°ï¼‰
          - ğŸ“‹ [ä»£ç è´¨é‡æŠ¥å‘Š](./quality/) - ä»£ç è´¨é‡åˆ†æï¼ˆå¾…å®ç°ï¼‰

          ## ğŸ”— ç›¸å…³é“¾æ¥

          - [ä¾èµ–ç»´æŠ¤æŒ‡å—](../maintenance/DEPENDENCY_GUARDIAN_MAINTENANCE_GUIDE.md)
          - [CI/CD å·¥ä½œæµ](../../.github/workflows/)
          EOF
          fi

      - name: Upload audit report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-report-${{ github.run_number }}
          path: |
            docs/_reports/security/pip_audit_*.md
            docs/_reports/security/archives/*.json
          retention-days: 90
          if-no-files-found: warn

      - name: Check for critical vulnerabilities
        run: |
          report_file="${{ steps.audit.outputs.report_file }}"
          critical_count="${{ steps.audit.outputs.critical_count }}"
          high_count="${{ steps.audit.outputs.high_count }}"

          if [ "$critical_count" -gt 0 ] || [ "$high_count" -gt 0 ]; then
            echo "ğŸš¨ High-severity vulnerabilities detected!"

            # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„å¼€æ”¾ Issue
            existing_issue=$(gh issue list \
              --label "security,dependencies" \
              --state open \
              --json number \
              --jq '.[0].number' 2>/dev/null || echo "")

            if [ -z "$existing_issue" ]; then
              # åˆ›å»ºæ–°çš„ Issue
              issue_body="## ğŸš¨ ä¾èµ–å®‰å…¨æ¼æ´å‘Šè­¦

              **æ‰«ææ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              **åˆ†æ”¯**: ${{ github.ref_name }}
              **ä¸¥é‡æ¼æ´**: $critical_count ä¸ª
              **é«˜å±æ¼æ´**: $high_count ä¸ª

              ### ğŸ“‹ å¤„ç†å»ºè®®

              1. ç«‹å³æŸ¥çœ‹æœ€æ–°çš„å®‰å…¨å®¡è®¡æŠ¥å‘Š
              2. è¯„ä¼°æ¼æ´å¯¹é¡¹ç›®çš„å½±å“
              3. æ›´æ–°å—å½±å“çš„ä¾èµ–åŒ…
              4. åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ä¿®å¤
              5. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

              ### ğŸ“Š è¯¦ç»†æŠ¥å‘Š

              [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/$report_file)

              ### ğŸ”§ ä¿®å¤å‘½ä»¤

              \`\`\`bash
              # æ›´æ–°ä¾èµ–
              vim requirements/base.in
              make lock-deps
              make verify-deps
              make test

              # æäº¤ä¿®å¤
              git add requirements/
              git commit -m \"fix(security): fix CVE vulnerabilities\"
              \`\`\`

              ---

              > æ­¤ Issue ç”± [Dependency Audit Automation](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) è‡ªåŠ¨åˆ›å»º

              **æ ‡ç­¾**: security, dependencies, automated"

              gh issue create \
                --title "ğŸš¨ ä¾èµ–å®‰å…¨æ¼æ´å‘Šè­¦ (å‘ç° $((critical_count + high_count)) ä¸ªé«˜å±æ¼æ´)" \
                --body "$issue_body" \
                --label "security,dependencies,automated" \
                --assignee "${{ github.actor }}" || echo "Failed to create issue"
            else
              echo "â„¹ï¸ ç›¸å…³ Issue å·²å­˜åœ¨: #$existing_issue"
            fi
          else
            echo "âœ… No critical or high vulnerabilities found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Security Badge
        if: always()
        run: |
          vulnerability_count="${{ steps.audit.outputs.vulnerability_count }}"
          critical_count="${{ steps.audit.outputs.critical_count }}"

          # æ›´æ–°å¾½ç« çŠ¶æ€
          if [ "$vulnerability_count" = "0" ]; then
            badge_color="brightgreen"
            badge_status="secure"
            badge_message="0%20vulnerabilities"
          elif [ "$critical_count" -gt 0 ]; then
            badge_color="critical"
            badge_status="critical"
            badge_message="$vulnerability_count%20vulns"
          else
            badge_color="yellow"
            badge_status="warning"
            badge_message="$vulnerability_count%20vulns"
          fi

          # åˆ›å»ºæˆ–æ›´æ–°å¾½ç« æ–‡ä»¶
          badge_file="docs/_reports/security/security-badge.svg"

          cat > "$badge_file" << EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="120" height="20" role="img">
            <title>Security: $badge_message</title>
            <linearGradient id="s" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <mask id="m">
              <rect width="120" height="20" rx="3" fill="#fff"/>
            </mask>
            <g mask="url(#m)">
              <rect width="60" height="20" fill="#555"/>
              <rect width="60" height="20" fill="#$badge_color"/>
              <rect width="120" height="20" fill="url(#s)"/>
            </g>
            <g aria-hidden="true" fill="#fff" text-anchor="middle" font-family="Verdana,Geneva,DejaVu Sans,sans-serif" text-rendering="geometricPrecision" font-size="110">
              <text aria-hidden="true" x="30" y="150" fill="#010101" transform="rotate(360 30 115)" textLength="30" lengthAdjust="spacing">security</text>
              <text x="90" y="150" transform="rotate(360 90 115)" textLength="50" lengthAdjust="spacing">$badge_message</text>
            </g>
          </svg>
          EOF

          echo "ğŸ“ˆ Security badge updated: $badge_status"

      - name: Commit reports
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ æŠ¥å‘Šæ–‡ä»¶
          git add docs/_reports/security/

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "docs(security): update dependency audit report

            - æ‰«ææ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            - æ¼æ´æ•°é‡: ${{ steps.audit.outputs.vulnerability_count }}
            - ä¸¥é‡æ¼æ´: ${{ steps.audit.outputs.critical_count }}

            [skip ci]"

            echo "ğŸ“ Committed security report"
          fi

          # æ¨é€åˆ°ä»“åº“
          git push

      - name: Notify team on failure
        if: failure()
        run: |
          echo "âŒ Security audit failed!"
          echo "Please check the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # å¯é€‰ï¼šå‘é€é€šçŸ¥åˆ° Slack æˆ–å…¶ä»–æ¸ é“
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸš¨ Dependency security audit failed! Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }} || true