name: Dependency Security Audit

on:
  schedule:
    - cron: "0 9 * * 1"  # 每周一 17:00 (北京时间)
  workflow_dispatch:      # 手动触发
  pull_request:
    paths:
      - "requirements/**"

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  security_audit:
    runs-on: ubuntu-latest
    name: Run pip-audit security check

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local/share/virtualenvs
          key: ${{ runner.os }}-pip-audit-${{ hashFiles('requirements/**') }}
          restore-keys: |
            ${{ runner.os }}-pip-audit-

      - name: Install dependencies
        run: |
          echo "Installing project dependencies..."
          # 优先使用完整依赖文件，回退到基础依赖
          if [ -f requirements/requirements.lock ]; then
            pip install -r requirements/requirements.lock
          elif [ -f requirements/base.lock ]; then
            pip install -r requirements/base.lock
          else
            echo "❌ No lock file found!"
            exit 1
          fi

          # 安装审计工具
          pip install pip-audit[toml]

          # 显示安装的包版本
          echo "✅ Dependencies installed successfully"
          pip list | head -20

      - name: Create reports directory
        run: |
          mkdir -p docs/_reports/security
          mkdir -p docs/_reports/security/archives
          echo "📁 Created reports directory"

      - name: Run pip-audit security scan
        id: audit
        run: |
          timestamp=$(date +"%Y-%m-%d_%H-%M-%S")
          report_file="docs/_reports/security/pip_audit_$timestamp.md"
          archive_file="docs/_reports/security/archives/pip_audit_$timestamp.json"

          echo "🔍 Running security audit..."
          echo "Report file: $report_file"

          # 生成 Markdown 报告
          pip-audit \
            -r requirements/requirements.lock \
            --format markdown \
            --output "$report_file" \
            --strict || true  # 允许失败但继续执行

          # 生成 JSON 归档
          pip-audit \
            -r requirements/requirements.lock \
            --format json \
            --output "$archive_file" \
            --strict || true

          # 添加报告头部信息
          cat > temp_report.md << EOF
          # 🔒 依赖安全审计报告

          > **扫描时间**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          > **扫描工具**: pip-audit
          > **Python版本**: $(python --version)
          > **分支**: ${{ github.ref_name }}
          > **提交**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

          ---

          EOF

          # 追加原始报告内容
          cat "$report_file" >> temp_report.md
          mv temp_report.md "$report_file"

          # 输出统计信息
          echo "📊 Audit Statistics:"
          if grep -q "No known vulnerabilities found" "$report_file"; then
            echo "✅ No vulnerabilities found"
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
          else
            vuln_count=$(grep -c "CVE-" "$report_file" 2>/dev/null || echo "0")
            echo "⚠️ Found $vuln_count vulnerabilities"
            echo "vulnerability_count=$vuln_count" >> $GITHUB_OUTPUT

            # 统计严重级别
            critical_count=$(grep -c "CRITICAL" "$report_file" 2>/dev/null || echo "0")
            high_count=$(grep -c "HIGH" "$report_file" 2>/dev/null || echo "0")
            medium_count=$(grep -c "MEDIUM" "$report_file" 2>/dev/null || echo "0")
            low_count=$(grep -c "LOW" "$report_file" 2>/dev/null || echo "0")

            echo "critical_count=$critical_count" >> $GITHUB_OUTPUT
            echo "high_count=$high_count" >> $GITHUB_OUTPUT
            echo "medium_count=$medium_count" >> $GITHUB_OUTPUT
            echo "low_count=$low_count" >> $GITHUB_OUTPUT
          fi

          # 保存报告文件名供后续步骤使用
          echo "report_file=$report_file" >> $GITHUB_OUTPUT
          echo "archive_file=$archive_file" >> $GITHUB_OUTPUT

      - name: Generate summary report
        run: |
          timestamp=$(date +"%Y-%m-%d")
          summary_file="docs/_reports/security/README.md"

          # 创建或更新摘要文件
          cat > "$summary_file" << EOF
          # 🔒 依赖安全审计报告索引 (Dependency Security Audit Reports)

          本目录用于存放项目的 **pip-audit 自动化安全扫描结果**，由 CI 工作流
          [.github/workflows/DEPENDENCY_AUDIT_AUTOMATION.yml](../../../.github/workflows/DEPENDENCY_AUDIT_AUTOMATION.yml)
          自动生成。

          ---

          ## 📅 审计任务说明

          | 项目 | 说明 |
          |------|------|
          | **执行频率** | 每周一 17:00 (北京时间) 自动执行 |
          | **触发条件** | 1) 定时任务 <br> 2) 手动触发 <br> 3) 修改 \`requirements/**\` |
          | **审计工具** | [pip-audit](https://github.com/pypa/pip-audit) |
          | **报告格式** | Markdown (可读性高，便于归档与审阅) |
          | **报告命名规则** | \`pip_audit_YYYY-MM-DD_HH-MM-SS.md\` |
          | **报告存放路径** | \`docs/_reports/security/\` |

          ## 🧩 报告示例
          \`\`\`
          docs/_reports/security/
          ├── pip_audit_2025-01-06_09-00-00.md
          ├── pip_audit_2025-01-05_09-00-00.md
          └── README.md
          \`\`\`

          ## ⚠️ 漏洞级别分类

          | 等级 | 说明 | 行动建议 |
          |------|------|-----------|
          | 🟥 **CRITICAL** | 高危漏洞，影响系统安全 | 立即修复并创建紧急 Issue |
          | 🟧 **HIGH** | 严重漏洞，可能导致依赖失效或数据风险 | 优先修复 |
          | 🟨 **MEDIUM** | 中等风险，存在兼容性问题 | 评估影响后修复 |
          | 🟩 **LOW** | 低风险或信息性提醒 | 可延后处理 |

          ## 🚨 发现高危漏洞时的响应流程

          1. 检查最新报告（文件名时间戳最大者）；
          2. 若包含 "CRITICAL" 关键字，系统会自动创建 Issue；
          3. 维护者需：
             - 确认漏洞包；
             - 在 \`requirements/*.in\` 中升级依赖；
             - 执行 \`make lock-deps && make verify-deps\`；
             - 提交修复 PR；
          4. 审核通过后关闭 Issue。

          ## 📊 最近扫描结果

          | 日期 | 总漏洞数 | 严重 | 高危 | 中危 | 低危 | 状态 |
          |------|----------|------|------|------|------|------|
          EOF

          # 收集最近10次扫描结果
          for report in $(ls -t docs/_reports/security/pip_audit_*.md 2>/dev/null | head -10); do
            report_date=$(echo "$report" | grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')
            if [ -f "$report" ]; then
              if grep -q "No known vulnerabilities found" "$report"; then
                echo "| $report_date | ✅ 0 | - | - | - | - | 🟢 安全 |" >> "$summary_file"
              else
                total=$(grep -c "CVE-" "$report" 2>/dev/null || echo "0")
                critical=$(grep -c "CRITICAL" "$report" 2>/dev/null || echo "0")
                high=$(grep -c "HIGH" "$report" 2>/dev/null || echo "0")
                medium=$(grep -c "MEDIUM" "$report" 2>/dev/null || echo "0")
                low=$(grep -c "LOW" "$report" 2>/dev/null || echo "0")

                # 根据漏洞数量确定状态
                if [ "$critical" -gt 0 ]; then
                  status="🟥 严重"
                elif [ "$high" -gt 0 ]; then
                  status="🟧 高危"
                elif [ "$medium" -gt 0 ]; then
                  status="🟨 中危"
                else
                  status="🟩 低危"
                fi

                echo "| $report_date | $total | $critical | $high | $medium | $low | $status |" >> "$summary_file"
              fi
            fi
          done

          echo "" >> "$summary_file"
          echo "## 📊 历史报告管理" >> "$summary_file"
          echo "" >> "$summary_file"
          echo "- 保留最近 12 份报告；" >> "$summary_file"
          echo "- 较旧报告可移动至 \`docs/_archive/security/\`；" >> "$summary_file"
          echo "- 审计汇总信息可在 \`docs/_reports/SECURITY_SUMMARY.md\` 维护。" >> "$summary_file"

          echo "" >> "$summary_file"
          echo "## 🧠 参考命令" >> "$summary_file"
          echo "" >> "$summary_file"
          echo '```bash' >> "$summary_file"
          echo "# 手动运行安全扫描" >> "$summary_file"
          echo "pip install pip-audit" >> "$summary_file"
          echo "pip-audit -r requirements/requirements.lock -f markdown -o docs/_reports/security/pip_audit_manual.md" >> "$summary_file"
          echo '```' >> "$summary_file"

          echo "" >> "$summary_file"
          echo "---" >> "$summary_file"
          echo "" >> "$summary_file"
          echo "📌 **维护提示**：" >> "$summary_file"
          echo "请勿手动修改历史报告内容；CI 会自动生成并覆盖。" >> "$summary_file"

          # 更新索引
          if [ ! -f docs/_reports/README.md ]; then
            mkdir -p docs/_reports
            cat > docs/_reports/README.md << EOF
          # 📊 项目报告汇总

          本目录包含项目的各类自动化报告：

          - 🔒 **[安全审计报告](./security/)** - 依赖安全扫描结果
          - 📈 **[性能报告](./performance/)** - 性能测试结果（待实现）
          - 📋 **[代码质量报告](./quality/)** - 代码质量分析（待实现）

          ## 🔗 相关链接

          - [依赖维护指南](../maintenance/DEPENDENCY_GUARDIAN_MAINTENANCE_GUIDE.md)
          - [安全审计手册](../maintenance/SECURITY_AUDIT_GUIDE.md)
          - [CI/CD 工作流](../../.github/workflows/)
          - [项目首页](../../README.md)

          ## 📝 报告历史

          所有历史报告自动归档，保留最近 90 天的详细数据。

          ---

          > 📌 **说明**: 本目录结构由自动化工作流维护，如需修改请更新相应的工作流配置文件。
          EOF
          fi

      - name: Upload audit report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-report-${{ github.run_number }}
          path: |
            docs/_reports/security/pip_audit_*.md
            docs/_reports/security/archives/*.json
          retention-days: 90
          if-no-files-found: warn

      - name: Detect critical vulnerabilities
        run: |
          report_file="${{ steps.audit.outputs.report_file }}"
          critical_count="${{ steps.audit.outputs.critical_count }}"
          high_count="${{ steps.audit.outputs.high_count }}"

          if [ "$critical_count" -gt 0 ] || [ "$high_count" -gt 0 ]; then
            echo "🚨 High-severity vulnerabilities detected!"

            # 检查是否已有相同的开放 Issue
            existing_issue=$(gh issue list \
              --label "security,dependencies" \
              --state open \
              --json number \
              --jq '.[0].number' 2>/dev/null || echo "")

            if [ -z "$existing_issue" ]; then
              # 创建新的 Issue
              issue_body="## 🚨 依赖安全漏洞告警

              **扫描时间**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              **分支**: ${{ github.ref_name }}
              **严重漏洞**: $critical_count 个
              **高危漏洞**: $high_count 个

              ### 📋 处理建议

              1. 立即查看最新的安全审计报告
              2. 评估漏洞对项目的影响
              3. 更新受影响的依赖包
              4. 在测试环境验证修复
              5. 部署到生产环境

              ### 📊 详细报告

              [查看完整报告](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/$report_file)

              ### 🔧 修复命令

              \`\`\`bash
              # 更新依赖
              vim requirements/base.in
              make lock-deps
              make verify-deps
              make test

              # 提交修复
              git add requirements/
              git commit -m \"fix(security): fix CVE vulnerabilities\"
              \`\`\`

              ---

              > 此 Issue 由 [Dependency Audit Automation](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) 自动创建

              **标签**: security, dependencies, automated"

              gh issue create \
                --title "🚨 依赖安全漏洞告警 (发现 $((critical_count + high_count)) 个高危漏洞)" \
                --body "$issue_body" \
                --label "security,dependencies,automated" \
                --assignee "${{ github.actor }}" || echo "Failed to create issue"
            else
              echo "ℹ️ 相关 Issue 已存在: #$existing_issue"
            fi
          else
            echo "✅ No critical or high vulnerabilities found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit reports
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # 添加报告文件
          git add docs/_reports/security/

          # 检查是否有变更
          if git diff --staged --quiet; then
            echo "ℹ️ No changes to commit"
          else
            git commit -m "docs(security): update dependency audit report

            - 扫描时间: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            - 漏洞数量: ${{ steps.audit.outputs.vulnerability_count }}
            - 严重漏洞: ${{ steps.audit.outputs.critical_count }}

            [skip ci]"

            echo "📝 Committed security report"
          fi

          # 推送到仓库
          git push

      - name: Notify team on failure
        if: failure()
        run: |
          echo "❌ Security audit failed!"
          echo "Please check the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
