name: ðŸ“š Enhanced Documentation CI/CD

on:
  push:
    branches: [main, develop, docs/**]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs-enhanced.yml'
      - 'scripts/docs_ci_pipeline.py'
  pull_request:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'scripts/docs_ci_pipeline.py'
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to GitHub Pages'
        required: false
        default: false
        type: boolean
      environment:
        description: 'Target environment'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      quality_check:
        description: 'Run quality checks'
        required: false
        default: true
        type: boolean

# å–æ¶ˆå¹¶è¡Œçš„è¿è¡Œï¼Œé¿å…èµ„æºæµªè´¹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ===== é˜¶æ®µ 1: çŽ¯å¢ƒå‡†å¤‡ =====
  setup:
    name: ðŸ”§ çŽ¯å¢ƒå‡†å¤‡
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}

    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4.1.6
        with:
          fetch-depth: 0

      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4.7.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material
          pip install -r requirements/requirements.lock

      - name: ðŸ“‹ è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ å®‰è£…Node.jsä¾èµ–
        run: |
          npm install -g markdown-link-check
          npm install -g htmlhint

      - name: ðŸ’¾ ç¼“å­˜ä¾èµ–
        id: cache
        uses: actions/cache@v3.3.2
        with:
          path: |
            ~/.cache/pip
            ~/.npm
            node_modules
          key: ${{ runner.os }}-docs-${{ hashFiles('**/requirements*.lock', '**/package*.json') }}
          restore-keys: |
            ${{ runner.os }}-docs-

  # ===== é˜¶æ®µ 2: æ–‡æ¡£éªŒè¯ =====
  validate:
    name: ðŸ” æ–‡æ¡£éªŒè¯
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4.1.6
        with:
          fetch-depth: 0

      - name: ðŸ æ¢å¤Pythonç¼“å­˜
        uses: actions/cache@v3.3.2
        with:
          path: |
            ~/.cache/pip
            ~/.npm
            node_modules
          key: ${{ runner.os }}-docs-${{ hashFiles('**/requirements*.lock', '**/package*.json') }}

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material
          pip install -r requirements/requirements.lock

      - name: ðŸƒâ€â™‚ï¸ è¿è¡Œæ–‡æ¡£CIæµæ°´çº¿
        run: |
          python scripts/docs_ci_pipeline.py \
            --build \
            --quality-check \
            --report-output docs-validation-report.json

      - name: ðŸ“Š ä¸Šä¼ éªŒè¯æŠ¥å‘Š
        uses: actions/upload-artifact@v3.1.3
        with:
          name: docs-validation-report
          path: |
            docs-validation-report.json
            .build/docs/pipeline_report_*.json
          retention-days: 30

      - name: ðŸ”— é“¾æŽ¥æ£€æŸ¥
        run: |
          echo "ðŸ”— æ‰§è¡Œæ–‡æ¡£é“¾æŽ¥æ£€æŸ¥..."
          markdown-link-check docs/ \
            --verbose \
            --config .mlc_config.json \
            --timeout 30 || {
            echo "âš ï¸ é“¾æŽ¥æ£€æŸ¥å‘çŽ°é—®é¢˜ï¼Œä½†ç»§ç»­æž„å»º"
          }

      - name: ðŸ“‹ è¯­æ³•æ£€æŸ¥
        run: |
          echo "ðŸ“‹ æ‰§è¡ŒMarkdownè¯­æ³•æ£€æŸ¥..."
          find docs -name "*.md" -exec echo "æ£€æŸ¥: {}" \; -exec markdownlint {} \; || {
            echo "âš ï¸ Markdownè¯­æ³•æ£€æŸ¥å‘çŽ°é—®é¢˜"
          }

  # ===== é˜¶æ®µ 3: æž„å»ºæ–‡æ¡£ =====
  build:
    name: ðŸ”¨ æž„å»ºæ–‡æ¡£
    runs-on: ubuntu-latest
    needs: [setup, validate]
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4.1.6
        with:
          fetch-depth: 0

      - name: ðŸ æ¢å¤Pythonç¼“å­˜
        uses: actions/cache@v3.3.2
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-docs-${{ hashFiles('**/requirements*.lock') }}

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material
          pip install -r requirements/requirements.lock

      - name: ðŸ”¨ æž„å»ºæ–‡æ¡£ç«™ç‚¹
        run: |
          echo "ðŸ”¨ å¼€å§‹æž„å»ºæ–‡æ¡£ç«™ç‚¹..."

          # æ¸…ç†ä¹‹å‰çš„æž„å»º
          rm -rf site/

          # æž„å»ºæ–‡æ¡£
          mkdocs build --verbose --clean

          # æ£€æŸ¥æž„å»ºç»“æžœ
          if [ ! -f "site/index.html" ]; then
            echo "âŒ æž„å»ºå¤±è´¥ï¼šä¸»é¡µé¢æœªç”Ÿæˆ"
            exit 1
          fi

          # ç»Ÿè®¡ç”Ÿæˆçš„é¡µé¢
          HTML_FILES=$(find site -name "*.html" | wc -l)
          echo "âœ… æž„å»ºæˆåŠŸï¼šç”Ÿæˆ $HTML_FILES ä¸ªHTMLé¡µé¢"

          # æ£€æŸ¥ç«™ç‚¹å¤§å°
          SITE_SIZE=$(du -sh site/ | cut -f1)
          echo "ðŸ“¦ ç«™ç‚¹å¤§å°ï¼š$SITE_SIZE"

      - name: ðŸ“Š ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        run: |
          cat > build-report.json << EOF
          {
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "$(git rev-parse --short HEAD)",
            "branch": "$(git rev-parse --abbrev-ref HEAD)",
            "html_pages": $(find site -name "*.html" | wc -l),
            "css_files": $(find site -name "*.css" | wc -l),
            "js_files": $(find site -name "*.js" | wc -l),
            "site_size": "$(du -sh site/ | cut -f1)",
            "build_status": "success"
          }
          EOF

      - name: ðŸ“¦ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3.1.3
        with:
          name: docs-site-${{ github.sha }}
          path: |
            site/
            build-report.json
          retention-days: 30

  # ===== é˜¶æ®µ 4: è´¨é‡æ£€æŸ¥ =====
  quality:
    name: ðŸ“ˆ è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4.1.6

      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4.7.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v3.0.2
        with:
          name: docs-site-${{ github.sha }}
          path: site/

      - name: ðŸ“ˆ æ‰§è¡Œè´¨é‡åˆ†æž
        run: |
          python scripts/docs_ci_pipeline.py \
            --quality-check \
            --report-output docs-quality-report.json

      - name: ðŸŽ¯ æ€§èƒ½åˆ†æž
        run: |
          echo "ðŸŽ¯ æ‰§è¡Œæ€§èƒ½åˆ†æž..."

          # æ£€æŸ¥é¡µé¢å¤§å°
          LARGE_PAGES=$(find site -name "*.html" -exec wc -c {} + | awk '$1 > 50000' | wc -l)
          if [ "$LARGE_PAGES" -gt 0 ]; then
            echo "âš ï¸ å‘çŽ° $LARGE_PAGES ä¸ªå¤§åž‹é¡µé¢ï¼ˆ>50KBï¼‰"
          fi

          # æ£€æŸ¥å›¾ç‰‡ä¼˜åŒ–
          IMAGES=$(find site -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" | wc -l)
          echo "ðŸ“· å›¾ç‰‡æ•°é‡ï¼š$IMAGES"

          # æ£€æŸ¥HTMLæœ‰æ•ˆæ€§
          npm install -g html-validator
          find site -name "*.html" -exec html-validator {} \; || {
            echo "âš ï¸ HTMLéªŒè¯å‘çŽ°é—®é¢˜"
          }

      - name: ðŸ“Š ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v3.1.3
        with:
          name: docs-quality-report
          path: |
            docs-quality-report.json
            .build/docs/pipeline_report_*.json
          retention-days: 30

  # ===== é˜¶æ®µ 5: éƒ¨ç½²åˆ°GitHub Pages =====
  deploy:
    name: ðŸš€ éƒ¨ç½²åˆ°GitHub Pages
    runs-on: ubuntu-latest
    needs: [validate, build, quality]
    if: |
      github.ref == 'refs/heads/main' ||
      github.ref == 'refs/heads/develop' ||
      github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true'
    timeout-minutes: 10
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4.1.6

      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4.7.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material
          pip install -r requirements/requirements.lock

      - name: ðŸ“¦ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v3.0.2
        with:
          name: docs-site-${{ github.sha }}
          path: site/

      - name: ðŸš€ é…ç½®GitHub Pages
        uses: actions/configure-pages@v4.0.0

      - name: ðŸš€ éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4.0.5

      - name: ðŸ“Š éƒ¨ç½²æŠ¥å‘Š
        run: |
          echo "ðŸŽ‰ æ–‡æ¡£å·²æˆåŠŸéƒ¨ç½²åˆ°GitHub Pages!"
          echo "ðŸ”— è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}"

          # ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
          cat > deployment-report.json << EOF
          {
            "deployment_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "$(git rev-parse --short HEAD)",
            "branch": "$(git rev-parse --abbrev-ref HEAD)",
            "deployment_url": "${{ steps.deployment.outputs.page_url }}",
            "environment": "${{ github.ref_name }}",
            "status": "success"
          }
          EOF

      - name: ðŸ“¦ ä¸Šä¼ éƒ¨ç½²æŠ¥å‘Š
        uses: actions/upload-artifact@v3.1.3
        with:
          name: docs-deployment-report
          path: deployment-report.json
          retention-days: 90

  # ===== é˜¶æ®µ 6: é€šçŸ¥ =====
  notify:
    name: ðŸ“¢ é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [validate, build, quality, deploy]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ðŸ“¢ æž„å»ºçŠ¶æ€é€šçŸ¥
        run: |
          echo "ðŸ“Š æ–‡æ¡£CI/CDæµæ°´çº¿æ‰§è¡Œå®Œæˆ"
          echo "======================================="
          echo "ðŸ” éªŒè¯çŠ¶æ€: ${{ needs.validate.result }}"
          echo "ðŸ”¨ æž„å»ºçŠ¶æ€: ${{ needs.build.result }}"
          echo "ðŸ“ˆ è´¨é‡æ£€æŸ¥: ${{ needs.quality.result }}"
          echo "ðŸš€ éƒ¨ç½²çŠ¶æ€: ${{ needs.deploy.result }}"
          echo "======================================="

          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ðŸŽ‰ æ–‡æ¡£å·²æˆåŠŸéƒ¨ç½²åˆ°GitHub Pages!"
            echo "ðŸ“– è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          elif [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… æ–‡æ¡£æž„å»ºæˆåŠŸï¼Œä½†æœªéƒ¨ç½²"
          else
            echo "âŒ æ–‡æ¡£æž„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
            echo "ðŸ”— æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

      - name: ðŸ“§ å‘é€é‚®ä»¶é€šçŸ¥ (å¯é€‰)
        if: failure() && github.event_name == 'push'
        run: |
          echo "ðŸ“§ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‚®ä»¶é€šçŸ¥é€»è¾‘"
          # ä½¿ç”¨GitHub Actionsçš„é‚®ä»¶å‘é€actionæˆ–è‡ªå®šä¹‰é‚®ä»¶æœåŠ¡

# ===== å·¥ä½œæµä¿¡æ¯ =====
outputs:
  site_url:
    description: "éƒ¨ç½²çš„æ–‡æ¡£ç«™ç‚¹URL"
    value: ${{ jobs.deploy.outputs.page_url }}
  build_status:
    description: "æž„å»ºçŠ¶æ€"
    value: ${{ jobs.build.result }}
  deployment_status:
    description: "éƒ¨ç½²çŠ¶æ€"
    value: ${{ jobs.deploy.result }}