name: Kanban History Summary

on:
  schedule:
    - cron: "0 2 * * 1"  # æ¯å‘¨ä¸€ 02:00 UTC æ‰§è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate-kanban-history:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git config
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Scan Kanban check reports
        id: scan-reports
        run: |
          REPORTS_DIR="docs/_reports"
          HISTORY_FILE="$REPORTS_DIR/KANBAN_HISTORY.md"
          TODAY=$(date -u +"%Y-%m-%d")

          # ç¡®ä¿æŠ¥å‘Šç›®å½•å­˜åœ¨
          mkdir -p "$REPORTS_DIR"

          # æŸ¥æ‰¾æ‰€æœ‰ KANBAN_CHECK_REPORT æ–‡ä»¶
          REPORT_FILES=$(find "$REPORTS_DIR" -name "KANBAN_CHECK_REPORT*.md" -type f | sort -r)

          if [ -z "$REPORT_FILES" ]; then
            echo "ğŸ“‹ æœ¬å‘¨æ— å¤±è´¥è®°å½•"
            echo "no_reports=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ğŸ“‹ å‘ç° $(echo "$REPORT_FILES" | wc -l) ä¸ªæ£€æŸ¥æŠ¥å‘Š"

          # ç”Ÿæˆæ–°çš„æ±‡æ€»å†…å®¹
          NEW_CONTENT="# ğŸ—‚ï¸ Kanban æ£€æŸ¥å†å²æ±‡æ€»\n\n"
          NEW_CONTENT="$NEW_CONTENT**æœ€åæ›´æ–°**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")\n\n"

          # å¤„ç†æ¯ä¸ªæŠ¥å‘Šæ–‡ä»¶
          for report_file in $REPORT_FILES; do
            echo "ğŸ“„ å¤„ç†æŠ¥å‘Š: $report_file"

            # æå–æŠ¥å‘Šä¿¡æ¯
            if [ -f "$report_file" ]; then
              # æå–ç”Ÿæˆæ—¶é—´
              gen_time=$(grep "ç”Ÿæˆæ—¶é—´:" "$report_file" | sed 's/**ç”Ÿæˆæ—¶é—´**: //')

              # æå– CI ç¼–å·
              ci_run=$(grep "CI è¿è¡Œç¼–å·:" "$report_file" | sed 's/**CI è¿è¡Œç¼–å·**: //')

              # æå–æäº¤ SHA
              commit_sha=$(grep "æäº¤ SHA:" "$report_file" | sed 's/**æäº¤ SHA**: //')

              # æå–å¤±è´¥åŸå› 
              reason=$(grep "åŸå› :" "$report_file" | sed 's/.*åŸå› : //')

              # æå–æ—¥æœŸä½œä¸ºæ ‡é¢˜
              if [ -n "$gen_time" ]; then
                date_title=$(echo "$gen_time" | cut -d' ' -f1)
                NEW_CONTENT="$NEW_CONTENT## $date_title\n"
                NEW_CONTENT="$NEW_CONTENT- çŠ¶æ€: âŒ å¤±è´¥\n"
                NEW_CONTENT="$NEW_CONTENT- åŸå› : $reason\n"
                NEW_CONTENT="$NEW_CONTENT- æäº¤ SHA: $commit_sha\n"
                NEW_CONTENT="$NEW_CONTENT- CI è¿è¡Œç¼–å·: $ci_run\n"
                NEW_CONTENT="$NEW_CONTENT\n---\n\n"
              fi
            fi
          done

          # ç§»é™¤æœ€åçš„åˆ†éš”çº¿
          NEW_CONTENT=$(echo "$NEW_CONTENT" | sed '/^---$/N;/^\n$/D')

          # å†™å…¥å†å²æ–‡ä»¶
          echo "$NEW_CONTENT" > "$HISTORY_FILE"
          echo "âœ… å†å²æ±‡æ€»å·²ç”Ÿæˆ: $HISTORY_FILE"
          echo "has_reports=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.scan-reports.outputs.has_reports == 'true'
        run: |
          HISTORY_FILE="docs/_reports/KANBAN_HISTORY.md"

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if ! git diff --quiet "$HISTORY_FILE"; then
            echo "ğŸ“¤ æäº¤å†å²æ±‡æ€»æ›´æ–°..."
            git add "$HISTORY_FILE"
            git commit -m "chore(report): update KANBAN_HISTORY.md (weekly summary)"
            git push origin main
            echo "âœ… æäº¤æˆåŠŸ"
          else
            echo "â„¹ï¸ æ— å˜åŒ–éœ€è¦æäº¤"
          fi

      - name: Summary
        run: |
          if [ "${{ steps.scan-reports.outputs.has_reports }}" = "true" ]; then
            echo "âœ… \033[32mKanban å†å²æ±‡æ€»æ›´æ–°å®Œæˆ\033[0m"
          else
            echo "ğŸ“‹ \033[36mæœ¬å‘¨æ— å¤±è´¥è®°å½•ï¼Œæ— éœ€æ›´æ–°\033[0m"
          fi