name: Smart Fixer CI Integration

on:
  workflow_dispatch:
    inputs:
      fix_mode:
        description: 'ä¿®å¤æ¨¡å¼'
        required: false
        default: 'standard'
        type: choice
        options:
          - standard
          - aggressive
          - dry_run
  schedule:
    - cron: '0 3 * * *'

env:
  PYTHON_VERSION: "3.11"

jobs:
  smart-quality-fix:
    name: Smart Quality Fix
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff black mypy bandit safety pytest pytest-cov
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    - name: Pre-fix Analysis
      id: pre-analysis
      run: |
        SYNTAX_ERRORS=$(ruff check src/ --output-format=concise 2>/dev/null | grep "invalid-syntax" | wc -l || echo "0")
        TOTAL_ISSUES=$(ruff check src/ --output-format=concise 2>/dev/null | wc -l || echo "0")

        echo "pre_syntax_errors=$SYNTAX_ERRORS" >> $GITHUB_OUTPUT
        echo "pre_total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT

        echo "ðŸ“Š ä¿®å¤å‰çŠ¶æ€:"
        echo "  - è¯­æ³•é”™è¯¯: $SYNTAX_ERRORS ä¸ª"
        echo "  - è´¨é‡é—®é¢˜: $TOTAL_ISSUES ä¸ª"

    - name: Run Smart Quality Fixer
      run: |
        echo "ðŸ› ï¸ è¿è¡Œæ™ºèƒ½è´¨é‡ä¿®å¤å™¨..."

        if [ -f scripts/smart_quality_fixer.py ]; then
          FIXER_ARGS="--verbose"

          if [ "${{ github.event.inputs.fix_mode }}" == "aggressive" ]; then
            FIXER_ARGS="$FIXER_ARGS --aggressive"
            echo "âš¡ å¯ç”¨æ¿€è¿›æ¨¡å¼"
          elif [ "${{ github.event.inputs.fix_mode }}" == "dry_run" ]; then
            FIXER_ARGS="$FIXER_ARGS --dry-run"
            echo "ðŸ” å¯ç”¨é¢„è§ˆæ¨¡å¼"
          fi

          python3 scripts/smart_quality_fixer.py $FIXER_ARGS || {
            echo "âš ï¸ æ™ºèƒ½ä¿®å¤å™¨æ‰§è¡Œé‡åˆ°é—®é¢˜"
          }
        else
          echo "âš ï¸ æ™ºèƒ½ä¿®å¤å™¨ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸºç¡€ä¿®å¤"
          if [ "${{ github.event.inputs.fix_mode }}" != "dry_run" ]; then
            make fix-code || ruff check src/ tests/ --fix --unsafe-fixes || true
          fi
        fi

    - name: Run Crisis Management
      if: github.event.inputs.fix_mode != 'dry_run'
      run: |
        echo "ðŸš¨ è¿è¡Œå±æœºç®¡ç†..."

        if [ -f scripts/fix_test_crisis.py ]; then
          python3 scripts/fix_test_crisis.py --diagnose || true
        fi

    - name: Post-fix Analysis
      id: post-analysis
      run: |
        SYNTAX_ERRORS=$(ruff check src/ --output-format=concise 2>/dev/null | grep "invalid-syntax" | wc -l || echo "0")
        TOTAL_ISSUES=$(ruff check src/ --output-format=concise 2>/dev/null | wc -l || echo "0")

        echo "post_syntax_errors=$SYNTAX_ERRORS" >> $GITHUB_OUTPUT
        echo "post_total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT

        echo "ðŸ“Š ä¿®å¤åŽçŠ¶æ€:"
        echo "  - è¯­æ³•é”™è¯¯: $SYNTAX_ERRORS ä¸ª"
        echo "  - è´¨é‡é—®é¢˜: $TOTAL_ISSUES ä¸ª"

    - name: Calculate Improvements
      run: |
        PRE_SYNTAX="${{ steps.pre-analysis.outputs.pre_syntax_errors }}"
        POST_SYNTAX="${{ steps.post-analysis.outputs.post_syntax_errors }}"
        PRE_TOTAL="${{ steps.pre-analysis.outputs.pre_total_issues }}"
        POST_TOTAL="${{ steps.post-analysis.outputs.post_total_issues }}"

        SYNTAX_IMPROVEMENT=$((PRE_SYNTAX - POST_SYNTAX))
        TOTAL_IMPROVEMENT=$((PRE_TOTAL - POST_TOTAL))

        echo "ðŸŽ¯ ä¿®å¤æˆæžœ:"
        echo "  - è¯­æ³•é”™è¯¯æ”¹è¿›: $SYNTAX_IMPROVEMENT ä¸ª"
        echo "  - æ€»é—®é¢˜æ”¹è¿›: $TOTAL_IMPROVEMENT ä¸ª"

    - name: Run Validation Tests
      if: github.event.inputs.fix_mode != 'dry_run'
      run: |
        echo "ðŸ§ª è¿è¡ŒéªŒè¯æµ‹è¯•..."

        pytest tests/unit/ -v \
          --maxfail=5 \
          --tb=short \
          -m "critical" || {
          echo "âš ï¸ å…³é”®æµ‹è¯•éªŒè¯å¤±è´¥"
        }

    - name: Generate Report
      run: |
        cat > smart-fixer-report.md << EOF
        # ðŸ› ï¸ æ™ºèƒ½ä¿®å¤æ‰§è¡ŒæŠ¥å‘Š

        **æ‰§è¡Œæ—¶é—´**: $(date)
        **ä¿®å¤æ¨¡å¼**: ${{ github.event.inputs.fix_mode || 'standard' }}

        ## ðŸ“Š ä¿®å¤æ•ˆæžœ

        - è¯­æ³•é”™è¯¯æ”¹è¿›: $(( ${{ steps.pre-analysis.outputs.pre_syntax_errors }} - ${{ steps.post-analysis.outputs.post_syntax_errors }} )) ä¸ª
        - æ€»é—®é¢˜æ”¹è¿›: $(( ${{ steps.pre-analysis.outputs.pre_total_issues }} - ${{ steps.post-analysis.outputs.post_total_issues }} )) ä¸ª

        ## ðŸ“ˆ ä¿®å¤å‰åŽå¯¹æ¯”

        | æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤åŽ | æ”¹è¿› |
        |------|--------|--------|------|
        | è¯­æ³•é”™è¯¯ | ${{ steps.pre-analysis.outputs.pre_syntax_errors }} | ${{ steps.post-analysis.outputs.post_syntax_errors }} | +$(( ${{ steps.pre-analysis.outputs.pre_syntax_errors }} - ${{ steps.post-analysis.outputs.post_syntax_errors }} )) |
        | æ€»é—®é¢˜ | ${{ steps.pre-analysis.outputs.pre_total_issues }} | ${{ steps.post-analysis.outputs.post_total_issues }} | +$(( ${{ steps.pre-analysis.outputs.pre_total_issues }} - ${{ steps.post-analysis.outputs.post_total_issues }} )) |

        EOF

    - name: Upload Report
      uses: actions/upload-artifact@v4
      with:
        name: smart-fixer-report
        path: smart-fixer-report.md
        retention-days: 30
