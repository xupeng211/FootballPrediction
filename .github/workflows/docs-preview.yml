name: ğŸ“š Documentation Preview

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'

# å–æ¶ˆå¹¶è¡Œçš„è¿è¡Œï¼Œé¿å…èµ„æºæµªè´¹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===== æ„å»ºé¢„è§ˆ =====
  preview:
    name: ğŸ”¨ æ„å»ºé¢„è§ˆ
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4.1.6

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4.7.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material
          pip install -r requirements/requirements.lock

      - name: ğŸ”¨ æ„å»ºé¢„è§ˆ
        run: |
          echo "ğŸ”¨ æ„å»ºPRé¢„è§ˆ..."

          # æ¸…ç†ä¹‹å‰çš„æ„å»º
          rm -rf site/

          # æ„å»ºæ–‡æ¡£
          mkdocs build --quiet

          # æ·»åŠ é¢„è§ˆæ ‡è¯†
          if [ -f "site/index.html" ]; then
            sed -i 's/<title>/<!-- PR Preview -->\n<title>/g' site/index.html
          fi

      - name: ğŸ“¦ ä¸Šä¼ é¢„è§ˆ
        uses: actions/upload-artifact@v3.1.3
        with:
          name: docs-preview-${{ github.event.number }}
          path: site/
          retention-days: 7

  # ===== PRè¯„è®º =====
  pr-comment:
    name: ğŸ’¬ PRè¯„è®º
    runs-on: ubuntu-latest
    needs: preview
    if: github.event_name == 'pull_request'
    timeout-minutes: 5
    permissions:
      pull-requests: write

    steps:
      - name: ğŸ’¬ æ·»åŠ é¢„è§ˆé“¾æ¥
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.number;

            // æŸ¥æ‰¾ç°æœ‰è¯„è®º
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ“š æ–‡æ¡£é¢„è§ˆ')
            );

            const commentBody = '## ğŸ“š æ–‡æ¡£é¢„è§ˆ\n\n' +
              'ğŸ”— **é¢„è§ˆé“¾æ¥**: [æŸ¥çœ‹æ–‡æ¡£é¢„è§ˆ](https://github-actions-viewer.pages.dev/view/' + owner + '/' + repo + '/docs-preview-' + prNumber + '/index.html)\n\n' +
              'ğŸ“‹ **é¢„è§ˆç‰¹æ€§**:\n' +
              '- ğŸ”„ å®æ—¶é¢„è§ˆæ–‡æ¡£æ›´æ”¹\n' +
              '- ğŸ“± å“åº”å¼è®¾è®¡æµ‹è¯•\n' +
              '- ğŸ” æœç´¢åŠŸèƒ½éªŒè¯\n' +
              '- ğŸ¨ ä¸»é¢˜æ ·å¼æ£€æŸ¥\n\n' +
              'ğŸ“ **æ³¨æ„äº‹é¡¹**:\n' +
              '- é¢„è§ˆé“¾æ¥å°†åœ¨7å¤©åè‡ªåŠ¨å¤±æ•ˆ\n' +
              '- éƒ¨ç½²åˆ°æ­£å¼ç¯å¢ƒåä¼šæ›¿æ¢é¢„è§ˆ\n' +
              '- å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨PRä¸­åé¦ˆ\n\n' +
              '---\n' +
              'ğŸ¤– ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ';

            if (existingComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existingComment.id,
                body: commentBody
              });
              console.log('Updated existing comment');
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('Created new comment');
            }

  # ===== è´¨é‡æ£€æŸ¥ =====
  quality-check:
    name: ğŸ” è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: preview
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4.1.6

      - name: ğŸ“¦ ä¸‹è½½é¢„è§ˆ
        uses: actions/download-artifact@v3.0.2
        with:
          name: docs-preview-${{ github.event.number }}
          path: site/

      - name: ğŸ” æ‰§è¡Œè´¨é‡æ£€æŸ¥
        run: |
          echo "ğŸ” æ‰§è¡Œæ–‡æ¡£è´¨é‡æ£€æŸ¥..."

          # æ£€æŸ¥HTMLæœ‰æ•ˆæ€§
          HTML_FILES=$(find site -name "*.html" | wc -l)
          echo "ğŸ“„ HTMLæ–‡ä»¶æ•°é‡ï¼š$HTML_FILES"

          # æ£€æŸ¥å…³é”®é¡µé¢
          CRITICAL_PAGES="index.html"
          for page in $CRITICAL_PAGES; do
            if [ -f "site/$page" ]; then
              echo "âœ… $page å­˜åœ¨"
            else
              echo "âŒ $page ç¼ºå¤±"
              exit 1
            fi
          done

          # æ£€æŸ¥èµ„æºæ–‡ä»¶
          CSS_FILES=$(find site -name "*.css" | wc -l)
          JS_FILES=$(find site -name "*.js" | wc -l)
          echo "ğŸ¨ CSSæ–‡ä»¶ï¼š$CSS_FILES"
          echo "âš¡ JSæ–‡ä»¶ï¼š$JS_FILES"

          # ç”Ÿæˆè´¨é‡æŠ¥å‘Š
          echo "ğŸ“Š ç”Ÿæˆè´¨é‡æŠ¥å‘Š..."
          echo "é¢„è§ˆæ„å»ºæˆåŠŸï¼Œè´¨é‡æ£€æŸ¥é€šè¿‡ï¼"

  # ===== çŠ¶æ€æ£€æŸ¥ =====
  status:
    name: âœ… çŠ¶æ€æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [preview, quality-check]
    if: always()
    timeout-minutes: 5

    steps:
      - name: âœ… æ£€æŸ¥é¢„è§ˆçŠ¶æ€
        if: needs.preview.result == 'success' && needs.quality-check.result == 'success'
        run: |
          echo "âœ… é¢„è§ˆæ„å»ºæˆåŠŸ"
          echo "ğŸ”— é¢„è§ˆé“¾æ¥å·²æ·»åŠ åˆ°PRè¯„è®º"

      - name: âŒ æ£€æŸ¥å¤±è´¥çŠ¶æ€
        if: needs.preview.result == 'failure' || needs.quality-check.result == 'failure'
        run: |
          echo "âŒ é¢„è§ˆæ„å»ºå¤±è´¥"
          echo "ğŸ”— è¯·æŸ¥çœ‹Actionsæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"

      - name: ğŸ“Š ç”ŸæˆçŠ¶æ€æŠ¥å‘Š
        run: |
          echo "ğŸ“Š é¢„è§ˆçŠ¶æ€æŠ¥å‘Šï¼š"
          echo "é¢„è§ˆæ„å»ºï¼š${{ needs.preview.result }}"
          echo "è´¨é‡æ£€æŸ¥ï¼š${{ needs.quality-check.result }}"
          echo "PRç¼–å·ï¼š${{ github.event.number }}"