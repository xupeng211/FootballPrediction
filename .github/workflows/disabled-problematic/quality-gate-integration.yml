name: 'Quality Gate Integration'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Phase G Week 3 è´¨é‡é—¨ç¦å·¥ä½œæµ
  phase-g-week3-quality:
    name: 'Phase G Week 3 è´¨é‡é—¨ç¦'
    runs-on: ubuntu-latest
    outputs:
      syntax-health: ${{ steps.quality-gate.outputs.syntax-health }}
      test-coverage: ${{ steps.quality-gate.outputs.test-coverage }}
      quality-status: ${{ steps.quality-gate.outputs.quality-status }}

    steps:
    - name: 'Checkout ä»£ç '
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

    - name: 'è®¾ç½® Python ${{ env.PYTHON_VERSION }}'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'ç¼“å­˜ pip ä¾èµ–'
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: 'å®‰è£…ä¾èµ–'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov ruff mypy bandit safety

    - name: 'Phase G Week 3 è´¨é‡é—¨ç¦æ£€æŸ¥'
      id: quality-gate
      run: |
        python3 scripts/week3_ci_quality_gate.py

        # è¯»å–è´¨é‡æŠ¥å‘Šå¹¶è®¾ç½®è¾“å‡º
        python3 -c "
import json
import os

# æŸ¥æ‰¾æœ€æ–°çš„è´¨é‡æŠ¥å‘Š
reports = [f for f in os.listdir('.') if f.startswith('ci_quality_gate_report_') and f.endswith('.json')]
if reports:
            latest = sorted(reports)[-1]
            with open(latest, 'r', encoding='utf-8') as f:
                data = json.load(f)

            syntax_health = data['checks']['syntax_health']['details']['health_percentage']
            test_coverage = data.get('checks', {}).get('test_coverage', {}).get('details', {}).get('total_coverage', 0)
            quality_status = data['overall_status']

            print(f'syntax-health={syntax_health}')
            print(f'test-coverage={test_coverage}')
            print(f'quality-status={quality_status}')

            # è®¾ç½®GitHub Actionsè¾“å‡º
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f_out:
                f_out.write(f'syntax-health={syntax_health}\\n')
                f_out.write(f'test-coverage={test_coverage}\\n')
                f_out.write(f'quality-status={quality_status}\\n')
        "

    - name: 'ä¸Šä¼ è´¨é‡æŠ¥å‘Š'
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: phase-g-week3-quality-report
        path: ci_quality_gate_report_*.json
        retention-days: 30

    - name: 'è¯­æ³•å¥åº·åº¦æ£€æŸ¥å¤±è´¥å¤„ç†'
      if: steps.quality-gate.outputs.quality-status == 'failed'
      run: |
        echo "âŒ Phase G Week 3 è´¨é‡é—¨ç¦æ£€æŸ¥å¤±è´¥"
        echo "ğŸ“Š è¯­æ³•å¥åº·åº¦: ${{ steps.quality-gate.outputs.syntax-health }}%"
        echo "ğŸ“ˆ æµ‹è¯•è¦†ç›–ç‡: ${{ steps.quality-gate.outputs.test-coverage }}%"
        exit 1

  # æµ‹è¯•ç”Ÿæˆå’Œè¦†ç›–ç‡æ£€æŸ¥
  test-generation:
    name: 'æµ‹è¯•ç”Ÿæˆå’Œè¦†ç›–ç‡'
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout ä»£ç '
      uses: actions/checkout@v4

    - name: 'è®¾ç½® Python ${{ env.PYTHON_VERSION }}'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'å®‰è£…ä¾èµ–'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: 'Phase G Week 3 æµ‹è¯•ç”Ÿæˆ'
      run: |
        python3 scripts/week3_test_coverage_monitor.py

    - name: 'è¿è¡Œæµ‹è¯•å¥—ä»¶'
      run: |
        pytest tests/unit/ -v --tb=short --maxfail=5 || true

    - name: 'ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š'
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-generation-report
        path: week3_test_coverage_report_*.json
        retention-days: 30

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: 'ä»£ç è´¨é‡æ£€æŸ¥'
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout ä»£ç '
      uses: actions/checkout@v4

    - name: 'è®¾ç½® Python ${{ env.PYTHON_VERSION }}'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'å®‰è£…ä¾èµ–'
      run: |
        python -m pip install --upgrade pip
        pip install ruff mypy

    - name: 'Ruff ä»£ç æ£€æŸ¥'
      run: |
        ruff check src/ --output-format=json > ruff-report.json || true
        ruff format --check src/ || true

    - name: 'MyPy ç±»å‹æ£€æŸ¥'
      run: |
        mypy src/ --ignore-missing-imports > mypy-report.txt || true

    - name: 'ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š'
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: code-quality-reports
        path: |
          ruff-report.json
          mypy-report.txt
        retention-days: 30

  # å®‰å…¨æ‰«æ
  security-scan:
    name: 'å®‰å…¨æ‰«æ'
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout ä»£ç '
      uses: actions/checkout@v4

    - name: 'è®¾ç½® Python ${{ env.PYTHON_VERSION }}'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'å®‰è£…å®‰å…¨å·¥å…·'
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety

    - name: 'Bandit å®‰å…¨æ‰«æ'
      run: |
        bandit -r src/ -f json -o bandit-report.json || true

    - name: 'Safety ä¾èµ–æ£€æŸ¥'
      run: |
        safety check --json --output safety-report.json || true

    - name: 'ä¸Šä¼ å®‰å…¨æŠ¥å‘Š'
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 30

  # è´¨é‡æŠ¥å‘Šæ±‡æ€»
  quality-summary:
    name: 'è´¨é‡æŠ¥å‘Šæ±‡æ€»'
    runs-on: ubuntu-latest
    needs: [phase-g-week3-quality, test-generation, code-quality, security-scan]
    if: always()

    steps:
    - name: 'Checkout ä»£ç '
      uses: actions/checkout@v4

    - name: 'ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š'
      uses: actions/download-artifact@v3

    - name: 'ç”Ÿæˆç»¼åˆè´¨é‡æŠ¥å‘Š'
      run: |
        python3 -c "
import json
import os
from datetime import datetime
from pathlib import Path

# æ”¶é›†æ‰€æœ‰æŠ¥å‘Š
reports = {}
report_paths = [
    'phase-g-week3-quality-report',
    'test-generation-report',
    'code-quality-reports',
    'security-reports'
]

for path in report_paths:
    if os.path.exists(path):
        for file in Path(path).glob('*.json'):
            try:
                with open(file, 'r', encoding='utf-8') as f:
                    reports[file.name] = json.load(f)
            except Exception as e:
                print(f'Error reading {file}: {e}')

# ç”Ÿæˆç»¼åˆæŠ¥å‘Š
summary = {
    'timestamp': datetime.now().isoformat(),
    'workflow_run_id': '${{ github.run_id }}',
    'commit_sha': '${{ github.sha }}',
    'branch': '${{ github.ref_name }}',
    'reports_collected': len(reports),
    'job_results': {
        'phase_g_week3_quality': '${{ needs.phase-g-week3-quality.result }}',
        'test_generation': '${{ needs.test-generation.result }}',
        'code_quality': '${{ needs.code-quality.result }}',
        'security_scan': '${{ needs.security-scan.result }}'
    }
}

# æå–å…³é”®æŒ‡æ ‡
if 'ci_quality_gate_report.json' in reports:
    qg = reports['ci_quality_gate_report.json']
    summary['quality_gate'] = {
        'overall_status': qg.get('overall_status', 'unknown'),
        'syntax_health': qg.get('checks', {}).get('syntax_health', {}).get('details', {}).get('health_percentage', 0),
        'summary': qg.get('summary', {})
    }

if 'week3_test_coverage_report.json' in reports:
    tc = reports['week3_test_coverage_report.json']
    summary['test_coverage'] = {
        'test_files_created': tc.get('test_files_created', 0),
        'total_tests': tc.get('total_tests', 0),
        'recommendations_count': len(tc.get('recommendations', []))
    }

# ä¿å­˜ç»¼åˆæŠ¥å‘Š
with open('phase_g_week3_comprehensive_quality_report.json', 'w', encoding='utf-8') as f:
    json.dump(summary, f, indent=2, ensure_ascii=False)

print('ğŸ“Š Phase G Week 3 ç»¼åˆè´¨é‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ')
print(f'ğŸ“‹ æ”¶é›†æŠ¥å‘Šæ•°: {summary[\"reports_collected\"]}')
print(f'ğŸ¯ è´¨é‡é—¨ç¦çŠ¶æ€: {summary.get(\"quality_gate\", {}).get(\"overall_status\", \"unknown\")}')
print(f'ğŸ“ˆ è¯­æ³•å¥åº·åº¦: {summary.get(\"quality_gate\", {}).get(\"syntax_health\", 0)}%')
print(f'ğŸ§ª æµ‹è¯•æ–‡ä»¶æ•°: {summary.get(\"test_coverage\", {}).get(\"test_files_created\", 0)}')
"

    - name: 'ä¸Šä¼ ç»¼åˆè´¨é‡æŠ¥å‘Š'
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-quality-report
        path: phase_g_week3_comprehensive_quality_report.json
        retention-days: 90

    - name: 'PR è´¨é‡æŠ¥å‘Šè¯„è®º'
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');

          if (fs.existsSync('comprehensive-quality-report/phase_g_week3_comprehensive_quality_report.json')) {
            const report = JSON.parse(fs.readFileSync('comprehensive-quality-report/phase_g_week3_comprehensive_quality_report.json', 'utf8'));

            const comment = `
## ğŸš¨ Phase G Week 3 è´¨é‡é—¨ç¦æŠ¥å‘Š

**æ‰§è¡Œæ—¶é—´**: ${report.timestamp}
**å·¥ä½œæµè¿è¡Œ**: #${report.workflow_run_id}
**æäº¤SHA**: \`${report.commit_sha}\`

### ğŸ“Š è´¨é‡æ£€æŸ¥ç»“æœ

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
|--------|------|------|
| è´¨é‡é—¨ç¦ | ${report.job_results.phase_g_week3_quality} | ${report.quality_gate?.overall_status?.toUpperCase() || 'N/A'} |
| æµ‹è¯•ç”Ÿæˆ | ${report.job_results.test_generation} | ${report.test_coverage?.test_files_created || 0} ä¸ªæµ‹è¯•æ–‡ä»¶ |
| ä»£ç è´¨é‡ | ${report.job_results.code_quality} | ä»£ç é£æ ¼å’Œç±»å‹æ£€æŸ¥ |
| å®‰å…¨æ‰«æ | ${report.job_results.security_scan} | å®‰å…¨æ¼æ´æ‰«æ |

### ğŸ“ˆ å…³é”®æŒ‡æ ‡

- **è¯­æ³•å¥åº·åº¦**: ${report.quality_gate?.syntax_health || 0}%
- **æµ‹è¯•æ–‡ä»¶åˆ›å»º**: ${report.test_coverage?.test_files_created || 0} ä¸ª
- **æ”¶é›†æŠ¥å‘Šæ•°**: ${report.reports_collected} ä¸ª

### ğŸ¯ Phase G Week 3 çŠ¶æ€

${report.quality_gate?.overall_status === 'passed' ?
  'âœ… **è´¨é‡é—¨ç¦é€šè¿‡** - ä»£ç è´¨é‡ç¬¦åˆ Phase G Week 3 æ ‡å‡†' :
  'âŒ **è´¨é‡é—¨ç¦å¤±è´¥** - éœ€è¦ä¿®å¤è´¨é‡é—®é¢˜'}

---
ğŸ“… æŠ¥å‘Šç”Ÿæˆ: ${report.timestamp}
ğŸ”§ Phase G Week 3 è´¨é‡é—¨ç¦ç³»ç»Ÿ
ğŸ“‹ [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

    - name: 'æ›´æ–° Commit Status'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          if (fs.existsSync('comprehensive-quality-report/phase_g_week3_comprehensive_quality_report.json')) {
            const report = JSON.parse(fs.readFileSync('comprehensive-quality-report/phase_g_week3_comprehensive_quality_report.json', 'utf8'));

            const qualityStatus = report.quality_gate?.overall_status || 'unknown';
            const syntaxHealth = report.quality_gate?.syntax_health || 0;

            // åˆ›å»º commit status
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: qualityStatus === 'passed' ? 'success' : 'failure',
              target_url: \`https://github.com/\${context.repo.owner}/\${context.repo.repo}/actions/runs/\${context.runId}\`,
              description: \`Phase G Week 3: \${qualityStatus.toUpperCase()} (è¯­æ³•å¥åº·åº¦: \${syntaxHealth}%)\`,
              context: 'phase-g-week-3/quality-gate'
            });
          }
