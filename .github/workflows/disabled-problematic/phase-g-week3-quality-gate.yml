name: 'Phase G Week 3 Quality Gate'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  quality-gate:
    name: 'Phase G Week 3 è´¨é‡é—¨ç¦'
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout ä»£ç '
      uses: actions/checkout@v4

    - name: 'è®¾ç½® Python ${{ env.PYTHON_VERSION }}'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'ç¼“å­˜ä¾èµ–'
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          .venv
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: 'å®‰è£…é¡¹ç›®ä¾èµ–'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov ruff mypy bandit

    - name: 'è¿è¡Œ Phase G Week 3 è´¨é‡é—¨ç¦'
      run: |
        python3 scripts/week3_ci_quality_gate.py

    - name: 'ä¸Šä¼ è´¨é‡æŠ¥å‘Š'
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: quality-gate-report
        path: ci_quality_gate_report_*.json
        retention-days: 30

    - name: 'è¯„è®º PR è´¨é‡æŠ¥å‘Š'
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // æŸ¥æ‰¾æœ€æ–°çš„è´¨é‡æŠ¥å‘Š
          const files = fs.readdirSync('.').filter(f => f.startsWith('ci_quality_gate_report_') && f.endsWith('.json'));

          if (files.length > 0) {
            const latestReport = files.sort().pop();
            const reportData = JSON.parse(fs.readFileSync(latestReport, 'utf8'));

            const comment = `
## ğŸš¨ Phase G Week 3 è´¨é‡é—¨ç¦æŠ¥å‘Š

**æ‰§è¡Œæ—¶é—´**: ${reportData.timestamp}
**æ•´ä½“çŠ¶æ€**: ${reportData.overall_status.toUpperCase()}
**é€€å‡ºç **: ${reportData.exit_code}

### ğŸ“Š è´¨é‡æ£€æŸ¥æ‘˜è¦

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | ç»“æœ |
|--------|------|------|
| è¯­æ³•å¥åº·åº¦ | ${reportData.checks.syntax_health?.status || 'N/A'} | ${reportData.checks.syntax_health?.message || 'N/A'} |
| ä»£ç è´¨é‡ | ${reportData.checks.code_quality?.status || 'N/A'} | ${reportData.checks.code_quality?.message || 'N/A'} |
| æµ‹è¯•è¦†ç›–ç‡ | ${reportData.checks.test_coverage?.status || 'N/A'} | ${reportData.checks.test_coverage?.message || 'N/A'} |
| å®‰å…¨æ€§æ£€æŸ¥ | ${reportData.checks.security?.status || 'N/A'} | ${reportData.checks.security?.message || 'N/A'} |
| å¯¼å…¥ä¾èµ– | ${reportData.checks.imports?.status || 'N/A'} | ${reportData.checks.imports?.message || 'N/A'} |

### ğŸ“ˆ è¯¦ç»†æŒ‡æ ‡

- **æ€»æ£€æŸ¥æ•°**: ${reportData.summary.total_checks}
- **é€šè¿‡æ£€æŸ¥**: ${reportData.summary.passed_checks} âœ…
- **å¤±è´¥æ£€æŸ¥**: ${reportData.summary.failed_checks} âŒ
- **è­¦å‘Šæ£€æŸ¥**: ${reportData.summary.warning_checks} âš ï¸

### ğŸ¯ æ”¹è¿›å»ºè®®

${reportData.recommendations.map(r => `- ${r}`).join('\n')}

---
ğŸ“… æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${reportData.timestamp}
ğŸ”§ Phase G Week 3 è´¨é‡é—¨ç¦ç³»ç»Ÿ
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

  test-coverage:
    name: 'æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥'
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout ä»£ç '
      uses: actions/checkout@v4

    - name: 'è®¾ç½® Python ${{ env.PYTHON_VERSION }}'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'å®‰è£…ä¾èµ–'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock

    - name: 'è¿è¡Œ Phase G Week 3 æµ‹è¯•è¦†ç›–ç‡ç›‘æ§'
      run: |
        python3 scripts/week3_test_coverage_monitor.py

    - name: 'ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š'
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-coverage-report
        path: week3_test_coverage_report_*.json
        retention-days: 30

  syntax-health:
    name: 'è¯­æ³•å¥åº·åº¦æ£€æŸ¥'
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout ä»£ç '
      uses: actions/checkout@v4

    - name: 'è®¾ç½® Python ${{ env.PYTHON_VERSION }}'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'è¿è¡Œ Phase G Week 3 é«˜çº§è¯­æ³•ä¿®å¤å™¨'
      run: |
        python3 scripts/phase_g_week3_advanced_fixer.py --check-only

    - name: 'ä¸Šä¼ è¯­æ³•å¥åº·æŠ¥å‘Š'
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: syntax-health-report
        path: phase_g_week3_syntax_report_*.json
        retention-days: 30

  security-scan:
    name: 'å®‰å…¨æ‰«æ'
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout ä»£ç '
      uses: actions/checkout@v4

    - name: 'è®¾ç½® Python ${{ env.PYTHON_VERSION }}'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 'å®‰è£…ä¾èµ–'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety

    - name: 'è¿è¡Œ Bandit å®‰å…¨æ‰«æ'
      run: |
        bandit -r src/ -f json -o bandit-report.json || true

    - name: 'è¿è¡Œ Safety ä¾èµ–æ£€æŸ¥'
      run: |
        safety check --json --output safety-report.json || true

    - name: 'ä¸Šä¼ å®‰å…¨æŠ¥å‘Š'
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 30

  quality-summary:
    name: 'è´¨é‡æŠ¥å‘Šæ±‡æ€»'
    runs-on: ubuntu-latest
    needs: [quality-gate, test-coverage, syntax-health, security-scan]
    if: always()

    steps:
    - name: 'Checkout ä»£ç '
      uses: actions/checkout@v4

    - name: 'ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š'
      uses: actions/download-artifact@v3

    - name: 'ç”Ÿæˆè´¨é‡æ±‡æ€»æŠ¥å‘Š'
      run: |
        python3 -c "
import json
import os
from datetime import datetime

# è¯»å–æ‰€æœ‰æŠ¥å‘Š
reports = {}
for root, dirs, files in os.walk('.'):
    for file in files:
        if file.endswith('.json') and any(keyword in file for keyword in ['quality_gate', 'test_coverage', 'syntax', 'bandit', 'safety']):
            try:
                with open(os.path.join(root, file), 'r', encoding='utf-8') as f:
                    reports[file] = json.load(f)
            except:
                pass

# ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
summary = {
    'timestamp': datetime.now().isoformat(),
    'workflow_run_id': '${{ github.run_id }}',
    'commit_sha': '${{ github.sha }}',
    'branch': '${{ github.ref_name }}',
    'reports': reports,
    'summary': {
        'total_reports': len(reports),
        'quality_gate_status': reports.get('ci_quality_gate_report.json', {}).get('overall_status', 'unknown'),
        'syntax_health': reports.get('phase_g_week3_syntax_report.json', {}).get('syntax_health_percentage', 0),
        'test_coverage': reports.get('week3_test_coverage_report.json', {}).get('metrics', {}).get('test_files_created', 0)
    }
}

with open('phase_g_week3_quality_summary.json', 'w', encoding='utf-8') as f:
    json.dump(summary, f, indent=2, ensure_ascii=False)

print('ğŸ“Š Phase G Week 3 è´¨é‡æ±‡æ€»æŠ¥å‘Šç”Ÿæˆå®Œæˆ')
print(f'ğŸ“‹ æ€»æŠ¥å‘Šæ•°: {summary[\"summary\"][\"total_reports\"]}')
print(f'ğŸ¯ è´¨é‡é—¨ç¦çŠ¶æ€: {summary[\"summary\"][\"quality_gate_status\"]}')
print(f'ğŸ“ˆ è¯­æ³•å¥åº·åº¦: {summary[\"summary\"][\"syntax_health\"]}%')
print(f'ğŸ§ª æµ‹è¯•æ–‡ä»¶æ•°: {summary[\"summary\"][\"test_coverage\"]}')
"

    - name: 'ä¸Šä¼ è´¨é‡æ±‡æ€»æŠ¥å‘Š'
      uses: actions/upload-artifact@v3
      with:
        name: quality-summary
        path: phase_g_week3_quality_summary.json
        retention-days: 90

    - name: 'æ›´æ–° GitHub çŠ¶æ€'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          if (fs.existsSync('phase_g_week3_quality_summary.json')) {
            const summary = JSON.parse(fs.readFileSync('phase_g_week3_quality_summary.json', 'utf8'));

            // åˆ›å»º commit status
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: summary.summary.quality_gate_status === 'passed' ? 'success' : 'failure',
              target_url: \`https://github.com/\${context.repo.owner}/\${context.repo.repo}/actions/runs/\${context.runId}\`,
              description: \`Phase G Week 3: \${summary.summary.quality_gate_status.toUpperCase()} (è¯­æ³•: \${summary.summary.syntax_health}%)\`,
              context: 'phase-g-week-3-quality-gate'
            });
          }
