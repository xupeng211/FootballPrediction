name: å®‰å…¨å¥åº·åº¦è·Ÿè¸ª

on:
  schedule:
    # æ¯å¤©UTC 09:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´17:00ï¼‰
    - cron: '0 9 * * *'
  workflow_dispatch:
  push:
    branches: [main, develop]
    paths:
      - 'requirements.txt'
      - 'src/**'
      - '.env*'
      - 'requirements*.txt'

jobs:
  security-health-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ç¼“å­˜ pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-security-health-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-security-health-

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pip-audit bandit safety
        pip install -r requirements.txt

    - name: è¿è¡Œå®‰å…¨å¥åº·åº¦æ£€æŸ¥
      id: health-check
      run: |
        python scripts/security/security_health_tracker.py

        # è¯»å–æœ€æ–°è¯„åˆ†
        if [ -f "docs/_reports/security/trend_analysis.json" ]; then
          SCORE=$(python -c "import json; print(json.load(open('docs/_reports/security/trend_analysis.json'))['current']['score'])")
          GRADE=$(python -c "import json; print(json.load(open('docs/_reports/security/trend_analysis.json'))['current']['grade'])")
          TREND=$(python -c "import json; print(json.load(open('docs/_reports/security/trend_analysis.json'))['trend']['direction'])")

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "grade=$GRADE" >> $GITHUB_OUTPUT
          echo "trend=$TREND" >> $GITHUB_OUTPUT

          echo "âœ… å®‰å…¨å¥åº·åº¦: $SCORE/100 ($GRADE) $TREND"
        fi

    - name: æ›´æ–°å®‰å…¨å¾½ç« 
      if: success()
      run: |
        # åˆ›å»ºæˆ–æ›´æ–°å¾½ç« 
        SCORE="${{ steps.health-check.outputs.score }}"
        GRADE="${{ steps.health-check.outputs.grade }}"

        # ç¡®å®šé¢œè‰²
        if [ "$GRADE" = "A" ]; then COLOR="brightgreen"
        elif [ "$GRADE" = "B" ]; then COLOR="green"
        elif [ "$GRADE" = "C" ]; then COLOR="yellow"
        elif [ "$GRADE" = "D" ]; then COLOR="orange"
        else COLOR="red"
        fi

        # åˆ›å»ºå¾½ç« JSON
        mkdir -p .github/badges
        cat > .github/badges/security-health.json << EOF
        {
          "schemaVersion": 1,
          "label": "Security Health",
          "message": "$SCORE/100 ($GRADE)",
          "color": "$COLOR"
        }
        EOF

    - name: ç”Ÿæˆå¥åº·åº¦è¶‹åŠ¿å›¾
      if: success()
      run: |
        python3 << 'EOF'
        import json
        import sys
        from datetime import datetime, timedelta

        try:
            # è¯»å–å†å²æ•°æ®
            with open('docs/_reports/security/health_history.json', 'r') as f:
                history = json.load(f)

            if len(history) >= 2:
                # ç”ŸæˆMarkdownè¡¨æ ¼
                print("## ğŸ“ˆ å®‰å…¨å¥åº·åº¦è¶‹åŠ¿ï¼ˆæœ€è¿‘30å¤©ï¼‰\n")
                print("| æ—¥æœŸ | è¯„åˆ† | ç­‰çº§ | è¶‹åŠ¿ |")
                print("|------|------|------|------|")

                recent = history[-30:]
                for i, entry in enumerate(recent):
                    date = datetime.fromisoformat(entry['date']).strftime('%m-%d')
                    score = entry['health_score']
                    grade = entry.get('grade', 'N/A')

                    # è®¡ç®—è¶‹åŠ¿
                    if i == 0:
                        trend = "â€”"
                    elif score > recent[i-1]['health_score']:
                        trend = "â†—"
                    elif score < recent[i-1]['health_score']:
                        trend = "â†˜"
                    else:
                        trend = "â†’"

                    print(f"| {date} | {score} | {grade} | {trend} |")

                # ç”Ÿæˆç®€å•ASCIIå›¾
                print("\n### è¶‹åŠ¿å›¾\n")
                print("```\n")

                scores = [e['health_score'] for e in recent[-14:]]  # æœ€è¿‘14å¤©
                max_score = max(scores) if scores else 100
                min_score = min(scores) if scores else 0
                range_score = max_score - min_score if max_score != min_score else 1

                height = 10
                for h in range(height, 0, -1):
                    line = ""
                    for score in scores:
                        normalized = int((score - min_score) / range_score * (height - 1))
                        if normalized >= h:
                            line += "â–ˆ"
                        else:
                            line += " "
                    print(f"{h*10:3d} |{line}")

                print("    +" + "-" * len(scores))
                print("     " + "".join([str(i%10) for i in range(len(scores))]))
                print("```\n")

        except Exception as e:
            print(f"ç”Ÿæˆè¶‹åŠ¿å›¾å¤±è´¥: {e}")
        EOF

    - name: åˆ›å»ºæˆ–æ›´æ–°å®‰å…¨é—®é¢˜ï¼ˆå¦‚æœå¥åº·åº¦ä¸‹é™ï¼‰
      if: failure() || contains(steps.health-check.outputs.trend, 'â†˜')
      uses: actions/github-script@v6
      with:
        script: |
          const score = '${{ steps.health-check.outputs.score }}';
          const grade = '${{ steps.health-check.outputs.grade }}';
          const trend = '${{ steps.health-check.outputs.trend }}';

          // å¦‚æœå¥åº·åº¦ä½äº70åˆ†æˆ–ä¸‹é™è¶‹åŠ¿ï¼Œåˆ›å»ºIssue
          if (parseInt(score) < 70 || trend === 'â†˜') {
            const title = `å®‰å…¨å¥åº·åº¦éœ€è¦å…³æ³¨ - å½“å‰è¯„åˆ†: ${score}/100 (${grade})`;

            const body = `
            ## å®‰å…¨å¥åº·åº¦è­¦æŠ¥

            **å½“å‰è¯„åˆ†**: ${score}/100 (${grade})
            **è¶‹åŠ¿**: ${trend}
            **æ£€æŸ¥æ—¶é—´**: ${new Date().toISOString()}

            ### å»ºè®®æªæ–½

            ${parseInt(score) < 60 ? `
            - ğŸš¨ **ç´§æ€¥**: å¥åº·åº¦è¿‡ä½ï¼Œéœ€è¦ç«‹å³é‡‡å–è¡ŒåŠ¨
            - ä¼˜å…ˆä¿®å¤æ‰€æœ‰ä¸¥é‡å’Œé«˜å±æ¼æ´
            - è¿›è¡Œå…¨é¢çš„å®‰å…¨å®¡è®¡
            ` : ''}

            ${trend === 'â†˜' ? `
            - ğŸ“‰ **ä¸‹é™è¶‹åŠ¿**: å®‰å…¨çŠ¶å†µæ­£åœ¨æ¶åŒ–
            - æŸ¥çœ‹æœ€è¿‘çš„å®‰å…¨æŠ¥å‘Š
            - åˆ†æé—®é¢˜æ ¹æº
            ` : ''}

            ### å¿«é€Ÿæ“ä½œ

            1. è¿è¡Œæœ¬åœ°å®‰å…¨æ£€æŸ¥:
               \`\`\`bash
               ./scripts/security-check.sh
               \`\`\`

            2. æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š:
               - [å®‰å…¨å¥åº·åº¦æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
               - [å†å²è¶‹åŠ¿](https://github.com/${{ github.repository }}/blob/main/docs/_reports/security/health_report.md)

            3. ä¿®å¤åé‡æ–°è¯„ä¼°:
               \`\`\`bash
               python scripts/security/security_health_tracker.py
               \`\`\`

            ---
            æ­¤Issueç”±è‡ªåŠ¨åŒ–å®‰å…¨å¥åº·åº¦æ£€æŸ¥åˆ›å»ºã€‚
            `;

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸ä¼¼çš„å¼€æ”¾Issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security', 'health']
            });

            const hasSimilarIssue = existingIssues.data.some(issue =>
              issue.title.includes('å®‰å…¨å¥åº·åº¦éœ€è¦å…³æ³¨')
            );

            if (!hasSimilarIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'health']
              });
            }
          }

    - name: æ›´æ–°é¡¹ç›®çœ‹æ¿
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const score = parseInt('${{ steps.health-check.outputs.score || "0" }}');

          // æ ¹æ®å¥åº·åº¦è¯„åˆ†æ›´æ–°é¡¹ç›®çŠ¶æ€
          let projectStatus = 'on-track';
          let healthStatus = 'healthy';

          if (score >= 90) {
            healthStatus = 'excellent';
          } else if (score >= 80) {
            healthStatus = 'good';
          } else if (score >= 70) {
            healthStatus = 'fair';
            projectStatus = 'at-risk';
          } else if (score >= 60) {
            healthStatus = 'poor';
            projectStatus = 'off-track';
          } else {
            healthStatus = 'critical';
            projectStatus = 'critical';
          }

          // è¿™é‡Œå¯ä»¥é›†æˆGitHub Project APIæ¥æ›´æ–°é¡¹ç›®çœ‹æ¿
          console.log(`Project status: ${projectStatus}`);
          console.log(`Health status: ${healthStatus}`);

    - name: ä¸Šä¼ æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-health-report
        path: |
          docs/_reports/security/health_report.md
          docs/_reports/security/health_history.json
          docs/_reports/security/trend_analysis.json
          .github/badges/

    - name: å‘é€é€šçŸ¥ï¼ˆä»…ä½å¥åº·åº¦ï¼‰
      if: failure() || (steps.health-check.outputs.score && '${{ steps.health-check.outputs.score }}' < '70')
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |
          ğŸš¨ å®‰å…¨å¥åº·åº¦è­¦æŠ¥

          å½“å‰è¯„åˆ†: ${{ steps.health-check.outputs.score }}/100 (${{ steps.health-check.outputs.grade }})
          è¶‹åŠ¿: ${{ steps.health-check.outputs.trend }}

          è¯·ç«‹å³æŸ¥çœ‹å¹¶å¤„ç†å®‰å…¨é—®é¢˜ã€‚
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_SLACK_WEBHOOK }}