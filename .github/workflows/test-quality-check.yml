name: Test Quality Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test-quality:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        make install
        pip install pytest pytest-cov pytest-xdist

    - name: Run test quality check
      run: |
        echo "Running comprehensive test quality check..."
        python scripts/check_test_quality.py tests/

        # ä¿å­˜è´¨é‡æŠ¥å‘Š
        python scripts/check_test_quality.py tests/ --output json > test-quality-report.json

    - name: Upload quality report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-quality-report
        path: test-quality-report.json
        retention-days: 30

    - name: Comment PR with quality score
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('test-quality-report.json', 'utf8'));

          const score = report.stats.issues_found;
          const files = report.stats.files_checked;
          const errors = report.stats.errors;
          const warnings = report.stats.warnings;

          // è´¨é‡è¯„åˆ†è®¡ç®—ï¼ˆç®€åŒ–ç‰ˆï¼‰
          const qualityScore = Math.max(0, 100 - errors * 10 - warnings * 3);

          let message = `## ğŸ“Š æµ‹è¯•è´¨é‡æŠ¥å‘Š\n\n`;
          message += `- **æ£€æŸ¥æ–‡ä»¶æ•°**: ${files}\n`;
          message += `- **é—®é¢˜æ€»æ•°**: ${score}\n`;
          message += `- **é”™è¯¯**: ${errors}\n`;
          message += `- **è­¦å‘Š**: ${warnings}\n`;
          message += `- **è´¨é‡è¯„åˆ†**: ${qualityScore}/100\n\n`;

          if (qualityScore >= 90) {
            message += `ğŸ† **ä¼˜ç§€**ï¼æµ‹è¯•è´¨é‡å¾ˆé«˜ã€‚\n`;
          } else if (qualityScore >= 80) {
            message += `ğŸ‘ **è‰¯å¥½**ï¼æµ‹è¯•è´¨é‡ä¸é”™ã€‚\n`;
          } else if (qualityScore >= 70) {
            message += `ğŸ‘Œ **ä¸€èˆ¬**ã€‚å»ºè®®æ”¹è¿›æµ‹è¯•è´¨é‡ã€‚\n`;
          } else {
            message += `âš ï¸ **éœ€è¦æ”¹è¿›**ã€‚è¯·ä¼˜å…ˆä¿®å¤æµ‹è¯•é—®é¢˜ã€‚\n`;
          }

          if (errors > 0) {
            message += `\nâš ï¸ æœ‰ ${errors} ä¸ªé”™è¯¯éœ€è¦ä¿®å¤ã€‚`;
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });

    - name: Check quality gate
      run: |
        # è·å–è´¨é‡è¯„åˆ†
        SCORE=$(python scripts/check_test_quality.py tests/ 2>&1 | grep "æ€»åˆ†:" | sed 's/.*æ€»åˆ†: \([0-9]*\)\/100.*/\1/')

        # è®¾ç½®è´¨é‡é—¨ç¦
        if [ "$SCORE" -lt 70 ]; then
          echo "âŒ æµ‹è¯•è´¨é‡è¯„åˆ†è¿‡ä½ ($SCORE/100)ï¼Œè¯·ä¿®å¤é—®é¢˜"
          exit 1
        else
          echo "âœ… æµ‹è¯•è´¨é‡è¯„åˆ†é€šè¿‡ ($SCORE/100)"
        fi

    - name: Run unit tests
      run: |
        echo "Running unit tests..."
        make test-unit

    - name: Check test coverage
      run: |
        echo "Checking test coverage..."
        make coverage-local
        # ç¡®ä¿è¦†ç›–ç‡ä¸ä½äº25%
        COVERAGE=$(coverage report --format=json | jq -r '.totals.percent_covered')
        if (( $(echo "$COVERAGE < 25" | bc -l) )); then
          echo "âŒ è¦†ç›–ç‡è¿‡ä½ ($COVERAGE%)ï¼Œéœ€è¦è‡³å°‘25%"
          exit 1
        fi
        echo "âœ… è¦†ç›–ç‡æ£€æŸ¥é€šè¿‡ ($COVERAGE%)"

  quality-report:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        make install
        pip install pytest pytest-cov pytest-xdist matplotlib

    - name: Run comprehensive quality check
      run: |
        # è¿è¡Œè´¨é‡æ£€æŸ¥
        python scripts/check_test_quality.py tests/ > quality-report.txt

        # ç”Ÿæˆè¶‹åŠ¿æŠ¥å‘Š
        python scripts/generate_quality_trend.py

        # ç”ŸæˆHTMLæŠ¥å‘Š
        mkdir -p reports
        python scripts/generate_quality_html.py > reports/quality-report.html

    - name: Upload quality reports
      uses: actions/upload-artifact@v3
      with:
        name: quality-reports
        path: |
          quality-report.txt
          reports/
          test-quality-report.json
        retention-days: 90

    - name: Update README with badge
      run: |
        # æ›´æ–°READMEä¸­çš„è´¨é‡å¾½ç« 
        SCORE=$(python scripts/check_test_quality.py tests/ 2>&1 | grep "æ€»åˆ†:" | sed 's/.*æ€»åˆ†: \([0-9]*\)\/100.*/\1/')

        # è¿™é‡Œå¯ä»¥æ›´æ–°READMEæˆ–å…¶ä»–æ–‡æ¡£ä¸­çš„å¾½ç« 
        echo "Current quality score: $SCORE/100"
