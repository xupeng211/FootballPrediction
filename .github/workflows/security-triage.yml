name: å®‰å…¨é—®é¢˜åˆ†æ´¾å’Œè·Ÿè¸ª

on:
  issues:
    types: [opened, labeled]
  schedule:
    # æ¯å¤©æ£€æŸ¥ä¸€æ¬¡æœªè§£å†³çš„å®‰å…¨é—®é¢˜
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  triage-security-issues:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'security') || github.event_name == 'schedule'

    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: åˆ†æ´¾æ–°å®‰å…¨é—®é¢˜
      if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'security')
      uses: actions/github-script@v6
      with:
        script: |
          const issue = context.payload.issue;
          const labels = issue.labels.map(l => l.name);

          // æ ¹æ®ä¸¥é‡æ€§ç¡®å®šä¼˜å…ˆçº§å’Œè´Ÿè´£äºº
          let priority = 'medium';
          let assignee = 'security-team';
          let slaHours = 72; // é»˜è®¤3å¤©

          if (labels.includes('critical')) {
            priority = 'critical';
            slaHours = 4; // 4å°æ—¶å†…å“åº”
            assignee = 'cto';
          } else if (labels.includes('high-priority')) {
            priority = 'high';
            slaHours = 24; // 1å¤©å†…å“åº”
            assignee = 'lead-developer';
          } else if (labels.includes('medium')) {
            priority = 'medium';
            slaHours = 72; // 3å¤©å†…å“åº”
            assignee = 'developer';
          } else if (labels.includes('low')) {
            priority = 'low';
            slaHours = 168; // 1å‘¨å†…å“åº”
            assignee = 'junior-developer';
          }

          // æ·»åŠ ä¼˜å…ˆçº§æ ‡ç­¾
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issue.number,
            labels: [`priority: ${priority}`]
          });

          // åˆ†æ´¾ç»™ç›¸åº”äººå‘˜
          await github.rest.issues.addAssignees({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issue.number,
            assignees: [assignee]
          });

          // æ·»åŠ SLAæˆªæ­¢æ—¶é—´è¯„è®º
          const slaDeadline = new Date(Date.now() + slaHours * 60 * 60 * 1000);
          const slaComment = `
          ## ğŸ¯ SLA ä¿¡æ¯

          - **ä¼˜å…ˆçº§**: ${priority}
          - **è´Ÿè´£äºº**: @${assignee}
          - **å“åº”æˆªæ­¢æ—¶é—´**: ${slaDeadline.toISOString()}
          - **SLA**: ${slaHours}å°æ—¶å†…å“åº”

          ---
          æ­¤è¯„è®ºç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿç”Ÿæˆã€‚
          `;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issue.number,
            body: slaComment
          });

    - name: æ£€æŸ¥è¿‡æœŸæœªè§£å†³çš„å®‰å…¨é—®é¢˜
      if: github.event_name == 'schedule'
      uses: actions/github-script@v6
      with:
        script: |
          // è·å–æ‰€æœ‰å¼€æ”¾çš„ã€å¸¦æœ‰securityæ ‡ç­¾çš„issues
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'security',
            state: 'open',
            sort: 'created',
            direction: 'asc'
          });

          const now = new Date();

          for (const issue of issues.data) {
            const createdAt = new Date(issue.created_at);
            const labels = issue.labels.map(l => l.name);

            // ç¡®å®šSLAæ—¶é—´
            let slaHours = 72;
            if (labels.includes('priority: critical')) slaHours = 4;
            else if (labels.includes('priority: high')) slaHours = 24;
            else if (labels.includes('priority: medium')) slaHours = 72;
            else if (labels.includes('priority: low')) slaHours = 168;

            const slaDeadline = new Date(createdAt.getTime() + slaHours * 60 * 60 * 1000);

            // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            if (now > slaDeadline) {
              // è®¡ç®—è¿‡æœŸæ—¶é—´
              const overdueHours = Math.floor((now - slaDeadline) / (1000 * 60 * 60));

              // æ·»åŠ è¿‡æœŸæ ‡ç­¾
              if (!labels.includes('overdue')) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['overdue']
                });
              }

              // å‡çº§é—®é¢˜
              let escalationComment = '';
              if (overdueHours > 168) { // è¶…è¿‡ä¸€å‘¨
                // å‡çº§ç»™ç®¡ç†å±‚
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  assignees: ['cto', 'engineering-manager']
                });

                escalationComment = `
                ## ğŸš¨ ç´§æ€¥å‡çº§ - é—®é¢˜å·²ä¸¥é‡è¿‡æœŸ

                æ­¤å®‰å…¨é—®é¢˜å·²è¿‡æœŸ ${overdueHours} å°æ—¶ï¼Œè¿œè¶…SLAæ—¶é—´ï¼

                - **åŸå®šSLA**: ${slaHours}å°æ—¶
                - **è¿‡æœŸæ—¶é—´**: ${overdueHours}å°æ—¶
                - **åˆ›å»ºæ—¶é—´**: ${createdAt.toISOString()}
                - **SLAæˆªæ­¢æ—¶é—´**: ${slaDeadline.toISOString()}

                **å·²å‡çº§ç»™**: @cto @engineering-manager

                è¯·ç«‹å³é‡‡å–è¡ŒåŠ¨ï¼
                `;
              } else if (overdueHours > 24) { // è¶…è¿‡1å¤©
                // å‡çº§ç»™å›¢é˜Ÿè´Ÿè´£äºº
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  assignees: ['lead-developer']
                });

                escalationComment = `
                ## âš ï¸ é—®é¢˜å·²è¿‡æœŸ - éœ€è¦å…³æ³¨

                æ­¤å®‰å…¨é—®é¢˜å·²è¿‡æœŸ ${overdueHours} å°æ—¶ã€‚

                - **SLAæ—¶é—´**: ${slaHours}å°æ—¶
                - **è¿‡æœŸæ—¶é—´**: ${overdueHours}å°æ—¶

                **å·²åˆ†æ´¾ç»™**: @lead-developer

                è¯·å°½å¿«å¤„ç†ã€‚
                `;
              }

              if (escalationComment) {
                // æ£€æŸ¥æœ€è¿‘æ˜¯å¦å·²æœ‰å‡çº§è¯„è®º
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  per_page: 10
                });

                const hasRecentEscalation = comments.data.some(comment =>
                  comment.body.includes('å‡çº§') &&
                  (now - new Date(comment.created_at)) < 24 * 60 * 60 * 1000
                );

                if (!hasRecentEscalation) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: escalationComment
                  });
                }
              }
            }
          }

    - name: ç”Ÿæˆæ¯æ—¥å®‰å…¨æŠ¥å‘Š
      if: github.event_name == 'schedule'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          // è·å–æ‰€æœ‰å®‰å…¨é—®é¢˜
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'security',
            state: 'open',
            sort: 'priority',
            direction: 'desc'
          });

          // ç»Ÿè®¡æ•°æ®
          const stats = {
            critical: 0,
            high: 0,
            medium: 0,
            low: 0,
            overdue: 0,
            total: issues.data.length
          };

          let report = '# æ¯æ—¥å®‰å…¨æŠ¥å‘Š\n\n';
          report += `**ç”Ÿæˆæ—¶é—´**: ${new Date().toISOString()}\n\n`;

          // åˆ†ç±»ç»Ÿè®¡
          issues.data.forEach(issue => {
            const labels = issue.labels.map(l => l.name);
            if (labels.includes('priority: critical')) stats.critical++;
            else if (labels.includes('priority: high')) stats.high++;
            else if (labels.includes('priority: medium')) stats.medium++;
            else if (labels.includes('priority: low')) stats.low++;
            if (labels.includes('overdue')) stats.overdue++;
          });

          report += '## ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆ\n\n';
          report += `- **æ€»é—®é¢˜æ•°**: ${stats.total}\n`;
          report += `- **ä¸¥é‡**: ${stats.critical}\n`;
          report += `- **é«˜å±**: ${stats.high}\n`;
          report += `- **ä¸­å±**: ${stats.medium}\n`;
          report += `- **ä½å±**: ${stats.low}\n`;
          report += `- **è¿‡æœŸ**: ${stats.overdue}\n\n`;

          // é—®é¢˜åˆ—è¡¨
          if (stats.total > 0) {
            report += '## ğŸš¨ å¾…å¤„ç†é—®é¢˜\n\n';

            issues.data.forEach(issue => {
              const labels = issue.labels.map(l => l.name);
              const priority = labels.find(l => l.startsWith('priority:')) || 'priority: medium';
              const emoji = priority.includes('critical') ? 'ğŸ”´' :
                          priority.includes('high') ? 'ğŸŸ ' :
                          priority.includes('medium') ? 'ğŸŸ¡' : 'ğŸŸ¢';

              report += `${emoji} **[${issue.title}](${issue.html_url})**\n`;
              report += `   - ä¼˜å…ˆçº§: ${priority}\n`;
              report += `   - è´Ÿè´£äºº: ${issue.assignees.map(a => '@' + a.login).join(', ') || 'æœªåˆ†é…'}\n`;
              report += `   - åˆ›å»ºæ—¶é—´: ${new Date(issue.created_at).toLocaleDateString()}\n`;
              if (labels.includes('overdue')) {
                report += `   - âš ï¸ **å·²è¿‡æœŸ**\n`;
              }
              report += '\n';
            });
          }

          // ä¿å­˜æŠ¥å‘Š
          fs.writeFileSync('daily-security-report.md', report);

          // å¦‚æœæœ‰ä¸¥é‡æˆ–è¿‡æœŸé—®é¢˜ï¼Œåˆ›å»ºæ‘˜è¦
          if (stats.critical > 0 || stats.overdue > 0) {
            const summary = `
            **æ¯æ—¥å®‰å…¨æé†’** ğŸ›¡ï¸

            ä»Šæ—¥æœ‰ ${stats.critical} ä¸ªä¸¥é‡é—®é¢˜å’Œ ${stats.overdue} ä¸ªè¿‡æœŸé—®é¢˜éœ€è¦å…³æ³¨ã€‚

            [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            console.log('::set-output name=summary::' + summary);
          }

    - name: æ›´æ–°å®‰å…¨çœ‹æ¿
      if: github.event_name == 'schedule'
      run: |
        # ç”ŸæˆMarkdownæ ¼å¼çš„çœ‹æ¿æ•°æ®
        cat > security-board-data.md << EOF
        # å®‰å…¨çœ‹æ¿æ•°æ®

        æ›´æ–°æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        ## å¾…åŠ (To Do)
        - [ ] æ‰€æœ‰æ–°å‘ç°çš„å®‰å…¨é—®é¢˜åˆå§‹çŠ¶æ€

        ## è¿›è¡Œä¸­ (In Progress)
        - [ ] æ­£åœ¨ä¿®å¤çš„é—®é¢˜

        ## å¾…å®¡æ ¸ (Review)
        - [ ] ä¿®å¤å®Œæˆå¾…ä»£ç å®¡æŸ¥

        ## å·²å®Œæˆ (Done)
        - [ ] å·²å…³é—­çš„å®‰å…¨é—®é¢˜
        EOF

    - name: å‘é€æ¯æ—¥å®‰å…¨æ‘˜è¦ï¼ˆå¯é€‰ï¼‰
      if: github.event_name == 'schedule' && steps.security-triage.outputs.summary
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            text: "${{ steps.security-triage.outputs.summary }}",
            attachments: [{
              color: "${{ stats.critical > 0 || stats.overdue > 0 && 'danger' || 'good' }}",
              fields: [{
                title: "ä¸¥é‡é—®é¢˜",
                value: "${{ stats.critical }}",
                short: true
              }, {
                title: "è¿‡æœŸé—®é¢˜",
                value: "${{ stats.overdue }}",
                short: true
              }]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_SLACK_WEBHOOK }}

    - name: ä¸Šä¼ æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: daily-security-report
        path: |
          daily-security-report.md
          security-board-data.md