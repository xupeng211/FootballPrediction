# ============================================================================
# ğŸ› ï¸ å…±äº«å·¥ä½œæµæ¨¡æ¿
# ============================================================================
# å¯å¤ç”¨çš„å·¥ä½œæµç»„ä»¶ï¼Œå‡å°‘é‡å¤é…ç½®
# ç‰ˆæœ¬: v1.0 | æœ€åæ›´æ–°: 2025-10-26

name: Shared Setup Template

on:
  workflow_call:
    inputs:
      job-name:
        required: false
        type: string
        default: 'setup'
      python-version:
        required: false
        type: string
        default: '3.11'
      install-deps:
        required: false
        type: boolean
        default: true
      cache-type:
        required: false
        type: string
        default: 'all'  # all, pip, mypy, coverage, none

jobs:
  setup:
    name: ${{ inputs.job-name || 'Environment Setup' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python-version || '3.11' }}
          cache: ${{ inputs.cache-type == 'all' || inputs.cache-type == 'pip' && 'pip' || '' }}
          cache-dependency-path: |
            requirements/requirements.lock
            pyproject.toml

      - name: ğŸ’¾ ç¼“å­˜MyPyç»“æœ
        if: inputs.cache-type == 'all' || inputs.cache-type == 'mypy'
        uses: actions/cache@v3
        with:
          path: .mypy_cache
          key: ${{ runner.os }}-mypy-${{ hashFiles('**/mypy_*.ini', '**/pyproject.toml', '**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-mypy-
            ${{ runner.os }}-mypy-${{ hashFiles('**/mypy_*.ini') }}

      - name: ğŸ’¾ ç¼“å­˜è¦†ç›–ç‡æ•°æ®
        if: inputs.cache-type == 'all' || inputs.cache-type == 'coverage'
        uses: actions/cache@v3
        with:
          path: .coverage_data
          key: ${{ runner.os }}-coverage-${{ hashFiles('**/src/**', '**/tests/**') }}

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        if: inputs.install-deps
        run: |
          echo "ğŸ å®‰è£…Pythonä¾èµ–..."
          if [ -f "requirements/requirements.lock" ]; then
            pip install --upgrade pip
            pip install -r requirements/requirements.lock
          elif [ -f "requirements.txt" ]; then
            pip install --upgrade pip
            pip install -r requirements.txt
          else
            pip install --upgrade pip
            pip install -e .
          fi

          # å®‰è£…å¼€å‘å·¥å…·
          pip install ruff mypy bandit pip-audit pytest pytest-cov pytest-xdist

          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ”§ éªŒè¯ç¯å¢ƒ
        run: |
          echo "ğŸ Pythonç‰ˆæœ¬: $(python --version)"
          echo "ğŸ“¦ pipç‰ˆæœ¬: $(pip --version)"
          echo "ğŸ› ï¸ å·²å®‰è£…çš„å…³é”®å·¥å…·:"

          for tool in ruff mypy bandit pip-audit pytest; do
            if command -v $tool &> /dev/null; then
              echo "  âœ… $tool: $($tool --version 2>/dev/null | head -1 || echo 'available')"
            else
              echo "  âŒ $tool: æœªå®‰è£…"
            fi
          done

          echo "ğŸ¯ ç¯å¢ƒéªŒè¯å®Œæˆ"