name: Project Maintenance

on:
  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹æ‰§è¡Œç»´æŠ¤ä»»åŠ¡
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨ 2 ç‚¹ UTC
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      task:
        description: 'Maintenance task to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - docs
        - cleanup
        - stats
        - archive

jobs:
  # æ–‡æ¡£æ›´æ–°
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'all' || github.event.inputs.task == 'docs' || github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate API documentation
        run: |
          # ç”ŸæˆAPIæ–‡æ¡£
          python scripts/generate_api_docs.py

      - name: Update README statistics
        run: |
          # æ›´æ–°READMEä¸­çš„ç»Ÿè®¡ä¿¡æ¯
          python scripts/update_readme_stats.py

      - name: Update contributor list
        run: |
          # æ›´æ–°è´¡çŒ®è€…åˆ—è¡¨
          python scripts/update_contributors.py

      - name: Update CHANGELOG
        run: |
          # è‡ªåŠ¨ç”Ÿæˆchangelog
          python scripts/generate_changelog.py --days 7

      - name: Commit documentation updates
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add docs/ README.md CHANGELOG.md
          git commit -m "chore: auto-update documentation [skip ci]" || exit 0
          git push

  # æ¸…ç†ä»»åŠ¡
  cleanup:
    name: Cleanup Old Data
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'all' || github.event.inputs.task == 'cleanup' || github.event_name == 'schedule'

    permissions:
      actions: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup old branches
        run: |
          # æ¸…ç†å·²åˆå¹¶çš„PRåˆ†æ”¯
          git branch -r --merged | grep -v 'origin/main\|origin/develop\|origin/hotfix' | \
            sed 's/origin\///' | \
            xargs -I {} git push origin --delete {} 2>/dev/null || true

      - name: Cleanup old workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ é™¤90å¤©å‰çš„workflow run
          gh run list --repo ${{ github.repository }} --limit 500 \
            --json databaseId,createdAt,status,conclusion \
            | jq '.[] | select(.status == "completed" and (.createdAt | fromdateiso8601) < (now - 86400 * 90)) | .databaseId' \
            | xargs -I {} gh run delete --repo ${{ github.repository }} {} --yes 2>/dev/null || true

      - name: Cleanup stale issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¤„ç†30å¤©æ— æ›´æ–°çš„issues
          gh issue list --repo ${{ github.repository }} --state open \
            --json number,updatedAt,title \
            | jq '.[] | select((.updatedAt | fromdateiso8601) < (now - 86400 * 30)) | .number' \
            | while read -r issue; do
                if [ -n "$issue" ]; then
                  echo "Processing stale issue #$issue"
                  # æ·»åŠ è¿‡æœŸæ ‡ç­¾
                  gh issue edit $issue --add-label "stale"
                  # è¯„è®ºæé†’
                  gh issue comment $issue --body "ğŸ”” This issue has been marked as stale due to no activity for 30 days. It will be closed in 7 days if there is no further activity."
                fi
              done || true

      - name: Close very old stale issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å…³é—­60å¤©æ— æ›´æ–°çš„stale issues
          gh issue list --repo ${{ github.repository }} --state open --label stale \
            --json number,updatedAt,title \
            | jq '.[] | select((.updatedAt | fromdateiso8601) < (now - 86400 * 60)) | .number' \
            | while read -r issue; do
                if [ -n "$issue" ]; then
                  echo "Closing very old stale issue #$issue"
                  gh issue close $issue \
                    --comment "This issue has been automatically closed due to no activity for 60 days. Feel free to reopen if it's still relevant."
                fi
              done || true

      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            // åˆ é™¤æ—§çš„artifacts
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 30);

            for (const artifact of artifacts.data.artifacts) {
              if (new Date(artifact.created_at) < cutoffDate) {
                console.log(`Deleting artifact: ${artifact.name}`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              }
            }

  # ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
  generate-stats:
    name: Generate Project Statistics
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'all' || github.event.inputs.task == 'stats' || github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install gitpython pandas matplotlib

      - name: Generate statistics
        run: |
          python scripts/generate_project_stats.py \
            --output reports/project_stats_$(date +%Y%m%d).html \
            --days 30

      - name: Generate contribution heat map
        run: |
          python scripts/generate_contribution_heatmap.py \
            --output reports/contribution_heatmap_$(date +%Y%m%d).png

      - name: Upload statistics
        uses: actions/upload-artifact@v4
        with:
          name: project-statistics
          path: |
            reports/project_stats_*.html
            reports/contribution_heatmap_*.png
          retention-days: 90

  # å½’æ¡£æ—§æŠ¥å‘Š
  archive-reports:
    name: Archive Old Reports
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'all' || github.event.inputs.task == 'archive' || github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Archive old reports
        run: |
          # åˆ›å»ºå½’æ¡£ç›®å½•
          mkdir -p docs/archive/$(date +%Y)/$(date +%m)

          # ç§»åŠ¨è¶…è¿‡3ä¸ªæœˆçš„æŠ¥å‘Šåˆ°å½’æ¡£
          find reports/generated -name "*.md" -mtime +90 \
            -exec mv {} docs/archive/$(date +%Y)/$(date +%m)/ \; 2>/dev/null || true

          # å‹ç¼©æ›´æ—§çš„æŠ¥å‘Š
          find docs/archive -name "*.md" -mtime +365 \
            -exec gzip {} \; 2>/dev/null || true

      - name: Update archive index
        run: |
          python scripts/generate_archive_index.py \
            --archive-dir docs/archive \
            --output docs/archive/README.md

      - name: Commit archive updates
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add docs/archive/
          git commit -m "chore: archive old reports [skip ci]" || exit 0
          git push

  # ç”Ÿæˆç»´æŠ¤æŠ¥å‘Š
  maintenance-report:
    name: Generate Maintenance Report
    runs-on: ubuntu-latest
    needs: [update-docs, cleanup, generate-stats, archive-reports]
    if: always() && github.event_name == 'schedule'

    steps:
      - name: Generate summary report
        run: |
          cat > maintenance_report.md << EOF
          # Weekly Maintenance Report - $(date +%Y-%m-%d)

          ## Tasks Status
          - ğŸ“š Documentation Update: ${{ needs.update-docs.result }}
          - ğŸ§¹ Cleanup Tasks: ${{ needs.cleanup.result }}
          - ğŸ“Š Statistics Generation: ${{ needs.generate-stats.result }}
          - ğŸ“¦ Archive Reports: ${{ needs.archive-reports.result }}

          ## Summary

          ### Documentation
          - API docs updated
          - README statistics refreshed
          - Contributors list updated
          - Changelog generated

          ### Cleanup
          - Old branches removed
          - Stale issues processed
          - Old workflow runs deleted
          - Artifacts cleaned

          ### Statistics
          - Project metrics generated
          - Contribution heatmap created
          - Performance trends analyzed

          ### Archive
          - Old reports archived
          - Archive index updated

          ---
          *Report generated automatically on $(date)*
          EOF

      - name: Create issue for review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('maintenance_report.md', 'utf8');

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ“‹ Weekly Maintenance Report',
              body: report,
              labels: ['maintenance', 'weekly-report']
            });

      - name: Notify in Slack (optional)
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"Weekly maintenance completed for ${{ github.repository }}\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}