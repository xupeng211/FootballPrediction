name: ğŸ¤– AIè‡ªåŠ¨ä¿®å¤æœºå™¨äºº

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      target:
        description: 'ä¿®å¤ç›®æ ‡'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - syntax
          - imports
          - style
          - types
          - security
          - tests
      auto_commit:
        description: 'è‡ªåŠ¨æäº¤ä¿®å¤'
        required: false
        default: false
        type: boolean

jobs:
  auto-fix-issues:
    name: ğŸ”§ è‡ªåŠ¨ä¿®å¤Issue
    if: |
      github.event_name == 'issues' &&
      (contains(github.event.issue.labels.*.name, 'auto-fixable') ||
       contains(github.event.issue.title, '[AI]'))
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements/requirements.lock
            pyproject.toml

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements/requirements.lock
          pip install ruff mypy bandit pip-audit pytest

      - name: ğŸ”§ AIè‡ªåŠ¨ä¿®å¤
        env:
          TARGET: 'all'
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "ğŸ¤– å¯åŠ¨AIè‡ªåŠ¨ä¿®å¤æœºå™¨äºº..."
          echo "ğŸ¯ Issue: $ISSUE_NUMBER"

          # è¿è¡Œè‡ªåŠ¨ä¿®å¤
          python3 scripts/ai_auto_fixer.py --target "$TARGET" --confidence 0.6

          # æ£€æŸ¥ä¿®å¤ç»“æœ
          if [ -f "ai_fix_report.json" ]; then
            echo "ğŸ“Š ä¿®å¤æŠ¥å‘Šç”ŸæˆæˆåŠŸ"
            python3 -c "
import json

with open('ai_fix_report.json', 'r') as f:
    report = json.load(f)

success_count = report['successful_fixes']
total_count = report['total_fixes_attempted']
files_count = len(report['files_modified'])

print(f'ä¿®å¤ç»Ÿè®¡: {success_count}/{total_count} æˆåŠŸ')
print(f'ä¿®æ”¹æ–‡ä»¶: {files_count} ä¸ª')

# ç”Ÿæˆä¿®å¤è¯„è®º
if success_count > 0:
    comment = f'''## ğŸ”§ AIè‡ªåŠ¨ä¿®å¤å®Œæˆ

### ğŸ“Š ä¿®å¤ç»Ÿè®¡
- **æˆåŠŸä¿®å¤**: {success_count}/{total_count} ç±»é—®é¢˜
- **ä¿®æ”¹æ–‡ä»¶**: {files_count} ä¸ª
- **ä¿®å¤ç½®ä¿¡åº¦**: é«˜

### ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶
'''

    for file_path in report['files_modified']:
        comment += f'- `{file_path}`\n'

    comment += '''
### ğŸ” ä¸‹ä¸€æ­¥å»ºè®®
1. æ£€æŸ¥è‡ªåŠ¨ä¿®å¤çš„æ•ˆæœ
2. è¿è¡Œ `make test-quick` éªŒè¯åŠŸèƒ½
3. å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

### ğŸ“‹ ä¿®å¤è¯¦æƒ…
'''

    for fix_detail in report['fix_details']:
        if fix_detail['success'] and fix_detail['issues_fixed']:
            comment += f'''
#### âœ… {fix_detail['type']}
'''
            for issue in fix_detail['issues_fixed']:
                comment += f"- {issue}\n"

    if any(detail['requires_manual_review'] for detail in report['fix_details']):
        comment += '''
### âš ï¸ éœ€è¦æ‰‹åŠ¨å®¡æŸ¥
éƒ¨åˆ†ä¿®å¤å¯èƒ½éœ€è¦æ‰‹åŠ¨å®¡æŸ¥å’Œè°ƒæ•´ã€‚å»ºè®®æ£€æŸ¥ä¿®æ”¹åçš„ä»£ç ã€‚
'''

    comment += '''
---
*ğŸ¤– æ­¤ä¿®å¤ç”±AIè‡ªåŠ¨ä¿®å¤æœºå™¨äººå®Œæˆ*
'''

    with open('fix_comment.md', 'w') as f:
        f.write(comment)

    else:
        print('âŒ æœªå‘ç°å¯è‡ªåŠ¨ä¿®å¤çš„é—®é¢˜')
"

            # å‘å¸ƒä¿®å¤è¯„è®º
            if [ -f "fix_comment.md" ]; then
              gh issue comment "$ISSUE_NUMBER" --body "$(cat fix_comment.md)"
            fi
          else
            echo "âŒ ä¿®å¤æŠ¥å‘Šç”Ÿæˆå¤±è´¥"
          fi

      - name: ğŸ“¤ åˆ›å»ºä¿®å¤PR (å¦‚æœéœ€è¦)
        if: github.event.inputs.auto_commit == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“¤ åˆ›å»ºè‡ªåŠ¨ä¿®å¤PR..."

            # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
            git config --global user.name "AI Auto Fixer"
            git config --global user.email "ai-fixer@actions.users.noreply.github.com"

            # åˆ›å»ºæ–°åˆ†æ”¯
            BRANCH_NAME="auto-fix-issue-$ISSUE_NUMBER"
            git checkout -b "$BRANCH_NAME"

            # æäº¤ä¿®å¤
            git add .
            git commit -m "ğŸ¤– AIè‡ªåŠ¨ä¿®å¤ Issue #$ISSUE_NUMBER

* ç”±AIè‡ªåŠ¨ä¿®å¤æœºå™¨äººå®Œæˆ
* ä¿®å¤æ—¶é—´: $(date)
* ç›¸å…³Issue: #$ISSUE_NUMBER"

            # æ¨é€åˆ†æ”¯
            git push origin "$BRANCH_NAME"

            # åˆ›å»ºPR
            gh pr create \
              --title "ğŸ¤– AIè‡ªåŠ¨ä¿®å¤: Issue #$ISSUE_NUMBER" \
              --body "## ğŸ”§ AIè‡ªåŠ¨ä¿®å¤PR

æ­¤PRç”±AIè‡ªåŠ¨ä¿®å¤æœºå™¨äººåŸºäºIssue #$ISSUE_NUMBERç”Ÿæˆã€‚

### ğŸ“‹ ä¿®å¤å†…å®¹
- è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤ä»£ç é—®é¢˜
- ä½¿ç”¨AIç®—æ³•åˆ†æå’Œä¿®å¤
- ä¿®å¤æ—¶é—´: $(date)

### âœ… éªŒè¯æ­¥éª¤
1. æ£€æŸ¥ä¿®å¤æ•ˆæœ
2. è¿è¡Œæµ‹è¯•éªŒè¯
3. å®¡æŸ¥ä»£ç å˜æ›´

---
*ğŸ¤– ç”±AIè‡ªåŠ¨ä¿®å¤æœºå™¨äººè‡ªåŠ¨ç”Ÿæˆ*" \
              --base main \
              --label "auto-fix" \
              --label "ai-programming" || echo "PRåˆ›å»ºå¯èƒ½å¤±è´¥"

            echo "âœ… ä¿®å¤PRå·²åˆ›å»º"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€åˆ›å»ºPR"
          fi

  auto-fix-pr:
    name: ğŸ”§ PRè‡ªåŠ¨ä¿®å¤
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements/requirements.lock
            pyproject.toml

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements/requirements.lock
          pip install ruff mypy bandit pip-audit pytest

      - name: ğŸ”§ AIè‡ªåŠ¨ä¿®å¤PR
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "ğŸ¤– åˆ†æPR: $PR_NUMBER - $PR_TITLE"

          # è¿è¡Œæ™ºèƒ½ä¿®å¤
          python3 scripts/smart_quality_fixer.py --auto-fix || echo "æ™ºèƒ½ä¿®å¤å®Œæˆ"

          # è¿è¡ŒAIè‡ªåŠ¨ä¿®å¤
          python3 scripts/ai_auto_fixer.py --target all --confidence 0.6 || echo "AIä¿®å¤å®Œæˆ"

          # æ£€æŸ¥ä¿®å¤ç»“æœ
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ”§ å‘ç°å¯ä¿®å¤çš„é—®é¢˜ï¼Œå°è¯•è‡ªåŠ¨ä¿®å¤..."

            # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
            git config --global user.name "AI Auto Fixer"
            git config --global user.email "ai-fixer@actions.users.noreply.github.com"

            # æäº¤ä¿®å¤
            git add .
            git commit -m "ğŸ¤– AIè‡ªåŠ¨ä¿®å¤ PRä»£ç è´¨é‡é—®é¢˜

* ç”±AIè‡ªåŠ¨ä¿®å¤æœºå™¨äººå®Œæˆ
* ä¿®å¤æ—¶é—´: $(date)
* ç›¸å…³PR: #$PR_NUMBER"

            # æ¨é€åˆ°åŒä¸€åˆ†æ”¯
            git push

            echo "âœ… è‡ªåŠ¨ä¿®å¤å·²æäº¤åˆ°PRåˆ†æ”¯"
          else
            echo "âœ… æœªå‘ç°å¯è‡ªåŠ¨ä¿®å¤çš„é—®é¢˜"
          fi

      - name: ğŸ“Š ç”Ÿæˆä¿®å¤æŠ¥å‘Š
        run: |
          if [ -f "ai_fix_report.json" ]; then
            echo "ğŸ“Š ç”ŸæˆAIä¿®å¤æŠ¥å‘Š..."
            python3 -c "
import json

with open('ai_fix_report.json', 'r') as f:
    report = json.load(f)

success_count = report['successful_fixes']
total_count = report['total_fixes_attempted']

comment = f'''## ğŸ¤– PRè‡ªåŠ¨ä¿®å¤æŠ¥å‘Š

### ğŸ“Š ä¿®å¤ç»Ÿè®¡
- **ä¿®å¤å°è¯•**: {total_count} ç±»é—®é¢˜
- **æˆåŠŸä¿®å¤**: {success_count} ç±»é—®é¢˜
- **æˆåŠŸç‡**: {(success_count/total_count*100):.1f}%

### ğŸ“ ä¿®æ”¹æ–‡ä»¶
{len(report['files_modified'])} ä¸ªæ–‡ä»¶è¢«ä¿®æ”¹

### ğŸ” ä¿®å¤è¯¦æƒ…
'''

for detail in report['fix_details']:
    status = 'âœ…' if detail['success'] else 'âŒ'
    comment += f'{status} **{detail[\"type\"]}**: {len(detail[\"issues_fixed\"])} ä¸ªé—®é¢˜\n'

if success_count > 0:
    comment += '''
### ğŸ’¡ å»ºè®®
è¯·æ£€æŸ¥ä¿®å¤æ•ˆæœï¼Œç¡®ä¿åŠŸèƒ½æ­£å¸¸ã€‚å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ‰‹åŠ¨è°ƒæ•´ã€‚
'''

comment += '''
---
*ğŸ¤– æ­¤æŠ¥å‘Šç”±AIè‡ªåŠ¨ä¿®å¤æœºå™¨äººç”Ÿæˆ*
'''

with open('pr_fix_comment.md', 'w') as f:
    f.write(comment)
"

            # å‘å¸ƒè¯„è®ºåˆ°PR
            gh pr comment "$PR_NUMBER" --body "$(cat pr_fix_comment.md)"
          fi

  manual-auto-fix:
    name: ğŸ”§ æ‰‹åŠ¨è§¦å‘è‡ªåŠ¨ä¿®å¤
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements/requirements.lock
            pyproject.toml

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements/requirements.lock
          pip install ruff mypy bandit pip-audit pytest

      - name: ğŸ”§ æ‰§è¡Œæ‰‹åŠ¨è‡ªåŠ¨ä¿®å¤
        env:
          TARGET: ${{ github.event.inputs.target || 'all' }}
          AUTO_COMMIT: ${{ github.event.inputs.auto_commit || 'false' }}
        run: |
          echo "ğŸ¤– æ‰§è¡Œæ‰‹åŠ¨è‡ªåŠ¨ä¿®å¤..."
          echo "ğŸ¯ ç›®æ ‡: $TARGET"
          echo "ğŸ“¤ è‡ªåŠ¨æäº¤: $AUTO_COMMIT"

          # è¿è¡ŒAIè‡ªåŠ¨ä¿®å¤
          python3 scripts/ai_auto_fixer.py --target "$TARGET" --confidence 0.6

          # æ˜¾ç¤ºä¿®å¤ç»“æœ
          if [ -f "ai_fix_report.json" ]; then
            python3 -c "
import json

with open('ai_fix_report.json', 'r') as f:
    report = json.load(f)

print('ğŸ“Š ä¿®å¤ç»Ÿè®¡:')
print(f'  æˆåŠŸä¿®å¤: {report[\"successful_fixes\"]}/{report[\"total_fixes_attempted\"]}')
print(f'  ä¿®æ”¹æ–‡ä»¶: {len(report[\"files_modified\"])}')

if report['files_modified']:
    print('ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶:')
    for file_path in report['files_modified']:
        print(f'  - {file_path}')
"

            # å¦‚æœè®¾ç½®äº†è‡ªåŠ¨æäº¤ï¼Œåˆ›å»ºPR
            if [ "$AUTO_COMMIT" = "true" ] && [ -n "$(git status --porcelain)" ]; then
              echo "ğŸ“¤ åˆ›å»ºè‡ªåŠ¨ä¿®å¤PR..."

              git config --global user.name "AI Auto Fixer"
              git config --global user.email "ai-fixer@actions.users.noreply.github.com"

              BRANCH_NAME="manual-auto-fix-$(date +%Y%m%d-%H%M%S)"
              git checkout -b "$BRANCH_NAME"

              git add .
              git commit -m "ğŸ¤– æ‰‹åŠ¨è§¦å‘AIè‡ªåŠ¨ä¿®å¤

* ç”±AIè‡ªåŠ¨ä¿®å¤æœºå™¨äººå®Œæˆ
* ä¿®å¤æ—¶é—´: $(date)
* ç›®æ ‡ç±»å‹: $TARGET"

              git push origin "$BRANCH_NAME"

              gh pr create \
                --title "ğŸ¤– æ‰‹åŠ¨è§¦å‘AIè‡ªåŠ¨ä¿®å¤" \
                --body="## ğŸ”§ æ‰‹åŠ¨è§¦å‘AIè‡ªåŠ¨ä¿®å¤PR

æ­¤PRç”±æ‰‹åŠ¨è§¦å‘çš„AIè‡ªåŠ¨ä¿®å¤æœºå™¨äººç”Ÿæˆã€‚

**ä¿®å¤ç›®æ ‡**: $TARGET
**ä¿®å¤æ—¶é—´**: $(date)

---
*ğŸ¤– ç”±AIè‡ªåŠ¨ä¿®å¤æœºå™¨äººè‡ªåŠ¨ç”Ÿæˆ*" \
                --base main \
                --label "auto-fix" \
                --label "ai-programming"

              echo "âœ… è‡ªåŠ¨ä¿®å¤PRå·²åˆ›å»º"
            fi
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´æˆ–æŠ¥å‘Šç”Ÿæˆå¤±è´¥"
          fi