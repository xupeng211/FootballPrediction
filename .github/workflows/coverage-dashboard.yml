name: Coverage Dashboard

on:
  schedule:
    - cron: "0 2 * * 5"   # æ¯å‘¨äº”å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  dashboard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-coverage-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-coverage-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt
          pip install -e .

      - name: Run tests and generate coverage reports
        run: |
          pytest --cov=src --cov-report=json:coverage.json --cov-report=xml --cov-report=term --maxfail=5 --disable-warnings

      - name: Generate Quality Snapshot
        run: |
          python scripts/generate_quality_snapshot.py
          echo "âœ… è´¨é‡å¿«ç…§ç”Ÿæˆå®Œæˆ"

      - name: Update Quality Dashboard
        run: |
          python scripts/update_quality_dashboard.py
          echo "âœ… è´¨é‡çœ‹æ¿æ›´æ–°å®Œæˆ"

      - name: Generate Quality Badges
        run: |
          python scripts/generate_badges.py --all
          echo "âœ… è´¨é‡å¾½ç« ç”Ÿæˆå®Œæˆ"

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-dashboard-${{ github.run_number }}
          path: |
            coverage.json
            coverage.xml
            htmlcov/
            docs/_reports/QUALITY_SNAPSHOT.json
            docs/_reports/TEST_COVERAGE_KANBAN.md
            docs/_reports/badges/
          retention-days: 30

      - name: Commit and push dashboard updates
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "coverage-bot"
          git config --global user.email "coverage-bot@example.com"

          # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
          git add coverage.json
          git add docs/_reports/QUALITY_SNAPSHOT.json
          git add docs/_reports/TEST_COVERAGE_KANBAN.md
          git add docs/_reports/badges/

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if ! git diff-index --quiet HEAD; then
            git commit -m "chore(coverage): update coverage dashboard and quality metrics [skip ci]

          ğŸ¤– Automated coverage dashboard update:
          - Coverage data generated and analyzed
          - Quality snapshot updated
          - Quality dashboard synchronized
          - Quality badges regenerated

          ğŸ“Š Run ID: ${{ github.run_number }}
          â° Timestamp: $(date -u)"
            git push origin HEAD:${GITHUB_REF}
            echo "âœ… è¦†ç›–ç‡ä»ªè¡¨æ¿å·²æ›´æ–°"
          else
            echo "â„¹ï¸  è¦†ç›–ç‡æ•°æ®æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"