name: ðŸš€ ä¼˜åŒ–çš„CI/CDæµæ°´çº¿

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - 'requirements/**'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - 'docs/**'
      - '**.md'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šé¢„æ£€æŸ¥å’ŒçŽ¯å¢ƒè®¾ç½®
  pre-checks:
    name: ðŸ” é¢„æ£€æŸ¥ä¸ŽçŽ¯å¢ƒè®¾ç½®
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should-proceed: ${{ steps.changes.outputs.should-proceed }}
      python-version: ${{ steps.python-version.outputs.version }}
    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ æ£€æµ‹Pythonç‰ˆæœ¬
        id: python-version
        run: |
          echo "python-version=$(python3 --version)" >> $GITHUB_OUTPUT

      - name: ðŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: changes
        uses: dorny/paths-filter@v2.11.1
        with:
          filters: |
            python:
              - 'src/**/*.py'
              - 'tests/**/*.py'
              - 'requirements/**'
              - 'pyproject.toml'
            docs:
              - '**/*.md'
            docker:
              - 'Dockerfile*'
              - 'docker-compose*'

      - name: ðŸŽ¯ åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡ŒCI
        id: decision
        run: |
          if [ "${{ steps.changes.outputs.files }}" == "" ]; then
            echo "should-proceed=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ æ²¡æœ‰ä»£ç å˜æ›´ï¼Œè·³è¿‡CI"
          else
            echo "should-proceed=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œç»§ç»­CIæµç¨‹"

  # ç¬¬äºŒé˜¶æ®µï¼šä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¹¶è¡Œï¼‰
  quality-checks:
    name: ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-proceed == 'true'
    strategy:
      matrix:
        check-type: [syntax, ruff, mypy, security]
    timeout-minutes: 8
    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: âš™ï¸ ç¼“å­˜ä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/venv
          key: ${{ runner.os }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-

      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.pre-checks.outputs.python-version }}

      - name: ðŸ”§ å¿«é€Ÿè¯­æ³•æ£€æŸ¥
        if: matrix.check-type == 'syntax'
        run: |
          echo "ðŸ” å¿«é€Ÿè¯­æ³•æ£€æŸ¥..."
          python -m py_compile src/main.py || exit 1

      - name: ðŸŽ¯ Ruffä»£ç æ£€æŸ¥
        if: matrix.check-type == 'ruff'
        run: |
          echo "ðŸ” Ruffä»£ç æ£€æŸ¥..."
          ruff check src/ --statistics

      - name: ðŸ“‹ MyPyç±»åž‹æ£€æŸ¥
        if: matrix.check-type == 'mypy'
        run: |
          echo "ðŸ“‹ MyPyç±»åž‹æ£€æŸ¥..."
          mypy src/ --no-error-summary || echo "MyPyæ£€æŸ¥æœ‰è­¦å‘Šï¼Œç»§ç»­æµç¨‹"

      - name: ðŸ›¡ï¸ å®‰å…¨æ£€æŸ¥
        if: matrix.check-type == 'security'
        run: |
          echo "ðŸ›¡ï¸ å®‰å…¨æ£€æŸ¥..."
          bandit -r src/ -f json -o bandit-report.json || echo "Banditæ£€æŸ¥å®Œæˆ"
          pip-audit || echo "ä¾èµ–å®¡è®¡å®Œæˆ"

  # ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•æ‰§è¡Œï¼ˆå¹¶è¡Œï¼‰
  test-execution:
    name: ðŸ§ª æµ‹è¯•æ‰§è¡Œ
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-proceed == 'true'
    strategy:
      matrix:
        test-type: [unit, integration, coverage]
    timeout-minutes: 15
    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: âš™ï¸ ç¼“å­˜çŽ¯å¢ƒå’Œä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/venv
          key: ${{ runner.os }}-test-deps-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-deps-
            ${{ runner.os }}-venv-

      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.pre-checks.outputs.python-version }}

      - name: ðŸ“¦ å®‰è£…æµ‹è¯•ä¾èµ–
        run: |
          pip install pytest pytest-cov pytest-mock pytest-asyncio

      - name: ðŸ”¬ å•å…ƒæµ‹è¯•
        if: matrix.test-type == 'unit'
        run: |
          echo "ðŸ”¬ è¿è¡Œå•å…ƒæµ‹è¯•..."
          make test-unit

      - name: ðŸ”„ é›†æˆæµ‹è¯•
        if: matrix.test-type == 'integration'
        run: |
          echo "ðŸ”„ è¿è¡Œé›†æˆæµ‹è¯•..."
          make test.int

      - name: ðŸ“Š è¦†ç›–çŽ‡åˆ†æž
        if: matrix.test-type == 'coverage'
        run: |
          echo "ðŸ“Š ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š..."
          make coverage-local

  # ç¬¬å››é˜¶æ®µï¼šæž„å»º
  build:
    name: ðŸ—ï¸ åº”ç”¨æž„å»º
    runs-on: ubuntu-latest
    needs: [quality-checks, test-execution]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    timeout-minutes: 20
    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: âš™ï¸ ç¼“å­˜æž„å»ºä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/venv
            ~/.cache/build
          key: ${{ runner.os }}-build-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-

      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.pre-checks.outputs.python-version }}

      - name: ðŸ”§ å®‰è£…æž„å»ºä¾èµ–
        run: |
          pip install -r requirements/requirements.lock

      - name: ðŸ—ï¸ æž„å»ºåº”ç”¨
        run: |
          echo "ðŸ—ï¸ æž„å»ºDockeré•œåƒ..."
          python -c "
import src.main
print('âœ… åº”ç”¨æž„å»ºæˆåŠŸ')
"

      - name: ðŸ“¦ æž„å»ºå¹¶æŽ¨é€é•œåƒ
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ“¦ æž„å»ºå¹¶æŽ¨é€ç”Ÿäº§é•œåƒ..."
          docker build -t football-prediction:${{ github.sha }} .
          # è¿™é‡Œå¯ä»¥æ·»åŠ Docker HubæŽ¨é€é€»è¾‘

  # ç¬¬äº”é˜¶æ®µï¼šéƒ¨ç½²
  deploy:
    name: ðŸš€ éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    timeout-minutes: 10
    steps:
      - name: ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
        run: |
          echo "ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ..."
          echo "è¿™é‡Œå¯ä»¥æ·»åŠ å®žé™…çš„éƒ¨ç½²é€»è¾‘"
          echo "éƒ¨ç½²å®Œæˆ"

  # å·¥ä½œæµçŠ¶æ€æ€»ç»“
  workflow-status:
    name: ðŸ“Š å·¥ä½œæµçŠ¶æ€
    runs-on: ubuntu-latest
    needs: [pre-checks, quality-checks, test-execution, build]
    if: always()
    steps:
      - name: ðŸ“Š ç”Ÿæˆå·¥ä½œæµçŠ¶æ€æŠ¥å‘Š
        run: |
          echo "## ðŸš€ CI/CD å·¥ä½œæµæ‰§è¡Œå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| é¢„æ£€æŸ¥ | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ä»£ç è´¨é‡ | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| æµ‹è¯•æ‰§è¡Œ | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| åº”ç”¨æž„å»º | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½² | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY