name: é¡¹ç›®å¥åº·ç›‘æ§

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´02:00è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  health-check:
    name: é¡¹ç›®å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.6

      - name: Setup Python
        uses: actions/setup-python@v4.7.1
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements.lock
          pip install ruff mypy safety pytest

      - name: Code quality metrics
        id: quality
        run: |
          echo "ğŸ“Š æ”¶é›†ä»£ç è´¨é‡æŒ‡æ ‡..."

          # Ruffæ£€æŸ¥
          ruff_errors=$(ruff check src/ --output-format=json | jq length || echo "0")
          ruff_format_errors=$(ruff format src/ --check 2>&1 | grep -c "file would be reformatted" || echo "0")

          # MyPyæ£€æŸ¥
          mypy_errors=$(mypy src/ --show-error-codes 2>&1 | grep -c "error:" || echo "0")

          # å®‰å…¨æ£€æŸ¥
          safety_issues=$(safety check --json 2>&1 | jq -r '.vulnerabilities | length' 2>/dev/null || echo "0")

          # ä¿å­˜æŒ‡æ ‡
          cat > health-metrics.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "code_quality": {
              "ruff_errors": $ruff_errors,
              "ruff_format_issues": $ruff_format_errors,
              "mypy_errors": $mypy_errors,
              "safety_issues": $safety_issues
            }
          }
          EOF

          # è¾“å‡ºæ‘˜è¦
          echo "ruff_errors=$ruff_errors" >> $GITHUB_OUTPUT
          echo "mypy_errors=$mypy_errors" >> $GITHUB_OUTPUT
          echo "safety_issues=$safety_issues" >> $GITHUB_OUTPUT

      - name: Test coverage check
        id: coverage
        run: |
          echo "ğŸ§ª æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡..."

          # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
          python -m pytest tests/ --cov=src/ --cov-report=json --cov-fail-under=20 || true

          if [ -f coverage.json ]; then
            coverage=$(python -c "
import json
with open('coverage.json') as f:
    data = json.load(f)
coverage = data.get('totals', {}).get('percent_covered', 0)
print(coverage)
")
            echo "coverage=$coverage" >> $GITHUB_OUTPUT
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi

      - name: Documentation check
        run: |
          echo "ğŸ“š æ£€æŸ¥æ–‡æ¡£..."

          # æ£€æŸ¥æ–‡æ¡£æ–‡ä»¶å­˜åœ¨
          doc_files=("README.md" "docs/INDEX.md" "CLAUDE.md")
          missing_docs=0

          for doc in "${doc_files[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ… $doc å­˜åœ¨"
            else
              echo "âŒ $doc ç¼ºå¤±"
              ((missing_docs++))
            fi
          done

          echo "missing_docs=$missing_docs" >> $GITHUB_OUTPUT

      - name: Dependencies check
        run: |
          echo "ğŸ“¦ æ£€æŸ¥ä¾èµ–..."

          # æ£€æŸ¥è¿‡æœŸä¾èµ–
          pip list --outdated --format=json > outdated-deps.json || true
          outdated_count=$(jq -r '.[] | select(.latest_version != .current_version) | length' outdated-deps.json 2>/dev/null || echo "0")

          # æ£€æŸ¥å®‰å…¨æ¼æ´
          security_issues=$(safety check --json 2>&1 | jq -r '.vulnerabilities | length' 2>/dev/null || echo "0")

          echo "outdated_deps=$outdated_count" >> $GITHUB_OUTPUT
          echo "security_issues=$security_issues" >> $GITHUB_OUTPUT

      - name: Generate health report
        run: |
          echo "## ğŸ¥ é¡¹ç›®å¥åº·æŠ¥å‘Š" > health-report.md
          echo "" >> health-report.md
          echo "**ç”Ÿæˆæ—¶é—´**: $(date)" >> health-report.md
          echo "" >> health-report.md

          echo "### ğŸ“Š è´¨é‡æŒ‡æ ‡" >> health-report.md
          echo "" >> health-report.md
          echo "- **Ruffé”™è¯¯**: ${{ steps.quality.outputs.ruff_errors }}" >> health-report.md
          echo "- **æ ¼å¼é—®é¢˜**: ${{ steps.quality.outputs.ruff_format_issues }}" >> health-report.md
          echo "- **ç±»å‹é”™è¯¯**: ${{ steps.quality.outputs.mypy_errors }}" >> health-report.md
          echo "- **å®‰å…¨é—®é¢˜**: ${{ steps.quality.outputs.safety_issues }}" >> health-report.md
          echo "" >> health-report.md

          echo "### ğŸ§ª æµ‹è¯•è¦†ç›–ç‡" >> health-report.md
          echo "" >> health-report.md
          echo "- **è¦†ç›–ç‡**: ${{ steps.coverage.outputs.coverage }}%" >> health-report.md
          echo "- **çŠ¶æ€**: $([ "${{ steps.coverage.outputs.coverage }}" -ge 80 ] && echo "âœ… ä¼˜ç§€" || ([ "${{ steps.coverage.outputs.coverage }}" -ge 60 ] && echo "âš ï¸ ä¸€èˆ¬" || echo "âŒ éœ€è¦æ”¹è¿›"))" >> health-report.md
          echo "" >> health-report.md

          echo "### ğŸ“š æ–‡æ¡£çŠ¶æ€" >> health-report.md
          echo "" >> health-report.md
          echo "- **ç¼ºå¤±æ–‡æ¡£**: ${{ steps.documentation.outputs.missing_docs }}" >> health-report.md
          echo "- **çŠ¶æ€**: $([ "${{ steps.documentation.outputs.missing_docs }}" -eq 0 ] && echo "âœ… å®Œæ•´" || echo "âŒ ä¸å®Œæ•´")" >> health-report.md
          echo "" >> health-report.md

          echo "### ğŸ“¦ ä¾èµ–çŠ¶æ€" >> health-report.md
          echo "" >> health-report.md
          echo "- **è¿‡æœŸä¾èµ–**: ${{ steps.dependencies.outputs.outdated_deps }}" >> health-report.md
          echo "- **å®‰å…¨æ¼æ´**: ${{ steps.dependencies.outputs.security_issues }}" >> health-report.md
          echo "- **çŠ¶æ€**: $([ "${{ steps.dependencies.outputs.security_issues }}" -eq 0 ] && echo "âœ… å®‰å…¨" || echo "âš ï¸ æœ‰é£é™©")" >> health-report.md
          echo "" >> health-report.md

          echo "### ğŸ“ˆ å¥åº·è¯„åˆ†" >> health-report.md
          echo "" >> health-report.md

          # è®¡ç®—å¥åº·è¯„åˆ† (0-100)
          ruff_score=$((100 - ${{ steps.quality.outputs.ruff_errors }} * 5))
          mypy_score=$((100 - ${{ steps.quality.outputs.mypy_errors }} * 3))
          coverage_score=${{ steps.coverage.outputs.coverage }}

          # ç¡®ä¿åˆ†æ•°åœ¨0-100èŒƒå›´å†…
          ruff_score=$(( ruff_score < 0 ? 0 : ruff_score ))
          mypy_score=$(( mypy_score < 0 ? 0 : mypy_score ))
          health_score=$(( (ruff_score + mypy_score + coverage_score) / 3 ))

          if [ $health_score -ge 90 ]; then
            status="ğŸŸ¢ ä¼˜ç§€"
          elif [ $health_score -ge 70 ]; then
            status="ğŸŸ¡ è‰¯å¥½"
          else
            status="ğŸ”´ éœ€è¦æ”¹è¿›"
          fi

          echo "- **å¥åº·è¯„åˆ†**: $health_score/100 $status" >> health-report.md

      - name: Update GitHub summary
        run: |
          cat health-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload reports
        uses: actions/upload-artifact@v3
        with:
          name: health-monitor-reports
          path: |
            health-report.md
            health-metrics.json
            outdated-deps.json

      - name: Create issue if health score low
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const healthScore = ${{ steps.coverage.outputs.coverage }};

            if (healthScore < 60) {
              console.log('Creating issue for low health score...');

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `é¡¹ç›®å¥åº·è­¦å‘Š - å¥åº·è¯„åˆ†: ${healthScore}/100`,
                body: `
            ## ğŸš¨ é¡¹ç›®å¥åº·è­¦å‘Š

            å½“å‰é¡¹ç›®å¥åº·è¯„åˆ†ä¸º **${healthScore}/100**ï¼Œä½äºæ¨èæ ‡å‡†ã€‚

            ### ğŸ“Š å½“å‰çŠ¶æ€
            - æµ‹è¯•è¦†ç›–ç‡: ${healthScore}%
            - ä»£ç è´¨é‡æ£€æŸ¥: éœ€è¦æ”¹è¿›
            - å»ºè®®: è¯·å¢åŠ æµ‹è¯•è¦†ç›–ç‡å¹¶ä¿®å¤ä»£ç è´¨é‡é—®é¢˜

            ### ğŸ¯ æ”¹è¿›å»ºè®®
            1. å¢åŠ å•å…ƒæµ‹è¯•è¦†ç›–ç‡è‡³80%ä»¥ä¸Š
            2. ä¿®å¤Ruffå’ŒMyPyæ£€æŸ¥å‘ç°çš„é—®é¢˜
            3. æ›´æ–°æ–‡æ¡£å’Œä¾èµ–

            è‡ªåŠ¨ç”Ÿæˆäº: ${new Date().toISOString()}
            `,
                labels: ['maintenance', 'quality']
              });

              console.log('âœ… Issue created successfully');
            } else {
              console.log('âœ… Health score is good:', healthScore);
            }