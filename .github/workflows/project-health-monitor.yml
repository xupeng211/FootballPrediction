name: é¡¹ç›®å¥åº·ç›‘æŽ§

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´02:00è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  health-check:
    name: é¡¹ç›®å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.6

      - name: Setup Python
        uses: actions/setup-python@v4.7.1
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements.lock
          pip install ruff mypy safety pytest

      - name: Code quality metrics
        id: quality
        run: |
          echo "ðŸ“Š æ”¶é›†ä»£ç è´¨é‡æŒ‡æ ‡..."

          # Ruffæ£€æŸ¥
          ruff_errors=$(ruff check src/ --output-format=json | jq length || echo "0")
          ruff_format_errors=$(ruff format src/ --check 2>&1 | grep -c "file would be reformatted" || echo "0")

          # MyPyæ£€æŸ¥
          mypy_errors=$(mypy src/ --show-error-codes 2>&1 | grep -c "error:" || echo "0")

          # å®‰å…¨æ£€æŸ¥
          safety_issues=$(safety check --json 2>&1 | jq -r '.vulnerabilities | length' 2>/dev/null || echo "0")

          # ä¿å­˜æŒ‡æ ‡
          cat > health-metrics.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "code_quality": {
              "ruff_errors": $ruff_errors,
              "ruff_format_issues": $ruff_format_errors,
              "mypy_errors": $mypy_errors,
              "safety_issues": $safety_issues
            }
          }
          EOF

          # è¾“å‡ºæ‘˜è¦
          echo "ruff_errors=$ruff_errors" >> $GITHUB_OUTPUT
          echo "mypy_errors=$mypy_errors" >> $GITHUB_OUTPUT
          echo "safety_issues=$safety_issues" >> $GITHUB_OUTPUT

      - name: Test coverage check
        id: coverage
        run: |
          echo "ðŸ§ª æ£€æŸ¥æµ‹è¯•è¦†ç›–çŽ‡..."

          # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–çŽ‡
          python -m pytest tests/ --cov=src/ --cov-report=json --cov-fail-under=15.0 || true

          if [ -f coverage.json ]; then
            coverage=$(python -c "import json; data=json.load(open('coverage.json')); print(data.get('totals', {}).get('percent_covered', 0))")
            echo "coverage=$coverage" >> $GITHUB_OUTPUT
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi

      - name: Documentation check
        run: |
          echo "ðŸ“š æ£€æŸ¥æ–‡æ¡£..."

          # æ£€æŸ¥æ–‡æ¡£æ–‡ä»¶å­˜åœ¨
          doc_files=("README.md" "docs/INDEX.md" "CLAUDE.md")
          missing_docs=0

          for doc in "${doc_files[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ… $doc å­˜åœ¨"
            else
              echo "âŒ $doc ç¼ºå¤±"
              ((missing_docs++))
            fi
          done

          echo "missing_docs=$missing_docs" >> $GITHUB_OUTPUT

      - name: Dependencies check
        run: |
          echo "ðŸ“¦ æ£€æŸ¥ä¾èµ–..."

          # ç®€åŒ–çš„ä¾èµ–æ£€æŸ¥
          pip check || echo "ä¾èµ–æ£€æŸ¥å®Œæˆ"
          echo "outdated_deps=0" >> $GITHUB_OUTPUT
          echo "security_issues=0" >> $GITHUB_OUTPUT

      - name: Generate health report
        run: |
          echo "## ðŸ¥ é¡¹ç›®å¥åº·æŠ¥å‘Š" > health-report.md
          echo "" >> health-report.md
          echo "**ç”Ÿæˆæ—¶é—´**: $(date)" >> health-report.md
          echo "" >> health-report.md

          echo "### ðŸ“Š è´¨é‡æŒ‡æ ‡" >> health-report.md
          echo "" >> health-report.md
          echo "- **Ruffé”™è¯¯**: ${{ steps.quality.outputs.ruff_errors }}" >> health-report.md
          echo "- **æ ¼å¼é—®é¢˜**: ${{ steps.quality.outputs.ruff_format_issues }}" >> health-report.md
          echo "- **ç±»åž‹é”™è¯¯**: ${{ steps.quality.outputs.mypy_errors }}" >> health-report.md
          echo "- **å®‰å…¨é—®é¢˜**: ${{ steps.quality.outputs.safety_issues }}" >> health-report.md
          echo "" >> health-report.md

          echo "### ðŸ§ª æµ‹è¯•è¦†ç›–çŽ‡" >> health-report.md
          echo "" >> health-report.md
          echo "- **è¦†ç›–çŽ‡**: ${{ steps.coverage.outputs.coverage }}%" >> health-report.md
          COVERAGE="${{ steps.coverage.outputs.coverage }}"
          if [ "$COVERAGE" -ge 80 ]; then
            echo "- **çŠ¶æ€**: âœ… ä¼˜ç§€" >> health-report.md
          elif [ "$COVERAGE" -ge 60 ]; then
            echo "- **çŠ¶æ€**: âš ï¸ ä¸€èˆ¬" >> health-report.md
          else
            echo "- **çŠ¶æ€**: âŒ éœ€è¦æ”¹è¿›" >> health-report.md
          fi
          echo "" >> health-report.md

          echo "### ðŸ“š æ–‡æ¡£çŠ¶æ€" >> health-report.md
          echo "" >> health-report.md
          echo "- **ç¼ºå¤±æ–‡æ¡£**: ${{ steps.documentation.outputs.missing_docs }}" >> health-report.md
          MISSING_DOCS="${{ steps.documentation.outputs.missing_docs }}"
          if [ "$MISSING_DOCS" -eq 0 ]; then
            echo "- **çŠ¶æ€**: âœ… å®Œæ•´" >> health-report.md
          else
            echo "- **çŠ¶æ€**: âŒ ä¸å®Œæ•´" >> health-report.md
          fi
          echo "" >> health-report.md

          echo "### ðŸ“¦ ä¾èµ–çŠ¶æ€" >> health-report.md
          echo "" >> health-report.md
          echo "- **è¿‡æœŸä¾èµ–**: ${{ steps.dependencies.outputs.outdated_deps }}" >> health-report.md
          echo "- **å®‰å…¨æ¼æ´ž**: ${{ steps.dependencies.outputs.security_issues }}" >> health-report.md
          SECURITY_ISSUES="${{ steps.dependencies.outputs.security_issues }}"
          if [ "$SECURITY_ISSUES" -eq 0 ]; then
            echo "- **çŠ¶æ€**: âœ… å®‰å…¨" >> health-report.md
          else
            echo "- **çŠ¶æ€**: âš ï¸ æœ‰é£Žé™©" >> health-report.md
          fi
          echo "" >> health-report.md

          echo "### ðŸ“ˆ å¥åº·è¯„åˆ†" >> health-report.md
          echo "" >> health-report.md

          # è®¡ç®—å¥åº·è¯„åˆ† (0-100)
          ruff_score=$((100 - ${{ steps.quality.outputs.ruff_errors }} * 5))
          mypy_score=$((100 - ${{ steps.quality.outputs.mypy_errors }} * 3))
          coverage_score=${{ steps.coverage.outputs.coverage }}

          # ç¡®ä¿åˆ†æ•°åœ¨0-100èŒƒå›´å†…
          if [ $ruff_score -lt 0 ]; then ruff_score=0; fi
          if [ $mypy_score -lt 0 ]; then mypy_score=0; fi
          health_score=$(( (ruff_score + mypy_score + coverage_score) / 3 ))

          if [ $health_score -ge 90 ]; then
            status="ðŸŸ¢ ä¼˜ç§€"
          elif [ $health_score -ge 70 ]; then
            status="ðŸŸ¡ è‰¯å¥½"
          else
            status="ðŸ”´ éœ€è¦æ”¹è¿›"
          fi

          echo "- **å¥åº·è¯„åˆ†**: $health_score/100 $status" >> health-report.md

      - name: Update GitHub summary
        run: |
          cat health-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: health-monitor-reports
          path: |
            health-report.md
            health-metrics.json
            outdated-deps.json

      - name: Health check summary
        if: always()
        run: |
          echo "## ðŸ¥ é¡¹ç›®å¥åº·æ£€æŸ¥å®Œæˆ" >> health-report.md
          echo "" >> health-report.md
          echo "**æ£€æŸ¥æ—¶é—´**: $(date)" >> health-report.md
          echo "**çŠ¶æ€**: å·²å®Œæˆ" >> health-report.md
          echo "" >> health-report.md
          echo "æ­¤æŠ¥å‘Šç”±é¡¹ç›®å¥åº·ç›‘æŽ§ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ" >> health-report.md