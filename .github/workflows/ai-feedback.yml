name: ðŸ¤– AIç¼–ç¨‹åŠ©æ‰‹åé¦ˆç³»ç»Ÿ

on:
  issues:
    types: [opened, reopened]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze-issues:
    name: ðŸ¤– åˆ†æžAIç¼–ç¨‹ç›¸å…³é—®é¢˜
    if: |
      contains(github.event.issue.labels.*.name, 'ai-programming') ||
      contains(github.event.issue.title, '[AI]') ||
      contains(github.event.pull_request.labels.*.name, 'ai-programming')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install requests

      - name: ðŸ¤– åˆ†æžIssue
        if: github.event_name == 'issues'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "ðŸ¤– å¼€å§‹åˆ†æžAIç¼–ç¨‹ç›¸å…³é—®é¢˜..."

          # è¿è¡ŒIssueåˆ†æžå™¨
          python3 scripts/ai_issue_analyzer.py \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --comment \
            --output analysis_result.md

          # ç”ŸæˆAIå‹å¥½è¯„è®º
          COMMENT_BODY=$(cat analysis_result.md)

          # å‘å¸ƒè¯„è®º
          gh issue comment "$ISSUE_NUMBER" --body "$COMMENT_BODY"

          echo "âœ… AIç¼–ç¨‹åˆ†æžå®Œæˆï¼Œå·²æ·»åŠ è¯„è®º"

      - name: ðŸ¤– åˆ†æžPR
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "ðŸ¤– å¼€å§‹åˆ†æžAIç¼–ç¨‹ç›¸å…³PR..."

          # æ£€æŸ¥PRå˜æ›´
          git fetch origin main
          CHANGED_FILES=$(git diff --name-only origin/main HEAD | grep -E '\.(py|yml|yaml)$' || true)

          if [ -n "$CHANGED_FILES" ]; then
            echo "ðŸ“ æ£€æµ‹åˆ°ä»¥ä¸‹æ–‡ä»¶å˜æ›´:"
            echo "$CHANGED_FILES"

            # è¿è¡Œå¿«é€Ÿè´¨é‡æ£€æŸ¥
            python3 scripts/quality_guardian.py --check-only || true

            # ç”ŸæˆAIç¼–ç¨‹å‹å¥½è¯„è®º
            COMMENT_BODY="## ðŸ¤– AIç¼–ç¨‹åŠ©æ‰‹PRåˆ†æž

### ðŸ“Š å˜æ›´æ‘˜è¦
- **å˜æ›´æ–‡ä»¶æ•°**: $(echo "$CHANGED_FILES" | wc -l)
- **Pythonæ–‡ä»¶**: $(echo "$CHANGED_FILES" | grep -c '\.py$' || echo 0)
- **é…ç½®æ–‡ä»¶**: $(echo "$CHANGED_FILES" | grep -c -E '\.(yml|yaml)$' || echo 0)

### ðŸ”§ å»ºè®®çš„éªŒè¯æ­¥éª¤
1. **æœ¬åœ°æµ‹è¯•**:
   \`\`\`bash
   make test-quick
   make coverage-targeted MODULE=src
   \`\`\`

2. **è´¨é‡æ£€æŸ¥**:
   \`\`\`bash
   python3 scripts/quality_guardian.py --check-only
   python3 scripts/smart_quality_fixer.py
   \`\`\`

3. **å®Œæ•´éªŒè¯**:
   \`\`\`bash
   make prepush
   \`\`\`

### ðŸ“š AIç¼–ç¨‹å·¥å…·æŒ‡å—
- [CLAUDE.md](CLAUDE.md) - å®Œæ•´ä½¿ç”¨æŒ‡å—
- [è´¨é‡å®ˆæŠ¤ç³»ç»Ÿ](docs/QUALITY_GUARDIAN_SYSTEM_GUIDE.md)
- [æµ‹è¯•ç­–ç•¥](docs/testing/TEST_IMPROVEMENT_GUIDE.md)

---
*ðŸ¤– æ­¤åˆ†æžç”±AIç¼–ç¨‹åŠ©æ‰‹åé¦ˆç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*
"

            # å‘å¸ƒè¯„è®º
            gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"
          else
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°Python/é…ç½®æ–‡ä»¶å˜æ›´"
          fi

          echo "âœ… AIç¼–ç¨‹PRåˆ†æžå®Œæˆ"

  smart-suggestions:
    name: ðŸ’¡ AIç¼–ç¨‹æ™ºèƒ½å»ºè®®
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'auto-fixable')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements/requirements.lock
            pyproject.toml

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements/requirements.lock

      - name: ðŸ”§ å°è¯•è‡ªåŠ¨ä¿®å¤
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "ðŸ”§ å°è¯•AIç¼–ç¨‹è‡ªåŠ¨ä¿®å¤..."

          # è¿è¡Œæ™ºèƒ½ä¿®å¤å·¥å…·
          python3 scripts/smart_quality_fixer.py || echo "æ™ºèƒ½ä¿®å¤å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰"

          # æ£€æŸ¥ä¿®å¤æ•ˆæžœ
          python3 scripts/quality_guardian.py --check-only || true

          # ç”Ÿæˆä¿®å¤æŠ¥å‘Š
          cat > fix_report.md << 'EOF'
          ## ðŸ”§ AIç¼–ç¨‹è‡ªåŠ¨ä¿®å¤æŠ¥å‘Š

          ### âœ… å·²å°è¯•çš„ä¿®å¤æ“ä½œ
          1. è¯­æ³•é”™è¯¯è‡ªåŠ¨ä¿®å¤
          2. å¯¼å…¥é—®é¢˜ä¿®å¤
          3. ä»£ç æ ¼å¼åŒ–
          4. åŸºç¡€å®‰å…¨é—®é¢˜ä¿®å¤

          ### ðŸ“Š ä¿®å¤ç»“æžœ
          è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—äº†è§£è¯¦ç»†çš„ä¿®å¤ç»“æžœã€‚

          ### ðŸŽ¯ ä¸‹ä¸€æ­¥å»ºè®®
          1. æ£€æŸ¥ä¿®å¤æ•ˆæžœæ˜¯å¦ç¬¦åˆé¢„æœŸ
          2. è¿è¡Œ `make test-quick` éªŒè¯åŠŸèƒ½
          3. å¦‚æœ‰å‰©ä½™é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

          ---
          *ðŸ”§ æ­¤æŠ¥å‘Šç”±AIç¼–ç¨‹è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿç”Ÿæˆ*
          EOF

          # å‘å¸ƒä¿®å¤æŠ¥å‘Š
          gh issue comment "$ISSUE_NUMBER" --body "$(cat fix_report.md)"

          echo "âœ… AIç¼–ç¨‹è‡ªåŠ¨ä¿®å¤å®Œæˆ"