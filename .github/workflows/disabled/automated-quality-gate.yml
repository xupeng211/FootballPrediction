# åŸºäºŽIssue #98æ™ºèƒ½è´¨é‡ä¿®å¤æ–¹æ³•è®ºå’ŒIssue #94è¦†ç›–çŽ‡æå‡å®žè·µçš„CI/CDæµæ°´çº¿
# ä¸ºIssue #89 CI/CDä¼˜åŒ–é¡¹ç›®æä¾›ä¼ä¸šçº§è‡ªåŠ¨åŒ–æ”¯æŒ

name: ðŸ›¡ï¸ Automated Quality Gate - Issue #89

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      run_coverage:
        description: 'Run full coverage analysis'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"

jobs:
  # è´¨é‡é—¨ç¦æ£€æŸ¥ - åŸºäºŽIssue #98æ™ºèƒ½è´¨é‡ä¿®å¤æ–¹æ³•è®º
  quality-gate:
    runs-on: ubuntu-latest
    name: ðŸ›¡ï¸ Quality Gate Check

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov ruff mypy bandit
          if [ -f requirements/requirements.lock ]; then pip install -r requirements/requirements.lock; fi

      - name: ðŸ”§ Run syntax check (Issue #98 methodology)
        run: |
          echo "ðŸ”§ åŸºäºŽIssue #98æ‰§è¡Œè¯­æ³•æ£€æŸ¥..."
          python3 scripts/smart_quality_fixer.py --syntax-only || echo "è¯­æ³•æ£€æŸ¥å®Œæˆ"

      - name: ðŸ›¡ï¸ Run quality guardian (Issue #98 methodology)
        run: |
          echo "ðŸ›¡ï¸ åŸºäºŽIssue #98æ‰§è¡Œè´¨é‡å®ˆæŠ¤æ£€æŸ¥..."
          python3 scripts/quality_guardian.py --check-only

      - name: ðŸš€ Run automated quality gate (Issue #89 Phase 1)
        run: |
          echo "ðŸš€ è¿è¡ŒIssue #89è‡ªåŠ¨åŒ–è´¨é‡é—¨ç¦..."
          python3 scripts/automated_quality_gate.py --save-report

      - name: ðŸ“Š Upload quality reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: quality-reports-${{ github.run_number }}
          path: |
            ci-reports/
            quality-reports/
          retention-days: 30

      - name: ðŸŽ¯ Gate status evaluation
        run: |
          echo "ðŸŽ¯ è¯„ä¼°è´¨é‡é—¨ç¦çŠ¶æ€..."

          # æ£€æŸ¥æœ€æ–°æŠ¥å‘Š
          LATEST_REPORT=$(ls -t ci-reports/quality_gate_report_*.json | head -1)
          if [ -f "$LATEST_REPORT" ]; then
            GATE_STATUS=$(python3 -c "
import json
import sys
try:
    with open('$LATEST_REPORT', 'r') as f:
        report = json.load(f)
    print(report['gate_status'])
except:
    print('unknown')
    sys.exit(1)
")
            echo "ðŸŽ¯ è´¨é‡é—¨ç¦çŠ¶æ€: $GATE_STATUS"

            if [ "$GATE_STATUS" = "pass" ]; then
              echo "âœ… è´¨é‡é—¨ç¦é€šè¿‡"
            elif [ "$GATE_STATUS" = "warning" ]; then
              echo "âš ï¸ è´¨é‡é—¨ç¦è­¦å‘Š - å¯ç»§ç»­ä½†éœ€å…³æ³¨"
            else
              echo "âŒ è´¨é‡é—¨ç¦å¤±è´¥"
              exit 1
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°è´¨é‡æŠ¥å‘Š"
            exit 1
          fi

  # æµ‹è¯•æ‰§è¡Œå’Œè¦†ç›–çŽ‡æ£€æŸ¥ - æ”¯æŒIssue #94è¦†ç›–çŽ‡æå‡è®¡åˆ’
  test-coverage:
    runs-on: ubuntu-latest
    name: ðŸ§ª Test & Coverage Analysis
    needs: quality-gate

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist
          if [ -f requirements/requirements.lock ]; then pip install -r requirements/requirements.lock; fi

      - name: ðŸ§ª Run utils module tests (Issue #94 priority)
        run: |
          echo "ðŸ§ª æ‰§è¡ŒIssue #94ä¼˜å…ˆçš„utilsæ¨¡å—æµ‹è¯•..."
          python -m pytest tests/unit/utils/ \
            --cov=src/utils \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --tb=short \
            -v \
            --maxfail=20

      - name: ðŸ“Š Upload coverage reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-reports-${{ github.run_number }}
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

      - name: ðŸ“ˆ Coverage summary (Issue #94 tracking)
        run: |
          echo "ðŸ“ˆ Issue #94è¦†ç›–çŽ‡æå‡è¿›å±•æŠ¥å‘Š..."

          # è§£æžè¦†ç›–çŽ‡æ•°æ®
          if [ -f htmlcov/index.html ]; then
            COVERAGE=$(grep -o '[0-9]*\.[0-9]%' htmlcov/index.html | head -1)
            echo "ðŸ“Š å½“å‰è¦†ç›–çŽ‡: $COVERAGE"
            echo "ðŸŽ¯ Issue #94ç›®æ ‡: 15%+ (å½“å‰é˜¶æ®µ)"

            # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡
            COVERAGE_NUM=$(echo $COVERAGE | sed 's/%//')
            if (( $(echo "$COVERAGE_NUM >= 15" | bc -l) )); then
              echo "ðŸŽ‰ æ­å–œï¼å·²è¾¾åˆ°Issue #94 15%è¦†ç›–çŽ‡ç›®æ ‡ï¼"
            else
              echo "ðŸ“ˆ ç»§ç»­æŽ¨è¿›Issue #94è¦†ç›–çŽ‡æå‡è®¡åˆ’"
              echo "ðŸŽ¯ å½“å‰è·ç¦»15%ç›®æ ‡è¿˜éœ€æå‡: $(echo "15 - $COVERAGE_NUM" | bc -l)%"
            fi
          fi

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: ðŸ” Code Quality Analysis
    needs: quality-gate

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy bandit
          if [ -f requirements/requirements.lock ]; then pip install -r requirements/requirements.lock; fi

      - name: ðŸ” Run Ruff linting (Issue #98 methodology)
        run: |
          echo "ðŸ” åŸºäºŽIssue #98æ‰§è¡ŒRuffä»£ç æ£€æŸ¥..."
          ruff check src/ --output-format=github --output-file=ruff-results.json

      - name: ðŸ” Run MyPy type checking
        run: |
          echo "ðŸ” æ‰§è¡ŒMyPyç±»åž‹æ£€æŸ¥..."
          mypy src/ --json-report mypy-results.json || echo "MyPyæ£€æŸ¥å®Œæˆ"

      - name: ðŸ” Run security scan
        run: |
          echo "ðŸ” æ‰§è¡Œå®‰å…¨æ‰«æ..."
          bandit -r src/ -f json -o bandit-results.json || echo "å®‰å…¨æ‰«æå®Œæˆ"

      - name: ðŸ“Š Upload quality reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: code-quality-reports-${{ github.run_number }}
          path: |
            ruff-results.json
            mypy-results.json
            bandit-results.json
          retention-days: 30

  # Issue #94è¦†ç›–çŽ‡æå‡ä¸“é¡¹ä»»åŠ¡
  coverage-boost:
    runs-on: ubuntu-latest
    name: ðŸš€ Coverage Boost Task
    needs: test-coverage
    if: github.event.inputs.run_coverage == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist
          if [ -f requirements/requirements.lock ]; then pip install -r requirements/requirements.lock; fi

      - name: ðŸš€ Run comprehensive coverage analysis
        run: |
          echo "ðŸš€ æ‰§è¡ŒIssue #94å…¨é¢è¦†ç›–çŽ‡åˆ†æž..."

          # è¿è¡Œæ›´å¤šæ¨¡å—æµ‹è¯•
          python -m pytest tests/unit/ tests/integration/ \
            --cov=src/ \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --tb=short \
            -x \
            --maxfail=50 \
            --timeout=300

      - name: ðŸ“Š Upload comprehensive coverage
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: comprehensive-coverage-${{ github.run_number }}
          path: htmlcov/
          retention-days: 7

  # æ±‡æ€»æŠ¥å‘Š
  summary:
    runs-on: ubuntu-latest
    name: ðŸ“‹ Build Summary
    needs: [quality-gate, test-coverage, code-quality]
    if: always()

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts/

      - name: ðŸ“‹ Generate summary report
        run: |
          echo "# ðŸ›¡ï¸ Issue #89 CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è´¨é‡é—¨ç¦çŠ¶æ€
          if [ -f artifacts/quality-reports-*/quality_gate_report_*.json ]; then
            echo "### ðŸ›¡ï¸ Quality Gate" >> $GITHUB_STEP_SUMMARY
            python3 -c "
import json
import glob
latest_report = sorted(glob.glob('artifacts/quality-reports-*/quality_gate_report_*.json'))[-1]
if latest_report:
    with open(latest_report, 'r') as f:
        report = json.load(f)

    status = report['gate_status']
    summary = report['summary']

    status_emoji = {
        'pass': 'âœ…',
        'warning': 'âš ï¸',
        'fail': 'âŒ',
        'error': 'ðŸš¨',
        'timeout': 'â°'
    }

    print(f'- **Status**: {status_emoji.get(status, \"â“\")} {status.upper()}')
    print(f'- **Checks**: {summary[\"total_checks\"]} total')
    print(f'- **Passed**: {summary[\"passed\"]} âœ…')
    print(f'- **Failed**: {summary[\"failed\"]} âŒ')
    print(f'- **Errors**: {summary[\"errors\"]} ðŸš¨')
    print(f'- **Timeouts**: {summary[\"timeouts\"]} â°')

    if report.get('metrics'):
        print('')
        print('### ðŸ“ˆ Key Metrics')
        for metric, value in report['metrics'].items():
            if isinstance(value, float):
                print(f'- **{metric}**: {value:.1f}')
            else:
                print(f'- **{metric}**: {value}')
" >> $GITHUB_STEP_SUMMARY
          fi

          # è¦†ç›–çŽ‡ä¿¡æ¯
          if [ -f artifacts/coverage-reports-*/htmlcov/index.html ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Coverage Analysis" >> $GITHUB_STEP_SUMMARY
            python3 -c "
import glob
import re
latest_html = sorted(glob.glob('artifacts/coverage-reports-*/htmlcov/index.html'))[-1]
if latest_html:
    with open(latest_html, 'r') as f:
        content = f.read()

    # æŸ¥æ‰¾è¦†ç›–çŽ‡ç™¾åˆ†æ¯”
    match = re.search(r'([0-9]+\.[0-9]+)%', content)
    if match:
        coverage = match.group(1)
        print(f'- **Current Coverage**: {coverage} ðŸ“Š')
        print(f'- **Issue #94 Target**: 15%+ ðŸŽ¯')

        # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡
        coverage_num = float(coverage)
        if coverage_num >= 15:
            print('- **Status**: ðŸŽ‰ **TARGET ACHIEVED!**')
        else:
            needed = 15 - coverage_num
            print(f'- **Gap to Target**: {needed:.1f}% ðŸ“ˆ')
" >> $GITHUB_STEP_SUMMARY
          fi

          # æŽ¨èè¡ŒåŠ¨
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps (Issue #94 & #89)" >> $GITHUB_STEP_SUMMARY
          echo "- Continue Issue #94 coverage boost plan" >> $GITHUB_STEP_SUMMARY
          echo "- Advance Issue #89 Phase 2 optimizations" >> $GITHUB_STEP_SUMMARY
          echo "- Apply Issue #98 methodology for improvements" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor quality trends and adjust strategies" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Report generated by Issue #89 CI/CD Pipeline*" >> $GITHUB_STEP_SUMMARY
          echo "*Based on Issue #98 quality methodology*" >> $GITHUB_STEP_SUMMARY
          echo "*Supporting Issue #94 coverage enhancement*" >> $GITHUB_STEP_SUMMARY
