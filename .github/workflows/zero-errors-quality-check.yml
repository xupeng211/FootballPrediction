name: Zero Errors Quality Check

# å†å²æ€§é›¶é”™è¯¯æˆå°±è´¨é‡æ£€æŸ¥æµæ°´çº¿
# åŸºäºä¼ä¸šçº§æ ‡å‡†ï¼Œç¡®ä¿ä»£ç å§‹ç»ˆä¿æŒé›¶é”™è¯¯çŠ¶æ€

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©UTC 02:00è¿è¡Œè´¨é‡æ£€æŸ¥
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  zero-errors-validation:
    name: ğŸ¯ Zero Errors Validation
    runs-on: ubuntu-latest

    steps:
    - name: ğŸš€ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºæ ‡ç­¾æ£€æŸ¥

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        # ç¡®ä¿è´¨é‡å·¥å…·æœ€æ–°ç‰ˆæœ¬
        pip install --upgrade ruff mypy bandit pytest pytest-cov pip-audit

    - name: ğŸ¯ Zero Errors Quality Check
      run: |
        echo "ğŸ¯ æ‰§è¡Œé›¶é”™è¯¯è´¨é‡æ£€æŸ¥..."
        echo "================================"

        # æ ¸å¿ƒè´¨é‡æ£€æŸ¥ - å¿…é¡»è¾¾åˆ°é›¶é”™è¯¯
        echo "ğŸ“Š è¿è¡Œruffä»£ç è´¨é‡æ£€æŸ¥..."
        if ruff check src/ tests/ --output-format=concise; then
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡ - é›¶é”™è¯¯çŠ¶æ€"
        else
          echo "âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥ - å‘ç°é”™è¯¯"
          ruff check src/ tests/ --output-format=full
          exit 1
        fi

        # æ ¼å¼æ£€æŸ¥
        echo "ğŸ“‹ æ£€æŸ¥ä»£ç æ ¼å¼..."
        if ruff format --check src/ tests/; then
          echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥"
          ruff format src/ tests/ --diff
          exit 1
        fi

  test-suite:
    name: ğŸ§ª Test Execution
    runs-on: ubuntu-latest

    steps:
    - name: ğŸš€ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: ğŸ”¬ Unit Tests
      run: |
        echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
        make test.unit

    - name: ğŸ”— Integration Tests
      run: |
        echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
        make test.integration

    - name: ğŸ“Š Coverage Report
      run: |
        echo "ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
        make coverage-unit
        echo "ğŸ“ˆ è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ"

        # ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ°codecovï¼ˆå¦‚æœé…ç½®äº†çš„è¯ï¼‰
        if [ -f "coverage.xml" ]; then
          echo "ğŸ“¤ å‘ç°è¦†ç›–ç‡æŠ¥å‘Šï¼Œå‡†å¤‡ä¸Šä¼ ..."
          # codecov -f coverage.xml  # å¦‚æœæœ‰codecov tokenå¯ä»¥å–æ¶ˆæ³¨é‡Š
        fi

    security-scan:
    name: ğŸ”’ Security Assessment
    runs-on: ubuntu-latest

    steps:
    - name: ğŸš€ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit pip-audit safety

    - name: ğŸ›¡ï¸ Security Scan
      run: |
        echo "ğŸ›¡ï¸ æ‰§è¡Œå®‰å…¨æ‰«æ..."
        echo "=================="

        # Banditå®‰å…¨æ£€æŸ¥
        echo "ğŸ” è¿è¡ŒBanditå®‰å…¨æ‰«æ..."
        if bandit -r src/ -f json -o bandit-report.json; then
          echo "âœ… Banditå®‰å…¨æ‰«æé€šè¿‡"
        else
          echo "âš ï¸  å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥bandit-report.json"
          # å¯¹äºå®‰å…¨é—®é¢˜ï¼Œæˆ‘ä»¬è­¦å‘Šä½†ä¸é˜»æ­¢æ„å»º
          cat bandit-report.json
        fi

        # ä¾èµ–å®‰å…¨å®¡è®¡
        echo "ğŸ“¦ è¿è¡Œä¾èµ–å®‰å…¨å®¡è®¡..."
        if pip-audit --format=json --output=pip-audit-report.json; then
          echo "âœ… ä¾èµ–å®‰å…¨å®¡è®¡é€šè¿‡"
        else
          echo "âš ï¸  å‘ç°ä¾èµ–å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥pip-audit-report.json"
          cat pip-audit-report.json
        fi

    version-tag-check:
    name: ğŸ·ï¸ Version and Tag Validation
    runs-on: ubuntu-latest

    steps:
    - name: ğŸš€ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²å’Œæ ‡ç­¾

    - name: ğŸ·ï¸ Check Zero Errors Tag
      run: |
        echo "ğŸ·ï¸ æ£€æŸ¥é›¶é”™è¯¯æˆå°±æ ‡ç­¾..."
        echo "=========================="

        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨é›¶é”™è¯¯æ ‡ç­¾
        if git tag -l | grep -q "v1.0.0-zero-errors"; then
          echo "âœ… å‘ç°é›¶é”™è¯¯æˆå°±æ ‡ç­¾: v1.0.0-zero-errors"

          # è·å–æ ‡ç­¾ä¿¡æ¯
          echo "ğŸ“‹ æ ‡ç­¾è¯¦ç»†ä¿¡æ¯:"
          git tag -l v1.0.0-zero-errors -n99

          # æ£€æŸ¥æ ‡ç­¾ä¸å½“å‰æäº¤çš„å…³ç³»
          LATEST_TAG_COMMIT=$(git rev-list -1 v1.0.0-zero-errors)
          CURRENT_COMMIT=$(git rev-parse HEAD)

          if [ "$LATEST_TAG_COMMIT" = "$CURRENT_COMMIT" ]; then
            echo "ğŸ¯ å½“å‰æäº¤æ­£æ˜¯é›¶é”™è¯¯æˆå°±ç‰ˆæœ¬"
          else
            echo "ğŸ“ˆ å½“å‰æäº¤åœ¨é›¶é”™è¯¯æˆå°±ç‰ˆæœ¬ä¹‹å"
          fi
        else
          echo "â„¹ï¸  æœªå‘ç°é›¶é”™è¯¯æˆå°±æ ‡ç­¾"
        fi

    quality-metrics:
    name: ğŸ“Š Quality Metrics Collection
    runs-on: ubuntu-latest

    steps:
    - name: ğŸš€ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: ğŸ“ˆ Collect Quality Metrics
      run: |
        echo "ğŸ“ˆ æ”¶é›†è´¨é‡æŒ‡æ ‡..."
        echo "=================="

        # ä»£ç è¡Œæ•°ç»Ÿè®¡
        echo "ğŸ“Š ä»£ç ç»Ÿè®¡:"
        find src/ -name "*.py" | xargs wc -l | tail -1

        # æµ‹è¯•æ–‡ä»¶ç»Ÿè®¡
        echo "ğŸ§ª æµ‹è¯•æ–‡ä»¶ç»Ÿè®¡:"
        find tests/ -name "*.py" | xargs wc -l | tail -1

        # è´¨é‡æ£€æŸ¥ç»“æœ
        echo "ğŸ¯ è´¨é‡æ£€æŸ¥ç»“æœ:"
        ERROR_COUNT=$(ruff check src/ tests/ --output-format=concise | wc -l)
        echo "é”™è¯¯æ•°é‡: $ERROR_COUNT"

        if [ "$ERROR_COUNT" -eq 0 ]; then
          echo "âœ… ç»´æŒé›¶é”™è¯¯çŠ¶æ€"
        else
          echo "âŒ æ£€æµ‹åˆ° $ERROR_COUNT ä¸ªé”™è¯¯"
        fi

        # ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        python3 -c "
        import subprocess
        import json
        from datetime import datetime

        # æ”¶é›†æŒ‡æ ‡
        result = subprocess.run(['ruff', 'check', 'src/', 'tests/', '--output-format=json'],
                              capture_output=True, text=True)
        errors = json.loads(result.stdout) if result.stdout else []

        metrics = {
            'timestamp': datetime.now().isoformat(),
            'zero_errors_status': len(errors) == 0,
            'error_count': len(errors),
            'commit_sha': '${{ github.sha }}',
            'branch': '${{ github.ref_name }}',
            'workflow_run_id': '${{ github.run_id }}'
        }

        # ä¿å­˜æŒ‡æ ‡
        with open('quality-metrics.json', 'w') as f:
            json.dump(metrics, f, indent=2)

        print(f'ğŸ“Š è´¨é‡æŒ‡æ ‡: {metrics}')
        "

    - name: ğŸ“¤ Upload Quality Reports
      uses: actions/upload-artifact@v3
      with:
        name: quality-reports
        path: |
          bandit-report.json
          pip-audit-report.json
          quality-metrics.json
          coverage.xml
        retention-days: 30

    - name: ğŸ‰ Success Notification
      if: success()
      run: |
        echo "ğŸ‰ è´¨é‡æ£€æŸ¥æµæ°´çº¿å®Œæˆï¼"
        echo "=========================="
        echo "âœ… é›¶é”™è¯¯çŠ¶æ€: å·²éªŒè¯"
        echo "âœ… æµ‹è¯•å¥—ä»¶: å…¨éƒ¨é€šè¿‡"
        echo "âœ… å®‰å…¨æ‰«æ: å·²å®Œæˆ"
        echo "âœ… ç‰ˆæœ¬æ ‡ç­¾: å·²æ£€æŸ¥"
        echo "âœ… è´¨é‡æŒ‡æ ‡: å·²æ”¶é›†"
        echo ""
        echo "ğŸ† FootballPredictioné¡¹ç›®ç»´æŒä¼ä¸šçº§é›¶é”™è¯¯æ ‡å‡†ï¼"

    - name: âš ï¸ Failure Notification
      if: failure()
      run: |
        echo "âš ï¸ è´¨é‡æ£€æŸ¥æµæ°´çº¿å¤±è´¥ï¼"
        echo "=========================="
        echo "è¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š"
        echo "1. ä»£ç è´¨é‡é”™è¯¯ (ruff check)"
        echo "2. æµ‹è¯•å¥—ä»¶æ‰§è¡Œ"
        echo "3. å®‰å…¨æ‰«æç»“æœ"
        echo ""
        echo "ğŸ”§ å¿«é€Ÿä¿®å¤å»ºè®®:"
        echo "make fix-code  # ä¸€é”®ä¿®å¤å¸¸è§é—®é¢˜"
        echo "make test.unit # è¿è¡Œå•å…ƒæµ‹è¯•"
        echo "ruff check src/ tests/ --fix  # è‡ªåŠ¨ä¿®å¤"