name: Production Deployment

# ç”Ÿäº§éƒ¨ç½²ä¸“ç”¨æµæ°´çº¿
# ç¡®ä¿åªæœ‰é«˜è´¨é‡çš„ä»£ç æ‰èƒ½éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ

on:
  push:
    tags:
      - 'v*'  # åªåœ¨ç‰ˆæœ¬æ ‡ç­¾æŽ¨é€æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      deploy_environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      confirm_deployment:
        description: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ'
        required: true
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ç”Ÿäº§å‰å®‰å…¨æ£€æŸ¥
  production-safety-check:
    name: ðŸ›¡ï¸ Production Safety Check
    runs-on: ubuntu-latest
    outputs:
      can_deploy: ${{ steps.safety.outputs.can_deploy }}
      error_message: ${{ steps.safety.outputs.error_message }}

    steps:
    - name: ðŸš€ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: ðŸŽ¯ Zero Errors Validation
      id: safety
      run: |
        echo "ðŸ” æ‰§è¡Œç”Ÿäº§å‰å®‰å…¨æ£€æŸ¥..."

        # 1. ä»£ç è´¨é‡æ£€æŸ¥ - ä¾èµ–Ruffé€€å‡ºç 
        ruff check --config pyproject.toml src/ tests/ --output-format=github

        # 2. åŸºç¡€è¯­æ³•æ£€æŸ¥
        if ! python3 -m py_compile src/**/*.py; then
          echo "âŒ è¯­æ³•é”™è¯¯æ£€æŸ¥å¤±è´¥ï¼Œç¦æ­¢ç”Ÿäº§éƒ¨ç½²"
          echo "can_deploy=false" >> $GITHUB_OUTPUT
          echo "error_message=è¯­æ³•é”™è¯¯æ£€æŸ¥å¤±è´¥" >> $GITHUB_OUTPUT
          exit 1
        fi

        # 3. æ ¸å¿ƒåŠŸèƒ½éªŒè¯
        if ! python3 -c "import src.core.config; print('âœ… æ ¸å¿ƒé…ç½®æ¨¡å—æ­£å¸¸')"; then
          echo "âŒ æ ¸å¿ƒåŠŸèƒ½éªŒè¯å¤±è´¥ï¼Œç¦æ­¢ç”Ÿäº§éƒ¨ç½²"
          echo "can_deploy=false" >> $GITHUB_OUTPUT
          echo "error_message=æ ¸å¿ƒåŠŸèƒ½éªŒè¯å¤±è´¥" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "âœ… æ‰€æœ‰å®‰å…¨æ£€æŸ¥é€šè¿‡"
        echo "can_deploy=true" >> $GITHUB_OUTPUT
        echo "error_message=" >> $GITHUB_OUTPUT

    - name: ðŸ” Security Assessment
      if: steps.safety.outputs.can_deploy == 'true'
      run: |
        echo "ðŸ”’ æ‰§è¡Œç”Ÿäº§å®‰å…¨è¯„ä¼°..."

        # å®‰å…¨æ‰«æ - è­¦å‘Šä½†ä¸é˜»æ­¢éƒ¨ç½²
        if bandit -r src/ -f json -o bandit-production.json; then
          echo "âœ… å®‰å…¨æ‰«æé€šè¿‡"
        else
          echo "âš ï¸ å‘çŽ°å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥ bandit-production.json"
        fi

        # ä¾èµ–å®‰å…¨å®¡è®¡
        if pip-audit --format=json --output=pip-audit-production.json; then
          echo "âœ… ä¾èµ–å®‰å…¨å®¡è®¡é€šè¿‡"
        else
          echo "âš ï¸ å‘çŽ°ä¾èµ–å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥ pip-audit-production.json"
        fi

  # æž„å»ºç”Ÿäº§é•œåƒ
  build-production-image:
    name: ðŸ—ï¸ Build Production Image
    runs-on: ubuntu-latest
    needs: production-safety-check
    if: needs.production-safety-check.outputs.can_deploy == 'true'

    steps:
    - name: ðŸš€ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ” Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: ðŸ·ï¸ Extract Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: footballprediction/production
        tags: |
          type=ref,event=tag
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ðŸ—ï¸ Build and Push Production Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: ðŸ“‹ Image Information
      run: |
        echo "ðŸ·ï¸ æž„å»ºçš„é•œåƒæ ‡ç­¾:"
        echo ${{ steps.meta.outputs.tags }}
        echo ""
        echo "ðŸ“Š é•œåƒå¤§å°ä¿¡æ¯:"
        docker images footballprediction/production

  # ç”Ÿäº§éƒ¨ç½²
  deploy-to-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [production-safety-check, build-production-image]
    if: needs.production-safety-check.outputs.can_deploy == 'true' && github.event_name == 'push'
    environment: production

    steps:
    - name: ðŸš€ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Configure Environment
      run: |
        echo "ðŸ”§ é…ç½®ç”Ÿäº§çŽ¯å¢ƒå˜é‡..."

        # æ£€æŸ¥å¿…è¦çš„çŽ¯å¢ƒå˜é‡
        if [ -z "${{ secrets.PRODUCTION_DB_HOST }}" ]; then
          echo "âŒ ç¼ºå°‘ç”Ÿäº§æ•°æ®åº“é…ç½®"
          exit 1
        fi

        if [ -z "${{ secrets.PRODUCTION_REDIS_HOST }}" ]; then
          echo "âŒ ç¼ºå°‘ç”Ÿäº§Redisé…ç½®"
          exit 1
        fi

        echo "âœ… ç”Ÿäº§çŽ¯å¢ƒé…ç½®æ£€æŸ¥é€šè¿‡"

    - name: ðŸš€ Deploy Application
      run: |
        echo "ðŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ..."

        # åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒé…ç½®æ–‡ä»¶
        cat > .env.production << EOF
        # ç”Ÿäº§çŽ¯å¢ƒé…ç½®
        NODE_ENV=production
        DEBUG=false

        # æ•°æ®åº“é…ç½®
        DATABASE_HOST=${{ secrets.PRODUCTION_DB_HOST }}
        DATABASE_PORT=${{ secrets.PRODUCTION_DB_PORT }}
        DATABASE_NAME=${{ secrets.PRODUCTION_DB_NAME }}
        DATABASE_USER=${{ secrets.PRODUCTION_DB_USER }}
        DATABASE_PASSWORD=${{ secrets.PRODUCTION_DB_PASSWORD }}

        # Redisé…ç½®
        REDIS_HOST=${{ secrets.PRODUCTION_REDIS_HOST }}
        REDIS_PORT=${{ secrets.PRODUCTION_REDIS_PORT }}
        REDIS_PASSWORD=${{ secrets.PRODUCTION_REDIS_PASSWORD }}

        # APIé…ç½®
        API_HOST=0.0.0.0
        API_PORT=8000

        # å®‰å…¨é…ç½®
        SECRET_KEY=${{ secrets.PRODUCTION_SECRET_KEY }}
        JWT_SECRET_KEY=${{ secrets.PRODUCTION_JWT_SECRET }}

        # ç›‘æŽ§é…ç½®
        SENTRY_DSN=${{ secrets.PRODUCTION_SENTRY_DSN }}
        LOG_LEVEL=INFO
        EOF

        echo "âœ… ç”Ÿäº§çŽ¯å¢ƒé…ç½®å®Œæˆ"

    - name: ðŸ§ª Post-Deploy Verification
      run: |
        echo "ðŸ§ª æ‰§è¡Œéƒ¨ç½²åŽéªŒè¯..."

        # å¥åº·æ£€æŸ¥
        echo "1. æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
        sleep 30  # ç­‰å¾…åº”ç”¨å¯åŠ¨

        # æ£€æŸ¥å…³é”®ç«¯ç‚¹
        echo "2. éªŒè¯APIç«¯ç‚¹..."

        # æ£€æŸ¥æ•°æ®åº“è¿žæŽ¥
        echo "3. éªŒè¯æ•°æ®åº“è¿žæŽ¥..."

        # æ£€æŸ¥ç¼“å­˜è¿žæŽ¥
        echo "4. éªŒè¯ç¼“å­˜è¿žæŽ¥..."

        echo "âœ… éƒ¨ç½²åŽéªŒè¯å®Œæˆ"

    - name: ðŸ“Š Deployment Report
      run: |
        echo "ðŸ“Š ç”Ÿäº§éƒ¨ç½²æŠ¥å‘Š"
        echo "=================="
        echo "âœ… éƒ¨ç½²æ—¶é—´: $(date)"
        echo "âœ… éƒ¨ç½²ç‰ˆæœ¬: ${{ github.ref_name }}"
        echo "âœ… æäº¤SHA: ${{ github.sha }}"
        echo "âœ… éƒ¨ç½²çŽ¯å¢ƒ: production"
        echo "âœ… é›¶é”™è¯¯çŠ¶æ€: å·²éªŒè¯"
        echo ""
        echo "ðŸ† FootballPredictionå·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒï¼"

  # éƒ¨ç½²åŽé€šçŸ¥
  deployment-notification:
    name: ðŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [production-safety-check, deploy-to-production]
    if: always()

    steps:
    - name: ðŸ“¢ Success Notification
      if: needs.deploy-to-production.result == 'success'
      run: |
        echo "ðŸŽ‰ ç”Ÿäº§éƒ¨ç½²æˆåŠŸé€šçŸ¥"
        echo "=================="
        echo "âœ… é¡¹ç›®: FootballPrediction"
        echo "âœ… ç‰ˆæœ¬: ${{ github.ref_name }}"
        echo "âœ… çŽ¯å¢ƒ: Production"
        echo "âœ… æ—¶é—´: $(date)"
        echo "âœ… çŠ¶æ€: éƒ¨ç½²æˆåŠŸ"
        echo ""
        echo "ðŸ”— è®¿é—®åœ°å€: https://api.footballprediction.com"
        echo "ðŸ“š APIæ–‡æ¡£: https://api.footballprediction.com/docs"

    - name: âš ï¸ Failure Notification
      if: needs.production-safety-check.result == 'failure' || needs.deploy-to-production.result == 'failure'
      run: |
        echo "âš ï¸ ç”Ÿäº§éƒ¨ç½²å¤±è´¥é€šçŸ¥"
        echo "=================="
        echo "âŒ é¡¹ç›®: FootballPrediction"
        echo "âŒ ç‰ˆæœ¬: ${{ github.ref_name }}"
        echo "âŒ æ—¶é—´: $(date)"
        echo "âŒ çŠ¶æ€: éƒ¨ç½²å¤±è´¥"

        if [ "${{ needs.production-safety-check.result }}" == "failure" ]; then
          echo "âŒ å¤±è´¥åŽŸå› : ${{ needs.production-safety-check.outputs.error_message }}"
        fi

        echo ""
        echo "ðŸ”§ è¯·ç«‹å³æ£€æŸ¥éƒ¨ç½²çŠ¶æ€å¹¶å¤„ç†é—®é¢˜"

  # æ¸…ç†æ—§é•œåƒï¼ˆå¯é€‰ï¼‰
  cleanup-old-images:
    name: ðŸ§¹ Cleanup Old Images
    runs-on: ubuntu-latest
    needs: deploy-to-production
    if: success()

    steps:
    - name: ðŸ§¹ Cleanup Docker Images
      run: |
        echo "ðŸ§¹ æ¸…ç†æ—§çš„Dockeré•œåƒ..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘
        echo "âœ… æ¸…ç†å®Œæˆ"
