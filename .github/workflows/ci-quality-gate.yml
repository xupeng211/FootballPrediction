name: CIè´¨é‡é—¨ç¦

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # é¢„æ£€æŸ¥é˜¶æ®µ
  pre-checks:
    name: é¢„æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      should-proceed: ${{ steps.decision.outputs.should-proceed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.6

      - name: Quick syntax check
        id: syntax
        run: |
          echo "å¿«é€Ÿè¯­æ³•æ£€æŸ¥..."
          python -m py_compile src/main.py || echo "syntax_error=true" >> $GITHUB_OUTPUT

      - name: Decision
        id: decision
        run: |
          if [ "${{ steps.syntax.outputs.syntax_error }}" == "true" ]; then
            echo "should-proceed=false" >> $GITHUB_OUTPUT
            echo "âŒ é¢„æ£€æŸ¥å¤±è´¥ï¼šè¯­æ³•é”™è¯¯"
            exit 1
          else
            echo "should-proceed=true" >> $GITHUB_OUTPUT
            echo "âœ… é¢„æ£€æŸ¥é€šè¿‡"
          fi

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-proceed == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.6

      - name: Setup Python
        uses: actions/setup-python@v4.7.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements.lock
          pip install ruff mypy bandit safety

      - name: Run Ruff linting
        run: |
          echo "ðŸ” Running Ruff checks..."
          ruff check src/ --output-format=json > ruff-report.json
          ruff format src/ --check

      - name: Run MyPy type checking
        run: |
          echo "ðŸ” Running MyPy type checking..."
          mypy src/ --show-error-codes > mypy-report.json || true

      - name: Run Security scan
        run: |
          echo "ðŸ”’ Running security scan..."
          bandit -r src/ -f json -o bandit-report.json || true
          safety check --json --output safety-report.json || true

      - name: Code quality summary
        run: |
          echo "## ä»£ç è´¨é‡æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Ruff results
          if [ -f ruff-report.json ]; then
            echo "### Ruffæ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            python -c "
import json
with open('ruff-report.json') as f:
    data = json.load(f)
print(f'- æ€»é—®é¢˜æ•°: {len(data)}')
for item in data[:5]:
    print(f'- {item[\"location\"][\"file\"]}:{item[\"location\"][\"row\"]} - {item[\"message\"]}')
" >> $GITHUB_STEP_SUMMARY
          fi

          # MyPy results
          if [ -f mypy-report.json ]; then
            echo "### MyPyç±»åž‹æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            error_count=$(grep -c "error:" mypy-report.json || echo "0")
            echo f'- ç±»åž‹é”™è¯¯æ•°: {error_count}' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload quality reports
        uses: actions/upload-artifact@v3
        with:
          name: quality-reports
          path: |
            ruff-report.json
            mypy-report.json
            bandit-report.json
            safety-report.json

  # æµ‹è¯•é˜¶æ®µ
  testing:
    name: æµ‹è¯•æ‰§è¡Œ
    runs-on: ubuntu-latest
    needs: pre-checks
    if: needs.pre-checks.outputs.should-proceed == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.6

      - name: Setup Python
        uses: actions/setup-python@v4.7.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements.lock
          pip install pytest pytest-cov pytest-mock

      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          python -m pytest tests/unit/ -v --tb=short --junit-xml=test-results.xml || true

      - name: Run integration tests
        run: |
          echo "ðŸ§ª Running integration tests..."
          python -m pytest tests/integration/ -v --tb=short || true

      - name: Coverage report
        run: |
          echo "ðŸ“Š Generating coverage report..."
          python -m pytest tests/ --cov=src/ --cov-report=json --cov-report=html --cov-report=xml || true

      - name: Test summary
        run: |
          echo "## æµ‹è¯•æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results.xml ]; then
            echo "### æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
            python -c "
import xml.etree.ElementTree as ET
tree = ET.parse('test-results.xml')
tests = tree.findall('.//testcase')
passed = len([t for t in tests if t.get('status') != 'failed'])
failed = len([t for t in tests if t.get('status') == 'failed'])
print(f'- æ€»æµ‹è¯•æ•°: {len(tests)}')
print(f'- é€šè¿‡: {passed}')
print(f'- å¤±è´¥: {failed}')
print(f'- æˆåŠŸçŽ‡: {passed/len(tests)*100:.1f}%')
" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f coverage.json ]; then
            echo "### è¦†ç›–çŽ‡" >> $GITHUB_STEP_SUMMARY
            python -c "
import json
with open('coverage.json') as f:
    data = json.load(f)
print(f'- æ€»è¦†ç›–çŽ‡: {data.get(\"totals\", {}).get(\"percent_covered\", 0):.1f}%')
print(f'- è¦†ç›–æ–‡ä»¶æ•°: {data.get(\"totals\", {}).get(\"num_files\", 0)}')
" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test reports
        uses: actions/upload-artifact@v3
        with:
          name: test-reports
          path: |
            test-results.xml
            coverage.json
            htmlcov/

  # æž„å»ºé˜¶æ®µ
  build:
    name: æž„å»ºéªŒè¯
    runs-on: ubuntu-latest
    needs: [code-quality, testing]
    if: always() && (needs.code-quality.result == 'success' || needs.code-quality.result == 'skipped') && (needs.testing.result == 'success' || needs.testing.result == 'skipped')

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.6

      - name: Setup Python
        uses: actions/setup-python@v4.7.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements.lock

      - name: Build application
        run: |
          echo "ðŸ—ï¸ Building application..."
          python -c "import src.main; print('âœ… Application imports successfully')"

      - name: Package check
        run: |
          echo "ðŸ“¦ Checking packaging..."
          pip check

      - name: Build summary
        run: |
          echo "## æž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… åº”ç”¨æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ä¾èµ–æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY

  # æœ€ç»ˆçŠ¶æ€
  quality-gate:
    name: è´¨é‡é—¨ç¦
    runs-on: ubuntu-latest
    needs: [code-quality, testing, build]
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.6

      - name: Evaluate quality gate
        run: |
          echo "## è´¨é‡é—¨ç¦è¯„ä¼°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è¯„ä¼°å„é˜¶æ®µç»“æžœ
          code_quality="${{ needs.code-quality.result }}"
          testing="${{ needs.testing.result }}"
          build="${{ needs.build.result }}"

          echo "### é˜¶æ®µç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- ä»£ç è´¨é‡: $code_quality" >> $GITHUB_STEP_SUMMARY
          echo "- æµ‹è¯•æ‰§è¡Œ: $testing" >> $GITHUB_STEP_SUMMARY
          echo "- æž„å»ºéªŒè¯: $build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # å†³å®šæœ€ç»ˆç»“æžœ
          if [[ "$code_quality" == "success" && ("$testing" == "success" || "$testing" == "skipped") && ("$build" == "success" || "$build" == "skipped") ]]; then
            echo "### âœ… è´¨é‡é—¨ç¦é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œä»£ç å¯ä»¥åˆå¹¶ï¼" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ è´¨é‡é—¨ç¦å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš« è¯·ä¿®å¤å¤±è´¥çš„é—®é¢˜åŽé‡æ–°æäº¤ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi