# ============================================================================
# ğŸš€ å…±äº«CI/CDé…ç½®æ ‡å‡†
# ============================================================================
# ç»Ÿä¸€çš„é¡¹ç›®CI/CDé…ç½®ï¼Œå‡å°‘é‡å¤ï¼Œæé«˜ä¸€è‡´æ€§
# ç‰ˆæœ¬: v1.0 | æœ€åæ›´æ–°: 2025-10-26

# ç¯å¢ƒå˜é‡é…ç½®
env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'  # æ–‡æ¡£æ„å»ºéœ€è¦
  PIP_CACHE_DIR: '~/.cache/pip'
  MYPY_CACHE_DIR: '.mypy_cache'
  COVERAGE_CACHE_DIR: '.coverage_data'
  POETRY_CACHE_DIR: '~/.cache/pypoetry'

# ç¼“å­˜é…ç½®æ¨¡æ¿
cache_config: &cache_config
  pip:
    key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.lock', '**/pyproject.toml') }}
    paths:
      - ~/.cache/pip
      - ~/.cache/pypoetry
      - ~/Library/Caches/pip  # macOS

  mypy:
    key: ${{ runner.os }}-mypy-${{ hashFiles('**/mypy_*.ini', '**/pyproject.toml', '**/src/**') }}
    paths:
      - .mypy_cache
      - ~/.cache/mypy

  coverage:
    key: ${{ runner.os }}-coverage-${{ hashFiles('**/src/**', '**/tests/**') }}
    paths:
      - .coverage_data

  node:
    key: ${{ runner.os }}-node-${{ hashFiles('**/package.json', '**/package-lock.json') }}
    paths:
      - ~/.npm
      - ~/.cache/npm

# è¶…æ—¶é…ç½®ï¼ˆåˆ†é’Ÿï¼‰
timeouts: &timeouts
  quality: 15
  test-unit: 20
  test-integration: 25
  test-e2e: 40
  build: 30
  deploy: 45
  docs: 35
  security: 20

# Pythonç¯å¢ƒé…ç½®æ¨¡æ¿
python_setup: &python_setup
  uses: actions/setup-python@v4
  with:
    python-version: ${{ env.PYTHON_VERSION }}
    cache: 'pip'
    cache-dependency-path: |
      requirements/requirements.lock
      pyproject.toml

# Node.jsç¯å¢ƒé…ç½®æ¨¡æ¿
node_setup: &node_setup
  uses: actions/setup-node@v4
  with:
    node-version: ${{ env.NODE_VERSION }}
    cache: 'npm'

# ä¾èµ–å®‰è£…æ¨¡æ¿
install_deps: &install_deps
  name: ğŸ“¦ å®‰è£…ä¾èµ–
  run: |
    echo "ğŸ å®‰è£…Pythonä¾èµ–..."
    if [ -f "requirements/requirements.lock" ]; then
      pip install --upgrade pip
      pip install -r requirements/requirements.lock
    elif [ -f "requirements.txt" ]; then
      pip install --upgrade pip
      pip install -r requirements.txt
    else
      pip install --upgrade pip
      pip install -e .
    fi

    # å®‰è£…å¼€å‘å·¥å…·
    pip install ruff mypy bandit pip-audit pytest pytest-cov pytest-xdist

    echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# å®‰å…¨æ£€æŸ¥æ¨¡æ¿
security_checks: &security_checks
  name: ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥
  run: |
    echo "ğŸ”’ å¼€å§‹å…¨é¢å®‰å…¨æ£€æŸ¥..."

    # Banditå®‰å…¨æ‰«æ
    echo "ğŸ” è¿è¡ŒBanditä»£ç å®‰å…¨æ‰«æ..."
    bandit -r src/ -f json -o bandit-report.json
    BANDIT_EXIT_CODE=$?

    if [ $BANDIT_EXIT_CODE -ne 0 ]; then
      echo "âš ï¸ Banditå‘ç°å®‰å…¨é—®é¢˜"
      HIGH_SEVERITY=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json 2>/dev/null || echo "0")
      MEDIUM_SEVERITY=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-report.json 2>/dev/null || echo "0")

      echo "ğŸ“Š å®‰å…¨é—®é¢˜ç»Ÿè®¡:"
      echo "  - é«˜å±: $HIGH_SEVERITY ä¸ª"
      echo "  - ä¸­å±: $MEDIUM_SEVERITY ä¸ª"

      if [ "$HIGH_SEVERITY" -gt 0 ]; then
        echo "âŒ å‘ç°é«˜å±å®‰å…¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥bandit-report.json"
        exit 1
      fi
    fi

    # ä¾èµ–å®‰å…¨å®¡è®¡
    echo "ğŸ” è¿è¡Œä¾èµ–å®‰å…¨å®¡è®¡..."
    pip-audit --format=json --output=audit-report.json
    AUDIT_EXIT_CODE=$?

    if [ $AUDIT_EXIT_CODE -ne 0 ]; then
      echo "âš ï¸ å‘ç°ä¾èµ–å®‰å…¨é—®é¢˜"
      VULNERABLE=$(jq '[.vulnerabilities[]] | length' audit-report.json 2>/dev/null || echo "0")
      if [ "$VULNERABLE" -gt 0 ]; then
        echo "âŒ å‘ç°$VULNERABLEä¸ªæ¼æ´ä¾èµ–ï¼Œè¯·æ›´æ–°ä¾èµ–"
        jq -r '.vulnerabilities[] | "  - \(.name): \(.vulnerabilities[0].advisory) (ä¸¥é‡æ€§: \(.vulnerabilities[0].severity)"' audit-report.json
        exit 1
      fi
    fi

    echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"

# è´¨é‡æ£€æŸ¥æ¨¡æ¿
quality_checks: &quality_checks
  name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
  run: |
    echo "ğŸ” å¼€å§‹ä»£ç è´¨é‡æ£€æŸ¥..."

    # è¯­æ³•æ£€æŸ¥
    echo "ğŸ”§ Pythonè¯­æ³•æ£€æŸ¥..."
    python -m py_compile src/**/*.py
    echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"

    # Ruffä»£ç æ£€æŸ¥
    echo "ğŸ“‹ Ruffä»£ç é£æ ¼æ£€æŸ¥..."
    ruff check src/ --output-format=github
    RUFF_EXIT_CODE=$?

    if [ $RUFF_EXIT_CODE -ne 0 ]; then
      echo "âŒ Ruffæ£€æŸ¥å‘ç°é—®é¢˜"
      exit 1
    fi

    # Ruffæ ¼å¼æ£€æŸ¥
    echo "ğŸ“ Ruffæ ¼å¼æ£€æŸ¥..."
    ruff format src/ --check
    FORMAT_EXIT_CODE=$?

    if [ $FORMAT_EXIT_CODE -ne 0 ]; then
      echo "âŒ ä»£ç æ ¼å¼é—®é¢˜ï¼Œè¯·è¿è¡Œ: ruff format src/"
      exit 1
    fi

    echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"

# æµ‹è¯•é…ç½®æ¨¡æ¿
test_config: &test_config
  env:
    PYTEST_ADDOPTS: "--tb=short --strict-markers --strict-config"
    PYTHONPATH: ${{ github.workspace }}

# è¦†ç›–ç‡é…ç½®
coverage_config: &coverage_config
  current_threshold: 13.89
  target_threshold: 80
  fail_behavior: "warn"  # warn, fail, ignore