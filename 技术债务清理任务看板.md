# 🚀 技术债务清理任务看板

> **创建时间**：2025-10-10
> **核心理念**：先让 CI 绿灯亮起，再逐步提高标准！
> **当前状态**：测试系统瘫痪，MyPy 错误 2762+ 个

## 📊 总体进度

```
████████████████████████████████████████████████████
Phase 1: 紧急修复  ████████████████░░░░░░░░░░░░░░  50%
Phase 2: 系统重建  ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  0%
Phase 3: 质量提升  ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  0%
```

## 📌 当前指标快照（每日更新）

| 指标 | 当前值* | 获取命令 | 最新更新 |
| --- | --- | --- | --- |
| Ruff 违规数 | 0 | `make lint | tee reports/lint.log` | 2025-10-10 |
| MyPy 错误数 | 3166 | `make lint 2>&1 | rg "error:" | wc -l` | 2025-10-10 |
| 可运行单测数 | 0（缺少 fastapi 依赖） | `pytest tests/unit -k "core" --maxfail=1` | 2025-10-10 |
| 覆盖率 | 13%（`make coverage` 低于阈值） | `make coverage && coverage report` | 2025-10-10 |
| TODO 计数 | 38 | `rg --files-with-matches "TODO" src | wc -l` | 2025-10-10 |
| CI 失败阶段 | lint→mypy（覆盖率阶段亦失败） | 查看最新 Pipelines | 2025-10-10 |

> *所有“当前值”需在每日例会上更新到真实数据，并附上执行人姓名。本次更新人：Codex Agent（2025-10-10）。

## 🎯 Phase 1: 紧急修复（1-2周）

### 🔴 P0 - 立即执行（阻塞 CI）

#### 任务 1.1: 修复核心导入错误
- **状态**：🚧 进行中
- **负责人**：Codex Agent（临时承担 Platform 职责）
- **前置依赖**：完成 `make context`，确认代码分支冻结
- **预计工时**：8-12 小时（按 30 个文件估算，执行后滚动修正）
- **文件数量**：~30 个核心文件
- **具体任务**：
  - [x] 修复 `src/tasks/backup/executor/backup_executor.py` 的导入问题（已通过 `scripts/fix_imports.py`、`python -m py_compile` 与 `ruff check` 验证）
  - [ ] 添加缺失的 `typing` 导入（Optional, List, Dict, Tuple）
  - [ ] 添加缺失的标准库导入（logging, os, subprocess, datetime）
  - [ ] 验证修复后文件可以正常编译
- **验证标准**：`python -m py_compile` 无错误，`make lint` 中不再出现对应导入错误
- **命令**：
  ```bash
  # 验证单个文件
  python -m py_compile src/tasks/backup/executor/backup_executor.py

  # 批量验证
  find src/tasks/backup -name "*.py" -exec python -m py_compile {} \;
  ```

#### 任务 1.2: 实现缺失的核心模块桩
- **状态**：⏳ 待开始
- **负责人**：待分配（建议：Domain 小组）
- **前置依赖**：完成任务 1.1 中的导入修复，以免桩文件增加新的 lint 错误
- **预计工时**：6-10 小时
- **具体任务**：
  - [ ] 创建 `src/security/key_manager.py` 桩实现
  - [ ] 创建 `src/realtime/websocket.py` 桩实现
  - [ ] 创建 `src/models/prediction_model.py` 桩实现
  - [ ] 创建 `src/ml/model_training.py` 桩实现
- **验证标准**：新增模块通过 `python -m py_compile`、`make lint`，并在集成点拥有最小化单测或快照测试
- **桩实现模板**：
  ```python
  # 示例：key_manager.py
  """密钥管理模块 - 桩实现"""
  class KeyManager:
      def get_key(self, key_name: str) -> str:
          return "dummy_key"

      def set_key(self, key_name: str, value: str) -> None:
          pass
 ```
#### 任务 1.3: 修复关键测试文件
- **状态**：⏳ 待开始
- **负责人**：待分配（建议：QA 小组）
- **前置依赖**：任务 1.2 完成必要桩；数据库/缓存配置在 `.env` 中可用
- **预计工时**：10-15 小时
- **目标**：让 20 个核心测试能够运行
- **优先列表**：
  1. `tests/unit/test_config.py` - 配置测试
  2. `tests/unit/test_health.py` - 健康检查
  3. `tests/unit/test_base_service.py` - 基础服务
  4. `tests/unit/test_database_connection.py` - 数据库连接
  5. `tests/unit/test_cache_service.py` - 缓存服务
- **修复步骤**：
  ```bash
  # 逐个修复并验证
  pytest tests/unit/test_config.py -v
  pytest tests/unit/test_health.py -v
  ```
- **验收工具**：`pytest --maxfail=1 --failed-first`、`coverage report --include=src/core/*`

### 🟡 P1 - 本周内完成

#### 任务 1.4: 批量修复 MyPy 错误
- **状态**：⏳ 待开始
- **负责人**：待分配（建议：Platform + Domain 联合）
- **前置依赖**：任务 1.1 导入修复完成 80% 以上
- **预计工时**：20-30 小时，按批次复盘实际耗时
- **当前错误**：2762 个
- **策略**：
  1. 使用自动化脚本批量修复常见错误
  2. 手动修复复杂类型问题
  3. 分批次处理（每次 50-100 个错误）
- **验收工具**：`mypy --hide-error-context --no-error-summary src`，并将趋势记录在 `reports/mypy_trend.csv`
- **自动化脚本**：
  ```python
  # scripts/fix_mypy_errors.py
  import re
  import os

  def fix_common_imports(file_path):
      """批量修复常见导入问题"""
      patterns = {
          r'\bOptional\b': 'from typing import Optional',
          r'\bList\b': 'from typing import List',
          r'\bDict\b': 'from typing import Dict',
          r'\bTuple\b': 'from typing import Tuple',
      }
      # 实现自动修复逻辑
  ```

#### 任务 1.5: 清理重复的基础服务类
- **状态**：⏳ 待开始
- **负责人**：待分配（建议：Services 小组）
- **前置依赖**：确认任务 1.3 中相关测试均可运行
- **预计工时**：4-6 小时
- **任务**：
  - [ ] 更新所有使用 `base.py` 和 `base_service.py` 的导入
  - [ ] 删除废弃的文件
  - [ ] 验证所有服务正常工作
- **影响文件**：约 7 个文件
- **验收工具**：`pytest tests/unit/test_base_service.py -v`、`make lint`

## 🎯 Phase 2: 系统重建（2-3周）

### 🟠 P2 - 重要但不紧急

#### 任务 2.1: 重构测试架构
- **状态**：⏳ 待开始
- **负责人**：待分配（建议：QA 小组）
- **前置依赖**：Phase 1 成功标准全部达成
- **预计工时**：30-40 小时
- **子任务**：
  - [ ] 分析 419 个测试文件，分类保留/删除/重写
  - [ ] 清理 `_legacy` 和 `archived` 测试
  - [ ] 建立清晰的测试目录结构
  - [ ] 编写测试指南文档

#### 任务 2.2: 提升测试覆盖率
- **状态**：⏳ 待开始
- **负责人**：待分配
- **目标**：从当前覆盖率提升到 15-20%
- **策略**：
  1. 为核心模块编写单元测试
  2. 使用测试工厂模式
  3. 集成测试覆盖率报告
- **验收工具**：`coverage report --skip-empty`，并将趋势同步到 `htmlcov/index.html`

#### 任务 2.3: 优化项目结构
- **状态**：⏳ 待开始
- **负责人**：待分配
- **前置依赖**：任务 2.1 的目录结构结论已产出
- **任务**：
  - [ ] 模块解耦和重构
  - [ ] 清理未使用的导入
  - [ ] 统一代码风格
- **验收工具**：`make fmt && make lint`、架构评审 checklist

## 🎯 Phase 3: 质量提升（1-2周）

### 🟢 P3 - 优化项

#### 任务 3.1: 清理 TODO 标记
- **负责人**：待分配
- **前置依赖**：Phase 2 完成
- **文件数（初始）**：50 个（通过 `rg --files-with-matches "TODO" src` 统计）
- **策略**：
  - 解决：实现标记的功能
  - 延期：移至 Issue 跟踪
  - 删除：不再需要的标记

#### 任务 3.2: 文档更新
- **负责人**：待分配（建议：Docs 小组）
- **前置依赖**：覆盖率与质量指标稳定
- 交付物：新的覆盖率截图、CLAUDE.md 更新、`docs/architecture.md`

#### 任务 3.3: CI/CD 优化
- [ ] 调整覆盖率阈值至合理水平（15% → 20% → 30%）
- [ ] 优化 CI 执行时间
- [ ] 添加更多质量检查
- **负责人**：DevOps
- **前置依赖**：Phase 3 其他任务达到稳定阈值
- **验收工具**：GitHub Actions 运行时间对比、`ci-verify.sh` 报告

## 🛠️ 快速启动指南

### 立即可执行的任务（今天）

```bash
# 1. 验证当前状态
make lint 2>&1 | rg "error:" | wc -l
pytest tests/unit/test_config.py 2>&1

# 2. 建议的修复流程模板（保存为 scripts/fix_imports.py 并纳入版本控制）
python scripts/fix_imports.py src/tasks/backup/executor/backup_executor.py

# 3. 修复后复验
python -m py_compile src/tasks/backup/executor/backup_executor.py
```

## 📈 进度跟踪

### 每日检查清单

- [ ] 今天修复了多少个 MyPy 错误？（更新 `reports/mypy_trend.csv`）
- [ ] 有多少测试现在可以运行了？（记录 `pytest --maxfail=1` 的通过数）
- [ ] CI 是否更接近通过了？（备注失败阶段与日志链接）
- [ ] 记录遇到的问题和解决方案（保存到 `docs/tech-debt-diary.md`）

### 周报模板

```markdown
## 周报 - Week X

### 完成的任务
- [x] 任务 X.X: 描述

### 遇到的问题
- 问题1: 描述和解决方案

### 下周计划
- [ ] 计划完成的任务

### 数据统计
- MyPy 错误: XXXX → YYYY (减少 ZZ 个)
- 可运行测试: XX → YY
- 测试覆盖率: XX% → YY%
```

## 🎯 成功标准

### Phase 1 完成标准
- [ ] 至少 20 个核心测试可以运行（`pytest tests/unit -k "core" --maxfail=1` 全部通过）
- [ ] MyPy 错误减少到 500 以下（`make lint` 输出计数）
- [ ] CI 能够运行到测试阶段（GitHub Actions 全绿至 `pytest` 步骤）
- [ ] 核心模块导入错误全部解决（`python -m py_compile` 覆盖受影响模块）

### Phase 2 完成标准
- [ ] 测试覆盖率达到 ≥15%（`coverage report`）
- [ ] 测试架构清晰合理（架构评审纪要记录于 `docs/testing-review.md`）
- [ ] 代码质量评分提升到 ≥7.0/10（SonarQube 或等效工具截图）

### Phase 3 完成标准
- [ ] 测试覆盖率达到 ≥25%
- [ ] 所有 TODO 标记已处理或转化为 Issue（更新 TODO 计数表）
- [ ] CI 稳定运行，质量门槛合理（`make ci` 连续三次通过）

## 💡 提示和技巧

1. **小步快跑**：每次只修改 1-2 个文件，立即验证
2. **保持 CI 绿灯**：宁可少改，不要让 CI 失败
3. **记录进度**：使用 git commit 详细记录每个修复
4. **寻求帮助**：遇到困难时，查看相关文档或寻求协助

## 📞 联系和支持

- **文档**：查看 `docs/` 目录下的详细文档
- **脚本**：使用 `scripts/` 目录下的自动化脚本
- **历史记录**：查看 git log 了解之前的修复思路

---

**最后更新**：2025-10-10
**版本**：1.0
**下一步**：开始执行任务 1.1
