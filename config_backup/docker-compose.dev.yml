# 本地开发环境 Docker Compose 配置
# 使用新的统一 Dockerfile 和 development 阶段
# 用途：日常开发和测试

version: '3.8'

services:
  # ================== PostgreSQL 数据库 ==================
  postgres-dev:
    image: postgres:15-alpine
    container_name: football-prediction-db-dev
    environment:
      POSTGRES_DB: football_prediction_dev
      POSTGRES_USER: dev_user
      POSTGRES_PASSWORD: dev_password
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"  # 使用标准端口
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    networks:
      - dev-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ================== Redis 缓存服务 ==================
  redis-dev:
    image: redis:7-alpine
    container_name: football-prediction-redis-dev
    ports:
      - "6379:6379"  # 使用标准端口
    volumes:
      - redis_dev_data:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes
    networks:
      - dev-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  # ================== 开发应用容器 ==================
  app-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development  # 使用新的 development 阶段
    container_name: football-prediction-app-dev
    environment:
      # 数据库连接配置
      DATABASE_URL: postgresql://dev_user:dev_password@postgres-dev:5432/football_prediction_dev
      DATABASE_HOST: postgres-dev
      DATABASE_PORT: 5432
      DATABASE_NAME: football_prediction_dev
      DATABASE_USER: dev_user
      DATABASE_PASSWORD: dev_password

      # Redis连接配置
      REDIS_URL: redis://redis-dev:6379/0
      REDIS_HOST: redis-dev
      REDIS_PORT: 6379
      REDIS_DB: 0

      # 环境标识
      ENVIRONMENT: development
      ENV: dev
      DEBUG: true
      LOG_LEVEL: DEBUG
      TESTING: false

      # 应用配置
      SECRET_KEY: dev-secret-key-for-local-development-only
      API_V1_PREFIX: /api/v1
      PYTHONPATH: /app

      # 开发便利配置
      AUTO_RELOAD: true
      SHOW_SQL: true
      ENABLE_PROFILING: true

    ports:
      - "8000:8000"  # 主应用端口
      - "8001:8001"  # 调试和指标端口
    volumes:
      # 代码挂载（支持热重载）
      - ./src:/app/src
      - ./tests:/app/tests
      - ./requirements:/app/requirements
      - ./config:/app/config
      # 开发工具配置
      - ./.venv:/app/.venv
      # 日志挂载
      - ./logs:/app/logs
      # 数据文件挂载
      - ./data:/app/data
    depends_on:
      postgres-dev:
        condition: service_healthy
      redis-dev:
        condition: service_healthy
    networks:
      - dev-network
    restart: unless-stopped
    # 使用开发阶段默认命令（uvicorn with reload）
    # 健康检查使用开发环境配置
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/v1/health/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ================== 开发工具服务 (可选) ==================

  # 数据库管理界面
  db-admin:
    image: dpage/pgadmin4:latest
    container_name: football-prediction-db-admin-dev
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@dev.local
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_dev_data:/var/lib/pgadmin
    depends_on:
      postgres-dev:
        condition: service_healthy
    networks:
      - dev-network
    restart: unless-stopped
    profiles:
      - admin  # 使用 --profile admin 启动

  # Redis 管理界面
  redis-admin:
    image: rediscommander/redis-commander:latest
    container_name: football-prediction-redis-admin-dev
    environment:
      REDIS_HOSTS: local:redis-dev:6379
      HTTP_USER: admin
      HTTP_PASSWORD: admin123
    ports:
      - "8081:8081"
    depends_on:
      redis-dev:
        condition: service_healthy
    networks:
      - dev-network
    restart: unless-stopped
    profiles:
      - admin  # 使用 --profile admin 启动

  # 文档服务
  docs:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: football-prediction-docs
    environment:
      - ENVIRONMENT=development
      - PYTHONPATH=/app
    ports:
      - "8080:8000"
    volumes:
      - ./docs:/app/docs
      - ./src:/app/src
      - ./README.md:/app/README.md
    working_dir: /app
    command: >
      sh -c "pip install mkdocs mkdocs-material &&
             mkdocs serve --dev-addr=0.0.0.0:8000"
    networks:
      - dev-network
    restart: unless-stopped
    profiles:
      - docs  # 使用 --profile docs 启动

  # 测试运行器
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
      target: test
    container_name: football-prediction-test-runner
    environment:
      - ENVIRONMENT=test
      - DATABASE_URL=postgresql://dev_user:dev_password@postgres-dev:5432/football_prediction_dev
      - REDIS_URL=redis://redis-dev:6379/1
      - TESTING=true
      - PYTHONPATH=/app
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
      - ./logs:/app/logs
      - pytest_cache:/app/.pytest_cache
    depends_on:
      postgres-dev:
        condition: service_healthy
      redis-dev:
        condition: service_healthy
    networks:
      - dev-network
    # 不自动启动，用于手动执行测试
    command: ["echo", "Test runner ready. Use 'docker-compose exec test-runner make test.smart' to run tests."]
    profiles:
      - test  # 使用 --profile test 启动

# ================== 数据卷定义 ==================
volumes:
  postgres_dev_data:
    driver: local
  redis_dev_data:
    driver: local
  pgadmin_dev_data:
    driver: local
  pytest_cache:
    driver: local

# ================== 网络配置 ==================
networks:
  dev-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/16