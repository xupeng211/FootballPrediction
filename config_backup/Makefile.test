# ğŸ§ª æµ‹è¯•åˆ†å±‚ä¸æ ‡å‡†åŒ– Makefile
# Test Stratification and Standardization Makefile
# V31.0 - å·¥ç¨‹æ•ˆèƒ½ä¸“å®¶å‡ºå“

.PHONY: help test test-fast test-unit test-all test-integration test-performance test-coverage lint lint-fix clean check

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# é¢œè‰²å®šä¹‰
GREEN := \033[32m
YELLOW := \033[33m
BLUE := \033[34m
RED := \033[31m
PURPLE := \033[35m
CYAN := \033[36m
RESET := \033[0m

help: ## ğŸ“‹ æ˜¾ç¤ºæµ‹è¯•ç›¸å…³å‘½ä»¤
	@echo "$(CYAN)ğŸ§ª æµ‹è¯•åˆ†å±‚ä¸æ ‡å‡†åŒ–å‘½ä»¤$(RESET)"
	@echo "$(YELLOW)å¿«é€Ÿæµ‹è¯• (å¼€å‘é˜¶æ®µ):$(RESET)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## .*å¿«é€Ÿ/ {printf "  $(GREEN)%-15s$(RESET) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo "$(YELLOW)å®Œæ•´æµ‹è¯• (éªŒè¯é˜¶æ®µ):$(RESET)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## .*å®Œæ•´/ {printf "  $(GREEN)%-15s$(RESET) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo "$(YELLOW)ä»£ç è´¨é‡ (æŒç»­é˜¶æ®µ):$(RESET)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## .*è´¨é‡/ {printf "  $(GREEN)%-15s$(RESET) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo "$(YELLOW)å·¥å…·å‘½ä»¤ (ç»´æŠ¤é˜¶æ®µ):$(RESET)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## .*å·¥å…·/ {printf "  $(GREEN)%-15s$(RESET) %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# ============================================================================
# å¿«é€Ÿæµ‹è¯• (å¼€å‘é˜¶æ®µ) - ç»¿ç¯åŒºï¼Œå¿…é¡»å…¨ç»¿
# ============================================================================

test-fast: ## å¿«é€Ÿ/è¿è¡Œå•å…ƒæµ‹è¯• (å¼€å‘æ—¥å¸¸ä½¿ç”¨)
	@echo "$(YELLOW)âš¡ è¿è¡Œå¿«é€Ÿå•å…ƒæµ‹è¯•...$(RESET)"
	pytest tests/unit/ -v --tb=short --durations=10

test-unit: ## å¿«é€Ÿ/è¿è¡Œå•å…ƒæµ‹è¯• (åˆ«å)
	@make test-fast

test-unit-quiet: ## å¿«é€Ÿ/é™é»˜è¿è¡Œå•å…ƒæµ‹è¯• (CIä½¿ç”¨)
	@echo "$(YELLOW)ğŸ¤« é™é»˜è¿è¡Œå•å…ƒæµ‹è¯•...$(RESET)"
	pytest tests/unit/ -q --tb=no

test-watch: ## å¿«é€Ÿ/ç›‘è§†æ¨¡å¼è¿è¡Œå•å…ƒæµ‹è¯•
	@echo "$(YELLOW)ğŸ‘€ ç›‘è§†æ¨¡å¼è¿è¡Œå•å…ƒæµ‹è¯•...$(RESET)"
	pytest-watch tests/unit/ -v --tb=short

# ============================================================================
# å®Œæ•´æµ‹è¯• (éªŒè¯é˜¶æ®µ) - å…è®¸å­˜åœ¨æŠ€æœ¯å€º
# ============================================================================

test: ## å®Œæ•´/è¿è¡Œæ‰€æœ‰æµ‹è¯• (éªŒè¯ç”¨)
	@echo "$(YELLOW)ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶...$(RESET)"
	pytest tests/ -v --tb=short --maxfail=10

test-all: ## å®Œæ•´/è¿è¡Œæ‰€æœ‰æµ‹è¯• (åˆ«å)
	@make test

test-integration: ## å®Œæ•´/è¿è¡Œé›†æˆæµ‹è¯•
	@echo "$(YELLOW)ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•...$(RESET)"
	pytest tests/integration/ -v --tb=short --maxfail=5

test-performance: ## å®Œæ•´/è¿è¡Œæ€§èƒ½æµ‹è¯•
	@echo "$(YELLOW)ğŸš€ è¿è¡Œæ€§èƒ½æµ‹è¯•...$(RESET)"
	pytest tests/performance/ -v --tb=short --maxfail=3

test-coverage: ## å®Œæ•´/ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
	@echo "$(YELLOW)ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š...$(RESET)"
	pytest tests/ --cov=src --cov-report=html --cov-report=term-missing --cov-fail-under=70

# ============================================================================
# ä»£ç è´¨é‡ (æŒç»­é˜¶æ®µ) - ä¿æŒé›¶æŠ€æœ¯å€º
# ============================================================================

lint: ## è´¨é‡/è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
	@echo "$(YELLOW)ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥...$(RESET)"
	ruff check . --statistics

lint-fix: ## è´¨é‡/è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜
	@echo "$(YELLOW)ğŸ”§ è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜...$(RESET)"
	ruff check . --fix

format: ## è´¨é‡/æ ¼å¼åŒ–ä»£ç 
	@echo "$(YELLOW)ğŸ¨ æ ¼å¼åŒ–ä»£ç ...$(RESET)"
	ruff format .

check: ## è´¨é‡/å®Œæ•´ä»£ç è´¨é‡æ£€æŸ¥
	@echo "$(YELLOW)ğŸ›¡ï¸ å®Œæ•´ä»£ç è´¨é‡æ£€æŸ¥...$(RESET)"
	@make lint
	@make test-unit-quiet
	@echo "$(GREEN)âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡$(RESET)"

# ============================================================================
# å·¥å…·å‘½ä»¤ (ç»´æŠ¤é˜¶æ®µ)
# ============================================================================

clean: ## å·¥å…·/æ¸…ç†æµ‹è¯•ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
	@echo "$(YELLOW)ğŸ§¹ æ¸…ç†ç¼“å­˜æ–‡ä»¶...$(RESET)"
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	rm -rf .pytest_cache htmlcov .coverage coverage.xml .ruff_cache 2>/dev/null || true
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(RESET)"

clean-all: ## å·¥å…·/å½»åº•æ¸…ç†æ‰€æœ‰ç¼“å­˜æ–‡ä»¶
	@echo "$(RED)ğŸ§¹ å½»åº•æ¸…ç†...$(RESET)"
	@make clean
	rm -rf build dist *.egg-info 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@echo "$(GREEN)âœ… å½»åº•æ¸…ç†å®Œæˆ$(RESET)"

install-dev: ## å·¥å…·/å®‰è£…å¼€å‘ä¾èµ–
	@echo "$(YELLOW)ğŸ“¦ å®‰è£…å¼€å‘ä¾èµ–...$(RESET)"
	pip install -e ".[dev]"
	pip install pytest pytest-watch pytest-cov pytest-mock pytest-asyncio
	@echo "$(GREEN)âœ… å¼€å‘ç¯å¢ƒå®‰è£…å®Œæˆ$(RESET)"

# ============================================================================
# æŠ¥å‘Šå’Œåˆ†æ
# ============================================================================

test-report: ## æŠ¥å‘Š/ç”Ÿæˆè¯¦ç»†æµ‹è¯•æŠ¥å‘Š
	@echo "$(YELLOW)ğŸ“‹ ç”Ÿæˆè¯¦ç»†æµ‹è¯•æŠ¥å‘Š...$(RESET)"
	pytest tests/ --html=report.html --self-contained-html --tb=short
	@echo "$(GREEN)ğŸ“Š æŠ¥å‘Šå·²ç”Ÿæˆ: report.html$(RESET)"

test-benchmark: ## æŠ¥å‘Š/è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
	@echo "$(YELLOW)â±ï¸ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•...$(RESET)"
	pytest tests/performance/ -v --benchmark-only --benchmark-json=benchmark.json
	@echo "$(GREEN)ğŸ“Š åŸºå‡†æµ‹è¯•ç»“æœå·²ä¿å­˜$(RESET)"

# ============================================================================
# å¼€å‘å·¥ä½œæµ
# ============================================================================

dev-setup: install-dev clean ## å·¥ä½œæµ/å®Œæ•´å¼€å‘ç¯å¢ƒè®¾ç½®
	@echo "$(GREEN)ğŸš€ å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ$(RESET)"

pre-commit: ## å·¥ä½œæµ/æäº¤å‰æ£€æŸ¥ (git hook)
	@echo "$(YELLOW)ğŸ”’ æäº¤å‰æ£€æŸ¥...$(RESET)"
	@make lint
	@make test-unit-quiet
	@echo "$(GREEN)âœ… æäº¤å‰æ£€æŸ¥é€šè¿‡$(RESET)"

ci-check: ## å·¥ä½œæµ/CIç¯å¢ƒæ£€æŸ¥
	@echo "$(YELLOW)ğŸ¤– CIç¯å¢ƒæ£€æŸ¥...$(RESET)"
	@make clean
	@make lint
	@make test-unit-quiet
	@echo "$(GREEN)âœ… CIæ£€æŸ¥é€šè¿‡$(RESET)"

# ============================================================================
# ç‰¹æ®Šå‘½ä»¤
# ============================================================================

test-unstable: ## å®Œæ•´/è¿è¡Œä¸ç¨³å®šæµ‹è¯• (æŠ€æœ¯å€ºåˆ†æ)
	@echo "$(YELLOW)âš ï¸ è¿è¡Œä¸ç¨³å®šæµ‹è¯•...$(RESET)"
	pytest tests/ -m "unstable" -v --tb=short

test-tech-debt: ## å®Œæ•´/è¿è¡ŒæŠ€æœ¯å€ºåŠ¡æµ‹è¯•
	@echo "$(YELLOW)ğŸ—ï¸ è¿è¡ŒæŠ€æœ¯å€ºåŠ¡æµ‹è¯•...$(RESET)"
	pytest tests/ -m "tech_debt" -v --tb=short

dry-run: ## å·¥å…·/æµ‹è¯•æ”¶é›†ä½†ä¸æ‰§è¡Œ (æ£€æŸ¥é…ç½®)
	@echo "$(YELLOW)ğŸ” æµ‹è¯•æ”¶é›†æ£€æŸ¥...$(RESET)"
	pytest tests/ --collect-only

# ============================================================================
# è¯´æ˜ä¿¡æ¯
# ============================================================================

info: ## å·¥å…·/æ˜¾ç¤ºæµ‹è¯•é…ç½®ä¿¡æ¯
	@echo "$(CYAN)ğŸ“‹ æµ‹è¯•é…ç½®ä¿¡æ¯$(RESET)"
	@echo "$(BLUE)Pythonç‰ˆæœ¬:$(RESET) $(shell python --version)"
	@echo "$(BLUE)pytestç‰ˆæœ¬:$(RESET) $(shell pytest --version)"
	@echo "$(BLUE)ruffç‰ˆæœ¬:$(RESET) $(shell ruff --version)"
	@echo "$(BLUE)æµ‹è¯•ç›®å½•ç»“æ„:$(RESET)"
	@find tests/ -type d -maxdepth 2 | sort