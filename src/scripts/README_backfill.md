# L2æ•°æ®å›å¡«è„šæœ¬ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

`backfill_l2_matches.py` æ˜¯ä¸€ä¸ªç”Ÿäº§çº§çš„L2æ•°æ®æ‰¹é‡æŠ“å–è„šæœ¬ï¼Œä¸“ä¸ºå¤„ç†å¤§é‡å†å²æ¯”èµ›æ•°æ®è€Œè®¾è®¡ã€‚å®ƒå…·å¤‡æµå¼å¤„ç†ã€å¹¶å‘æ§åˆ¶ã€é”™è¯¯æ¢å¤å’Œå®æ—¶ç›‘æ§ç­‰ä¼ä¸šçº§ç‰¹æ€§ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸš€ é«˜æ€§èƒ½
- **æµå¼å¤„ç†**: é€æ‰¹è¯»å–æ•°æ®ï¼Œé¿å…å†…å­˜æº¢å‡ºï¼Œå¯å¤„ç†TBçº§æ•°æ®
- **æ™ºèƒ½å¹¶å‘**: å¯é…ç½®çš„å¹¶å‘æ§åˆ¶ï¼Œé»˜è®¤15ä¸ªå¹¶å‘è¯·æ±‚
- **å¼‚æ­¥I/O**: å…¨å¼‚æ­¥æ¶æ„ï¼Œæœ€å¤§åŒ–ç½‘ç»œååé‡

### ğŸ›¡ï¸ å¥å£®æ€§
- **è‡ªåŠ¨é‡è¯•**: é›†æˆtenacityé‡è¯•æœºåˆ¶ï¼Œå¤„ç†ç½‘ç»œæ³¢åŠ¨
- **é”™è¯¯éš”ç¦»**: å•ä¸ªå¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹
- **ä¼˜é›…åœæœº**: Ctrl+Cå®‰å…¨åœæ­¢ï¼Œä¿å­˜å½“å‰è¿›åº¦

### ğŸ“Š å¯è§‚æµ‹æ€§
- **å®æ—¶è¿›åº¦**: tqdmè¿›åº¦æ¡æ˜¾ç¤ºå¤„ç†çŠ¶æ€å’Œé¢„è®¡å®Œæˆæ—¶é—´
- **ç»“æ„åŒ–æ—¥å¿—**: è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ï¼Œæ”¯æŒé—®é¢˜æ’æŸ¥
- **ç»Ÿè®¡ç›‘æ§**: æˆåŠŸç‡ã€å¤„ç†é€Ÿç‡ç­‰å…³é”®æŒ‡æ ‡

### ğŸ”„ æ–­ç‚¹ç»­ä¼ 
- **è¿›åº¦ä¿å­˜**: è‡ªåŠ¨ä¿å­˜å¤„ç†è¿›åº¦ï¼Œæ”¯æŒä¸­æ–­æ¢å¤
- **å¤±è´¥è®°å½•**: ç‹¬ç«‹è®°å½•å¤±è´¥çš„match_idï¼Œæ–¹ä¾¿è¡¥è·‘
- **çŠ¶æ€ç®¡ç†**: é¿å…é‡å¤å¤„ç†ç›¸åŒæ•°æ®

## å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡è¾“å…¥æ•°æ®

åˆ›å»ºCSVæ–‡ä»¶ï¼ŒåŒ…å«å¾…å¤„ç†çš„match_idåˆ—ï¼š

```csv
match_id
1234567
1234568
1234569
...
```

### 2. åŸºæœ¬ä½¿ç”¨

```bash
# ä½¿ç”¨é»˜è®¤å‚æ•°è¿è¡Œ
python src/scripts/backfill_l2_matches.py

# æŒ‡å®šè¾“å…¥æ–‡ä»¶å’Œå¹¶å‘æ•°
python src/scripts/backfill_l2_matches.py \
    --input data/my_matches.csv \
    --concurrent 20 \
    --output data/output

# åˆ›å»ºç¤ºä¾‹æ–‡ä»¶ç”¨äºæµ‹è¯•
python src/scripts/backfill_l2_matches.py --create-sample
```

### 3. å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | çŸ­å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|--------|------|
| `--input` | `-i` | `data/l2_backfill_queue.csv` | è¾“å…¥CSVæ–‡ä»¶è·¯å¾„ |
| `--output` | `-o` | `data/l2_output` | è¾“å‡ºç›®å½•è·¯å¾„ |
| `--concurrent` | `-c` | `15` | æœ€å¤§å¹¶å‘è¯·æ±‚æ•° |
| `--create-sample` | - | - | åˆ›å»ºç¤ºä¾‹è¾“å…¥æ–‡ä»¶ |

## è¾“å‡ºæ–‡ä»¶

### æˆåŠŸçš„æ•°æ®
- **ä½ç½®**: `{output_dir}/{match_id}.json`
- **æ ¼å¼**: ç»“æ„åŒ–JSONï¼ŒåŒ…å«å®Œæ•´çš„L2æ•°æ®
- **ç¤ºä¾‹**: `data/l2_output/1234567.json`

### æ—¥å¿—æ–‡ä»¶
- **ä¸»æ—¥å¿—**: `logs/backfill.log` - è¯¦ç»†çš„æ‰§è¡Œè¿‡ç¨‹
- **å¤±è´¥è®°å½•**: `logs/failed_ids.txt` - ä»…åŒ…å«å¤±è´¥çš„match_id
- **è¿›åº¦æ–‡ä»¶**: `data/l2_output/progress.txt` - å¤„ç†è¿›åº¦çŠ¶æ€

### è¿›åº¦æ–‡ä»¶æ ¼å¼
```json
{
  "processed_count": 1000,
  "successful_count": 950,
  "failed_count": 50,
  "processed_ids": ["1234567", "1234568", ...],
  "last_update": "2025-12-10T16:30:00"
}
```

## é«˜çº§é…ç½®

### è‡ªå®šä¹‰é…ç½®ç±»

```python
from src.scripts.backfill_l2_matches import BackfillManager, BackfillConfig

# åˆ›å»ºè‡ªå®šä¹‰é…ç½®
config = BackfillConfig(
    max_concurrent=20,           # é«˜å¹¶å‘
    batch_size=2000,             # å¤§æ‰¹æ¬¡
    request_timeout=60.0,        # é•¿è¶…æ—¶
    rate_limit_delay=0.05,       # å¿«é€Ÿè¯·æ±‚
    enable_progress_bar=False,  # ç¦ç”¨è¿›åº¦æ¡
    save_interval=50,            # é¢‘ç¹ä¿å­˜è¿›åº¦
)

# è¿è¡Œå›å¡«
manager = BackfillManager(config)
stats = await manager.run_backfill()
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
export L2_BACKFILL_CONCURRENT=25
export L2_BACKFILL_INPUT_FILE="data/production_matches.csv"
export L2_BACKFILL_OUTPUT_DIR="data/l2_production"
```

## ç›‘æ§å’Œç»´æŠ¤

### å®æ—¶ç›‘æ§

è„šæœ¬è¿è¡Œæ—¶ä¼šæ˜¾ç¤ºå®æ—¶è¿›åº¦ä¿¡æ¯ï¼š
```
Processing matches: 45%|â–ˆâ–ˆâ–ˆâ–ˆâ–Œ     | 4500/10000 [00:15<00:18, 300.23matches/s]
```

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/backfill.log

# ç»Ÿè®¡å¤±è´¥æ•°é‡
wc -l logs/failed_ids.txt

# åˆ†æé”™è¯¯æ¨¡å¼
grep "ERROR" logs/backfill.log | head -20
```

### æ€§èƒ½è°ƒä¼˜

æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´å¹¶å‘æ•°ï¼š
- **ä½é…æœåŠ¡å™¨**: 5-10 å¹¶å‘
- **æ ‡å‡†æœåŠ¡å™¨**: 15-20 å¹¶å‘
- **é«˜æ€§èƒ½æœåŠ¡å™¨**: 30-50 å¹¶å‘

## é”™è¯¯å¤„ç†å’Œæ•…éšœæ¢å¤

### å¸¸è§é”™è¯¯ç±»å‹

1. **ç½‘ç»œè¶…æ—¶**: è‡ªåŠ¨é‡è¯•ï¼Œå¯è°ƒæ•´timeoutå‚æ•°
2. **APIé™åˆ¶**: è‡ªåŠ¨é™ä½å¹¶å‘ï¼Œæ·»åŠ å»¶è¿Ÿ
3. **è§£æé”™è¯¯**: è®°å½•å¤±è´¥IDï¼Œå¯å•ç‹¬å¤„ç†
4. **å­˜å‚¨é”™è¯¯**: æ£€æŸ¥ç£ç›˜ç©ºé—´å’Œæƒé™

### æ–­ç‚¹æ¢å¤

```bash
# å¦‚æœè„šæœ¬ä¸­æ–­ï¼Œå¯ä»¥ç›´æ¥é‡æ–°è¿è¡Œ
# å®ƒä¼šè‡ªåŠ¨ä»progress.txtè¯»å–è¿›åº¦
python src/scripts/backfill_l2_matches.py

# ä»…é‡æ–°å¤„ç†å¤±è´¥çš„ID
cat logs/failed_ids.txt | head -100 > failed_retry.csv
python src/scripts/backfill_l2_matches.py --input failed_retry.csv
```

## æœ€ä½³å®è·µ

### 1. ç”Ÿäº§ç¯å¢ƒå»ºè®®
- ä½¿ç”¨åˆç†çš„å¹¶å‘æ•°ï¼ˆ15-25ï¼‰
- è®¾ç½®é€‚å½“çš„è¯·æ±‚å»¶è¿Ÿ
- ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
- å®šæœŸå¤‡ä»½è¾“å‡ºæ•°æ®

### 2. å¤§æ•°æ®å¤„ç†
- åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹10ä¸‡æ¡è®°å½•
- ä½¿ç”¨SSDå­˜å‚¨æé«˜I/Oæ€§èƒ½
- è€ƒè™‘åˆ†å¸ƒå¼å¤„ç†å¤šä¸ªæ–‡ä»¶

### 3. é”™è¯¯ç®¡ç†
- å®šæœŸæ£€æŸ¥failed_ids.txt
- åˆ†æå¤±è´¥æ¨¡å¼å¹¶ä¼˜åŒ–
- è®¾ç½®å‘Šè­¦æœºåˆ¶

## æ•…éšœæ’é™¤

### é—®é¢˜: å†…å­˜ä½¿ç”¨è¿‡é«˜
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥batch_sizeè®¾ç½®ï¼Œç¡®ä¿ä½¿ç”¨æµå¼å¤„ç†

### é—®é¢˜: å¤§é‡å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**:
1. é™ä½å¹¶å‘æ•°
2. å¢åŠ è¯·æ±‚å»¶è¿Ÿ
3. æ£€æŸ¥ç½‘ç»œè¿æ¥
4. éªŒè¯APIè®¤è¯

### é—®é¢˜: è¿›åº¦ä¸æ›´æ–°
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥è¾“å‡ºç›®å½•æƒé™å’Œç£ç›˜ç©ºé—´

## æ‰©å±•å¼€å‘

### è‡ªå®šä¹‰æ•°æ®å¤„ç†å™¨

```python
class CustomBackfillManager(BackfillManager):
    async def _save_match_data(self, match_id: str, match_data: L2MatchData):
        # è‡ªå®šä¹‰å­˜å‚¨é€»è¾‘
        await super()._save_match_data(match_id, match_data)

        # é¢å¤–å¤„ç†ï¼Œå¦‚å­˜å…¥æ•°æ®åº“
        await self._save_to_database(match_data)
```

### é›†æˆç›‘æ§

```python
import prometheus_client

class MetricsBackfillManager(BackfillManager):
    def __init__(self, config):
        super().__init__(config)
        self.success_counter = prometheus_client.Counter('l2_backfill_success')
        self.failure_counter = prometheus_client.Counter('l2_backfill_failure')
```

---

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ—¥å¿—æ–‡ä»¶ `logs/backfill.log`
2. å¤±è´¥è®°å½• `logs/failed_ids.txt`
3. è¿›åº¦æ–‡ä»¶ `data/l2_output/progress.txt`

æ”¯æŒè”ç³»æ–¹å¼ï¼šå¼€å‘å›¢é˜Ÿ | é¡¹ç›®æ–‡æ¡£ | Issuesé¡µé¢