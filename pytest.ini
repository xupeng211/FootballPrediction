[pytest]
# pytest配置文件 - 测试分层与标准化
# Architecture Governance: Test Stratification and Standardization

# 默认测试目录
testpaths = tests

# 最小版本要求
minversion = 6.0

# 默认命令行参数
addopts =
    -v
    --tb=short
    --strict-markers
    --disable-warnings
    --color=yes
    --durations=10

# 定义测试标记
markers =
    # 测试层级标记
    unit: 单元测试 - 快速、隔离、无外部依赖
    integration: 集成测试 - 需要数据库、Redis或外部API
    performance: 性能测试 - 负载、压力、基准测试
    e2e: 端到端测试 - 完整业务流程
    api: API测试 - HTTP接口测试
    database: 数据库测试 - 需要数据库连接
    ml: 机器学习测试 - 需要模型加载
    slow: 慢速测试 - 执行时间较长

    # 特殊标记
    skip_ci: 跳过CI环境的测试
    skip_local: 跳过本地环境的测试
    unstable: 不稳定测试 - 可能间歇性失败
    tech_debt: 技术债务 - 已知问题，待修复

# 排除目录
norecursedirs =
    .git
    .tox
    dist
    build
    *.egg
    .venv
    venv
    env
    __pycache__
    .pytest_cache
    htmlcov
    .coverage
    coverage.xml
    node_modules
    .mypy_cache
    .ruff_cache

# 文件匹配模式
python_files = test_*.py *_test.py
python_classes = Test*
python_functions = test_*

# 超时设置
timeout = 300
timeout_method = signal

# 异步测试支持
asyncio_mode = auto

# 覆盖率配置
[coverage:run]
source = src
omit =
    */tests/*
    */test_*
    */__pycache__/*
    */migrations/*
    */venv/*
    */.venv/*

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    if self.debug:
    if settings.DEBUG
    raise AssertionError
    raise NotImplementedError
    if 0:
    if __name__ == .__main__.:
    class .*\bProtocol\):
    @(abc\.)?abstractmethod

[coverage:html]
directory = htmlcov