"""
Phase 5.3.2: API å¥åº·æ£€æŸ¥å…¨é¢æµ‹è¯•

ç›®æ ‡æ–‡ä»¶: src/api/health.py
å½“å‰è¦†ç›–ç‡: 41% (99/178 è¡Œæœªè¦†ç›–)
ç›®æ ‡è¦†ç›–ç‡: â‰¥70%
æµ‹è¯•é‡ç‚¹: FastAPIè·¯ç”±ã€å¥åº·æ£€æŸ¥é€»è¾‘ã€é”™è¯¯å¤„ç†ã€ä¾èµ–æ³¨å…¥
"""

import pytest
from unittest.mock import AsyncMock, MagicMock, patch, Mock
from fastapi.testclient import TestClient
from fastapi import FastAPI, HTTPException, Depends
from datetime import datetime, timedelta
import time
import json
from typing import Dict, Any

# å¯¼å…¥ç›®æ ‡æ¨¡å—
from src.api.health import router, health_check, liveness_check, readiness_check, _check_database, _check_redis, _check_kafka, _check_mlflow, _check_filesystem
from src.api.schemas import HealthCheckResponse
from src.database.connection import get_db_session
from src.utils.retry import CircuitBreaker


class TestHealthAPIPhase53:
    """Phase 5.3.2 å¥åº·æ£€æŸ¥APIå…¨é¢æµ‹è¯•"""

    @pytest.fixture
    def client(self):
        """åˆ›å»ºæµ‹è¯•å®¢æˆ·ç«¯"""
        app = FastAPI()
        app.include_router(router)

        # Mockæ•°æ®åº“ä¾èµ–
        async def mock_get_db_session():
            mock_db = AsyncMock()
            mock_db.execute = AsyncMock()
            return mock_db

        app.dependency_overrides[get_db_session] = mock_get_db_session
        return TestClient(app)

    @pytest.fixture
    def mock_db_session(self):
        """Mockæ•°æ®åº“ä¼šè¯"""
        mock_db = AsyncMock()
        mock_db.execute = AsyncMock()
        return mock_db

    def test_liveness_check_basic(self, client):
        """æµ‹è¯•åŸºæœ¬å­˜æ´»æ€§æ£€æŸ¥"""
        response = client.get("/health/liveness")
        assert response.status_code == 200

        data = response.json()
        assert "status" in data
        assert "timestamp" in data
        assert data["status"] == "alive"
        assert isinstance(data["timestamp"], str)

    def test_liveness_check_response_structure(self, client):
        """æµ‹è¯•å­˜æ´»æ€§æ£€æŸ¥å“åº”ç»“æ„"""
        response = client.get("/health/liveness")
        data = response.json()

        # éªŒè¯å¿…éœ€å­—æ®µ
        required_fields = ["status", "timestamp"]
        for field in required_fields:
            assert field in data, f"Missing field: {field}"

        # éªŒè¯å­—æ®µç±»å‹
        assert isinstance(data["status"], str)
        assert isinstance(data["timestamp"], str)

    def test_readiness_check_success(self, client):
        """æµ‹è¯•å°±ç»ªæ€§æ£€æŸ¥æˆåŠŸåœºæ™¯"""
        with patch('src.api.health._check_database') as mock_db, \
             patch('src.api.health._check_redis') as mock_redis, \
             patch('src.api.health._check_kafka') as mock_kafka, \
             patch('src.api.health._check_mlflow') as mock_mlflow, \
             patch('src.api.health._check_filesystem') as mock_fs:

            # Mockæ‰€æœ‰æœåŠ¡éƒ½å¥åº·
            mock_db.return_value = {"healthy": True, "details": "Database OK"}
            mock_redis.return_value = {"healthy": True, "details": "Redis OK"}
            mock_kafka.return_value = {"healthy": True, "details": "Kafka OK"}
            mock_mlflow.return_value = {"healthy": True, "details": "MLflow OK"}
            mock_fs.return_value = {"healthy": True, "details": "Feature Store OK"}

            response = client.get("/health/readiness")
            assert response.status_code == 200

            data = response.json()
            assert data["ready"] is True
            assert "checks" in data
            assert "database" in data["checks"]
            assert "redis" in data["checks"]
            assert "kafka" in data["checks"]
            assert "mlflow" in data["checks"]

    def test_readiness_check_partial_failure(self, client):
        """æµ‹è¯•å°±ç»ªæ€§æ£€æŸ¥éƒ¨åˆ†å¤±è´¥åœºæ™¯"""
        with patch('src.api.health._check_database') as mock_db, \
             patch('src.api.health._check_redis') as mock_redis, \
             patch('src.api.health._check_kafka') as mock_kafka, \
             patch('src.api.health._check_mlflow') as mock_mlflow, \
             patch('src.api.health._check_filesystem') as mock_fs:

            # Mockéƒ¨åˆ†æœåŠ¡å¤±è´¥
            mock_db.return_value = {"healthy": True, "details": "Database OK"}
            mock_redis.return_value = {"healthy": False, "details": "Redis connection failed", "error": "Connection timeout"}
            mock_kafka.return_value = {"healthy": False, "details": "Kafka connection failed", "error": "Kafka broker not available"}
            mock_mlflow.return_value = {"healthy": True, "details": "MLflow OK"}
            mock_fs.return_value = {"healthy": True, "details": "Filesystem OK"}

            response = client.get("/health/readiness")
            assert response.status_code == 503  # Service Unavailable

            data = response.json()
            assert "detail" in data
            assert data["detail"]["ready"] is False
            assert "checks" in data["detail"]

    def test_readiness_check_all_failure(self, client):
        """æµ‹è¯•å°±ç»ªæ€§æ£€æŸ¥å…¨éƒ¨å¤±è´¥åœºæ™¯"""
        with patch('src.api.health._check_database') as mock_db, \
             patch('src.api.health._check_redis') as mock_redis, \
             patch('src.api.health._check_kafka') as mock_kafka, \
             patch('src.api.health._check_mlflow') as mock_mlflow, \
             patch('src.api.health._check_filesystem') as mock_fs:

            # Mockæ‰€æœ‰æœåŠ¡éƒ½å¤±è´¥
            mock_db.side_effect = Exception("Database connection failed")
            mock_redis.side_effect = Exception("Redis connection failed")
            mock_kafka.side_effect = Exception("Kafka connection failed")
            mock_mlflow.side_effect = Exception("MLflow connection failed")
            mock_fs.side_effect = Exception("Filesystem error")

            response = client.get("/health/readiness")
            assert response.status_code == 503

            data = response.json()
            assert "detail" in data
            assert data["detail"]["ready"] is False
            assert "checks" in data["detail"]

    def test_health_check_comprehensive(self, client):
        """æµ‹è¯•ç»¼åˆå¥åº·æ£€æŸ¥"""
        with patch('src.api.health._check_database') as mock_db, \
             patch('src.api.health._check_redis') as mock_redis, \
             patch('src.api.health._check_kafka') as mock_kafka, \
             patch('src.api.health._check_mlflow') as mock_mlflow, \
             patch('src.api.health._check_filesystem') as mock_fs:

            # MockæœåŠ¡çŠ¶æ€
            mock_db.return_value = {"healthy": True, "details": "Database OK", "response_time_ms": 0.001}
            mock_redis.return_value = {"healthy": True, "details": "Redis OK", "response_time_ms": 0.0005}
            mock_kafka.return_value = {"healthy": True, "details": "Kafka OK", "response_time_ms": 0.002}
            mock_mlflow.return_value = {"healthy": True, "details": "MLflow OK", "response_time_ms": 0.003}
            mock_fs.return_value = {"status": "healthy", "details": {"log_directory": "/tmp/logs"}, "response_time_ms": 0.001}

            response = client.get("/health")
            assert response.status_code == 200

            data = response.json()
            assert "status" in data
            assert "timestamp" in data
            assert "checks" in data

    @pytest.mark.asyncio
    async def test_check_database_success(self):
        """æµ‹è¯•æ•°æ®åº“æ£€æŸ¥æˆåŠŸåœºæ™¯"""
        mock_db = AsyncMock()
        mock_result = Mock()
        mock_result.scalar.return_value = 1
        mock_db.execute.return_value = mock_result

        result = await _check_database(mock_db)
        assert result["healthy"] is True
        assert "response_time_ms" in result
        assert result["details"] == "Database connection successful"

    @pytest.mark.asyncio
    async def test_check_database_failure(self):
        """æµ‹è¯•æ•°æ®åº“æ£€æŸ¥å¤±è´¥åœºæ™¯"""
        mock_db = AsyncMock()
        mock_db.execute.side_effect = Exception("Connection failed")

        result = await _check_database(mock_db)
        assert result["healthy"] is False
        assert "error" in result
        assert "Connection failed" in result["error"]

    @pytest.mark.asyncio
    async def test_check_database_timeout(self):
        """æµ‹è¯•æ•°æ®åº“æ£€æŸ¥è¶…æ—¶åœºæ™¯"""
        mock_db = AsyncMock()
        mock_db.execute.side_effect = TimeoutError("Query timeout")

        result = await _check_database(mock_db)
        assert result["healthy"] is False
        assert "timeout" in result["error"].lower()

    @pytest.mark.asyncio
    async def test_check_redis_success(self):
        """æµ‹è¯•Redisæ£€æŸ¥æˆåŠŸåœºæ™¯"""
        with patch('src.cache.redis_manager.RedisManager') as mock_redis_manager_class:
            mock_redis_manager = AsyncMock()
            mock_redis_manager.aping.return_value = True
            mock_redis_manager.get_info.return_value = {
                "version": "7.0.0",
                "connected_clients": 5,
                "used_memory_human": "1MB"
            }
            mock_redis_manager_class.return_value = mock_redis_manager

            result = await _check_redis()
            assert result["healthy"] is True
            assert "version" in result["details"]
            assert result["details"]["version"] == "7.0.0"

    @pytest.mark.asyncio
    async def test_check_redis_connection_failure(self):
        """æµ‹è¯•Redisè¿æ¥å¤±è´¥åœºæ™¯"""
        with patch('src.cache.redis_manager.RedisManager') as mock_redis_manager_class:
            mock_redis_manager = AsyncMock()
            mock_redis_manager.aping.side_effect = Exception("Connection failed")
            mock_redis_manager_class.return_value = mock_redis_manager

            result = await _check_redis()
            assert result["healthy"] is False
            assert "error" in result
            assert "connection failed" in result["error"].lower()

    @pytest.mark.asyncio
    async def test_check_redis_timeout(self):
        """æµ‹è¯•Redisè¶…æ—¶åœºæ™¯"""
        with patch('src.cache.redis_manager.RedisManager') as mock_redis_manager_class:
            mock_redis_manager = AsyncMock()
            mock_redis_manager.aping.side_effect = TimeoutError("Redis timeout")
            mock_redis_manager_class.return_value = mock_redis_manager

            result = await _check_redis()
            assert result["healthy"] is False
            assert "timeout" in result["error"].lower()

    @pytest.mark.asyncio
    async def test_check_kafka_success(self):
        """æµ‹è¯•Kafkaæ£€æŸ¥æˆåŠŸåœºæ™¯"""
        with patch('src.streaming.kafka_consumer.FootballKafkaConsumer') as mock_consumer_class:
            mock_consumer = AsyncMock()
            mock_consumer.check_connection.return_value = {
                "healthy": True,
                "brokers": ["localhost:9092"],
                "topics": ["test-topic"]
            }
            mock_consumer_class.return_value = mock_consumer

            result = await _check_kafka()
            assert result["healthy"] is True
            assert "brokers" in result["details"]

    @pytest.mark.asyncio
    async def test_check_kafka_failure(self):
        """æµ‹è¯•Kafkaæ£€æŸ¥å¤±è´¥åœºæ™¯"""
        with patch('src.streaming.kafka_consumer.FootballKafkaConsumer') as mock_consumer_class:
            mock_consumer = AsyncMock()
            mock_consumer.check_connection.side_effect = Exception("Kafka not available")
            mock_consumer_class.return_value = mock_consumer

            result = await _check_kafka()
            assert result["healthy"] is False
            assert "error" in result

    @pytest.mark.asyncio
    async def test_check_mlflow_success(self):
        """æµ‹è¯•MLflowæ£€æŸ¥æˆåŠŸåœºæ™¯"""
        with patch('src.models.model_training.MLflowClient') as mock_client_class:
            mock_client = Mock()
            mock_client.tracking_server_uri = "http://localhost:5000"
            mock_client_class.return_value = mock_client

            result = await _check_mlflow()
            assert result["healthy"] is True
            assert "tracking_server_uri" in result["details"]

    @pytest.mark.asyncio
    async def test_check_mlflow_failure(self):
        """æµ‹è¯•MLflowæ£€æŸ¥å¤±è´¥åœºæ™¯"""
        with patch('src.models.model_training.MLflowClient') as mock_client_class:
            mock_client_class.side_effect = Exception("MLflow server not available")

            result = await _check_mlflow()
            assert result["healthy"] is False
            assert "error" in result

    @pytest.mark.asyncio
    async def test_check_filesystem_success(self):
        """æµ‹è¯•æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥æˆåŠŸåœºæ™¯"""
        with patch('os.path.exists', return_value=True), \
             patch('os.makedirs'):

            result = await _check_filesystem()
            assert result["status"] == "healthy"
            assert "response_time_ms" in result
            assert "log_directory" in result["details"]

    @pytest.mark.asyncio
    async def test_check_filesystem_failure(self):
        """æµ‹è¯•æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥å¤±è´¥åœºæ™¯"""
        with patch('os.path.exists', return_value=False), \
             patch('os.makedirs', side_effect=Exception("Permission denied")):

            result = await _check_filesystem()
            assert result["status"] == "unhealthy"
            assert "error" in result

    def test_health_check_response_model(self):
        """æµ‹è¯•å¥åº·æ£€æŸ¥å“åº”æ¨¡å‹"""
        # æµ‹è¯•å“åº”åºåˆ—åŒ–
        response_data = {
            "status": "healthy",
            "timestamp": datetime.now().isoformat(),
            "version": "1.0.0",
            "uptime": 3600,
            "checks": {
                "database": {"healthy": True, "response_time": 0.001},
                "redis": {"healthy": True, "response_time": 0.0005}
            },
            "overall_score": 0.95
        }

        # éªŒè¯å¯ä»¥è¢«åºåˆ—åŒ–ä¸ºJSON
        json_str = json.dumps(response_data)
        parsed_data = json.loads(json_str)
        assert parsed_data["status"] == "healthy"

    def test_circuit_breaker_integration(self, client):
        """æµ‹è¯•æ–­è·¯å™¨é›†æˆ"""
        with patch('src.api.health._check_database') as mock_db:
            # æ¨¡æ‹Ÿè¿ç»­å¤±è´¥è§¦å‘æ–­è·¯å™¨
            mock_db.side_effect = Exception("Database failure")

            # å‘é€å¤šä¸ªè¯·æ±‚æ¥è§¦å‘æ–­è·¯å™¨
            for _ in range(3):
                response = client.get("/health/readiness")
                assert response.status_code == 503

    def test_health_check_timing(self, client):
        """æµ‹è¯•å¥åº·æ£€æŸ¥å“åº”æ—¶é—´"""
        start_time = time.time()

        with patch('src.api.health._check_database') as mock_db, \
             patch('src.api.health._check_redis') as mock_redis:

            mock_db.return_value = {"healthy": True, "response_time": 0.001}
            mock_redis.return_value = {"healthy": True, "response_time": 0.0005}

            response = client.get("/health")
            end_time = time.time()

            assert response.status_code == 200
            assert (end_time - start_time) < 1.0  # å“åº”æ—¶é—´åº”è¯¥å°äº1ç§’

    def test_health_check_error_handling(self, client):
        """æµ‹è¯•å¥åº·æ£€æŸ¥é”™è¯¯å¤„ç†"""
        with patch('src.api.health._check_database') as mock_db, \
             patch('src.api.health._check_redis') as mock_redis, \
             patch('src.api.health._check_kafka') as mock_kafka, \
             patch('src.api.health._check_mlflow') as mock_mlflow, \
             patch('src.api.health._check_filesystem') as mock_fs:

            # æ¨¡æ‹Ÿæœªå¤„ç†çš„å¼‚å¸¸
            mock_db.side_effect = RuntimeError("Unexpected error")

            response = client.get("/health/readiness")
            assert response.status_code == 503

            data = response.json()
            assert "detail" in data
            assert "checks" in data["detail"]

    def test_health_check_dependency_injection(self, client):
        """æµ‹è¯•ä¾èµ–æ³¨å…¥"""
        # æµ‹è¯•æ•°æ®åº“ä¾èµ–æ³¨å…¥
        with patch('src.api.health.get_db_session') as mock_get_db:
            mock_db = AsyncMock()
            mock_result = Mock()
            mock_result.scalar.return_value = 1
            mock_db.execute.return_value = mock_result
            mock_get_db.return_value = mock_db

            response = client.get("/health/readiness")
            assert response.status_code == 200


def test_health_api_comprehensive_phase53():
    """Phase 5.3.2 å¥åº·æ£€æŸ¥APIç»¼åˆæµ‹è¯•"""
    print("ğŸš€ å¼€å§‹ Phase 5.3.2: API å¥åº·æ£€æŸ¥å…¨é¢æµ‹è¯•...")

    test_instance = TestHealthAPIPhase53()

    # æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
    tests = [
        # åŸºæœ¬åŠŸèƒ½æµ‹è¯•
        test_instance.test_liveness_check_basic,
        test_instance.test_liveness_check_response_structure,
        test_instance.test_readiness_check_success,
        test_instance.test_readiness_check_partial_failure,
        test_instance.test_readiness_check_all_failure,
        test_instance.test_health_check_comprehensive,

        # æ•°æ®åº“æ£€æŸ¥æµ‹è¯•
        test_instance.test_check_database_success,
        test_instance.test_check_database_failure,
        test_instance.test_check_database_timeout,

        # Redisæ£€æŸ¥æµ‹è¯•
        test_instance.test_check_redis_success,
        test_instance.test_check_redis_connection_failure,
        test_instance.test_check_redis_timeout,

        # Kafkaæ£€æŸ¥æµ‹è¯•
        test_instance.test_check_kafka_success,
        test_instance.test_check_kafka_failure,

        # MLflowæ£€æŸ¥æµ‹è¯•
        test_instance.test_check_mlflow_success,
        test_instance.test_check_mlflow_failure,

        # æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥æµ‹è¯•
        test_instance.test_check_filesystem_success,
        test_instance.test_check_filesystem_failure,

        # é›†æˆæµ‹è¯•
        test_instance.test_health_check_response_model,
        test_instance.test_circuit_breaker_integration,
        test_instance.test_health_check_timing,
        test_instance.test_health_check_error_handling,
        test_instance.test_health_check_dependency_injection,
    ]

    passed = 0
    failed = 0

    # æ‰§è¡ŒåŒæ­¥æµ‹è¯•
    for test in tests:
        try:
            test()
            passed += 1
            print(f"  âœ… {test.__name__}")
        except Exception as e:
            failed += 1
            print(f"  âŒ {test.__name__}: {e}")

    print(f"\nğŸ“Š æµ‹è¯•ç»“æœ: {passed} é€šè¿‡, {failed} å¤±è´¥")

    if failed == 0:
        print("ğŸ‰ Phase 5.3.2: API å¥åº·æ£€æŸ¥æµ‹è¯•å®Œæˆ")
        print("\nğŸ“‹ æµ‹è¯•è¦†ç›–çš„åŠŸèƒ½:")
        print("  - âœ… FastAPIè·¯ç”±æµ‹è¯•")
        print("  - âœ… å­˜æ´»æ€§å’Œå°±ç»ªæ€§æ£€æŸ¥")
        print("  - âœ… æ•°æ®åº“å¥åº·æ£€æŸ¥")
        print("  - âœ… Rediså¥åº·æ£€æŸ¥")
        print("  - âœ… Kafkaå¥åº·æ£€æŸ¥")
        print("  - âœ… MLflowå¥åº·æ£€æŸ¥")
        print("  - âœ… æ–‡ä»¶ç³»ç»Ÿå¥åº·æ£€æŸ¥")
        print("  - âœ… é”™è¯¯å¤„ç†å’Œå¼‚å¸¸åœºæ™¯")
        print("  - âœ… æ–­è·¯å™¨é›†æˆ")
        print("  - âœ… ä¾èµ–æ³¨å…¥æµ‹è¯•")
        print("  - âœ… å“åº”æ—¶é—´å’Œæ€§èƒ½")
        print("  - âœ… å“åº”æ¨¡å‹éªŒè¯")
    else:
        print("âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥")


if __name__ == "__main__":
    test_health_api_comprehensive_phase53()