# ğŸ¯ P2.2: APIæ¨¡å—æµ‹è¯•è¦†ç›–è¡ŒåŠ¨è®¡åˆ’

**ä»»åŠ¡ç¼–å·**: P2.2 (å¯¹åº”GitHub Issue #1055)
**æ‰§è¡Œæ—¥æœŸ**: 2025-11-12 (é˜¶æ®µ2 Day 2)
**æ ¸å¿ƒç›®æ ‡**: APIæ¨¡å—æµ‹è¯•è¦†ç›–ç‡æå‡åˆ°35%ä»¥ä¸Š
**ç®¡ç†æ–¹å¼**: å¢å¼ºå‹æ··åˆç®¡ç† (ç»†ç²’åº¦æˆ˜æœ¯æ‰§è¡Œ)

---

## ğŸ“Š **APIæ¨¡å—ç°çŠ¶åˆ†æ**

### **è§„æ¨¡ä¸å¤æ‚åº¦**
- **æ–‡ä»¶æ€»æ•°**: 80ä¸ªPythonæ–‡ä»¶
- **ä»£ç è§„æ¨¡**: ~17,000è¡Œä»£ç 
- **æµ‹è¯•ç°çŠ¶**: 530ä¸ªæµ‹è¯•æ”¶é›†
- **å½“å‰çŠ¶æ€**: 300ä¸ªé€šè¿‡ï¼Œ179ä¸ªå¤±è´¥ï¼Œ45ä¸ªé”™è¯¯

### **å…³é”®å‘ç°**
- âœ… **æµ‹è¯•åŸºç¡€å­˜åœ¨**: å·²æœ‰530ä¸ªæµ‹è¯•æ¡†æ¶
- âš ï¸ **å¤§é‡å¤±è´¥**: 179ä¸ªå¤±è´¥æµ‹è¯•éœ€è¦ä¿®å¤
- âŒ **å¯¼å…¥é—®é¢˜**: éƒ¨åˆ†APIç«¯ç‚¹å­˜åœ¨å¯¼å…¥é˜»å¡
- ğŸ¯ **è¦†ç›–ç‡ä¸è¶³**: å½“å‰è¿œä½äº35%ç›®æ ‡

---

## ğŸ¯ **ä¼˜å…ˆç›®æ ‡åˆ†æ (Priority Targets)**

### **Priority 1: é¢„æµ‹APIæ ¸å¿ƒç«¯ç‚¹** â­â­â­â­â­
**æ¨¡å—**: `src/api/predictions/`
**é‡è¦æ€§**: æœ€æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
**P2.1ä¾èµ–**: ç›´æ¥ä¾èµ–Domainå±‚äº‹ä»¶å’Œç­–ç•¥ç³»ç»Ÿ
**å…³é”®æ–‡ä»¶**:
- `router.py` - ä¸»è¦é¢„æµ‹ç«¯ç‚¹ (POST /predictions, GET /predictions/{id})
- `models.py` - é¢„æµ‹æ•°æ®æ¨¡å‹ (PredictionRequest, PredictionResult)
- `optimized_router.py` - ä¼˜åŒ–ç‰ˆè·¯ç”±å™¨
- `health.py` - é¢„æµ‹æœåŠ¡å¥åº·æ£€æŸ¥

**æµ‹è¯•é‡ç‚¹**:
- é¢„æµ‹åˆ›å»ºå’ŒæŸ¥è¯¢åŠŸèƒ½
- æ‰¹é‡é¢„æµ‹å¤„ç†
- é¢„æµ‹ç»“æœéªŒè¯
- é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶

### **Priority 2: è®¤è¯ä¸ç”¨æˆ·ç®¡ç†API** â­â­â­â­â­
**æ¨¡å—**: `src/api/auth/`
**é‡è¦æ€§**: å®‰å…¨å…³é”®æ¨¡å—
**P2.1ä¾èµ–**: ä¾èµ–Domainå±‚ç”¨æˆ·ç›¸å…³äº‹ä»¶
**å…³é”®æ–‡ä»¶**:
- `__init__.py` - è®¤è¯æ¨¡å‹ (UserRegister, UserLogin, TokenResponse)
- `router.py` - è®¤è¯ç«¯ç‚¹ (æ³¨å†Œã€ç™»å½•ã€JWTéªŒè¯)

**æµ‹è¯•é‡ç‚¹**:
- ç”¨æˆ·æ³¨å†Œæµç¨‹éªŒè¯
- JWTä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯
- æƒé™æ§åˆ¶å’Œè®¿é—®éªŒè¯
- å®‰å…¨é”™è¯¯å¤„ç†

### **Priority 3: å¥åº·æ£€æŸ¥å’Œç›‘æ§API** â­â­â­â­
**æ¨¡å—**: `src/api/` (æ ¹çº§åˆ«)
**é‡è¦æ€§**: è¿ç»´åŸºç¡€ï¼Œç³»ç»Ÿç›‘æ§
**P2.1ä¾èµ–**: ä¾èµ–Domainå±‚å¥åº·æ£€æŸ¥äº‹ä»¶
**å…³é”®æ–‡ä»¶**:
- `health.py` - ç³»ç»Ÿå¥åº·æ£€æŸ¥
- `docs.py` - APIæ–‡æ¡£æ¥å£

**æµ‹è¯•é‡ç‚¹**:
- ç³»ç»ŸçŠ¶æ€ç›‘æ§
- æ•°æ®åº“è¿æ¥æ£€æŸ¥
- å¤–éƒ¨æœåŠ¡å¥åº·éªŒè¯
- APIæ–‡æ¡£ç”Ÿæˆ

### **Priority 4: æ•°æ®æ”¶é›†API** â­â­â­
**æ¨¡å—**: `src/api/data_collection/` (å¦‚æœå­˜åœ¨)
**é‡è¦æ€§**: æ•°æ®æºæ¥å£
**P2.1ä¾èµ–**: ä¾èµ–Domainå±‚æ•°æ®ç›¸å…³äº‹ä»¶
**å…³é”®æ–‡ä»¶**:
- æ•°æ®æºè¿æ¥æ¥å£
- æ•°æ®æ ¼å¼è½¬æ¢å™¨

**æµ‹è¯•é‡ç‚¹**:
- æ•°æ®æºè¿æ¥ç¨³å®šæ€§
- æ•°æ®æ ¼å¼éªŒè¯
- é”™è¯¯æ¢å¤æœºåˆ¶

### **Priority 5: é€‚é…å™¨API** â­â­â­
**æ¨¡å—**: `src/api/adapters/`
**é‡è¦æ€§**: ç³»ç»Ÿé›†æˆæ¥å£
**P2.1ä¾èµ–**: ä¾èµ–Domainå±‚äº‹ä»¶ç³»ç»Ÿé›†æˆ
**å…³é”®æ–‡ä»¶**:
- `router.py` - é€‚é…å™¨ç«¯ç‚¹

**æµ‹è¯•é‡ç‚¹**:
- å¤–éƒ¨ç³»ç»Ÿé›†æˆ
- æ•°æ®è½¬æ¢æ­£ç¡®æ€§
- æ¥å£å…¼å®¹æ€§

---

## ğŸ”§ **æˆ˜æœ¯ä»»åŠ¡åˆ†è§£ (Task Breakdown)**

### **P2.2.1: é¢„æµ‹APIæ ¸å¿ƒä¿®å¤** â±ï¸ **2-3å°æ—¶**
**ç›®æ ‡**: ä¿®å¤é¢„æµ‹APIçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç¡®ä¿åŸºç¡€æµ‹è¯•é€šè¿‡

#### **P2.2.1.1: ä¿®å¤å¯¼å…¥é—®é¢˜** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: è§£å†³predictionsæ¨¡å—å¯¼å…¥é˜»å¡
é‡ç‚¹:
â”œâ”€â”€ æ£€æŸ¥ src/api/predictions/router.py å¯¼å…¥ä¾èµ–
â”œâ”€â”€ éªŒè¯ Domain å±‚ç­–ç•¥ç³»ç»Ÿé›†æˆ
â””â”€â”€ ç¡®ä¿ Event ç³»ç»Ÿæ­£å¸¸å·¥ä½œ
```

#### **P2.2.1.2: åŸºç¡€åŠŸèƒ½æµ‹è¯•** (45åˆ†é’Ÿ)
```bash
ä»»åŠ¡: ä¿®å¤é¢„æµ‹APIåŸºç¡€ç«¯ç‚¹æµ‹è¯•
é‡ç‚¹:
â”œâ”€â”€ POST /predictions - åˆ›å»ºé¢„æµ‹
â”œâ”€â”€ GET /predictions/{id} - è·å–é¢„æµ‹è¯¦æƒ…
â”œâ”€â”€ GET /predictions - è·å–é¢„æµ‹åˆ—è¡¨
â””â”€â”€ DELETE /predictions/{id} - åˆ é™¤é¢„æµ‹
```

#### **P2.2.1.3: ç»“æœéªŒè¯æµ‹è¯•** (45åˆ†é’Ÿ)
```bash
ä»»åŠ¡: è¡¥å……é¢„æµ‹ç»“æœéªŒè¯æµ‹è¯•
é‡ç‚¹:
â”œâ”€â”€ é¢„æµ‹æ¦‚ç‡èŒƒå›´éªŒè¯ (0-1)
â”œâ”€â”€ é¢„æµ‹ç»“æœæ ¼å¼éªŒè¯
â”œâ”€â”€ ç½®ä¿¡åº¦è®¡ç®—éªŒè¯
â””â”€â”€ æ¨¡å‹ç‰ˆæœ¬è·Ÿè¸ªéªŒè¯
```

#### **P2.2.1.4: é”™è¯¯å¤„ç†æµ‹è¯•** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: æ·»åŠ é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•
é‡ç‚¹:
â”œâ”€â”€ æ— æ•ˆè¯·æ±‚æ•°æ®å¤„ç†
â”œâ”€â”€ ä¸å­˜åœ¨çš„é¢„æµ‹IDå¤„ç†
â”œâ”€â”€ æ•°æ®åº“è¿æ¥é”™è¯¯å¤„ç†
â””â”€â”€ ç­–ç•¥ç³»ç»Ÿé”™è¯¯å¤„ç†
```

#### **P2.2.1.5: è¦†ç›–ç‡éªŒè¯** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: éªŒè¯é¢„æµ‹APIè¦†ç›–ç‡è¾¾åˆ°40%+
é‡ç‚¹:
â”œâ”€â”€ è¿è¡Œè¦†ç›–ç‡åˆ†æ
â”œâ”€â”€ è¯†åˆ«è¦†ç›–ç‡ç¼ºå£
â”œâ”€â”€ è¡¥å……å…³é”®è·¯å¾„æµ‹è¯•
â””â”€â”€ ç¡®è®¤è´¨é‡æ ‡å‡†è¾¾æˆ
```

### **P2.2.2: è®¤è¯APIæµ‹è¯•å¢å¼º** â±ï¸ **2å°æ—¶**
**ç›®æ ‡**: å®Œå–„è®¤è¯å’Œæˆæƒæµ‹è¯•ï¼Œç¡®ä¿å®‰å…¨åŠŸèƒ½æ­£å¸¸

#### **P2.2.2.1: è®¤è¯ç«¯ç‚¹ä¿®å¤** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: ä¿®å¤è®¤è¯APIå¯¼å…¥å’ŒåŸºç¡€åŠŸèƒ½
é‡ç‚¹:
â”œâ”€â”€ æ£€æŸ¥ src/api/auth/__init__.py å¯¼å…¥
â”œâ”€â”€ éªŒè¯è®¤è¯æ¨¡å‹å®Œæ•´æ€§
â””â”€â”€ ç¡®ä¿JWTä¾èµ–æ­£å¸¸
```

#### **P2.2.2.2: ç”¨æˆ·æ³¨å†Œæµ‹è¯•** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: è¡¥å……ç”¨æˆ·æ³¨å†Œæµç¨‹æµ‹è¯•
é‡ç‚¹:
â”œâ”€â”€ æœ‰æ•ˆç”¨æˆ·æ³¨å†Œæµ‹è¯•
â”œâ”€â”€ æ— æ•ˆé‚®ç®±æ ¼å¼æµ‹è¯•
â”œâ”€â”€ å¼±å¯†ç æ‹’ç»æµ‹è¯•
â”œâ”€â”€ é‡å¤ç”¨æˆ·åå¤„ç†æµ‹è¯•
â””â”€â”€ æ³¨å†Œæ•°æ®éªŒè¯æµ‹è¯•
```

#### **P2.2.2.3: JWTä»¤ç‰Œæµ‹è¯•** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: è¡¥å……JWTä»¤ç‰Œç›¸å…³æµ‹è¯•
é‡ç‚¹:
â”œâ”€â”€ ä»¤ç‰Œç”ŸæˆéªŒè¯
â”œâ”€â”€ ä»¤ç‰Œè§£æéªŒè¯
â”œâ”€â”€ ä»¤ç‰Œè¿‡æœŸå¤„ç†æµ‹è¯•
â”œâ”€â”€ ä»¤ç‰Œåˆ·æ–°æœºåˆ¶æµ‹è¯•
â””â”€â”€ æ— æ•ˆä»¤ç‰Œæ‹’ç»æµ‹è¯•
```

#### **P2.2.2.4: æƒé™éªŒè¯æµ‹è¯•** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: æ·»åŠ æƒé™æ§åˆ¶å’Œè®¿é—®éªŒè¯æµ‹è¯•
é‡ç‚¹:
â”œâ”€â”€ æœªæˆæƒè®¿é—®æ‹’ç»æµ‹è¯•
â”œâ”€â”€ è§’è‰²æƒé™éªŒè¯æµ‹è¯•
â”œâ”€â”€ èµ„æºè®¿é—®æ§åˆ¶æµ‹è¯•
â”œâ”€â”€ APIç«¯ç‚¹ä¿æŠ¤æµ‹è¯•
â””â”€â”€ æƒé™å‡çº§é˜²æŠ¤æµ‹è¯•
```

### **P2.2.3: å¥åº·æ£€æŸ¥APIå®Œå–„** â±ï¸ **1.5å°æ—¶**
**ç›®æ ‡**: å®Œå–„å¥åº·æ£€æŸ¥å’Œç›‘æ§æµ‹è¯•

#### **P2.2.3.1: å¥åº·æ£€æŸ¥ç«¯ç‚¹** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: ä¿®å¤å’Œå®Œå–„å¥åº·æ£€æŸ¥API
é‡ç‚¹:
â”œâ”€â”€ GET /health - åŸºç¡€å¥åº·æ£€æŸ¥
â”œâ”€â”€ GET /health/detailed - è¯¦ç»†çŠ¶æ€æ£€æŸ¥
â”œâ”€â”€ æ•°æ®åº“è¿æ¥çŠ¶æ€æ£€æŸ¥
â””â”€â”€ å¤–éƒ¨æœåŠ¡ä¾èµ–æ£€æŸ¥
```

#### **P2.2.3.2: ç³»ç»Ÿç›‘æ§æµ‹è¯•** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: è¡¥å……ç³»ç»Ÿç›‘æ§åŠŸèƒ½æµ‹è¯•
é‡ç‚¹:
â”œâ”€â”€ å†…å­˜ä½¿ç”¨ç›‘æ§
â”œâ”€â”€ CPUä½¿ç”¨ç›‘æ§
â”œâ”€â”€ å“åº”æ—¶é—´ç›‘æ§
â””â”€â”€ é”™è¯¯ç‡ç›‘æ§
```

#### **P2.2.3.3: APIæ–‡æ¡£æµ‹è¯•** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: æ·»åŠ APIæ–‡æ¡£ç›¸å…³æµ‹è¯•
é‡ç‚¹:
â”œâ”€â”€ OpenAPIæ–‡æ¡£ç”Ÿæˆæµ‹è¯•
â”œâ”€â”€ æ–‡æ¡£å®Œæ•´æ€§éªŒè¯
â”œâ”€â”€ ç¤ºä¾‹æ•°æ®æ­£ç¡®æ€§æµ‹è¯•
â””â”€â”€ æ–‡æ¡£è®¿é—®æƒé™æµ‹è¯•
```

### **P2.2.4: æ•°æ®APIåŸºç¡€æµ‹è¯•** â±ï¸ **1.5å°æ—¶**
**ç›®æ ‡**: å»ºç«‹æ•°æ®APIçš„åŸºç¡€æµ‹è¯•æ¡†æ¶

#### **P2.2.4.1: æ•°æ®æºè¿æ¥æµ‹è¯•** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: æµ‹è¯•æ•°æ®æºè¿æ¥å’ŒåŸºç¡€åŠŸèƒ½
é‡ç‚¹:
â”œâ”€â”€ å¤–éƒ¨APIè¿æ¥æµ‹è¯•
â”œâ”€â”€ æ•°æ®æºå¯ç”¨æ€§æ£€æŸ¥
â”œâ”€â”€ è¿æ¥è¶…æ—¶å¤„ç†æµ‹è¯•
â””â”€â”€ è¿æ¥é‡è¯•æœºåˆ¶æµ‹è¯•
```

#### **P2.2.4.2: æ•°æ®æ ¼å¼éªŒè¯æµ‹è¯•** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: éªŒè¯æ•°æ®æ ¼å¼å’Œè½¬æ¢æ­£ç¡®æ€§
é‡ç‚¹:
â”œâ”€â”€ JSONæ ¼å¼éªŒè¯
â”œâ”€â”€ æ•°æ®ç±»å‹è½¬æ¢æµ‹è¯•
â”œâ”€â”€ å¿…éœ€å­—æ®µéªŒè¯
â””â”€â”€ æ•°æ®èŒƒå›´éªŒè¯
```

#### **P2.2.4.3: é”™è¯¯å¤„ç†æµ‹è¯•** (30åˆ†é’Ÿ)
```bash
ä»»åŠ¡: æ·»åŠ æ•°æ®APIé”™è¯¯å¤„ç†æµ‹è¯•
é‡ç‚¹:
â”œâ”€â”€ æ•°æ®æºä¸å¯ç”¨å¤„ç†
â”œâ”€â”€ æ•°æ®æ ¼å¼é”™è¯¯å¤„ç†
â”œâ”€â”€ ç½‘ç»œé”™è¯¯å¤„ç†
â””â”€â”€ æ•°æ®è¶…é™å¤„ç†
```

### **P2.2.5: é›†æˆä¸è¦†ç›–ç‡éªŒè¯** â±ï¸ **1å°æ—¶**
**ç›®æ ‡**: æ•´ä½“éªŒè¯APIæ¨¡å—è¦†ç›–ç‡å’ŒåŠŸèƒ½å®Œæ•´æ€§

#### **P2.2.5.1: å®Œæ•´æµ‹è¯•å¥—ä»¶** (20åˆ†é’Ÿ)
```bash
ä»»åŠ¡: è¿è¡Œå®Œæ•´APIæµ‹è¯•å¥—ä»¶
é‡ç‚¹:
â”œâ”€â”€ æ‰§è¡Œæ‰€æœ‰APIæµ‹è¯•
â”œâ”€â”€ æ”¶é›†æµ‹è¯•ç»“æœç»Ÿè®¡
â”œâ”€â”€ è¯†åˆ«å¤±è´¥æ¨¡å¼
â””â”€â”€ è®°å½•å…³é”®é—®é¢˜
```

#### **P2.2.5.2: è¦†ç›–ç‡åˆ†æ** (20åˆ†é’Ÿ)
```bash
ä»»åŠ¡: åˆ†æAPIæ¨¡å—è¦†ç›–ç‡æŠ¥å‘Š
é‡ç‚¹:
â”œâ”€â”€ ç”Ÿæˆè¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š
â”œâ”€â”€ åˆ†ææœªè¦†ç›–ä»£ç è·¯å¾„
â”œâ”€â”€ è¯†åˆ«é«˜ä¼˜å…ˆçº§ç¼ºå£
â””â”€â”€ åˆ¶å®šè¡¥å……æµ‹è¯•è®¡åˆ’
```

#### **P2.2.5.3: è¦†ç›–ç‡ç¼ºå£åˆ†æ** (20åˆ†é’Ÿ)
```bash
ä»»åŠ¡: æ·±å…¥åˆ†æè¦†ç›–ç‡ç¼ºå£
é‡ç‚¹:
â”œâ”€â”€ å…³é”®ä¸šåŠ¡é€»è¾‘è¦†ç›–ç‡
â”œâ”€â”€ é”™è¯¯å¤„ç†è·¯å¾„è¦†ç›–ç‡
â”œâ”€â”€ è¾¹ç•Œæ¡ä»¶è¦†ç›–ç‡
â””â”€â”€ é›†æˆç‚¹è¦†ç›–ç‡
```

#### **P2.2.5.4: ç›®æ ‡è¾¾æˆç¡®è®¤** (20åˆ†é’Ÿ)
```bash
ä»»åŠ¡: ç¡®è®¤35%+è¦†ç›–ç‡ç›®æ ‡è¾¾æˆ
é‡ç‚¹:
â”œâ”€â”€ éªŒè¯è¦†ç›–ç‡æ•°å€¼
â”œâ”€â”€ ç¡®è®¤æµ‹è¯•ç¨³å®šæ€§
â”œâ”€â”€ è¯„ä¼°è´¨é‡æ ‡å‡†
â””â”€â”€ å‡†å¤‡P2.3ä»»åŠ¡
```

---

## ğŸ­ **ä¾èµ–ä¸Mockingç­–ç•¥ (Dependencies & Mocks)**

### **P2.1ä¿®å¤åçš„æ–°ä¾èµ–å…³ç³»**

åŸºäºDomainå±‚çš„ä¿®å¤ï¼ŒAPIå±‚ç°åœ¨é¢ä¸´ä»¥ä¸‹æ–°çš„ä¾èµ–å…³ç³»ï¼š

#### **äº‹ä»¶ç³»ç»Ÿä¾èµ–**
```python
# æ–°å¢ä¾èµ– - éœ€è¦Mock
from src.domain.events.bus import EventBus, get_event_bus
from src.domain.events.handlers import (
    MetricsEventHandler,
    LoggingEventHandler,
    NotificationEventHandler
)
from src.domain.events.types import (
    MatchCreatedEventData,
    PredictionMadeEventData,
    SystemErrorEventData
)
```

#### **ç­–ç•¥ç³»ç»Ÿä¾èµ–**
```python
# ä¿®å¤åçš„å¯¼å…¥ - éœ€è¦Mock
from src.domain.strategies.base import (
    PredictionInput,
    PredictionOutput,
    PredictionStrategy,
    StrategyType
)
from src.domain.strategies.ml_model import MLModelStrategy
from src.domain.strategies.factory import PredictionStrategyFactory
```

### **ğŸ› ï¸ Mockingç­–ç•¥è¯¦ç»†å»ºè®®**

#### **1. Domainå±‚äº‹ä»¶ç³»ç»ŸMock**
```python
# æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹
import pytest
from unittest.mock import Mock, patch
from fastapi.testclient import TestClient

@pytest.fixture
def mock_event_bus():
    """Mockäº‹ä»¶æ€»çº¿å¤¹å…·"""
    with patch('src.domain.events.bus.event_bus') as mock_bus:
        # é…ç½®mockè¡Œä¸º
        mock_bus.publish = Mock()
        mock_bus.subscribe = Mock()
        mock_bus.get_handlers = Mock(return_value=[])
        yield mock_bus

@pytest.fixture
def mock_metrics_handler():
    """MockæŒ‡æ ‡å¤„ç†å™¨å¤¹å…·"""
    with patch('src.domain.events.handlers.MetricsEventHandler') as mock_handler:
        mock_instance = Mock()
        mock_handler.return_value = mock_instance
        mock_instance.handle = Mock()
        yield mock_instance

def test_prediction_creation_with_events(mock_event_bus, mock_metrics_handler):
    """æµ‹è¯•é¢„æµ‹åˆ›å»ºæ—¶çš„äº‹ä»¶å‘å¸ƒ"""
    client = TestClient(app)

    # å‘é€é¢„æµ‹è¯·æ±‚
    response = client.post("/predictions", json={
        "match_id": 123,
        "model_version": "v1.0"
    })

    # éªŒè¯å“åº”
    assert response.status_code == 201

    # éªŒè¯äº‹ä»¶è¢«å‘å¸ƒ
    mock_event_bus.publish.assert_called()

    # éªŒè¯æŒ‡æ ‡å¤„ç†å™¨è¢«è°ƒç”¨
    mock_metrics_handler.instance.handle.assert_called()
```

#### **2. ç­–ç•¥ç³»ç»ŸMock**
```python
@pytest.fixture
def mock_prediction_strategy():
    """Mocké¢„æµ‹ç­–ç•¥å¤¹å…·"""
    strategy = Mock()
    strategy.predict.return_value = {
        "home_win_prob": 0.6,
        "draw_prob": 0.25,
        "away_win_prob": 0.15,
        "predicted_outcome": "home",
        "confidence": 0.75,
        "model_version": "v1.0"
    }
    strategy.get_strategy_type.return_value = "ml_model"
    strategy.get_metrics.return_value = {"accuracy": 0.85}
    return strategy

@pytest.fixture
def mock_strategy_factory(mock_prediction_strategy):
    """Mockç­–ç•¥å·¥å‚å¤¹å…·"""
    with patch('src.domain.strategies.factory.PredictionStrategyFactory') as mock_factory:
        mock_instance = Mock()
        mock_factory.return_value = mock_instance
        mock_instance.create_strategy.return_value = mock_prediction_strategy
        yield mock_instance

def test_prediction_with_mock_strategy(mock_strategy_factory):
    """æµ‹è¯•ä½¿ç”¨Mockç­–ç•¥çš„é¢„æµ‹API"""
    client = TestClient(app)

    response = client.post("/predictions", json={
        "match_id": 123,
        "model_version": "ml_model"
    })

    assert response.status_code == 201
    data = response.json()

    # éªŒè¯ç­–ç•¥å·¥å‚è¢«è°ƒç”¨
    mock_strategy_factory.instance.create_strategy.assert_called_once()

    # éªŒè¯é¢„æµ‹ç»“æœæ ¼å¼
    assert "home_win_prob" in data
    assert "predicted_outcome" in data
    assert 0 <= data["home_win_prob"] <= 1
```

#### **3. æ•°æ®åº“è¿æ¥Mock**
```python
@pytest.fixture
def mock_database_session():
    """Mockæ•°æ®åº“ä¼šè¯å¤¹å…·"""
    with patch('src.database.session.SessionLocal') as mock_session:
        mock_db = Mock()
        mock_session.return_value = mock_db

        # é…ç½®å¸¸ç”¨çš„æ•°æ®åº“æ“ä½œ
        mock_db.query.return_value.filter.return_value.first.return_value = None
        mock_db.add.return_value = None
        mock_db.commit.return_value = None
        mock_db.refresh.return_value = None

        yield mock_db

def test_api_with_mock_database(mock_database_session):
    """æµ‹è¯•ä½¿ç”¨Mockæ•°æ®åº“çš„API"""
    client = TestClient(app)

    response = client.get("/predictions/123")

    # éªŒè¯æ•°æ®åº“æŸ¥è¯¢è¢«è°ƒç”¨
    mock_database_session.query.assert_called()
```

#### **4. å¤–éƒ¨æœåŠ¡Mock**
```python
@pytest.fixture
def mock_external_api():
    """Mockå¤–éƒ¨APIæœåŠ¡å¤¹å…·"""
    with patch('src.external.football_data_api.FootballDataAPI') as mock_api:
        mock_instance = Mock()
        mock_api.return_value = mock_instance
        mock_instance.get_match_data.return_value = {
            "match_id": 123,
            "home_team": "Team A",
            "away_team": "Team B",
            "league": "Premier League"
        }
        yield mock_instance

def test_api_with_external_service(mock_external_api):
    """æµ‹è¯•ä¾èµ–å¤–éƒ¨æœåŠ¡çš„API"""
    client = TestClient(app)

    response = client.get("/predictions/123/match-data")

    assert response.status_code == 200
    data = response.json()

    # éªŒè¯å¤–éƒ¨æœåŠ¡è¢«è°ƒç”¨
    mock_external_api.instance.get_match_data.assert_called_with(123)

    # éªŒè¯è¿”å›æ•°æ®
    assert data["match_id"] == 123
```

### **ğŸ”§ æµ‹è¯•å·¥å…·å’Œå¤¹å…·é…ç½®**

#### **é€šç”¨æµ‹è¯•å¤¹å…·**
```python
# conftest.py
@pytest.fixture
def client():
    """FastAPIæµ‹è¯•å®¢æˆ·ç«¯"""
    from src.main import app
    return TestClient(app)

@pytest.fixture
def auth_headers():
    """è®¤è¯å¤´å¤¹å…·"""
    return {"Authorization": "Bearer test_token"}

@pytest.fixture
def sample_prediction_request():
    """ç¤ºä¾‹é¢„æµ‹è¯·æ±‚æ•°æ®"""
    return {
        "match_id": 123,
        "model_version": "v1.0",
        "include_details": True
    }

@pytest.fixture
def sample_prediction_result():
    """ç¤ºä¾‹é¢„æµ‹ç»“æœæ•°æ®"""
    return {
        "match_id": 123,
        "home_win_prob": 0.6,
        "draw_prob": 0.25,
        "away_win_prob": 0.15,
        "predicted_outcome": "home",
        "confidence": 0.75,
        "model_version": "v1.0"
    }
```

---

## ğŸ“Š **æˆåŠŸæŒ‡æ ‡å’ŒéªŒè¯æ ‡å‡†**

### **è¦†ç›–ç‡ç›®æ ‡**
- **APIæ¨¡å—æ€»ä½“è¦†ç›–ç‡**: â‰¥ 35%
- **æ ¸å¿ƒç«¯ç‚¹è¦†ç›–ç‡**: â‰¥ 50%
- **é”™è¯¯å¤„ç†è·¯å¾„è¦†ç›–ç‡**: â‰¥ 40%
- **é›†æˆæµ‹è¯•è¦†ç›–ç‡**: â‰¥ 30%

### **è´¨é‡ç›®æ ‡**
- **æµ‹è¯•é€šè¿‡ç‡**: â‰¥ 95%
- **æµ‹è¯•æ‰§è¡Œæ—¶é—´**: â‰¤ 5åˆ†é’Ÿ
- **Mockè¦†ç›–ç‡**: â‰¥ 90% (å…³é”®ä¾èµ–)
- **æµ‹è¯•ç¨³å®šæ€§**: è¿ç»­5æ¬¡æ‰§è¡Œæ— å¤±è´¥

### **åŠŸèƒ½ç›®æ ‡**
- **æ‰€æœ‰æ ¸å¿ƒAPIç«¯ç‚¹**: 100%åŠŸèƒ½æµ‹è¯•è¦†ç›–
- **è®¤è¯å’Œæˆæƒ**: 100%å®‰å…¨æµ‹è¯•è¦†ç›–
- **é”™è¯¯å¤„ç†**: 100%é”™è¯¯åœºæ™¯æµ‹è¯•è¦†ç›–
- **è¾¹ç•Œæ¡ä»¶**: â‰¥ 80%è¾¹ç•Œæµ‹è¯•è¦†ç›–

---

## â° **æ‰§è¡Œæ—¶é—´è¡¨**

### **ä¸Šåˆæ—¶æ®µ (09:00-12:00)**
- **09:00-10:30**: P2.2.1.1-P2.2.1.2 (é¢„æµ‹APIå¯¼å…¥ä¿®å¤+åŸºç¡€åŠŸèƒ½)
- **10:30-12:00**: P2.2.1.3-P2.2.1.4 (é¢„æµ‹APIç»“æœéªŒè¯+é”™è¯¯å¤„ç†)

### **åˆé¤ä¼‘æ¯ (12:00-14:00)**
- ä¼‘æ¯å’Œè¿›åº¦è¯„ä¼°
- è°ƒæ•´ä¸‹åˆä»»åŠ¡ä¼˜å…ˆçº§

### **ä¸‹åˆæ—¶æ®µ (14:00-17:00)**
- **14:00-15:30**: P2.2.2 (è®¤è¯APIæµ‹è¯•å¢å¼º)
- **15:30-16:30**: P2.2.3 (å¥åº·æ£€æŸ¥APIå®Œå–„)
- **16:30-17:00**: P2.2.4 (æ•°æ®APIåŸºç¡€æµ‹è¯•)

### **æ”¶å°¾æ—¶æ®µ (17:00-18:00)**
- **17:00-17:40**: P2.2.5 (é›†æˆä¸è¦†ç›–ç‡éªŒè¯)
- **17:40-18:00**: æ€»ç»“å’ŒP2.3å‡†å¤‡

---

## ğŸš¨ **é£é™©ç®¡ç†**

### **æŠ€æœ¯é£é™©**
- **é£é™©**: APIæ¨¡å—å¯¼å…¥å¤æ‚æ€§è¶…å‡ºé¢„æœŸ
- **ç¼“è§£**: ä¼˜å…ˆä¿®å¤åŸºç¡€å¯¼å…¥ï¼Œå†è¿›è¡ŒåŠŸèƒ½æµ‹è¯•
- **é¢„æ¡ˆ**: å¦‚é‡åˆ°å¤æ‚ä¾èµ–é—®é¢˜ï¼Œå…ˆåˆ›å»ºåŸºç¡€Mockæµ‹è¯•

### **è¿›åº¦é£é™©**
- **é£é™©**: æµ‹è¯•ä¿®å¤æ—¶é—´è¶…å‡ºé¢„æœŸ
- **ç¼“è§£**: ä¸¥æ ¼æŒ‰ç…§æ—¶é—´è¡¨æ‰§è¡Œï¼ŒåŠæ—¶è°ƒæ•´ä¼˜å…ˆçº§
- **é¢„æ¡ˆ**: å¦‚æ—¶é—´ä¸è¶³ï¼Œä¼˜å…ˆç¡®ä¿æ ¸å¿ƒç«¯ç‚¹æµ‹è¯•

### **è´¨é‡é£é™©**
- **é£é™©**: ä¸ºè¿½æ±‚è¦†ç›–ç‡ç‰ºç‰²æµ‹è¯•è´¨é‡
- **ç¼“è§£**: è´¨é‡ä¼˜å…ˆåŸåˆ™ï¼Œç¡®ä¿æ¯ä¸ªæµ‹è¯•éƒ½æœ‰ä»·å€¼
- **é¢„æ¡ˆ**: é‡æ–°è¯„ä¼°æµ‹è¯•ç­–ç•¥ï¼Œç¡®ä¿å®ç”¨æ€§

---

## ğŸ¯ **é¢„æœŸæˆæœ**

### **çŸ­æœŸæˆæœ (å½“å¤©å®Œæˆ)**
- âœ… **APIè¦†ç›–ç‡**: æå‡åˆ°35%ä»¥ä¸Š
- âœ… **æµ‹è¯•ç¨³å®šæ€§**: 530ä¸ªæµ‹è¯•ä¸­95%+é€šè¿‡
- âœ… **Mockä½“ç³»**: å»ºç«‹å®Œæ•´çš„Domainå±‚Mockç­–ç•¥
- âœ… **æµ‹è¯•å·¥å…·**: å®Œå–„APIæµ‹è¯•å·¥å…·é“¾

### **ä¸­æœŸä»·å€¼ (æœ¬å‘¨å†…)**
- âœ… **APIè´¨é‡**: å»ºç«‹ç¨³å®šå¯é çš„APIæµ‹è¯•ä½“ç³»
- âœ… **å¼€å‘æ•ˆç‡**: APIå¼€å‘è°ƒè¯•æ•ˆç‡æå‡
- âœ… **æŠ€æœ¯å€ºåŠ¡**: å¤§å¹…å‡å°‘APIç›¸å…³é—®é¢˜
- âœ… **å›¢é˜ŸæŠ€èƒ½**: APIæµ‹è¯•èƒ½åŠ›æ˜¾è‘—æå‡

### **é•¿æœŸå½±å“ (é¡¹ç›®å±‚é¢)**
- âœ… **è´¨é‡æ–‡åŒ–**: å»ºç«‹APIè´¨é‡ä¿éšœæ–‡åŒ–
- âœ… **æŠ€æœ¯æ ‡å‡†**: å»ºç«‹APIæµ‹è¯•æœ€ä½³å®è·µ
- âœ… **è‡ªåŠ¨åŒ–åŸºç¡€**: ä¸ºCI/CDé›†æˆæä¾›åŸºç¡€
- âœ… **çŸ¥è¯†æ²‰æ·€**: å®Œæ•´çš„APIæµ‹è¯•æ–¹æ³•è®º

---

**P2.2çš„æˆåŠŸå°†ä¸ºé˜¶æ®µ2æ•´ä½“ç›®æ ‡(29%â†’40%è¦†ç›–ç‡)æä¾›å…³é”®æ”¯æ’‘ï¼** ğŸš€

---

*è®¡åˆ’åˆ¶å®šæ—¶é—´: 2025-11-11 23:30*
*æ‰§è¡Œæ—¶é—´: 2025-11-12 09:00-18:00*
*é¢„æœŸå®Œæˆ: 2025-11-12 18:00*
*æˆåŠŸæ¦‚ç‡: 90% (åŸºäºP2.1æˆåŠŸç»éªŒ)*
