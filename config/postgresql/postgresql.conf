# PostgreSQL Configuration for Football Prediction System
# 针对足球预测系统优化的PostgreSQL配置
# 适用于中等规模的应用负载

# =============================================================================
# CONNECTION AND AUTHENTICATION
# =============================================================================

# 监听地址
listen_addresses = '*'
port = 5432

# 连接限制
max_connections = 200                    # 最大连接数
superuser_reserved_connections = 3       # 为超级用户保留的连接

# =============================================================================
# RESOURCE USAGE (MEMORY)
# =============================================================================

# 共享缓冲区 - 建议设置为系统内存的25%
shared_buffers = 512MB                   # 对于2GB系统内存

# 工作内存设置
work_mem = 8MB                           # 用于排序和哈希表的内存
maintenance_work_mem = 128MB             # 维护操作内存
max_worker_processes = 8                 # 最大工作进程数
max_parallel_workers = 4                 # 最大并行工作进程
max_parallel_workers_per_gather = 2      # 每个gather节点的最大并行工作进程

# 自动清理设置
autovacuum_work_mem = 256MB              # 自动清理工作内存

# =============================================================================
# WRITE-AHEAD LOGGING
# =============================================================================

# WAL配置
wal_level = replica                      # 支持流复制
max_wal_size = 2GB                       # WAL最大大小
min_wal_size = 512MB                     # WAL最小大小
wal_compression = on                     # 启用WAL压缩
wal_writer_delay = 200ms                 # WAL写入延迟

# 检查点配置
checkpoint_timeout = 15min               # 检查点超时
checkpoint_completion_target = 0.9       # 检查点完成目标

# =============================================================================
# REPLICATION
# =============================================================================

# 流复制设置（为将来的主从复制准备）
max_wal_senders = 3                      # 最大WAL发送进程
max_replication_slots = 3                # 最大复制槽
hot_standby = on                         # 热备份
hot_standby_feedback = on                # 热备份反馈

# =============================================================================
# QUERY TUNING
# =============================================================================

# 查询规划器配置
random_page_cost = 1.1                   # 随机页面成本（SSD优化）
seq_page_cost = 1.0                      # 顺序页面成本
cpu_tuple_cost = 0.01                    # CPU元组成本
cpu_index_tuple_cost = 0.005             # CPU索引元组成本
cpu_operator_cost = 0.0025               # CPU操作符成本

# 统计信息
default_statistics_target = 100          # 默认统计目标
constraint_exclusion = partition         # 约束排除（分区表优化）

# =============================================================================
# LOGGING
# =============================================================================

# 日志记录
log_destination = 'stderr'               # 日志目标
logging_collector = off                  # 禁用日志收集器（Docker环境）
log_min_messages = info                  # 最小日志级别
log_min_error_statement = error          # 最小错误语句日志级别

# SQL语句日志
log_statement = 'mod'                    # 记录修改语句
log_duration = off                       # 不记录语句持续时间
log_min_duration_statement = 1000        # 记录超过1秒的语句

# 连接日志
log_connections = on                     # 记录连接
log_disconnections = on                  # 记录断开连接
log_hostname = off                       # 不记录主机名

# 错误详情
log_error_verbosity = default            # 错误详细程度
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# =============================================================================
# RUNTIME STATISTICS
# =============================================================================

# 统计收集
track_activities = on                    # 跟踪活动
track_counts = on                        # 跟踪计数
track_io_timing = on                     # 跟踪IO时间
track_functions = all                    # 跟踪函数统计
track_activity_query_size = 2048         # 查询跟踪大小

# 语句统计（需要pg_stat_statements扩展）
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000           # 最大跟踪语句数
pg_stat_statements.track = all           # 跟踪所有语句

# =============================================================================
# CLIENT CONNECTION DEFAULTS
# =============================================================================

# 语言和格式化
lc_messages = 'en_US.utf8'               # 消息语言
lc_monetary = 'en_US.utf8'               # 货币格式
lc_numeric = 'en_US.utf8'                # 数字格式
lc_time = 'en_US.utf8'                   # 时间格式

# 默认配置
default_text_search_config = 'pg_catalog.english'
timezone = 'UTC'                         # 时区设置
datestyle = 'iso, mdy'                   # 日期样式

# 客户端连接设置
statement_timeout = 0                    # 语句超时（0=禁用）
lock_timeout = 0                         # 锁超时（0=禁用）
idle_in_transaction_session_timeout = 0  # 事务中空闲超时

# =============================================================================
# LOCK MANAGEMENT
# =============================================================================

deadlock_timeout = 1s                   # 死锁检测超时
max_locks_per_transaction = 64           # 每个事务最大锁数
max_pred_locks_per_transaction = 64      # 每个事务最大谓词锁数

# =============================================================================
# VERSION AND PLATFORM COMPATIBILITY
# =============================================================================

# 兼容性设置
array_nulls = on                         # 数组NULL值
backslash_quote = safe_encoding          # 反斜杠引号
default_with_oids = off                  # 默认不带OID
escape_string_warning = on               # 转义字符串警告
lo_compat_privileges = off               # 大对象兼容权限
operator_precedence_warning = off        # 操作符优先级警告
quote_all_identifiers = off              # 不引号化所有标识符
sql_inheritance = on                     # SQL继承
standard_conforming_strings = on         # 标准一致字符串
synchronize_seqscans = on                # 同步序列扫描

# =============================================================================
# CUSTOM SETTINGS FOR FOOTBALL PREDICTION
# =============================================================================

# 针对足球预测应用的特殊配置
enable_hashjoin = on                     # 启用哈希连接（JSON查询优化）
enable_mergejoin = on                    # 启用合并连接
enable_nestloop = on                     # 启用嵌套循环连接

# 分区表优化
enable_partitionwise_join = on           # 启用分区明智连接
enable_partitionwise_aggregate = on      # 启用分区明智聚合

# 并行查询
max_parallel_maintenance_workers = 2     # 最大并行维护工作进程
parallel_leader_participation = on       # 并行领导者参与

# JIT编译（PostgreSQL 11+）
jit = on                                 # 启用JIT编译
jit_above_cost = 100000                  # JIT成本阈值
jit_inline_above_cost = 500000           # JIT内联成本阈值
jit_optimize_above_cost = 500000         # JIT优化成本阈值
