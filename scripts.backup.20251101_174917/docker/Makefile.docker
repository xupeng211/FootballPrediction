# Dockerç›¸å…³å‘½ä»¤

.PHONY: docker-build docker-run docker-dev docker-stop docker-clean docker-push

# æ„å»ºç”Ÿäº§é•œåƒ
docker-build:
	@echo "ğŸ³ æ„å»ºç”Ÿäº§Dockeré•œåƒ..."
	docker build -t aiculturekit:latest .

# æ„å»ºå¼€å‘é•œåƒ
docker-build-dev:
	@echo "ğŸ³ æ„å»ºå¼€å‘Dockeré•œåƒ..."
	docker build -f Dockerfile.dev -t aiculturekit:dev .

# è¿è¡Œç”Ÿäº§ç¯å¢ƒ
docker-run:
	@echo "ğŸš€ å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ..."
	docker-compose up -d

# è¿è¡Œå¼€å‘ç¯å¢ƒ
docker-dev:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	docker-compose -f docker-compose.dev.yml up -d

# åœæ­¢æ‰€æœ‰å®¹å™¨
docker-stop:
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰å®¹å™¨..."
	docker-compose down
	docker-compose -f docker-compose.dev.yml down

# æŸ¥çœ‹æ—¥å¿—
docker-logs:
	@echo "ğŸ“‹ æŸ¥çœ‹åº”ç”¨æ—¥å¿—..."
	docker-compose logs -f app

# è¿›å…¥åº”ç”¨å®¹å™¨
docker-shell:
	@echo "ğŸš è¿›å…¥åº”ç”¨å®¹å™¨..."
	docker-compose exec app bash

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-rebuild:
	@echo "ğŸ”„ é‡æ–°æ„å»ºå¹¶å¯åŠ¨..."
	docker-compose down
	docker-compose build --no-cache
	docker-compose up -d

# æ¸…ç†Dockerèµ„æº
docker-clean:
	@echo "ğŸ§¹ æ¸…ç†Dockerèµ„æº..."
	docker system prune -f
	docker volume prune -f

# æ¨é€é•œåƒåˆ°æ³¨å†Œè¡¨
docker-push:
	@echo "ğŸ“¤ æ¨é€é•œåƒåˆ°GitHub Container Registry..."
	docker tag aiculturekit:latest ghcr.io/xupeng211/aiculturekit:latest
	docker push ghcr.io/xupeng211/aiculturekit:latest

# æœ¬åœ°å®Œæ•´æµ‹è¯•
docker-test:
	@echo "ğŸ§ª è¿è¡ŒDockerç¯å¢ƒæµ‹è¯•..."
	docker-compose -f docker-compose.dev.yml up -d
	sleep 10
	docker-compose -f docker-compose.dev.yml exec -T app pytest tests/
	docker-compose -f docker-compose.dev.yml down

# å¥åº·æ£€æŸ¥
docker-health:
	@echo "ğŸ¥ æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€..."
	docker-compose ps
	curl -f http://localhost:8000/health || echo "å¥åº·æ£€æŸ¥å¤±è´¥"

# æŸ¥çœ‹é•œåƒå¤§å°
docker-size:
	@echo "ğŸ“Š æŸ¥çœ‹é•œåƒå¤§å°..."
	docker images | grep aiculturekit
