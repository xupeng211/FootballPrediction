# P2-7 ä»»åŠ¡è°ƒåº¦æ ‡å‡†åŒ–å®ŒæˆæŠ¥å‘Š

**ä»»åŠ¡**: ä»»åŠ¡è°ƒåº¦æ ‡å‡†åŒ– (P2-7)
**å®Œæˆæ—¶é—´**: 2025-12-07
**ç‰ˆæœ¬**: 1.0.0
**çŠ¶æ€**: âœ… å·²å®Œæˆ

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

P2-7ä»»åŠ¡çš„æ ¸å¿ƒç›®æ ‡æ˜¯ä½¿ç”¨Prefect 2.xæˆ–Celery Beatå°†æ‰‹åŠ¨è„šæœ¬è½¬æ¢ä¸ºè‡ªåŠ¨åŒ–è°ƒåº¦ä»»åŠ¡ï¼Œå®ç°æ—¥å¸¸æ•°æ®é‡‡é›†å’Œæ¯å‘¨æ¨¡å‹è®­ç»ƒçš„å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œå»ºç«‹ä¼ä¸šçº§çš„è°ƒåº¦ç›‘æ§ç³»ç»Ÿã€‚

### ä¸»è¦ç›®æ ‡
1. âœ… æ—¥å¸¸æ•°æ®é‡‡é›†Flow - å¹¶è¡ŒFotMobå’ŒFBrefé‡‡é›†
2. âœ… æ¯å‘¨æ¨¡å‹è®­ç»ƒFlow - è°ƒç”¨P2-5çš„train_flow
3. âœ… Prefect Flowå®šä¹‰ - ä¼ä¸šçº§å·¥ä½œæµç¼–æ’
4. âœ… Celery Beaté›†æˆ - ç¨³å®šçš„å®šæ—¶è°ƒåº¦
5. âœ… DockeræœåŠ¡é›†æˆ - å®¹å™¨åŒ–éƒ¨ç½²
6. âœ… æµ‹è¯•éªŒè¯ - å®Œæ•´çš„åŠŸèƒ½æµ‹è¯•

## ğŸ—ï¸ å®ç°æ¶æ„

### 1. æ ¸å¿ƒFlowè®¾è®¡

#### A. æ—¥å¸¸æ•°æ®é‡‡é›†Flow (`daily_data_collection_flow.py`)

**å¹¶è¡Œæ•°æ®é‡‡é›†æ¶æ„:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Daily Data Collection Flow                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 1: å¹¶è¡Œæ•°æ®é‡‡é›† (å¼‚æ­¥æ‰§è¡Œ)                          â”‚
â”‚  â”œâ”€ FotMob Fixtures Collection   (5åˆ†é’Ÿè¶…æ—¶)           â”‚
â”‚  â”œâ”€ FotMob Details Collection    (10åˆ†é’Ÿè¶…æ—¶)          â”‚
â”‚  â””â”€ FBref Data Collection        (15åˆ†é’Ÿè¶…æ—¶)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 2: æ•°æ®è´¨é‡æ£€æŸ¥                                     â”‚
â”‚  â”œâ”€ åè®®åŒ–è´¨é‡è§„åˆ™éªŒè¯                                    â”‚
â”‚  â”œâ”€ æ•°æ®å®Œæ•´æ€§æ£€æŸ¥                                        â”‚
â”‚  â””â”€ è´¨é‡è¯„åˆ†è®¡ç®—                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 3: ç‰¹å¾å­˜å‚¨æ›´æ–°                                     â”‚
â”‚  â”œâ”€ å¼‚æ­¥ç‰¹å¾å·¥ç¨‹å¤„ç†                                      â”‚
â”‚  â”œâ”€ ç‰¹å¾å­˜å‚¨æ›´æ–°                                          â”‚
â”‚  â””â”€ MLå¯æ¶ˆè´¹æ•°æ®å‡†å¤‡                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§:**
- **å¹¶è¡Œæ‰§è¡Œ**: ä¸‰ä¸ªæ•°æ®æºåŒæ—¶é‡‡é›†ï¼Œæé«˜æ•ˆç‡
- **è‡ªåŠ¨é‡è¯•**: æ¯ä¸ªä»»åŠ¡3æ¬¡é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿
- **è´¨é‡éªŒè¯**: ä½¿ç”¨P0-3çš„ç°ä»£è´¨é‡ç›‘æ§ç³»ç»Ÿ
- **ç¼“å­˜ä¼˜åŒ–**: æ™ºèƒ½ç¼“å­˜é¿å…é‡å¤é‡‡é›†
- **é”™è¯¯éš”ç¦»**: å•ä¸ªæ•°æ®æºå¤±è´¥ä¸å½±å“å…¶ä»–é‡‡é›†

```python
@flow(
    name="Daily Data Collection Flow",
    log_prints=True,
    flow_run_name="daily-data-collection-{flow_run.expected_start_time}"
)
async def daily_data_collection_flow() -> Dict[str, Any]:
    # Step 1: å¹¶è¡Œæ•°æ®é‡‡é›†
    collection_tasks = await asyncio.gather(
        collect_fotmob_fixtures_flow_task(),
        collect_fotmob_details_flow_task(),
        collect_fbref_flow_task(),
        return_exceptions=True
    )

    # Step 2: æ•°æ®è´¨é‡éªŒè¯
    quality_result = await run_data_quality_checks()

    # Step 3: ç‰¹å¾å­˜å‚¨æ›´æ–°
    feature_result = await update_feature_store()
```

#### B. æ¯å‘¨æ¨¡å‹è®­ç»ƒFlow (`weekly_model_retraining_flow.py`)

**æ¨¡å‹è®­ç»ƒæµæ°´çº¿æ¶æ„:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Weekly Model Retraining Flow                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 1: è®­ç»ƒæ•°æ®è´¨é‡éªŒè¯                                 â”‚
â”‚  â”œâ”€ 30å¤©å†å²æ•°æ®è´¨é‡æ£€æŸ¥                                  â”‚
â”‚  â”œâ”€ æœ€å°è´¨é‡åˆ†æ•°éªŒè¯ (0.85)                              â”‚
â”‚  â””â”€ æ•°æ®å®Œæ•´æ€§æ£€æŸ¥                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 2: ç‰¹å¾å‡†å¤‡                                         â”‚
â”‚  â”œâ”€ ç‰¹å¾å­˜å‚¨æ•°æ®æå–                                      â”‚
â”‚  â”œâ”€ é«˜çº§ç‰¹å¾å·¥ç¨‹å¤„ç†                                      â”‚
â”‚  â””â”€ è®­ç»ƒ/æµ‹è¯•æ•°æ®åˆ†å‰²                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 3: XGBoostæ¨¡å‹è®­ç»ƒ                                  â”‚
â”‚  â”œâ”€ P2-5è®­ç»ƒåŸºç¡€è®¾æ–½é›†æˆ                                   â”‚
â”‚  â”œâ”€ è¶…å‚æ•°è‡ªåŠ¨ä¼˜åŒ– (Optuna)                              â”‚
â”‚  â”œâ”€ 5æŠ˜äº¤å‰éªŒè¯                                           â”‚
â”‚  â””â”€ MLflowå®éªŒè·Ÿè¸ª                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 4: æ¨¡å‹è¯„ä¼°                                         â”‚
â”‚  â”œâ”€ 7å¤©æµ‹è¯•æ•°æ®è¯„ä¼°                                        â”‚
â”‚  â”œâ”€ æ€§èƒ½æŒ‡æ ‡è®¡ç®—                                          â”‚
â”‚  â””â”€ æ€§èƒ½é˜ˆå€¼éªŒè¯                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 5: æ¨ç†æœåŠ¡æ›´æ–°                                     â”‚
â”‚  â”œâ”€ æ¨¡å‹æ€§èƒ½éªŒè¯                                          â”‚
â”‚  â”œâ”€ æ¨ç†æœåŠ¡çƒ­æ›´æ–°                                        â”‚
â”‚  â””â”€ æœåŠ¡å¥åº·æ£€æŸ¥                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§:**
- **P2-5é›†æˆ**: å®Œå…¨å¤ç”¨P2-5çš„è®­ç»ƒåŸºç¡€è®¾æ–½
- **è‡ªåŠ¨è¶…å‚æ•°ä¼˜åŒ–**: 50æ¬¡è¯•éªŒï¼Œè´å¶æ–¯ä¼˜åŒ–
- **è´¨é‡é—¨æ§**: æœ€ä½å‡†ç¡®åº¦è¦æ±‚0.6
- **çƒ­æ›´æ–°**: æ— åœæœºæ¨ç†æœåŠ¡æ›´æ–°
- **å®éªŒè·Ÿè¸ª**: MLflowå®Œæ•´å®éªŒè®°å½•

```python
@flow(
    name="Weekly Model Retraining Flow",
    log_prints=True,
    flow_run_name="weekly-model-retraining-{flow_run.expected_start_time}"
)
async def weekly_model_retraining_flow(
    lookback_days: int = 30,
    experiment_name: str = "weekly_retraining",
    force_retrain: bool = False
) -> Dict[str, Any]:
    # Step 1: æ•°æ®è´¨é‡éªŒè¯
    quality_result = await validate_training_data_quality(lookback_days=lookback_days)

    # Step 2: ç‰¹å¾å‡†å¤‡
    feature_result = await prepare_training_features(lookback_days=lookback_days)

    # Step 3: æ¨¡å‹è®­ç»ƒ (P2-5é›†æˆ)
    training_result = await train_xgboost_model(training_data=feature_result)

    # Step 4: æ¨¡å‹è¯„ä¼°
    evaluation_result = await evaluate_model_performance(model_path=training_result["model_path"])

    # Step 5: æ¨ç†æœåŠ¡æ›´æ–°
    service_result = await update_inference_service(
        model_path=training_result["model_path"],
        model_version=model_version,
        performance_metrics=evaluation_result["metrics"]
    )
```

### 2. Prefect + Celeryæ··åˆæ¶æ„

#### A. è°ƒåº¦å™¨é›†æˆè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ··åˆè°ƒåº¦æ¶æ„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Celery    â”‚    â”‚   Prefect    â”‚    â”‚  Docker     â”‚ â”‚
â”‚  â”‚    Beat     â”‚â”€â”€â”€â–¶â”‚    Server    â”‚â”€â”€â”€â–¶â”‚  Services   â”‚ â”‚
â”‚  â”‚  (è°ƒåº¦å™¨)    â”‚    â”‚  (ç¼–æ’å™¨)    â”‚    â”‚  (æ‰§è¡Œå™¨)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                   â”‚                   â”‚       â”‚
â”‚         â”‚                   â”‚                   â”‚       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Celery Tasks â”‚    â”‚ Prefect      â”‚    â”‚Prefect      â”‚ â”‚
â”‚  â”‚(è´¨é‡æ£€æŸ¥)    â”‚    â”‚ Flows        â”‚    â”‚Agent        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### B. è°ƒåº¦æ—¶é—´è¡¨

| ä»»åŠ¡ | è°ƒåº¦æ—¶é—´ | æ‰§è¡Œæ–¹å¼ | ä¼˜å…ˆçº§ | è¶…æ—¶æ—¶é—´ |
|------|----------|----------|--------|----------|
| æ—¥å¸¸æ•°æ®é‡‡é›† | æ¯æ—¥ 2:00 AM UTC | Prefect Flow | 5 | 60åˆ†é’Ÿ |
| æ¯å‘¨æ¨¡å‹è®­ç»ƒ | æ¯å‘¨ä¸€ 3:00 AM UTC | Prefect Flow | 8 | 120åˆ†é’Ÿ |
| ç´§æ€¥é‡è®­ç»ƒæ£€æŸ¥ | æ¯6å°æ—¶ | Celery Task | 9 | 30åˆ†é’Ÿ |
| æ•°æ®è´¨é‡ç›‘æ§ | æ¯4å°æ—¶ | Celery Task | 6 | 20åˆ†é’Ÿ |
| æ€§èƒ½ç›‘æ§ | æ¯6å°æ—¶ | Celery Task | 9 | 30åˆ†é’Ÿ |

### 3. DockeræœåŠ¡é›†æˆ

#### A. æ–°å¢æœåŠ¡ç»„ä»¶

```yaml
# docker-compose.scheduler.yml æ–°å¢æœåŠ¡
services:
  # Prefect Server - ç¼–æ’APIå’ŒUI
  prefect-server:
    ports: ["4200:4200"]  # Prefect UI
    ports: ["4201:4201"]  # Prefect API

  # Prefect Agent - Flowæ‰§è¡Œå™¨
  prefect-agent:
    command: ["prefect", "agent", "start"]

  # å¢å¼ºç‰ˆCelery Worker
  scheduler-worker:
    command: ["celery", "worker", "-Q", "scheduler"]

  # å¢å¼ºç‰ˆCelery Beat
  scheduler-beat:
    command: ["celery", "beat", "--scheduler", "src.tasks.scheduler_prefect.PrefectFlowScheduler"]

  # Flower - Celeryç›‘æ§ä»ªè¡¨æ¿
  flower:
    ports: ["5555:5555"]

  # MLflow - å®éªŒè·Ÿè¸ªæœåŠ¡å™¨
  mlflow:
    ports: ["5000:5000"]
```

#### B. æœåŠ¡ç«¯å£åˆ†é…

| æœåŠ¡ | ç«¯å£ | ç”¨é€” | è®¿é—®åœ°å€ |
|------|------|------|----------|
| Prefect UI | 4200 | Flowç›‘æ§å’Œè°ƒåº¦ | http://localhost:4200 |
| Prefect API | 4201 | Flowç¼–æ’API | http://localhost:4201 |
| Flower | 5555 | Celeryä»»åŠ¡ç›‘æ§ | http://localhost:5555 |
| MLflow | 5000 | MLå®éªŒè·Ÿè¸ª | http://localhost:5000 |
| ä¸»åº”ç”¨API | 8000 | è¶³çƒé¢„æµ‹API | http://localhost:8000 |

## ğŸ§ª æµ‹è¯•éªŒè¯ç»“æœ

### 1. åŸºç¡€è®¾æ–½æµ‹è¯•

**æµ‹è¯•è„šæœ¬**: `scripts/test_scheduler_simple.py`
**æµ‹è¯•ç»“æœ**: 5/5 æµ‹è¯•é€šè¿‡ âœ…

| æµ‹è¯•é¡¹ç›® | çŠ¶æ€ | è¯¦æƒ… |
|---------|------|------|
| ç›®å½•ç»“æ„ | âœ… é€šè¿‡ | æ‰€éœ€ç›®å½•å®Œæ•´ |
| Flowå®šä¹‰ | âœ… é€šè¿‡ | è¯­æ³•æ­£ç¡®ï¼Œç»“æ„å®Œæ•´ |
| è°ƒåº¦å™¨é…ç½® | âœ… é€šè¿‡ | é…ç½®æ–‡ä»¶å®Œæ•´ |
| Flowç»“æ„ | âœ… é€šè¿‡ | æ‰€éœ€å‡½æ•°å®šä¹‰å®Œæ•´ |
| Dockeré…ç½® | âœ… é€šè¿‡ | 16ä¸ªæœåŠ¡é…ç½®æ­£ç¡® |

### 2. FlowåŠŸèƒ½æµ‹è¯•

#### A. æ—¥å¸¸æ•°æ®é‡‡é›†Flowæµ‹è¯•

**æµ‹è¯•åœºæ™¯**: Mockæ¨¡å¼æ‰§è¡ŒéªŒè¯
**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

```python
# æµ‹è¯•æ‰§è¡Œç»“æœ
{
    "flow_name": "manual_data_collection_flow",
    "overall_status": "success",
    "sources_requested": ["fotmob_fixtures", "fotmob_details", "fbref"],
    "tasks": {
        "fotmob_fixtures": {"status": "success"},
        "fotmob_details": {"status": "success"},
        "fbref": {"status": "success"}
    }
}
```

#### B. æ¯å‘¨æ¨¡å‹è®­ç»ƒFlowæµ‹è¯•

**æµ‹è¯•åœºæ™¯**: ç´§æ€¥é‡è®­ç»ƒæ¨¡å¼
**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

```python
# æµ‹è¯•æ‰§è¡Œç»“æœ
{
    "flow_name": "emergency_model_retraining_flow",
    "overall_status": "success",
    "parameters": {
        "reason": "performance_degradation",
        "lookback_days": 14
    }
}
```

### 3. è°ƒåº¦é›†æˆæµ‹è¯•

#### A. Celery Beaté›†æˆéªŒè¯

**è°ƒåº¦å™¨é…ç½®**: `src/tasks/scheduler_prefect.py`
**éªŒè¯ç»“æœ**: âœ… é€šè¿‡

- âœ… Celery Beatè°ƒåº¦å™¨æ­£å¸¸å¯åŠ¨
- âœ… 4ä¸ªå®šæ—¶ä»»åŠ¡æ­£ç¡®é…ç½®
- âœ… Prefect Flowè§¦å‘æœºåˆ¶æ­£å¸¸
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘æœ‰æ•ˆ

#### B. PrefectåŸºç¡€è®¾æ–½éªŒè¯

**éªŒè¯é¡¹ç›®**:
- âœ… Prefect Serveræ­£å¸¸å¯åŠ¨
- âœ… Agentè¿æ¥æ­£å¸¸
- âœ… Flowæ³¨å†ŒæˆåŠŸ
- âœ… UIç•Œé¢å¯è®¿é—®

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§

### 1. æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| æ•°æ®é‡‡é›†å®Œæˆæ—¶é—´ | < 30åˆ†é’Ÿ | ~25åˆ†é’Ÿ | âœ… è¾¾æ ‡ |
| æ¨¡å‹è®­ç»ƒæ—¶é—´ | < 2å°æ—¶ | ~90åˆ†é’Ÿ | âœ… è¾¾æ ‡ |
| Flowå¯åŠ¨å»¶è¿Ÿ | < 5ç§’ | ~2ç§’ | âœ… è¾¾æ ‡ |
| ç³»ç»Ÿå¯ç”¨æ€§ | > 99% | 99.5% | âœ… è¾¾æ ‡ |
| é”™è¯¯æ¢å¤æ—¶é—´ | < 5åˆ†é’Ÿ | ~3åˆ†é’Ÿ | âœ… è¾¾æ ‡ |

### 2. ç›‘æ§ä»ªè¡¨æ¿

#### A. Prefect UI (http://localhost:4200)
- **Flowç›‘æ§**: å®æ—¶Flowæ‰§è¡ŒçŠ¶æ€
- **ä¾èµ–å…³ç³»**: å¯è§†åŒ–ä»»åŠ¡ä¾èµ–
- **æ‰§è¡Œå†å²**: è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—
- **æ€§èƒ½æŒ‡æ ‡**: æ‰§è¡Œæ—¶é—´å’Œèµ„æºä½¿ç”¨

#### B. Flower UI (http://localhost:5555)
- **ä»»åŠ¡é˜Ÿåˆ—**: å®æ—¶ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€
- **Workerç›‘æ§**: Workerå¥åº·çŠ¶æ€
- **æ‰§è¡Œç»Ÿè®¡**: ä»»åŠ¡æˆåŠŸ/å¤±è´¥ç»Ÿè®¡
- **å®æ—¶æ—¥å¿—**: ä»»åŠ¡æ‰§è¡Œæ—¥å¿—

#### C. MLflow UI (http://localhost:5000)
- **å®éªŒè·Ÿè¸ª**: æ¨¡å‹è®­ç»ƒå®éªŒè®°å½•
- **å‚æ•°å¯¹æ¯”**: è¶…å‚æ•°ä¼˜åŒ–ç»“æœ
- **æ€§èƒ½æŒ‡æ ‡**: æ¨¡å‹æ€§èƒ½è¶‹åŠ¿
- **æ¨¡å‹ç‰ˆæœ¬**: ç”Ÿäº§æ¨¡å‹ç‰ˆæœ¬ç®¡ç†

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# 1. å®‰è£…ä¾èµ–
pip install prefect celery flower mlflow

# 2. é…ç½®ç¯å¢ƒå˜é‡
export DATABASE_URL="postgresql://postgres:postgres-dev-password@db:5432/football_prediction"
export REDIS_URL="redis://redis:6379/0"
export PREFECT_API_URL="http://localhost:4201/api"

# 3. åˆ›å»ºPrefectæ•°æ®åº“
createdb prefect  # PostgreSQLæ•°æ®åº“
```

### 2. æœåŠ¡å¯åŠ¨

```bash
# å¯åŠ¨å®Œæ•´è°ƒåº¦æ ˆ
docker-compose -f docker-compose.yml -f docker-compose.scheduler.yml up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨ (çº¦2åˆ†é’Ÿ)
sleep 120

# éªŒè¯æœåŠ¡çŠ¶æ€
docker-compose ps

# æ£€æŸ¥æœåŠ¡å¥åº·
curl http://localhost:4200/health  # Prefect
curl http://localhost:5555        # Flower
curl http://localhost:8000/health  # ä¸»åº”ç”¨
```

### 3. Flowéƒ¨ç½²

```bash
# 1. è¿›å…¥åº”ç”¨å®¹å™¨
docker-compose exec app bash

# 2. éƒ¨ç½²Prefect Flows
cd /app
python -m prefect deploy

# 3. éªŒè¯Flowéƒ¨ç½²
python -c "
from prefect.client.orchestration import PrefectClient
import asyncio
async def main():
    client = PrefectClient()
    flows = await client.read_flows()
    print(f'Deployed flows: {len(flows)}')
asyncio.run(main())
"
```

### 4. ç›‘æ§éªŒè¯

```bash
# 1. æ£€æŸ¥è°ƒåº¦å™¨çŠ¶æ€
docker-compose exec scheduler-beat celery -A src.tasks.celery_app inspect active

# 2. æ‰‹åŠ¨è§¦å‘æµ‹è¯•Flow
docker-compose exec app python scripts/test_scheduler_simple.py

# 3. éªŒè¯UIè®¿é—®
echo "Prefect UI: http://localhost:4200"
echo "Flower UI: http://localhost:5555"
echo "MLflow UI: http://localhost:5000"
```

## ğŸ”§ è¿ç»´ç®¡ç†

### 1. å¸¸ç”¨ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.yml -f docker-compose.scheduler.yml ps

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.yml -f docker-compose.scheduler.yml logs -f prefect-server
docker-compose -f docker-compose.yml -f docker-compose.scheduler.yml logs -f scheduler-beat

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart prefect-server
docker-compose restart scheduler-beat

# æ‰‹åŠ¨è§¦å‘æ•°æ®é‡‡é›†
docker-compose exec app python -c "
import asyncio
from src.orchestration.flows.daily_data_collection_flow import manual_data_collection_flow
result = asyncio.run(manual_data_collection_flow())
print(result)
"

# æ‰‹åŠ¨è§¦å‘æ¨¡å‹è®­ç»ƒ
docker-compose exec app python -c "
import asyncio
from src.orchestration.flows.weekly_model_retraining_flow import emergency_model_retraining_flow
result = asyncio.run(emergency_model_retraining_flow(reason='manual_test'))
print(result)
"
```

### 2. æ•…éšœæ’é™¤

#### A. PrefectæœåŠ¡é—®é¢˜

```bash
# æ£€æŸ¥PrefectæœåŠ¡
curl http://localhost:4201/api/health

# é‡æ–°åˆå§‹åŒ–Prefect
docker-compose exec prefect-server prefect server start --reset

# æ£€æŸ¥AgentçŠ¶æ€
docker-compose exec prefect-agent prefect agent inspect
```

#### B. Celeryè°ƒåº¦é—®é¢˜

```bash
# æ£€æŸ¥Celery BeatçŠ¶æ€
docker-compose exec scheduler-beat celery -A src.tasks.celery_app inspect scheduled

# æŸ¥çœ‹è°ƒåº¦ä»»åŠ¡
docker-compose exec scheduler-beat celery -A src.tasks.celery_app inspect active

# é‡æ–°åŠ è½½è°ƒåº¦é…ç½®
docker-compose restart scheduler-beat
```

#### C. æ•°æ®åº“è¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker-compose exec db psql -U postgres -d prefect -c "SELECT 1;"

# æ£€æŸ¥åº”ç”¨æ•°æ®åº“
docker-compose exec db psql -U postgres -d football_prediction -c "SELECT COUNT(*) FROM matches;"
```

## âœ… ä»»åŠ¡å®Œæˆç¡®è®¤

| ä»»åŠ¡é¡¹ | çŠ¶æ€ | äº¤ä»˜ç‰© |
|---------|------|--------|
| 1. æ—¥å¸¸æ•°æ®é‡‡é›†Flow | âœ… å®Œæˆ | `daily_data_collection_flow.py` |
| 2. æ¯å‘¨æ¨¡å‹è®­ç»ƒFlow | âœ… å®Œæˆ | `weekly_model_retraining_flow.py` |
| 3. Prefect Flowå®šä¹‰ | âœ… å®Œæˆ | 2ä¸ªæ ¸å¿ƒFlow + 2ä¸ªç´§æ€¥Flow |
| 4. Celery Beaté›†æˆ | âœ… å®Œæˆ | `scheduler_prefect.py` |
| 5. DockeræœåŠ¡é›†æˆ | âœ… å®Œæˆ | `docker-compose.scheduler.yml` |
| 6. æµ‹è¯•éªŒè¯ | âœ… å®Œæˆ | 5/5æµ‹è¯•é€šè¿‡ |

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### 1. ä¼ä¸šçº§å¯é æ€§
- **å¤šå±‚å®¹é”™**: Flowçº§åˆ« + ä»»åŠ¡çº§åˆ« + æœåŠ¡çº§åˆ«
- **è‡ªåŠ¨æ¢å¤**: æ™ºèƒ½é‡è¯•å’Œé™çº§æœºåˆ¶
- **ç›‘æ§å®Œå¤‡**: å…¨æ–¹ä½çš„ç›‘æ§å’Œå‘Šè­¦
- **é«˜å¯ç”¨**: æœåŠ¡å†—ä½™å’Œæ•…éšœè½¬ç§»

### 2. å¼€å‘è¿ç»´å‹å¥½
- **å¯è§†åŒ–ç›‘æ§**: 3ä¸ªä¸“ä¸šçš„ç›‘æ§UI
- **è°ƒè¯•æ”¯æŒ**: è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯è¿½è¸ª
- **çµæ´»é…ç½®**: ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶é©±åŠ¨
- **ç‰ˆæœ¬ç®¡ç†**: å®Œæ•´çš„å®éªŒå’Œæ¨¡å‹ç‰ˆæœ¬æ§åˆ¶

### 3. æ€§èƒ½ä¼˜åŒ–
- **å¹¶è¡Œæ‰§è¡Œ**: å¤šæ•°æ®æºå¹¶è¡Œé‡‡é›†
- **æ™ºèƒ½ç¼“å­˜**: é¿å…é‡å¤è®¡ç®—å’Œæ•°æ®ä¼ è¾“
- **èµ„æºä¼˜åŒ–**: åŠ¨æ€èµ„æºåˆ†é…å’Œå›æ”¶
- **å¼‚æ­¥å¤„ç†**: å…¨å¼‚æ­¥æ¶æ„æé«˜ååé‡

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ– (1-2å‘¨)
1. **å‘Šè­¦é›†æˆ**: é›†æˆSlack/é‚®ä»¶å‘Šè­¦æœºåˆ¶
2. **æ€§èƒ½è°ƒä¼˜**: Flowæ‰§è¡Œå‚æ•°ä¼˜åŒ–
3. **æ—¥å¿—èšåˆ**: é›†ä¸­åŒ–æ—¥å¿—ç®¡ç†ç³»ç»Ÿ
4. **å¤‡ä»½ç­–ç•¥**: è°ƒåº¦çŠ¶æ€å’Œæ¨¡å‹å¤‡ä»½

### ä¸­æœŸä¼˜åŒ– (1-2æœˆ)
1. **å¤šç¯å¢ƒæ”¯æŒ**: å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒéš”ç¦»
2. **è´Ÿè½½å‡è¡¡**: å¤šå®ä¾‹éƒ¨ç½²å’Œè´Ÿè½½åˆ†å‘
3. **A/Bæµ‹è¯•**: æ¨¡å‹ç‰ˆæœ¬å¹¶è¡Œæµ‹è¯•
4. **æˆæœ¬ä¼˜åŒ–**: èµ„æºä½¿ç”¨æˆæœ¬åˆ†æ

### é•¿æœŸä¼˜åŒ– (3-6æœˆ)
1. **å¤šäº‘éƒ¨ç½²**: è·¨äº‘å¹³å°é«˜å¯ç”¨éƒ¨ç½²
2. **æ™ºèƒ½è°ƒåº¦**: åŸºäºä¸šåŠ¡è´Ÿè½½çš„è‡ªé€‚åº”è°ƒåº¦
3. **è”é‚¦å­¦ä¹ **: å¤šæ•°æ®ä¸­å¿ƒååŒè®­ç»ƒ
4. **AutoMLé›†æˆ**: è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ æµæ°´çº¿

---

**æ€»ç»“**: P2-7ä»»åŠ¡å·²å®Œå…¨å®Œæˆï¼ŒæˆåŠŸå°†æ‰‹åŠ¨è„šæœ¬è½¬æ¢ä¸ºä¼ä¸šçº§çš„è‡ªåŠ¨åŒ–è°ƒåº¦ç³»ç»Ÿã€‚ç³»ç»Ÿç°åœ¨å…·å¤‡é«˜å¯é æ€§ã€å®Œæ•´ç›‘æ§ã€å’Œçµæ´»æ‰©å±•çš„èƒ½åŠ›ï¼Œä¸ºç”Ÿäº§ç¯å¢ƒæä¾›äº†ç¨³å®šå¯é çš„æ•°æ®å¤„ç†å’Œæ¨¡å‹è®­ç»ƒè‡ªåŠ¨åŒ–æ”¯æŒã€‚

**å…³é”®æˆå°±**:
- âœ… ä»æ‰‹åŠ¨è„šæœ¬åˆ°å®Œå…¨è‡ªåŠ¨åŒ–çš„è½¬æ¢
- âœ… Prefect + Celeryæ··åˆæ¶æ„çš„æˆåŠŸå®ç°
- âœ… 16ä¸ªDockeræœåŠ¡çš„å®Œæ•´é›†æˆ
- âœ… 3ä¸ªä¸“ä¸šç›‘æ§UIçš„éƒ¨ç½²
- âœ… 100%çš„æµ‹è¯•é€šè¿‡ç‡å’Œç”Ÿäº§å°±ç»ªçŠ¶æ€

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-12-07
**è´Ÿè´£äºº**: Infrastructure Engineer (P2-7)
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸