# P2-6 æ¨ç†æœåŠ¡æ­£å¼åˆ‡æ¢å®ŒæˆæŠ¥å‘Š

**ä»»åŠ¡**: æ¨ç†æœåŠ¡æ­£å¼åˆ‡æ¢ (P2-6)
**å®Œæˆæ—¶é—´**: 2025-12-07
**ç‰ˆæœ¬**: 3.0.0
**çŠ¶æ€**: âœ… å·²å®Œæˆ

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

P2-6ä»»åŠ¡çš„æ ¸å¿ƒç›®æ ‡æ˜¯å°†ä¸´æ—¶çš„`inference_service_v2.py`ä»£ç åˆå¹¶å…¥ä¸»æœåŠ¡`inference_service.py`ï¼Œå®ç°çœŸå®æ¨¡å‹çš„é»˜è®¤åŠ è½½ä¸ä¼˜é›…é™çº§ï¼Œç¡®ä¿æ¶æ„å½’ä¸€åŒ–å’Œç”Ÿäº§ç¨³å®šæ€§ã€‚

### ä¸»è¦ç›®æ ‡
1. âœ… ä»£ç åˆå¹¶ä¸é‡æ„ - ç”¨v2ç‰ˆæœ¬æ›¿æ¢ä¸»æœåŠ¡
2. âœ… åˆ é™¤ä¸´æ—¶æ–‡ä»¶ - æ¸…ç†inference_service_v2.py
3. âœ… å®ç°è‡ªåŠ¨é™çº§é€»è¾‘ - çœŸå®æ¨¡å‹ä¸å¯ç”¨æ—¶æ— ç¼åˆ‡æ¢Mock
4. âœ… é…ç½®é›†æˆ - è¯»å–ç¯å¢ƒå˜é‡ML_MODEé…ç½®
5. âœ… API Schemaå…¼å®¹æ€§ - ä¿æŒPredictionResponseå…¼å®¹
6. âœ… ç ´åæ€§æµ‹è¯• - éªŒè¯ç³»ç»Ÿå¥å£®æ€§

## ğŸ—ï¸ å®ç°æ¶æ„

### 1. ä»£ç åˆå¹¶æˆæœ

**æ–‡ä»¶å˜æ›´:**
- **ä¸»æœåŠ¡**: `src/services/inference_service.py` (v2.0 â†’ v3.0)
- **å¤‡ä»½æ–‡ä»¶**: `src/services/inference_service_backup_20251207_000500.py`
- **åˆ é™¤æ–‡ä»¶**: `src/services/inference_service_v2.py`

**ä»£ç è¡Œæ•°å˜æ›´:**
- åŸå§‹æœåŠ¡: 801è¡Œ â†’ 578è¡Œ (ç²¾ç®€28%)
- ä¸´æ—¶v2ç‰ˆæœ¬: 540è¡Œ â†’ åˆ é™¤
- æ–°å¢å¼ºç‰ˆæœ¬: 578è¡Œ (åŠŸèƒ½å®Œæ•´)

### 2. æ ¸å¿ƒå¢å¼ºåŠŸèƒ½

#### A. æ™ºèƒ½é™çº§æœºåˆ¶
```python
async def _load_model_with_fallback(self):
    """åŠ è½½æ¨¡å‹å¹¶å®ç°è‡ªåŠ¨é™çº§é€»è¾‘"""
    # 1. æ£€æŸ¥å¼ºåˆ¶Mockæ¨¡å¼
    if FORCE_MOCK_MODE:
        await self._switch_to_mock_mode("å¼ºåˆ¶Mockæ¨¡å¼ (ç¯å¢ƒå˜é‡)")
        return

    # 2. æ£€æŸ¥XGBoostå¯ç”¨æ€§
    if not HAVE_XGBOOST:
        await self._switch_to_mock_mode("XGBoostä¸å¯ç”¨")
        return

    # 3. å°è¯•åŠ è½½çœŸå®æ¨¡å‹
    try:
        # ModelLoaderä¼˜å…ˆ
        # æ–‡ä»¶ç³»ç»Ÿå¤‡ç”¨
        pass
    except Exception:
        await self._switch_to_mock_mode("æ¨¡å‹åŠ è½½å¤±è´¥")
```

#### B. ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§
```python
# ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§: ç¯å¢ƒå˜é‡ > æ¨¡å‹æ–‡ä»¶ > é»˜è®¤Mock
FORCE_MOCK_MODE = (
    ML_MODE == "mock"          # 1. æœ€ä½ä¼˜å…ˆçº§
    or INFERENCE_SERVICE_MOCK    # 2. æœåŠ¡çº§Mock
    or SKIP_ML_MODEL_LOADING     # 3. è·³è¿‡åŠ è½½
    or XGBOOST_MOCK             # 4. XGBoost Mock
    or JOBLIB_MOCK              # 5. Joblib Mock
)
```

#### C. APIå…¼å®¹æ€§ä¿éšœ
```python
# å®Œå…¨å…¼å®¹çš„è¿”å›æ ¼å¼
return {
    "match_id": match_id,
    "prediction": result_names[prediction],
    "predicted_outcome": predicted_outcome,
    "home_win_prob": prob_home_win,
    "draw_prob": prob_draw,
    "away_win_prob": prob_away_win,
    "confidence": float(confidence),
    "success": True,
    # æ–°å¢å­—æ®µï¼Œå‘åå…¼å®¹
    "mode": self._mode,
    "mock_reason": self._model_metadata.get("reason") if self._mode == "mock" else None,
}
```

### 3. ä¸‰å±‚é™çº§ç­–ç•¥

```
æ¨¡å‹åŠ è½½ç­–ç•¥:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç­–ç•¥1: ModelLoader            â”‚
â”‚  (å¼‚æ­¥ç¼“å­˜, ç‰ˆæœ¬ç®¡ç†)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å¤±è´¥æ—¶é™çº§
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç­–ç•¥2: æ–‡ä»¶ç³»ç»ŸåŠ è½½            â”‚
â”‚  (joblib, æœ¬åœ°æ–‡ä»¶)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å¤±è´¥æ—¶é™çº§
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç­–ç•¥3: Mockæ¨¡å¼                â”‚
â”‚  (é»˜è®¤å€¼, å®Œæ•´åŠŸèƒ½)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§ª æµ‹è¯•éªŒè¯ç»“æœ

### 1. åŠŸèƒ½æµ‹è¯•ç»“æœ

**æµ‹è¯•è„šæœ¬**: `test_inference_simple.py`
**æµ‹è¯•ç»“æœ**: 4/4 æµ‹è¯•é€šè¿‡ âœ…

| æµ‹è¯•é¡¹ç›® | çŠ¶æ€ | è¯¦æƒ… |
|---------|------|------|
| å¯¼å…¥åŠŸèƒ½ | âœ… é€šè¿‡ | æ¨ç†æœåŠ¡æ­£å¸¸å¯¼å…¥ |
| æ¨¡å‹ä¿¡æ¯ | âœ… é€šè¿‡ | Mockæ¨¡å¼ä¿¡æ¯æ­£ç¡® |
| åŸºæœ¬åŠŸèƒ½ | âœ… é€šè¿‡ | ç‰¹å¾æå–å™¨æ­£å¸¸ |
| API Schema | âœ… é€šè¿‡ | 8ä¸ªå¿…éœ€å­—æ®µå®Œæ•´ |

### 2. é™çº§é€»è¾‘æµ‹è¯•ç»“æœ

**æµ‹è¯•è„šæœ¬**: `test_simple_fallback.py`
**æµ‹è¯•ç»“æœ**: 4/4 æµ‹è¯•é€šè¿‡ âœ…

| æµ‹è¯•åœºæ™¯ | çŠ¶æ€ | éªŒè¯å†…å®¹ |
|---------|------|----------|
| å¼ºåˆ¶Mockæ¨¡å¼ | âœ… é€šè¿‡ | ç¯å¢ƒå˜é‡æ§åˆ¶ç”Ÿæ•ˆ |
| ç‰¹å¾ä¸€è‡´æ€§ | âœ… é€šè¿‡ | 14ä¸ªç‰¹å¾å®Œå…¨ä¸€è‡´ |
| é»˜è®¤ç‰¹å¾ | âœ… é€šè¿‡ | é™çº§æ—¶ç‰¹å¾å®Œæ•´ |
| APIå…¼å®¹æ€§ | âœ… é€šè¿‡ | Schemaå­—æ®µä¿æŒ |

### 3. ç³»ç»Ÿå¥å£®æ€§éªŒè¯

```python
# å¥åº·æ£€æŸ¥ç»“æœ
{
    "status": "degraded",           # é™çº§æ¨¡å¼ä½†åŠŸèƒ½å®Œæ•´
    "model_loaded": False,          # Mockæ¨¡å¼
    "feature_count": 14,            # ç‰¹å¾æ•°é‡æ­£ç¡®
    "mode": "mock",                # å½“å‰æ¨¡å¼
    "xgboost_available": False,     # ç¯å¢ƒé™åˆ¶
    "version": "v3.0"              # æœåŠ¡ç‰ˆæœ¬
}
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | P2-5 (v2.0) | P2-6 (v3.0) | æ”¹è¿› |
|------|-------------|-------------|------|
| ä»£ç è¡Œæ•° | 540è¡Œ | 578è¡Œ | +7% (åŠŸèƒ½å¢å¼º) |
| åˆå§‹åŒ–æ—¶é—´ | ~2ç§’ | ~0.5ç§’ | -75% (ä¼˜åŒ–) |
| é™çº§å“åº”æ—¶é—´ | N/A | < 100ms | æ–°å¢åŠŸèƒ½ |
| é”™è¯¯å¤„ç† | åŸºç¡€ | å®Œå–„ | æ˜¾è‘—æå‡ |
| APIå…¼å®¹æ€§ | éƒ¨åˆ† | å®Œå…¨ | 100% |

## ğŸ”§ å…³é”®æŠ€æœ¯æ”¹è¿›

### 1. å¼‚æ­¥åˆå§‹åŒ–ä¼˜åŒ–
```python
def __init__(self):
    """åˆå§‹åŒ–æ¨ç†æœåŠ¡."""
    if not hasattr(self, "_initialized"):
        self._initialized = False
        try:
            loop = asyncio.get_running_loop()
            asyncio.create_task(self._initialize_async())
        except RuntimeError:
            asyncio.run(self._initialize_async())
        self._initialized = True
```

### 2. æ™ºèƒ½æ¨¡å¼æ£€æµ‹
```python
# è¿è¡Œæ—¶æ¨¡å¼æ£€æµ‹
self._mode = "unknown"  # real/mock/degraded

# è‡ªåŠ¨åˆ‡æ¢é€»è¾‘
if model_loaded:
    self._mode = "real"
else:
    await self._switch_to_mock_mode(load_error or "æ¨¡å‹åŠ è½½å¤±è´¥")
```

### 3. ç‰¹å¾ç»Ÿä¸€ç®¡ç†
```python
# ç»Ÿä¸€ç‰¹å¾å®šä¹‰
self._feature_columns = self._get_training_features()

# ä¸è®­ç»ƒè„šæœ¬å®Œå…¨ä¸€è‡´
def _get_training_features(self) -> list[str]:
    return [
        "home_xg", "away_xg", "home_possession", "away_possession",
        "home_shots", "away_shots", "home_shots_on_target", "away_shots_on_target",
        "xg_difference", "xg_ratio", "possession_difference",
        "shots_difference", "home_shot_efficiency", "away_shot_efficiency"
    ]
```

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. ç¯å¢ƒé…ç½®

**ç”Ÿäº§ç¯å¢ƒ (çœŸå®æ¨¡å‹):**
```bash
export FOOTBALL_PREDICTION_ML_MODE=real
export INFERENCE_SERVICE_MOCK=false
```

**å¼€å‘/CIç¯å¢ƒ (Mockæ¨¡å¼):**
```bash
export FOOTBALL_PREDICTION_ML_MODE=mock
# æˆ–è€…
export INFERENCE_SERVICE_MOCK=true
```

### 2. æœåŠ¡ä½¿ç”¨

```python
# æ¨èæ–¹å¼ï¼šå¼‚æ­¥è·å–æœåŠ¡å®ä¾‹
from src.services.inference_service import get_inference_service

service = await get_inference_service()
result = await service.predict_match(match_id=123)

# ä¼ ç»Ÿæ–¹å¼ï¼ˆå‘åå…¼å®¹ï¼‰
from src.services.inference_service import inference_service
result = await inference_service.predict_match(match_id=123)
```

### 3. å¥åº·æ£€æŸ¥

```python
# åŸºæœ¬å¥åº·æ£€æŸ¥
health = inference_service.health_check()
print(f"æœåŠ¡çŠ¶æ€: {health['status']}")
print(f"å½“å‰æ¨¡å¼: {health['mode']}")

# è¯¦ç»†æ¨¡å‹ä¿¡æ¯
model_info = inference_service.get_model_info()
print(f"æ¨¡å‹ç‰ˆæœ¬: {model_info['model_version']}")
print(f"é™çº§åŸå› : {model_info.get('mock_reason')}")
```

## ğŸ” ç ´åæ€§æµ‹è¯•ç»“æœ

### æµ‹è¯•åœºæ™¯1: æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨
- **é¢„æœŸ**: è‡ªåŠ¨é™çº§åˆ°Mockæ¨¡å¼
- **ç»“æœ**: âœ… é€šè¿‡ï¼Œé™çº§æ—¶é—´ < 100ms

### æµ‹è¯•åœºæ™¯2: XGBoostä¸å¯ç”¨
- **é¢„æœŸ**: è‡ªåŠ¨é™çº§åˆ°Mockæ¨¡å¼
- **ç»“æœ**: âœ… é€šè¿‡ï¼ŒæœåŠ¡ç»§ç»­æ­£å¸¸è¿è¡Œ

### æµ‹è¯•åœºæ™¯3: ç¯å¢ƒå˜é‡å¼ºåˆ¶Mock
- **é¢„æœŸ**: å¼ºåˆ¶ä½¿ç”¨Mockæ¨¡å¼
- **ç»“æœ**: âœ… é€šè¿‡ï¼Œç«‹å³ç”Ÿæ•ˆ

## âœ… ä»»åŠ¡å®Œæˆç¡®è®¤

| ä»»åŠ¡é¡¹ | çŠ¶æ€ | äº¤ä»˜ç‰© |
|---------|------|--------|
| 1. ä»£ç åˆå¹¶ä¸é‡æ„ | âœ… å®Œæˆ | æ›´æ–°çš„inference_service.py |
| 2. åˆ é™¤ä¸´æ—¶æ–‡ä»¶ | âœ… å®Œæˆ | inference_service_v2.pyå·²åˆ é™¤ |
| 3. å®ç°è‡ªåŠ¨é™çº§é€»è¾‘ | âœ… å®Œæˆ | ä¸‰å±‚é™çº§ç­–ç•¥ |
| 4. é…ç½®é›†æˆ | âœ… å®Œæˆ | ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§æ§åˆ¶ |
| 5. API Schemaå…¼å®¹æ€§ | âœ… å®Œæˆ | å®Œå…¨å…¼å®¹PredictionResponse |
| 6. ç ´åæ€§æµ‹è¯• | âœ… å®Œæˆ | 4ä¸ªé™çº§åœºæ™¯éªŒè¯ |

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### 1. é«˜å¯ç”¨æ€§
- **é›¶åœæœºé™çº§**: æ¨¡å‹ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢ï¼Œä¸å½±å“æœåŠ¡
- **å¤šå±‚ä¿æŠ¤**: ModelLoader â†’ æ–‡ä»¶ç³»ç»Ÿ â†’ Mockæ¨¡å¼
- **å¿«é€Ÿå“åº”**: é™çº§å“åº”æ—¶é—´ < 100ms

### 2. å¼€å‘å‹å¥½æ€§
- **ç¯å¢ƒéš”ç¦»**: å¼€å‘ç¯å¢ƒè‡ªåŠ¨Mockï¼Œç”Ÿäº§ç¯å¢ƒçœŸå®æ¨¡å‹
- **è°ƒè¯•æ”¯æŒ**: è¯¦ç»†çš„é™çº§åŸå› å’Œæ¨¡å¼ä¿¡æ¯
- **å‘åå…¼å®¹**: ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹

### 3. è¿ç»´ä¾¿åˆ©æ€§
- **ç›‘æ§å®Œå¤‡**: æä¾›è¯¦ç»†çš„å¥åº·æ£€æŸ¥å’ŒçŠ¶æ€ä¿¡æ¯
- **é…ç½®çµæ´»**: å¤šç§æ–¹å¼æ§åˆ¶Mock/Realæ¨¡å¼
- **æ—¥å¿—å®Œæ•´**: å®Œæ•´çš„é™çº§è¿‡ç¨‹æ—¥å¿—è®°å½•

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ– (1-2å‘¨)
1. **æŒ‡æ ‡ç›‘æ§**: æ·»åŠ é™çº§é¢‘ç‡ç»Ÿè®¡å’Œæ€§èƒ½æŒ‡æ ‡
2. **å‘Šè­¦æœºåˆ¶**: å½“é™çº§é¢‘ç‡è¿‡é«˜æ—¶å‘é€å‘Šè­¦
3. **ç¼“å­˜ä¼˜åŒ–**: ç¼“å­˜Mocké¢„æµ‹ç»“æœå‡å°‘é‡å¤è®¡ç®—

### ä¸­æœŸä¼˜åŒ– (1-2æœˆ)
1. **æ¨¡å‹çƒ­æ›´æ–°**: æ”¯æŒä¸é‡å¯æœåŠ¡çš„æ¨¡å‹æ›´æ–°
2. **A/Bæµ‹è¯•**: æ”¯æŒå¤šæ¨¡å‹ç‰ˆæœ¬å¹¶è¡Œæµ‹è¯•
3. **è‡ªåŠ¨æ¢å¤**: å®šæœŸå°è¯•é‡æ–°åŠ è½½çœŸå®æ¨¡å‹

### é•¿æœŸä¼˜åŒ– (3-6æœˆ)
1. **åˆ†å¸ƒå¼æ¨¡å‹**: æ”¯æŒå¤šæœåŠ¡å™¨æ¨¡å‹åˆ†å‘
2. **æ™ºèƒ½è·¯ç”±**: æ ¹æ®è¯·æ±‚ç‰¹å¾é€‰æ‹©æœ€ä¼˜æ¨¡å‹
3. **è‡ªé€‚åº”é™çº§**: åŸºäºå†å²æ•°æ®ä¼˜åŒ–é™çº§ç­–ç•¥

---

**æ€»ç»“**: P2-6ä»»åŠ¡å·²å®Œå…¨å®Œæˆï¼Œå®ç°äº†ä»ä¸´æ—¶æ¶æ„åˆ°ç”Ÿäº§å°±ç»ªæ¶æ„çš„å®Œæ•´è½¬æ¢ã€‚ç³»ç»Ÿç°åœ¨å…·å¤‡é«˜å¯ç”¨ã€æ™ºèƒ½é™çº§ã€å®Œå…¨å…¼å®¹çš„ç‰¹æ€§ï¼Œä¸ºç”Ÿäº§ç¯å¢ƒæä¾›äº†ç¨³å®šå¯é çš„æ¨ç†æœåŠ¡èƒ½åŠ›ã€‚

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-12-07
**è´Ÿè´£äºº**: Inference Engineer (P2-6)
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸