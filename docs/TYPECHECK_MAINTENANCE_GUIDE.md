# ğŸ§© TYPECHECK_MAINTENANCE_GUIDE.md
> ç±»å‹æ£€æŸ¥ç»´æŠ¤æ‰‹å†Œï¼ˆMyPy åˆ†å±‚ç­–ç•¥æŒ‡å¼•ï¼‰

---

## ğŸ§­ ä¸€ã€æ‰§è¡Œæ‘˜è¦

æœ¬é¡¹ç›®é‡‡ç”¨ **åˆ†å±‚ç±»å‹é˜²å¾¡ä½“ç³»ï¼ˆLayered Type Defense Systemï¼‰**ï¼š
- âœ… æ ¸å¿ƒæ¨¡å—ï¼šé›¶é”™è¯¯ï¼ˆä¸¥æ ¼ç±»å‹æ£€æŸ¥ï¼‰
- âš™ï¸ è¾…åŠ©æ¨¡å—ï¼šå®½æ¾æ£€æŸ¥ï¼ˆå…è®¸éƒ¨åˆ†ç¼ºå¤±ï¼‰
- ğŸ’¤ éæ ¸å¿ƒæ¨¡å—ï¼šå¿½ç•¥æ£€æŸ¥ï¼ˆå»¶åæ¸…ç†ï¼‰

è¿™ç§ç»“æ„æ—¢ä¿è¯äº† **ç”Ÿäº§å®‰å…¨æ€§**ï¼Œåˆå…¼é¡¾ **è¿­ä»£æ•ˆç‡**ã€‚

---

## âš™ï¸ äºŒã€é…ç½®è§„èŒƒ

### 1. æ–‡ä»¶ç»“æ„

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `mypy.ini` | ä¸»é…ç½®æ–‡ä»¶ï¼ˆåˆ†å±‚è§„åˆ™å®šä¹‰ï¼‰ |
| `Makefile` | æä¾›ä¸€é”®æ‰§è¡Œ `make typecheck` |
| `.github/workflows/ci-pipeline.yml` | é›†æˆåˆ° CI æµç¨‹ |
| `docs/TYPECHECK_MAINTENANCE_GUIDE.md` | æœ¬ç»´æŠ¤æ‰‹å†Œ |

### 2. æ£€æŸ¥å‘½ä»¤åˆ†å±‚

```bash
# ä¸¥æ ¼æ¨¡å¼ï¼šæ ¸å¿ƒé€»è¾‘å¿…é¡»é›¶é”™è¯¯
mypy src/core src/services src/api --strict

# å®½æ¾æ¨¡å¼ï¼šè¾…åŠ©é€»è¾‘å¯å®¹å¿é”™è¯¯
mypy src/utils src/tasks src/monitoring || true
```

### 3. å¿½ç•¥è§„åˆ™ï¼ˆè§ mypy.iniï¼‰

```ini
exclude = (?x)(
    ^examples/|
    ^scripts/|
    _simple\.py$
)
```

---

## ğŸ§© ä¸‰ã€æ ¸å¿ƒç»´æŠ¤åŸåˆ™

| åŸåˆ™        | è¯´æ˜                   |
| --------- | -------------------- |
| **é›¶é”™è¯¯åŸåˆ™** | æ ¸å¿ƒæ¨¡å—å¿…é¡»ä¿æŒ MyPy å…¨ç»¿     |
| **æ¸è¿›å¢å¼º**  | ä»å†…å‘å¤–æ‰©å±•ç±»å‹è¦†ç›–ç‡          |
| **å¯è¯»æ€§ä¼˜å…ˆ** | ç±»å‹æ³¨è§£æ¸…æ™°å¯è¯»ï¼Œä¸ç›²ç›®å¤æ‚åŒ–      |
| **è‡ªåŠ¨åŒ–é˜²å¾¡** | æ‰€æœ‰æ£€æŸ¥çº³å…¥ CIï¼Œç¦æ­¢æ‰‹åŠ¨è·³è¿‡æ ¸å¿ƒé”™è¯¯ |
| **æŠ€æœ¯å€ºè·Ÿè¸ª** | è®°å½•ç±»å‹é”™è¯¯æ•°é‡è¶‹åŠ¿ï¼Œçº³å…¥è´¨é‡æŒ‡æ ‡    |

---

## ğŸ” å››ã€å¸¸è§é—®é¢˜ä¸ä¿®å¤ç­–ç•¥

| é—®é¢˜ç±»å‹             | ç¤ºä¾‹                                           | æ¨èå¤„ç†æ–¹å¼                                              |
| ---------------- | -------------------------------------------- | --------------------------------------------------- |
| **ç¼ºå°‘ç±»å‹æ³¨è§£**       | `def func(x): ...`                           | æ·»åŠ æ³¨è§£ï¼š`def func(x: int) -> None:`                    |
| **ç±»å‹æ¨æ–­å¤±è´¥**       | "Incompatible types in assignment"           | æ˜¾å¼å£°æ˜å˜é‡ç±»å‹                                            |
| **å¯¼å…¥ç±»å‹ç¼ºå¤±**       | "Cannot find implementation or library stub" | ä½¿ç”¨ `# type: ignore` æˆ– `ignore_missing_imports=True` |
| **å¤–éƒ¨åº“æ—  stub æ–‡ä»¶** | ç¬¬ä¸‰æ–¹åŒ…æŠ¥é”™                                       | å®‰è£…è¡¥ä¸åŒ…ï¼š`pip install types-requests` ç­‰                |
| **Union ç±»å‹ä¸å…¼å®¹**  | "Item of type None not callable"             | ä½¿ç”¨ `Optional[T]` æˆ–æ˜¾å¼åˆ¤ç©º                              |

---

## ğŸ§± äº”ã€æŒç»­æ”¹è¿›è·¯çº¿å›¾

| é˜¶æ®µ      | ç›®æ ‡                 | è¯´æ˜                  |
| ------- | ------------------ | ------------------- |
| Phase 1 | æ ¸å¿ƒæ¨¡å—é›¶é”™è¯¯            | å·²å®Œæˆ                 |
| Phase 2 | è¾…åŠ©æ¨¡å—è¡¥å…¨ç±»å‹           | é’ˆå¯¹ utils/tasks å¢å¼ºæ³¨è§£ |
| Phase 3 | æ¸…ç† examples/simple | å¯å»¶åå¤„ç†               |
| Phase 4 | å¯ç”¨å…¨å±€ strict æ¨¡å¼     | é•¿æœŸç›®æ ‡ï¼Œç±»å‹å…¨è¦†ç›–          |

---

## ğŸ§  å…­ã€è¾…åŠ©å·¥å…·æ¨è

| å·¥å…·                | åŠŸèƒ½               | å®‰è£…å‘½ä»¤                        |
| ----------------- | ---------------- | --------------------------- |
| **mypy**          | ä¸»ç±»å‹æ£€æŸ¥å·¥å…·          | `pip install mypy`          |
| **ruff**          | å¿«é€Ÿé™æ€æ£€æŸ¥ + ç±»å‹æç¤º    | `pip install ruff`          |
| **pyright**       | VS Code å®æ—¶ç±»å‹æ£€æŸ¥   | `npm install -g pyright`    |
| **mypy-protobuf** | è‡ªåŠ¨ç”Ÿæˆç±»å‹å®šä¹‰ï¼ˆå¦‚ gRPCï¼‰ | `pip install mypy-protobuf` |

---

## ğŸ“ˆ ä¸ƒã€CI é›†æˆæ£€æŸ¥é¡¹

* æ ¸å¿ƒæ¨¡å—å‡ºé”™ â†’ **é˜»æ–­æ„å»º**
* è¾…åŠ©æ¨¡å—å‡ºé”™ â†’ ä»…è®°å½•æ—¥å¿—
* æŠ¥å‘Šè¾“å‡ºåˆ° `docs/_reports/TYPECHECK_REPORT.md`
* å¯ä¸æµ‹è¯•è¦†ç›–ç‡ã€lint æŠ¥å‘Šä¸€åŒçº³å…¥è´¨é‡ä»ªè¡¨æ¿

---

## ğŸ§© å…«ã€é•¿æœŸç»´æŠ¤å»ºè®®

1. æ¯æ¬¡åˆå¹¶åˆ†æ”¯å‰æ‰§è¡Œï¼š

   ```bash
   make typecheck
   ```
2. æ¯å­£åº¦æ‰§è¡Œä¸€æ¬¡å…¨é¢ç±»å‹æ£€æŸ¥å®¡è®¡ï¼›
3. è‹¥æ–°æ¨¡å—æ·»åŠ åˆ°æ ¸å¿ƒè·¯å¾„ï¼ˆå¦‚ `src/models`ï¼‰ï¼Œè¯·æ›´æ–° mypy.iniï¼›
4. CI è‹¥å‡ºç°ç±»å‹è­¦å‘Šï¼Œä¼˜å…ˆä¿®å¤æ ¸å¿ƒæ¨¡å—ï¼›
5. æœªæ¥å¯è€ƒè™‘å¼€å¯ï¼š

   ```ini
   disallow_any_generics = True
   strict_concatenate = True
   ```

---

## ğŸ§¾ é™„å½•ï¼šè¯Šæ–­ä¸ä¿®å¤å‘½ä»¤

```bash
# æŸ¥çœ‹ç±»å‹é”™è¯¯æ€»æ•°
mypy src | grep "error:" | wc -l

# å¯¼å‡ºè¯¦ç»†æŠ¥å‘Š
mypy src --txt-report docs/_reports/mypy_report

# ä»…æ£€æµ‹æ ¸å¿ƒæ¨¡å—
mypy src/core src/services src/api --strict

# å…¨é¡¹ç›®æ‰«æï¼ˆä¸æ¨èåœ¨CIä¸­ä½¿ç”¨ï¼‰
mypy src
```

### ä¿®å¤æ¨¡æ¿

```python
# ä¿®å¤å‰
def calculate_stats(data):
    total = sum(data)
    return total

# ä¿®å¤å
from typing import List, Union

def calculate_stats(data: List[Union[int, float]]) -> float:
    """è®¡ç®—ç»Ÿè®¡æ•°æ®"""
    total = sum(data)
    return total
```

### å¿½ç•¥ç­–ç•¥

```python
# çŸ­æœŸå¿½ç•¥ï¼ˆæ·»åŠ TODOæ³¨é‡Šï¼‰
result = complex_function()  # TODO: æ·»åŠ ç±»å‹æ³¨è§£

# é•¿æœŸå¿½ç•¥ï¼ˆå¤–éƒ¨åº“é—®é¢˜ï¼‰
import third_party_lib
value = third_party_lib.magic()  # type: ignore

# æ¨¡å—çº§å¿½ç•¥ï¼ˆé—ç•™ä»£ç ï¼‰
# mypy: disable-error-code=no-untyped-def
```

---

## ğŸ“Š ç±»å‹æ£€æŸ¥æŒ‡æ ‡çœ‹æ¿

| æŒ‡æ ‡                  | å½“å‰å€¼ | ç›®æ ‡å€¼ | çŠ¶æ€   |
| ------------------- | ----- | ----- | ---- |
| æ ¸å¿ƒæ¨¡å—é”™è¯¯æ•°        | 0     | 0     | âœ…    |
| è¾…åŠ©æ¨¡å—é”™è¯¯æ•°        | 1480  | <500  | âš ï¸   |
| ç±»å‹è¦†ç›–ç‡            | 65%   | 85%   | ğŸ“ˆ   |
| æ–°å¢ä»£ç ç±»å‹æ³¨è§£ç‡     | 80%   | 95%   | ğŸ“ˆ   |
| CI ç±»å‹æ£€æŸ¥é€šè¿‡ç‡     | 100%  | 100%  | âœ…    |

---

## ğŸ”„ ç‰ˆæœ¬æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬   | æ—¥æœŸ       | æ›´æ–°å†…å®¹                     |
| ----- | --------- | -------------------------- |
| v1.0  | 2025-01-14 | åˆå§‹ç‰ˆæœ¬ï¼Œå»ºç«‹åˆ†å±‚ç±»å‹æ£€æŸ¥ä½“ç³»      |
| v1.1  | TBD       | è®¡åˆ’ï¼šå®Œå–„è¾…åŠ©æ¨¡å—ç±»å‹æ³¨è§£         |
| v2.0  | TBD       | è®¡åˆ’ï¼šå¯ç”¨å…¨å±€ strict æ¨¡å¼      |

---

**æœ€åæ›´æ–°æ—¥æœŸ**ï¼š2025-01-14

**ç»´æŠ¤äºº**ï¼šç±»å‹é˜²å¾¡å°ç»„ï¼ˆType Defense Teamï¼‰
