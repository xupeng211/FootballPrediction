# Claude Code 用户偏好和项目配置

## 🎯 用户的核心理念

> "我要先让真实的ci绿灯先跑起来，我已经很久没看到绿灯了，很打击我的信心！你先想办法把代码合并到主干，并且让我看到绿灯，我们再一步一步提高门禁"

### 开发哲学
1. **渐进式改进**：从小处着手，逐步提高标准
2. **保持 CI 绿灯**：优先确保 CI 能够通过，给开发者信心
3. **务实主义**：从当前实际情况出发，不追求完美
4. **持续优化**：在 CI 稳定运行的基础上，逐步提高质量要求

## 📊 当前项目状态（2025-10-09）

### 基础信息
- **项目性质**：足球预测系统，FastAPI + SQLAlchemy + Redis + PostgreSQL
- **开发者**：单人开发（用户是唯一开发者）
- **技术债务阶段**：当前测试覆盖率约 16.51%
- **代码质量**：约 199 个 lint 错误（主要是未使用导入和定义错误）

### 测试覆盖率配置
```yaml
CI 环境: 30%      # 最近从 20% 提升到 30%
开发环境: 20%     # 本地开发要求
最低覆盖率: 15%   # 绝对最低门槛
当前实际: ~16.51% # 仍需努力
```

## 🚀 用户接受的 Best Practices

### 1. 开发工作流程
```bash
# ✅ 推荐流程
./scripts/quality-check.sh  # 提交前快速检查
make prepush                # 完整检查（如有可能）
git commit -m "message"     # 提交（不使用 --no-verify）
git push                    # 推送

# ❌ 避免使用
git push --no-verify        # 只在紧急情况下使用
```

### 2. 质量改进节奏
- **每周**：测试覆盖率提高 5%
- **每次提交**：不增加新的 lint 错误
- **优先级**：先修复阻塞 CI 的错误

### 3. 错误处理原则
1. **阻塞性错误**：立即修复（影响 CI 运行）
2. **核心模块错误**：高优先级（src/core, src/api）
3. **测试文件错误**：中优先级
4. **工具脚本错误**：低优先级

## 📋 重要约束和偏好

### 绝对禁止
- 硬编码任何密钥、密码、令牌
- 直接运行 pytest（必须使用 Makefile 命令）
- 提交前不运行任何检查

### 必须遵守
- 所有业务逻辑必须在 Service 层
- 必须使用项目的 KeyManager 系统
- 使用结构化日志记录
- 继承 EnhancedBaseService

### 用户偏好
1. **保持简洁**：不要过度设计
2. **实用性优先**：能跑起来比完美更重要
3. **渐进式改进**：小步快跑，持续优化
4. **CI 绿灯优先**：先看到绿灯，再提高标准

## 🔄 已完成的改进历程

### Phase 1: 修复 CI 基础问题
- 降低了覆盖率门槛（80% → 20%）
- 修复了关键导入错误
- CI 首次亮起绿灯 ✅

### Phase 2: 逐步提高标准
- 覆盖率门槛：20% → 30%
- 修复了部分 lint 错误
- 更新了过时的 actions 版本
- CI 再次通过 ✅

### Phase 3: 优化工作流程（2025-10-09）
- 清理项目根目录，创建干净环境（76个文件）
- 采用务实的工作流，减少对 --no-verify 的依赖
- 创建快速健康检查工具
- 建立质量仪表板和反馈机制

## 🎯 下一步计划

### 新的工作流（2025-10-09起采用）

#### 核心原则
1. **不让情况变得更糟**：每次提交不增加新的失败测试
2. **快速反馈**：本地先检查，不要等CI发现错误
3. **渐进式改进**：每周提高一点点
4. **零技术债务**：每次提交让项目变好一点点

#### 日常开发流程
```bash
# 每30分钟
./scripts/quick-health-check.sh  # 5秒快速检查

# 提交前（必须）
ruff check src/ --fix            # 自动修复lint
python -m py_compile src/main.py # 语法检查
git commit -m "message"          # 不使用 --no-verify

# 推送前（每天1-2次）
make coverage-local              # 确保不低于15%
git push
```

#### --no-verify 使用原则
- ✅ 紧急修复：生产环境问题
- ✅ 文档更新：不涉及代码的改动
- ✅ 实验性分支：明确标注为实验
- ❌ 日常开发：避免使用

### 短期目标（1-2周）
1. 第1周：覆盖率 16.5% → 18%，减少使用 --no-verify
2. 第2周：覆盖率 18% → 20%，极少使用 --no-verify
3. 第3周：覆盖率 20% → 25%，完全不用 --no-verify
4. 第4周：覆盖率 25% → 30%，养成好习惯

### 中期目标（1个月）
1. 覆盖率达到 40-50%
2. 清理所有 lint 错误
3. 建立稳定的开发流程

### 长期目标
1. 覆盖率达到 70-80%
2. 建立完整的代码质量保证体系
3. 实现真正的持续集成

## 💬 用户的重要言论

> "我已经很久没看到绿灯了，很打击我的信心！"
> "我们一步一步提高门禁"
> "先让代码能合并到主干，慢慢优化"

这些话反映了用户的核心需求：**先建立信心，再追求完美**。

## 📝 给 Claude Code 的建议

当与用户合作时：

1. **优先确保 CI 能运行**：这是用户的底线
2. **渐进式改进**：不要一次性提出太高的要求
3. **解释原因**：告诉用户为什么需要某些改进
4. **庆祝小胜利**：每次 CI 通过都值得高兴
5. **保持耐心**：技术债务需要时间来解决

## 🔧 快速参考

### 常用命令
```bash
make test-quick          # 快速测试
make coverage-local      # 本地覆盖率检查
make lint               # 代码风格检查
make prepush            # 完整预推送检查
./scripts/quality-check.sh  # 推荐的快速检查
```

### 重要文件
- `Makefile`：定义了所有开发和测试命令
- `coverage_local.ini`：本地覆盖率配置
- `.github/workflows/ci-pipeline.yml`：CI 流水线配置
- `CLAUDE.md`：详细的 AI 编程规范
- `RECOMMENDED_WORKFLOW.md`：推荐的工作流程

---

**最后更新**：2025-10-09
**更新者**：Claude Code
**版本**：1.0
