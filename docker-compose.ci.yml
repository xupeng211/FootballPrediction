# ğŸ—ï¸ æœ¬åœ°CIæ¨¡æ‹Ÿå™¨ - å®Œå…¨å¤ç°GitHub Actionsç¯å¢ƒ
# ç‰ˆæœ¬: V5.0 - æ„å»ºæœ¬åœ°CIæ¨¡æ‹Ÿå™¨ï¼šæ‹’ç»ç­‰å¾…

services:
  # PostgreSQLæ•°æ®åº“æœåŠ¡ - ä¸CIç¯å¢ƒå®Œå…¨ä¸€è‡´
  db:
    image: postgres:15
    container_name: football-prediction-ci-db
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: test_football_prediction
      POSTGRES_USER: postgres
    ports:
      - "5433:5432"  # ä½¿ç”¨ä¸åŒç«¯å£é¿å…å†²çª
    volumes:
      - ci_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - ci-network

  # Redisç¼“å­˜æœåŠ¡ - ä¸CIç¯å¢ƒå®Œå…¨ä¸€è‡´
  redis:
    image: redis:7
    container_name: football-prediction-ci-redis
    ports:
      - "6380:6379"  # ä½¿ç”¨ä¸åŒç«¯å£é¿å…å†²çª
    command: redis-server --appendonly yes
    volumes:
      - ci_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - ci-network

  # CIè¿è¡Œå™¨ - å®Œå…¨éš”ç¦»çš„æµ‹è¯•ç¯å¢ƒ
  ci-runner:
    build:
      context: .
      dockerfile: Dockerfile.ci
    container_name: football-prediction-ci-runner
    environment:
      # æ•°æ®åº“é…ç½® - ä¸CIå®Œå…¨ä¸€è‡´
      DATABASE_URL: postgresql://postgres:postgres@db:5432/test_football_prediction
      REDIS_URL: redis://redis:6379/0

      # ç¯å¢ƒæ ‡è¯†
      ENV: testing
      CI: true
      TESTING: true
      DEBUG: false
      LOG_LEVEL: WARNING

      # Pythonè·¯å¾„
      PYTHONPATH: /app

      # æ€§èƒ½ä¼˜åŒ–
      PYTEST_CURRENT_TEST: 1
      MALLOC_ARENA_MAX: 2

      # ML Mocké…ç½® - å…³é”®ï¼é¿å…é‡å‹ä¾èµ–
      FOOTBALL_PREDICTION_ML_MODE: mock
      INFERENCE_SERVICE_MOCK: true
      SKIP_ML_MODEL_LOADING: true
      XGBOOST_MOCK: true
      JOBLIB_MOCK: true

    volumes:
      # æŒ‚è½½æºä»£ç  - æ’é™¤æœ¬åœ°æ„å»ºäº§ç‰©
      - ./src:/app/src
      - ./tests:/app/tests
      - ./scripts:/app/scripts
      - ./data:/app/data
      - ./logs:/app/logs
      - ./requirements.txt:/app/requirements.txt
      - ./requirements-ci.txt:/app/requirements-ci.txt

      # æ’é™¤æœ¬åœ°è™šæ‹Ÿç¯å¢ƒå’Œç¼“å­˜
      - ./.venv:/app/.venv:ro  # åªè¯»æŒ‚è½½ï¼Œç¡®ä¿ä¸ä¼šä½¿ç”¨
      - ./htmlcov:/app/htmlcov  # è¦†ç›–ç‡æŠ¥å‘Šè¾“å‡º

    working_dir: /app

    # CIå‘½ä»¤åºåˆ— - å®Œå…¨å¤ç°GitHub Actionsæ­¥éª¤
    command: >
      bash -c "
        echo 'ğŸš€ å¯åŠ¨æœ¬åœ°CIæ¨¡æ‹Ÿå™¨ V5.0...';

        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo 'â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨...';
        # ä½¿ç”¨TCPè¿æ¥æµ‹è¯•PostgreSQL
        while ! timeout 2 bash -c "</dev/tcp/db/5432"; do
          echo 'ç­‰å¾…PostgreSQL...';
          sleep 2;
        done;

        echo 'â³ ç­‰å¾…Rediså¯åŠ¨...';
        while ! timeout 2 bash -c "</dev/tcp/redis/6379"; do
          echo 'ç­‰å¾…Redis...';
          sleep 2;
        done;

        echo 'âœ… æ‰€æœ‰æœåŠ¡å·²å°±ç»ª';

        # åˆ›å»ºæµ‹è¯•æ•°æ®æ–‡ä»¶
        echo 'ğŸ“ åˆ›å»ºæµ‹è¯•æ‰€éœ€çš„æ•°æ®æ–‡ä»¶...';
        mkdir -p data logs;

        # åˆ›å»º dataset_v1.csv ç¤ºä¾‹æ•°æ®
        cat > data/dataset_v1.csv << 'EOF'
        date,home_team,away_team,home_score,away_score,result
        2024-01-01,Manchester United,Liverpool,2,1,H
        2024-01-02,Arsenal,Chelsea,1,1,D
        2024-01-03,Manchester City,Tottenham,3,0,H
        2024-01-04,Newcastle,Everton,1,2,A
        2024-01-05,Leicester,West Ham,2,2,D
        EOF;

        # åˆ›å»ºå¿…è¦çš„æ—¥å¿—æ–‡ä»¶
        touch logs/enhanced_ev_test.log;

        echo 'âœ… æ•°æ®æ–‡ä»¶åˆ›å»ºå®Œæˆ';

        # å®‰è£…ä¾èµ–
        echo 'ğŸ“¦ å®‰è£…CIä¾èµ–...';
        python -m pip install --upgrade pip;
        pip install pip-tools;
        pip install -r requirements-ci.txt;

        # è¿è¡Œä»£ç æ£€æŸ¥
        echo 'ğŸ” è¿è¡Œä»£ç æ£€æŸ¥...';
        ruff check src/ tests/ || echo 'âš ï¸ ä»£ç æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œç»§ç»­æ‰§è¡Œæµ‹è¯•';

        # è¿è¡Œå®‰å…¨æ‰«æ
        echo 'ğŸ›¡ï¸ è¿è¡Œå®‰å…¨æ‰«æ...';
        bandit -r src/ -f json -o bandit-report.json || echo 'âš ï¸ å®‰å…¨æ‰«æå®Œæˆ';

        # è¿è¡Œæµ‹è¯•å¥—ä»¶ - ä¸CIå®Œå…¨ä¸€è‡´çš„å‘½ä»¤
        echo 'ğŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶...';
        timeout 600s python -m pytest tests/unit/ \\
          --ignore=tests/unit/ml/ \\
          --ignore=tests/unit/scripts/ \\
          --ignore=tests/unit/collectors/ \\
          --timeout=30 \\
          --timeout-method=thread \\
          --cov=src \\
          --cov-report=xml:test-results-full.xml \\
          --cov-report=html:htmlcov-full \\
          --cov-report=term-missing \\
          --maxfail=5 \\
          -x \\
          -v \\
          --tb=short;

        TEST_EXIT_CODE=$?;

        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo 'ğŸ‰ CIæµ‹è¯•é€šè¿‡ï¼';
          echo 'ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ: htmlcov/index.html';
        else
          echo 'âŒ CIæµ‹è¯•å¤±è´¥';
        fi;

        # ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
        echo 'ğŸ“‹ ç”ŸæˆCIæŠ¥å‘Š...';
        echo '=== æœ¬åœ°CIæ¨¡æ‹Ÿå™¨æŠ¥å‘Š ===' > ci-report.txt;
        echo 'æµ‹è¯•æ—¶é—´: '$(date) >> ci-report.txt;
        echo 'æµ‹è¯•çŠ¶æ€: '$([ $TEST_EXIT_CODE -eq 0 ] && echo 'âœ… é€šè¿‡' || echo 'âŒ å¤±è´¥') >> ci-report.txt;
        echo 'è¦†ç›–ç‡æŠ¥å‘Š: htmlcov/index.html' >> ci-report.txt;
        echo 'å®‰å…¨æ‰«ææŠ¥å‘Š: bandit-report.json' >> ci-report.txt;
        cat ci-report.txt;

        exit $TEST_EXIT_CODE
      "

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

    networks:
      - ci-network

# ç½‘ç»œé…ç½®
networks:
  ci-network:
    driver: bridge
    name: football-prediction-ci-network

# æ•°æ®å·
volumes:
  ci_postgres_data:
    name: football-prediction-ci-postgres-data
  ci_redis_data:
    name: football-prediction-ci-redis-data