# 🚀 Pre-commit配置 - 自动化代码质量检查

repos:
  # 基础代码检查
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: 移除行尾空格
        description: 移除文件末尾的空格
      - id: end-of-file-fixer
        name: 文件结尾修复
        description: 确保文件以换行符结尾
      - id: check-yaml
        name: YAML语法检查
        description: 检查YAML文件语法
      - id: check-json
        name: JSON语法检查
        description: 检查JSON文件语法
      - id: check-merge-conflict
        name: 检查合并冲突标记
        description: 检查是否有未解决的合并冲突
      - id: check-added-large-files
        name: 检查大文件
        description: 防止提交过大的文件
        args: ['--maxkb=1000']

  # Python代码格式化
  - repo: https://github.com/psf/black
    rev: 24.4.2
    hooks:
      - id: black
        name: Black代码格式化
        description: 使用Black格式化Python代码
        language_version: python3.11
        line_length: 88

  # 导入排序
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: 导入排序
        description: 排序Python导入语句
        args: ["--profile", "black", "--line-length", "88"]

  # 代码检查
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.5.0
    hooks:
      - id: ruff
        name: Ruff代码检查
        description: 使用Ruff检查Python代码
        args: [--fix, --exit-non-zero-on-fix]
      - id: ruff-format
        name: Ruff格式化
        description: 使用Ruff格式化代码

  # 自定义修复钩子
  - repo: local
    hooks:
      - id: test-crisis-fix
        name: 测试危机修复
        description: 运行测试危机修复工具
        entry: python scripts/fix_test_crisis.py
        language: system
        pass_filenames: false
        always_run: true

      - id: syntax-check
        name: 语法检查
        description: 检查Python语法错误
        entry: python scripts/smart_quality_fixer.py --syntax-only
        language: system
        pass_filenames: false
        always_run: true

      - id: quick-test-check
        name: 快速测试检查
        description: 快速检查测试收集状态
        entry: python -c "import subprocess; subprocess.run(['python', '-m', 'pytest', '--collect-only', '-q'], check=False)"
        language: system
        pass_filenames: false
        always_run: true

# 配置选项
default_stages: [commit]
fail_fast: false
default_language_version:
  python: python3

# CI配置
ci:
  autofix_commit_msg: |
    🤖 自动修复pre-commit问题

    修复内容:
    - 代码格式化 (Black, isort)
    - 语法错误检查
    - 导入问题修复
    - 基础质量问题修复

    🎯 请检查修复后的代码并提交
  autofix_prs: true
  autoupdate_branch: true
  autoupdate_schedule: weekly
